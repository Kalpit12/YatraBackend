<!DOCTYPE html>
<!--
    Yatra Admin Panel - Working Version
    ====================================
    
    LOCALHOST SETUP:
    1. Make sure your backend server is running:
       - Navigate to your backend directory
       - Run: npm start
       - Server should be on http://localhost:3000
    
    2. Open this file in your browser:
       - Option 1: Use Live Server extension in VS Code
       - Option 2: Use Python: python -m http.server 5500
       - Option 3: Use Node.js: npx http-server -p 5500
       - Then open: http://localhost:5500/Yatra_Admin_Working.html
    
    3. Login credentials:
       - Provided securely by the administrator (do not hardcode)
    
    4. Required files in same directory:
       - api-integration.js (API connection to backend)
       - Backend server running on http://localhost:3000
    
    All data is stored in MySQL database via backend API.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yatra Admin Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïâÔ∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries for Export Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- API Integration -->
    <script src="api-integration.js"></script>
    
    <style>
        :root {
            --saffron: #FF9933;
            --white: #FFFFFF;
            --green: #138808;
            --navy: #000080;
            --light-saffron: #FFB366;
            --dark-green: #0A5504;
            --light-gray: #f5f5f5;
            --border-gray: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light-gray);
            overflow-x: hidden;
        }

        /* Header */
        .admin-header {
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: var(--saffron);
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--saffron) 0%, var(--white) 50%, var(--green) 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }

        .login-header {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--navy);
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--navy);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--saffron);
        }

        .submit-btn {
            width: auto;
            min-width: 180px;
            max-width: 250px;
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        /* Images Container */
        .images-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .image-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .image-input-row input {
            flex: 1;
        }

        .delete-image-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .delete-image-btn:hover {
            background: #c82333;
        }

        .add-image-btn {
            background: var(--green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }

        .add-image-btn:hover {
            background: var(--dark-green);
            transform: translateY(-2px);
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-item {
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            color: #333;
        }

        .sidebar-item:hover {
            background: rgba(255, 153, 51, 0.1);
            border-left: 4px solid var(--saffron);
            padding-left: 26px;
        }

        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(255, 153, 51, 0.2), transparent);
            border-left: 4px solid var(--saffron);
            padding-left: 26px;
            color: var(--saffron);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--navy);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--saffron);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--saffron), var(--green));
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: white;
            margin-bottom: 3px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.85rem;
        }

        /* Table Styles */
        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .add-btn {
            background: white;
            color: var(--saffron);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--light-gray);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--navy);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-gray);
        }

        tbody tr:hover {
            background: rgba(255, 153, 51, 0.05);
        }

        /* Action Buttons */
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            margin-right: 5px;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-approve {
            background: var(--green);
            color: white;
        }

        .btn-approve:hover {
            background: var(--dark-green);
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #007bff;
            color: white;
        }

        .btn-edit:hover {
            background: #0056b3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .action-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .action-btn:active {
            transform: translateY(0) scale(1);
        }

        /* Post Preview */
        .post-preview {
            display: flex;
            gap: 15px;
            align-items: start;
        }

        .post-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
        }

        .post-details {
            flex: 1;
        }

        .post-location {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 5px;
        }

        .post-author {
            font-size: 0.85rem;
            color: var(--green);
            margin-bottom: 5px;
        }

        .post-description {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-pending {
            background: #ffc107;
            color: #333;
        }

        .badge-approved {
            background: var(--green);
            color: white;
        }

        .badge-rejected {
            background: #dc3545;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            font-size: 1.5rem;
            font-weight: 600;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .close-modal:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--saffron);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            background: rgba(255, 153, 51, 0.1);
            border-color: var(--green);
        }

        .file-upload-area input {
            display: none;
        }

        /* Header Image Upload */
        .header-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .header-image-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-image-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .image-type-label {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 5px;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 100px;
            right: 30px;
            background: var(--green);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10000 !important;
            display: none;
            visibility: hidden;
            opacity: 0;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes slideInRight {
            from { 
                transform: translateX(400px); 
                opacity: 0; 
                visibility: hidden;
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
                visibility: visible;
            }
        }
        
        .success-message.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Gallery */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .gallery-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .gallery-image:hover {
            transform: scale(1.05);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .admin-title {
                font-size: 1.2rem;
            }

            .admin-user {
                flex-direction: column;
                gap: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px;
            }

            .post-preview {
                flex-direction: column;
            }

            .success-message {
                right: 10px;
                left: 10px;
            }
        }

        /* ==================== NEW FEATURES STYLES ==================== */
        
        /* Export Button Styles */
        .export-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        /* Journal Entry Styles */
        .journal-section {
            margin-top: 30px;
        }

        .journal-entry-admin-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--saffron);
        }

        .journal-date-header {
            color: var(--saffron);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .journal-mood-badge {
            display: inline-block;
            padding: 5px 12px;
            background: linear-gradient(135deg, var(--saffron), var(--light-saffron));
            color: white;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        .journal-content-preview {
            color: #666;
            line-height: 1.6;
            margin: 10px 0;
        }

        /* Notification Settings */
        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .notification-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .notification-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--green);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        /* Share Buttons in Posts Table */
        .admin-share-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem;
            color: white;
            margin: 2px;
            transition: all 0.2s ease;
        }

        .admin-share-btn:hover {
            transform: scale(1.05);
        }

        /* ==================== END NEW FEATURES STYLES ==================== */
    </style>
</head>
<body>
    <!-- Simple Login Function - Defined Early to Ensure Availability -->
    <script>
        // ============================================
        // VERSION CHECK - If you see this, new code is loaded!
        // ============================================
        console.log('üÜïüÜïüÜï NEW CODE VERSION LOADED - Date: 2025-12-05 v3.0 üÜïüÜïüÜï');
        console.log('‚úÖ File: Yatra_Admin_With_Room_Pairs (4).html');
        console.log('‚úÖ localStorage REMOVED - Now using MySQL/DOM state only!');
        console.log('‚úÖ All fixes applied - handleAddTraveler should work now!');
        // ============================================
        
        // Simple login function - defined early to ensure it's always available
        async function handleAdminLogin(event) {
            if (event) event.preventDefault();
            
            const usernameEl = document.getElementById('adminUsername');
            const passwordEl = document.getElementById('adminPassword');
            
            if (!usernameEl || !passwordEl) {
                alert('Error: Form fields not found');
                return false;
            }
            
            const user = usernameEl.value.trim();
            const pass = passwordEl.value;
            
            try {
                if (typeof api === 'undefined' || !api.adminLogin) {
                    alert('Login service unavailable. Please contact support.');
                    return false;
                }
                
                const result = await api.adminLogin(user, pass);
                if (!result || !result.token || !result.admin) {
                    alert('Invalid credentials');
                    return false;
                }
                
                // Persist auth state
                localStorage.setItem('adminData', JSON.stringify({
                    token: result.token,
                    email: result.admin.email,
                    name: result.admin.name,
                    id: result.admin.id,
                    isAdmin: true
                }));
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    sessionStorage.setItem('adminLoginTime', Date.now().toString());
                
                // Update UI
                const loginPage = document.getElementById('loginPage');
                const dashboard = document.getElementById('dashboard');
                if (loginPage) loginPage.style.display = 'none';
                if (dashboard) dashboard.classList.add('active');
                
                const adminName = document.getElementById('adminName');
                if (adminName) adminName.textContent = result.admin.name || 'Admin';
                
                    if (typeof updateDashboard === 'function') {
                        // Load data from API first, then update dashboard
                        updateDashboard().catch(err => {
                            console.error('Error updating dashboard after login:', err);
                        });
                }
                
                setTimeout(() => {
                    if (typeof loadTravelersTable === 'function') {
                        loadTravelersTable();
                    }
                    if (typeof showSection === 'function') {
                        showSection('overview');
                    }
                }, 300);
                
                return true;
            } catch (err) {
                console.error('üö´ Login failed:', err);
                alert('Login failed: ' + (err.message || 'Invalid credentials'));
                return false;
            }
        }
        
        // ============================================
        // EARLY ACTION BUTTON FUNCTIONS - Defined early so they're available immediately
        // ============================================
        window.deleteTraveler = async function(id) {
            if (confirm('Are you sure you want to delete this traveler?')) {
                try {
                    // Get traveler email before deleting
                    const traveler = (typeof travelers !== 'undefined') ? travelers.find(t => t.id === id) : null;
                    
                    // Delete via API if available
                    if (typeof api !== 'undefined' && api.deleteTraveler) {
                        await api.deleteTraveler(id);
                        // Clear cache
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/travelers');
                        }
                        if (typeof showMessage === 'function') showMessage('Traveler deleted successfully! ‚úÖ');
                        // Reload from API
                        if (typeof travelers !== 'undefined') {
                            travelers = await api.getTravelers();
                        }
                    } else {
                        // Fallback to localStorage
                        if (typeof travelers !== 'undefined') {
                            travelers = travelers.filter(t => t.id !== id);
                        }
                        if (typeof showMessage === 'function') showMessage('Traveler deleted successfully! ‚úÖ');
                    }
                    
                    if (typeof loadTravelersTable === 'function') loadTravelersTable();
                    if (typeof updateDashboard === 'function') updateDashboard();
                } catch (error) {
                    console.error('Error deleting traveler:', error);
                    if (typeof showMessage === 'function') showMessage('Error deleting traveler. Please try again.', 'error');
                }
            }
        };
        console.log('‚úÖ window.deleteTraveler defined');
        
        window.editTraveler = function(id) {
            const traveler = (typeof travelers !== 'undefined') ? travelers.find(t => t.id === id) : null;
            if (!traveler) {
                console.error('Traveler not found with id:', id);
                alert('Traveler not found. Please refresh the page.');
                return;
            }
            
            // Load latest profile data from website updates
            const allProfiles = JSON.parse(localStorage.getItem('travelerProfileData') || '{}');
            const webProfile = allProfiles[traveler.email];
            
            // Update modal title and button
            const titleEl = document.getElementById('travelerModalTitle');
            const submitBtn = document.getElementById('travelerSubmitBtn');
            if (titleEl) titleEl.textContent = 'Edit Traveler';
            if (submitBtn) submitBtn.textContent = 'Update Traveler';
            
            // Fill form with traveler data
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
            setVal('travelerId', traveler.id);
            setVal('travelerTirthId', traveler.tirthId);
            setVal('travelerFirstName', traveler.firstName || (traveler.name ? traveler.name.split(' ')[0] : ''));
            setVal('travelerMiddleName', traveler.middleName);
            setVal('travelerLastName', traveler.lastName || (traveler.name ? traveler.name.split(' ').pop() : ''));
            setVal('travelerProfileLine', (webProfile && webProfile.punchline) || traveler.profileLine);
            setVal('travelerAboutMe', (webProfile && webProfile.about) || traveler.aboutMe);
            setVal('travelerBirthDate', traveler.birthDate);
            setVal('travelerAge', traveler.age);
            setVal('travelerPassportNo', traveler.passportNo);
            setVal('travelerPassportIssue', traveler.passportIssueDate);
            setVal('travelerPassportExpiry', traveler.passportExpiryDate);
            setVal('travelerNationality', traveler.nationality);
            setVal('travelerEmail', traveler.email);
            setVal('travelerPassword', traveler.password);
            setVal('travelerPhone', traveler.phone);
            setVal('travelerCity', traveler.city);
            setVal('travelerCountry', traveler.country);
            setVal('travelerCenter', traveler.center);
            setVal('travelerHoodiSize', traveler.hoodiSize);
            
            // Populate vehicle dropdown
            const vehicleIdField = document.getElementById('travelerVehicleId') || document.getElementById('vehicleId');
            if (vehicleIdField) {
                // Populate dropdown with vehicles
                const vehiclesList = (typeof vehicles !== 'undefined' && Array.isArray(vehicles)) ? vehicles : [];
                vehicleIdField.innerHTML = '<option value="">No vehicle assigned</option>';
                vehiclesList.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.id;
                    option.textContent = `${v.name} (${v.type} - ${v.capacity} seats)`;
                    vehicleIdField.appendChild(option);
                });
                
                // Set current vehicle assignment
                const vehicleId = traveler.vehicleId || traveler.vehicle_id || null;
                // Convert null/undefined to empty string for dropdown
                vehicleIdField.value = vehicleId ? String(vehicleId) : '';
                console.log('‚úÖ Set vehicle ID dropdown to:', vehicleIdField.value, 'for traveler:', traveler.email);
                console.log('‚úÖ Original vehicleId from traveler object:', vehicleId, 'type:', typeof vehicleId);
            }
            
            // Show image if exists
            const travelerProfiles = JSON.parse(localStorage.getItem('travelerProfiles') || '{}');
            const imageUrl = (webProfile && webProfile.photo) || traveler.image || travelerProfiles[traveler.email] || '';
            if (imageUrl) {
                const preview = document.getElementById('travelerImagePreview');
                if (preview) preview.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">`;
                if (typeof tempTravelerImage !== 'undefined') tempTravelerImage = imageUrl;
            }
            
            // Open modal
            const modal = document.getElementById('travelerModal');
            if (modal) modal.style.display = 'block';
        };
        console.log('‚úÖ window.editTraveler defined');
        // ============================================
        
        // ============================================
        // EARLY MODAL FUNCTIONS - These must be defined before HTML loads
        // ============================================
        
        // Room Pair Modal - Full version defined early
        window.openPairModal = async function(pairId = null) {
            // This will be overwritten by the full version later, or work as fallback
            console.log('Opening pair modal...', pairId);
            const existingModal = document.getElementById('pairModal');
            if (existingModal) existingModal.remove();
            
            // Always reload pairs before opening modal to ensure we have latest data
            if (typeof api !== 'undefined' && api.getRoomPairs) {
                console.log('üîÑ Loading latest pairs before opening modal...');
                try {
                    // Clear cache to get fresh data
                    if (api.clearCacheFor) {
                        api.clearCacheFor('/room-pairs');
                    }
                    roomPairs = await api.getRoomPairs();
                    window.roomPairs = roomPairs;
                    console.log('‚úÖ Loaded', roomPairs.length, 'pairs before opening modal');
                } catch (error) {
                    console.error('Error loading pairs before modal:', error);
                }
            }
            
            // Get roomPairs and travelers from global scope - ensure they are arrays
            // Use the freshly loaded pairs from above
            const pairs = (typeof roomPairs !== 'undefined' && Array.isArray(roomPairs)) ? roomPairs : [];
            const travelersList = (typeof travelers !== 'undefined' && Array.isArray(travelers)) ? travelers : [];
            
            console.log('Pairs array:', pairs.length, 'Travelers:', travelersList.length);
            
            const pair = pairId ? pairs.find(p => p.id === pairId || p.id === parseInt(pairId)) : null;
            const isEdit = !!pair;
            
            const modal = document.createElement('div');
            modal.id = 'pairModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            // Get selected IDs from pair (handle both formats)
            const selectedIds = pair ? (pair.traveler_ids || pair.travelerIds || []) : [];
            const pairedTravelerIds = pairs.filter(p => !isEdit || (p.id !== pairId && p.id !== parseInt(pairId)))
                .flatMap(p => p.traveler_ids || p.travelerIds || []);
            const availableTravelers = isEdit ? travelersList : travelersList.filter(t => !pairedTravelerIds.includes(t.id));
            
            const getNextPairNo = () => {
                if (pairs.length === 0) return 1;
                const usedNumbers = pairs.map(p => p.pair_no || p.pairNo || 0).filter(n => n > 0);
                if (usedNumbers.length === 0) return 1;
                return Math.max(...usedNumbers) + 1;
            };
            
            // Get pair number for display (handle both formats)
            const displayPairNo = pair ? (pair.pair_no || pair.pairNo || pair.id) : getNextPairNo();
            
            const travelerCheckboxes = availableTravelers.map(t => {
                const isInOtherPair = isEdit && pairedTravelerIds.includes(t.id);
                const isSelected = selectedIds.includes(t.id);
                const isDisabled = isInOtherPair && !isSelected;
                return `<label class="traveler-item" data-name="${(t.name||'').toLowerCase()}" data-email="${(t.email||'').toLowerCase()}" style="display: flex; align-items: center; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'}; background: ${isSelected ? '#e8f5e9' : (isDisabled ? '#f5f5f5' : 'white')}; opacity: ${isDisabled ? '0.5' : '1'};">
                    <input type="checkbox" value="${t.id}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                    <div><strong>${t.name || 'Unknown'}</strong><br><small style="color: #666;">${t.email || ''}</small></div>
                </label>`;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <h2 style="color: var(--navy); margin-bottom: 20px;">${isEdit ? 'Edit' : 'Create'} Room Pair</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--navy); font-weight: 500;">Pair Number</label>
                        <input type="number" id="pairNumber" value="${displayPairNo}" min="1" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem;">
                    </div>
                    <div style="margin-bottom: 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <label style="display: block; margin-bottom: 8px; color: var(--navy); font-weight: 500;">Select Travelers</label>
                        <input type="text" id="travelerSearch" placeholder="üîç Search..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;" oninput="filterTravelers()">
                        <div id="travelerCheckboxes" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; max-height: 300px;">${travelerCheckboxes}</div>
                        <div id="travelerCount" style="margin-top: 8px; font-size: 0.9rem; color: #666;">${availableTravelers.length} travelers available</div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closePairModal()" style="padding: 12px 30px; background: #999; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button onclick="savePair(${pairId || 'null'})" style="padding: 12px 30px; background: linear-gradient(135deg, var(--saffron), var(--green)); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Save Pair</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        };
        console.log('‚úÖ window.openPairModal defined early');
        
        window.closePairModal = function() {
            const modal = document.getElementById('pairModal');
            if (modal) modal.remove();
        };
        
        window.savePair = async function(pairId) {
            const pairNo = parseInt(document.getElementById('pairNumber')?.value || 0);
            const checkboxes = document.querySelectorAll('#travelerCheckboxes input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes)
                .map(cb => parseInt(cb.value))
                .filter(id => !isNaN(id) && id > 0); // Filter out invalid IDs
            
            if (!pairNo || pairNo <= 0) { 
                alert('Please enter a valid pair number (greater than 0)'); 
                return; 
            }
            if (selectedIds.length === 0) { 
                alert('Please select at least one traveler'); 
                return; 
            }
            
            console.log('üìã Validation passed:', { pairNo, selectedIds, count: selectedIds.length });
            
            const pairs = (typeof roomPairs !== 'undefined') ? roomPairs : [];
            const travelersList = (typeof travelers !== 'undefined' && Array.isArray(travelers)) ? travelers : [];
            const travelerNames = selectedIds.map(id => { const t = travelersList.find(tr => tr.id === id); return t ? t.name : 'Unknown'; });
            
            try {
                if (typeof api !== 'undefined' && api.createRoomPair) {
                    // Check if pair number already exists (only for new pairs)
                    if (!pairId) {
                        // Reload pairs to check for existing pair number
                        try {
                            const existingPairs = await api.getRoomPairs();
                            const existingPair = existingPairs.find(p => 
                                (p.pair_no === pairNo || p.pairNo === pairNo) && p.id !== pairId
                            );
                            
                            if (existingPair) {
                                const existingTravelers = (existingPair.traveler_ids || existingPair.travelerIds || [])
                                    .map(id => {
                                        const t = travelersList.find(tr => tr.id === id);
                                        return t ? t.name : `Traveler ${id}`;
                                    })
                                    .join(', ');
                                
                                const editConfirm = confirm(
                                    `Pair number ${pairNo} already exists!\n\n` +
                                    `Existing travelers: ${existingTravelers}\n\n` +
                                    `Would you like to edit this pair instead?\n\n` +
                                    `Click OK to edit, or Cancel to use a different pair number.`
                                );
                                
                                if (editConfirm) {
                                    // Close current modal and open edit modal
                                    window.closePairModal();
                                    setTimeout(() => {
                                        window.openPairModal(existingPair.id);
                                    }, 300);
                                    return;
                                } else {
                                    // User wants to use different number - suggest next available
                                    const usedNumbers = existingPairs.map(p => p.pair_no || p.pairNo || 0).filter(n => n > 0);
                                    const nextAvailable = usedNumbers.length > 0 ? Math.max(...usedNumbers) + 1 : pairNo + 1;
                                    alert(`Please use a different pair number.\n\nSuggested next available number: ${nextAvailable}`);
                                    // Update the input field with suggested number
                                    const pairNumberInput = document.getElementById('pairNumber');
                                    if (pairNumberInput) {
                                        pairNumberInput.value = nextAvailable;
                                        pairNumberInput.focus();
                                    }
                                    return;
                                }
                            }
                        } catch (checkError) {
                            console.warn('Could not check for existing pairs:', checkError);
                            // Continue with creation attempt
                        }
                    }
                    
                    // Build pair data - try snake_case format first (common for MySQL backends)
                    // If backend expects camelCase, it should accept both
                    const pairData = { 
                        pair_no: pairNo, // Primary format (snake_case for MySQL)
                        pairNo: pairNo, // Fallback (camelCase)
                        traveler_ids: selectedIds, // Primary format (snake_case)
                        travelerIds: selectedIds, // Fallback (camelCase)
                        // travelerNames is optional - backend can derive from IDs
                        travelerNames: travelerNames
                    };
                    console.log('üì¶ Saving pair data:', pairData);
                    console.log('üì¶ Selected IDs:', selectedIds);
                    console.log('üì¶ Traveler names:', travelerNames);
                    
                    if (pairId) {
                        await api.updateRoomPair(pairId, pairData);
                        if (api.clearCacheFor) api.clearCacheFor('/room-pairs');
                        if (typeof showMessage === 'function') showMessage(`‚úÖ Pair ${pairNo} updated successfully!`);
                    } else {
                        const response = await api.createRoomPair(pairData);
                        console.log('‚úÖ API Response:', response);
                        if (api.clearCacheFor) api.clearCacheFor('/room-pairs');
                        if (typeof showMessage === 'function') showMessage(`‚úÖ Pair ${pairNo} created successfully!`);
                    }
                    
                    // Update global roomPairs
                    if (api.clearCacheFor) api.clearCacheFor('/room-pairs');
                    roomPairs = await api.getRoomPairs();
                    window.roomPairs = roomPairs;
                    console.log('‚úÖ Updated roomPairs array:', roomPairs.length);
                }
            } catch (error) {
                console.error('‚ùå Error saving room pair:', error);
                console.error('‚ùå Error details:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                
                // Try to get more details from the error
                let errorMessage = 'Error saving room pair. Please try again.';
                let shouldReloadPairs = false;
                
                if (error.message) {
                    if (error.message.includes('Pair number already exists')) {
                        errorMessage = `‚ùå Pair number ${pairNo} already exists!\n\nPlease use a different pair number or edit the existing pair.`;
                        shouldReloadPairs = true;
                        
                        // Try to find and suggest editing the existing pair
                        try {
                            const existingPairs = await api.getRoomPairs();
                            const existingPair = existingPairs.find(p => 
                                p.pair_no === pairNo || p.pairNo === pairNo
                            );
                            
                            if (existingPair) {
                                const editConfirm = confirm(
                                    errorMessage + '\n\n' +
                                    `Would you like to edit Pair ${pairNo} instead?`
                                );
                                
                                if (editConfirm) {
                                    window.closePairModal();
                                    setTimeout(() => {
                                        window.openPairModal(existingPair.id);
                                    }, 300);
                                    return;
                                }
                            }
                        } catch (findError) {
                            console.warn('Could not find existing pair:', findError);
                        }
                    } else if (error.message.includes('400')) {
                        errorMessage = 'Invalid data format. Please check that pair number and travelers are selected correctly.';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                // Reload pairs to show existing pairs
                if (shouldReloadPairs && typeof loadPairs === 'function') {
                    setTimeout(() => {
                        console.log('üîÑ Reloading pairs table to show existing pairs...');
                        loadPairs();
                    }, 500);
                }
                
                if (typeof showMessage === 'function') {
                    showMessage(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
                return;
            }
            
            window.closePairModal();
            // Reload pairs table
            if (typeof loadPairs === 'function') {
                setTimeout(() => loadPairs(), 100);
            }
        };
        console.log('‚úÖ window.savePair defined early');
        
        window.filterTravelers = function() {
            const searchText = (document.getElementById('travelerSearch')?.value || '').toLowerCase();
            document.querySelectorAll('.traveler-item').forEach(item => {
                const name = item.getAttribute('data-name') || '';
                const email = item.getAttribute('data-email') || '';
                item.style.display = (name.includes(searchText) || email.includes(searchText)) ? 'flex' : 'none';
            });
        };
        
        // Vehicle Modal
        window.openVehicleModal = async function() {
            console.log('üöó Opening vehicle modal...');
            const modal = document.getElementById('vehicleModal');
            if (modal) {
                modal.style.display = 'block';
                document.getElementById('vehicleModalTitle').textContent = 'Add Vehicle';
                ['vehicleId', 'vehicleName', 'vehicleType', 'vehicleCapacity', 'vehicleRegNo', 'vehicleNotes'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                const colorEl = document.getElementById('vehicleColor');
                if (colorEl) colorEl.value = '#FF9933';
                const statusEl = document.getElementById('vehicleStatus');
                if (statusEl) statusEl.value = 'Active';
                
                // Always populate group leaders dropdown
                console.log('üìã Calling populateGroupLeadersDropdown...');
                if (typeof populateGroupLeadersDropdown === 'function') {
                    await populateGroupLeadersDropdown();
                } else {
                    console.error('‚ùå populateGroupLeadersDropdown function not found!');
                    // Try to call it directly if it exists later
                    setTimeout(async () => {
                        if (typeof populateGroupLeadersDropdown === 'function') {
                            console.log('üìã Retrying populateGroupLeadersDropdown...');
                            await populateGroupLeadersDropdown();
                        }
                    }, 100);
                }
            }
        };
        console.log('‚úÖ window.openVehicleModal defined early');
        
        window.closeVehicleModal = function() {
            const modal = document.getElementById('vehicleModal');
            if (modal) modal.style.display = 'none';
        };
        
        // Hotel Modal
        window.openHotelModal = function() {
            const modal = document.getElementById('hotelModal');
            if (modal) {
                modal.style.display = 'block';
                document.getElementById('hotelModalTitle').textContent = 'Add New Hotel / Utara';
                ['hotelId', 'hotelName', 'hotelLocation', 'hotelFloors', 'hotelRooms', 'hotelCheckIn', 'hotelCheckOut', 'hotelAddress', 'hotelContact', 'hotelNotes'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                const btn = document.getElementById('hotelSubmitBtn');
                if (btn) btn.textContent = 'Add Hotel';
            }
        };
        console.log('‚úÖ window.openHotelModal defined early');
        
        window.closeHotelModal = function() {
            const modal = document.getElementById('hotelModal');
            if (modal) modal.style.display = 'none';
        };
        
        // Section Modal
        window.openSectionModal = function() {
            const modal = document.getElementById('sectionModal');
            if (modal) modal.style.display = 'block';
        };
        window.closeSectionModal = function() {
            const modal = document.getElementById('sectionModal');
            if (modal) modal.style.display = 'none';
        };
        console.log('‚úÖ window.openSectionModal defined early');
        
        // Tag Modal
        window.openTagModal = function() {
            const modal = document.getElementById('tagModal');
            if (modal) modal.style.display = 'block';
        };
        window.closeTagModal = function() {
            const modal = document.getElementById('tagModal');
            if (modal) modal.style.display = 'none';
        };
        console.log('‚úÖ window.openTagModal defined early');
        
        // Itinerary Modal
        window.openItineraryModal = function() {
            const modal = document.getElementById('itineraryModal');
            if (modal) {
                // Clear activities and images containers FIRST
                const activitiesContainer = document.getElementById('itineraryActivitiesContainer');
                if (activitiesContainer) {
                    activitiesContainer.innerHTML = '';
                }
                const imagesContainer = document.getElementById('itineraryImagesContainer');
                if (imagesContainer) {
                    imagesContainer.innerHTML = '';
                }
                
                // Reset form and clear ID for new entry
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                const idField = document.getElementById('itineraryId');
                if (idField) {
                    idField.value = '';
                    console.log('‚úÖ Cleared itinerary ID for new entry (early function)');
                }
                const titleEl = document.getElementById('itineraryModalTitle');
                if (titleEl) {
                    titleEl.textContent = 'Add Itinerary Day';
                }
                modal.style.display = 'block';
                const itineraryList = (typeof itinerary !== 'undefined') ? itinerary : [];
                const nextDay = itineraryList.length > 0 ? Math.max(...itineraryList.map(d => d.day || 0)) + 1 : 1;
                const dayEl = document.getElementById('itineraryDay');
                if (dayEl) dayEl.value = nextDay;
                if (typeof addItineraryImageInput === 'function') {
                    const container = document.getElementById('itineraryImagesContainer');
                    if (container) container.innerHTML = '';
                    addItineraryImageInput();
                }
                if (typeof loadActivitiesIntoForm === 'function') loadActivitiesIntoForm([]);
            }
        };
        window.closeItineraryModal = function() {
            const modal = document.getElementById('itineraryModal');
            if (modal) modal.style.display = 'none';
        };
        console.log('‚úÖ window.openItineraryModal defined early');
        
        // Activity and Image helpers
        window.addActivityField = window.addActivityField || function() { console.log('addActivityField will be loaded'); };
        window.removeActivityField = window.removeActivityField || function(id) { const el = document.getElementById(id); if (el) el.remove(); };
        window.addItineraryImageInput = window.addItineraryImageInput || function() { console.log('addItineraryImageInput will be loaded'); };
        window.removeItineraryImageInput = window.removeItineraryImageInput || function(rowId) { const el = document.getElementById(rowId); if (el) el.remove(); };
        
        console.log('‚úÖ All early modal functions defined');
        
        // ============================================
        // EARLY loadPairs FUNCTION - Must be defined before HTML buttons try to use it
        // ============================================
        // Define loadPairs function EARLY - full version, not a stub
        // This ensures it's available immediately when buttons try to call it
        // Note: roomPairs variable will be defined later, but we'll access it via window.roomPairs
        window.loadPairs = async function loadPairs() {
            console.log('üìã ========== loadPairs() CALLED ==========');
            
            // Wait a bit to ensure DOM and API are ready
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const tbody = document.getElementById('pairsTable');
            console.log('  - pairsTable element:', tbody ? 'FOUND' : 'NOT FOUND');
            
            if (!tbody) {
                console.warn('‚ö†Ô∏è pairsTable element not found - section may not be visible yet');
                console.warn('  - Checking if roomPairs section exists...');
                const section = document.getElementById('roomPairs');
                console.warn('  - roomPairs section:', section ? 'FOUND' : 'NOT FOUND');
                if (section) {
                    console.warn('  - roomPairs section active:', section.classList.contains('active'));
                }
                
                // Retry after a short delay
                setTimeout(() => {
                    const retryTbody = document.getElementById('pairsTable');
                    if (retryTbody) {
                        console.log('üîÑ Retrying loadPairs after DOM ready...');
                        window.loadPairs();
                    } else {
                        console.error('‚ùå pairsTable still not found after retry!');
                    }
                }, 500);
                return;
            }
            
            console.log('  - pairsTable found, proceeding with load...');
            
            // Ensure travelers are loaded first (for name lookup)
            if ((!travelers || travelers.length === 0) && typeof api !== 'undefined' && api.getTravelers) {
                console.log('üìã Loading travelers first for name lookup...');
                try {
                    travelers = await api.getTravelers();
                    window.travelers = travelers;
                    console.log('‚úÖ Travelers loaded for pair display:', travelers.length);
                } catch (error) {
                    console.warn('Could not load travelers for pair display:', error);
                }
            }
            
            // Load from API
            try {
                if (typeof api === 'undefined') {
                    console.error('‚ùå API object is undefined!');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">‚ö†Ô∏è API not available. Please check your backend connection.</td></tr>';
                    return;
                }
                
                if (!api.getRoomPairs) {
                    console.error('‚ùå api.getRoomPairs function not found!');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">‚ö†Ô∏è Room pairs API method not available.</td></tr>';
                    return;
                }
                
                console.log('üåê Calling api.getRoomPairs()...');
                // Clear cache to get fresh data
                if (api.clearCacheFor) {
                    api.clearCacheFor('/room-pairs');
                    console.log('üóëÔ∏è Cleared cache for /room-pairs');
                }
                
                // Load room pairs from API
                const loadedPairs = await api.getRoomPairs();
                // Store in global variable (accessible via window.roomPairs)
                window.roomPairs = loadedPairs;
                // Also update local variable if it exists in scope (for compatibility)
                try {
                    if (typeof roomPairs !== 'undefined') {
                        roomPairs = loadedPairs;
                    }
                } catch (e) {
                    // roomPairs not in scope yet, that's OK - we'll use window.roomPairs
                }
                
                console.log('‚úÖ Loaded room pairs from API:', loadedPairs.length);
                console.log('üìä Room pairs data:', loadedPairs);
                
                if (loadedPairs.length > 0) {
                    console.log('üìä First pair sample:', JSON.stringify(loadedPairs[0], null, 2));
                } else {
                    console.log('‚ö†Ô∏è API returned empty array - no pairs in database yet');
                }
                
                // Clear table
                tbody.innerHTML = '';
                
                // Check if we have pairs
                if (!loadedPairs || !Array.isArray(loadedPairs) || loadedPairs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #666;">No room pairs created yet. Click "+ Create Pair" to add one.</td></tr>';
                    return;
                }
                
                // Get travelers list for name lookup
                const travelersList = (typeof travelers !== 'undefined' && Array.isArray(travelers)) ? travelers : [];
                console.log('üìã Travelers available for name lookup:', travelersList.length);
                
                // Render each pair
                console.log('üîÑ Starting to render pairs...');
                console.log('üìä Pairs to render:', loadedPairs.length);
                let rowsRendered = 0;
                
                loadedPairs.forEach((pair, index) => {
                    console.log(`üìù Rendering pair ${index + 1}/${loadedPairs.length}:`, {
                        id: pair.id,
                        pairNo: pair.pair_no || pair.pairNo,
                        travelerIds: pair.traveler_ids || pair.travelerIds
                    });
                    
                    const row = document.createElement('tr');
                    
                    // Handle both pair_no and pairNo formats
                    const pairNo = pair.pair_no || pair.pairNo || pair.id;
                    
                    // Get traveler IDs (handle both formats)
                    const travelerIds = pair.traveler_ids || pair.travelerIds || [];
                    
                    // Get traveler names - either from pair data or lookup from travelers array
                    let travelerNames = [];
                    if (pair.traveler_names && Array.isArray(pair.traveler_names)) {
                        travelerNames = pair.traveler_names;
                    } else if (pair.travelerNames && Array.isArray(pair.travelerNames)) {
                        travelerNames = pair.travelerNames;
                    } else if (travelerIds.length > 0 && travelersList.length > 0) {
                        // Look up names from travelers array
                        travelerNames = travelerIds.map(id => {
                            const traveler = travelersList.find(t => t.id === id || t.id === parseInt(id));
                            return traveler ? (traveler.name || `${traveler.firstName || ''} ${traveler.lastName || ''}`.trim() || `Traveler ${id}`) : `Traveler ${id}`;
                        });
                    }
                    
                    const travelerCount = travelerIds.length || travelerNames.length;
                    const travelerNamesDisplay = travelerNames.length > 0 
                        ? travelerNames.join(', ') 
                        : (travelerIds.length > 0 ? `${travelerIds.length} traveler(s)` : 'No travelers assigned');
                    
                    row.innerHTML = `
                        <td style="font-weight: 600; color: var(--saffron);">Pair ${pairNo}</td>
                        <td>${escapeHTML(travelerNamesDisplay)}</td>
                        <td style="text-align: center;">${travelerCount}</td>
                        <td style="white-space: nowrap;">
                            <button class="action-btn btn-edit" onclick="editPair(${pair.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn btn-delete" onclick="deletePair(${pair.id})" title="Delete">üóë</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                    rowsRendered++;
                });
                
                console.log(`‚úÖ Room pairs table loaded - ${rowsRendered} rows rendered out of ${loadedPairs.length} pairs`);
                console.log(`üìä Table tbody now has ${tbody.children.length} children`);
                console.log('üìä Sample pair data:', loadedPairs.length > 0 ? loadedPairs[0] : 'none');
            } catch (error) {
                console.error('‚ùå Error loading room pairs:', error);
                console.error('‚ùå Error details:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                const errorTbody = document.getElementById('pairsTable');
                if (errorTbody) {
                    errorTbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">‚ùå Error loading pairs: ${error.message}</td></tr>`;
                }
            }
        };
        window.refreshPairs = window.loadPairs;
        console.log('‚úÖ window.loadPairs defined early (FULL VERSION - ready to use)');
        // ============================================
        
        // Make showSection available globally early (will be replaced by full version later)
        window.showSection = function(sectionId) {
            // Early stub - basic functionality until full version loads
            try {
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Find and activate sidebar item
                const sidebarItems = document.querySelectorAll('.sidebar-item');
                sidebarItems.forEach(item => {
                    const onclick = item.getAttribute('onclick');
                    if (onclick && onclick.includes("'" + sectionId + "'")) {
                        item.classList.add('active');
                    }
                });
            } catch (e) {
                // Silently handle errors during early initialization
                // The full function will be available once scripts load
            }
        };
        
        // Make openAdminPostModal available globally early
        window.openAdminPostModal = function() {
            try {
                const modal = document.getElementById('adminPostModal');
                if (modal) {
                    modal.style.display = 'block';
                    // Initialize variables if they don't exist yet
                    if (typeof window.adminSelectedMedia === 'undefined') {
                        window.adminSelectedMedia = [];
                    }
                    if (typeof window.adminSelectedTags === 'undefined') {
                        window.adminSelectedTags = [];
                    }
                    // Try to render tags if the function exists
                    if (typeof renderAdminTags === 'function') {
                        renderAdminTags();
                    }
                } else {
                    // Modal not found yet, wait a bit and try again
                    setTimeout(() => {
                        const retryModal = document.getElementById('adminPostModal');
                        if (retryModal) {
                            retryModal.style.display = 'block';
                        }
                    }, 100);
                }
            } catch (e) {
                // Silently handle errors during early initialization
                // The full function will be available once scripts load
            }
        };
        
        // Make logout available globally early
        // Early logout function (will be overridden by full version later)
        window.logout = function() {
            console.log('üö™ Logging out (early function)...');
            try {
                const loginPage = document.getElementById('loginPage');
                const dashboard = document.getElementById('dashboard');
                const adminUsername = document.getElementById('adminUsername');
                const adminPassword = document.getElementById('adminPassword');
                
                // Immediately hide dashboard and show login page
                if (dashboard) {
                    dashboard.classList.remove('active');
                    dashboard.style.display = 'none';
                }
                
                if (loginPage) {
                    loginPage.style.display = 'flex';
                }
                
                if (adminUsername) {
                    adminUsername.value = '';
                }
                
                if (adminPassword) {
                    adminPassword.value = '';
                }
                
                // Close any open modals
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                
                // Clear sessionStorage on logout
                try {
                    sessionStorage.removeItem('adminLoggedIn');
                    sessionStorage.removeItem('adminLoginTime');
                    sessionStorage.removeItem('activeSection');
                    console.log('‚úÖ Login state cleared from sessionStorage');
                } catch (e) {
                    console.warn('Could not clear login state:', e);
                }
                
                console.log('‚úÖ Logout complete (early function)');
            } catch (e) {
                // Silently handle errors during early initialization
                // The full function will be available once scripts load
                console.error('Error in early logout:', e);
            }
        };
        
        // Make togglePasswordVisibility available globally early
        window.togglePasswordVisibility = function(fieldId, button) {
            try {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'password') {
                        field.type = 'text';
                        if (button) {
                            button.textContent = 'üôà';
                            button.title = 'Hide Password';
                        }
                    } else {
                        field.type = 'password';
                        if (button) {
                            button.textContent = 'üëÅÔ∏è';
                            button.title = 'Show Password';
                        }
                    }
                }
            } catch (e) {
                // Silently handle errors during early initialization
            }
        };
        
        // ==================== UTILITY FUNCTIONS (Loaded Early) ====================
        // These functions must be available before handle functions are called
        
        // escapeHTML - Escape HTML special characters
        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        window.escapeHTML = escapeHTML;
        
        // showMessage - Display success/error messages
        function showMessage(message, type = 'success') {
            try {
                const msgDiv = document.getElementById('successMessage');
                if (!msgDiv) {
                    console.warn('Notification element not found, using alert fallback');
                    alert(message);
                    return;
                }
                
                msgDiv.textContent = message;
                msgDiv.style.background = type === 'error' ? '#dc3545' : (type === 'info' ? '#007bff' : (type === 'warning' ? '#ff9800' : 'var(--green)'));
                msgDiv.classList.add('show');
                msgDiv.style.display = 'block';
                msgDiv.style.zIndex = '10000';
                msgDiv.style.opacity = '1';
                msgDiv.style.visibility = 'visible';
                
                // Force reflow to ensure animation
                void msgDiv.offsetHeight;
                
                setTimeout(() => {
                    if (msgDiv) {
                        msgDiv.style.opacity = '0';
                        msgDiv.classList.remove('show');
                        setTimeout(() => {
                            if (msgDiv) {
                                msgDiv.style.display = 'none';
                                msgDiv.style.visibility = 'hidden';
                            }
                        }, 300);
                    }
                }, 3000);
            } catch (e) {
                console.error('Error showing message:', e);
                alert(message);
            }
        }
        window.showMessage = showMessage;
        
        // safeGetFromStorage - Safely get data from localStorage
        function safeGetFromStorage(key, defaultValue = []) {
            try {
                if (typeof localStorage === 'undefined' || localStorage === null) {
                    console.warn(`‚ö†Ô∏è localStorage not available. Using defaults for ${key}.`);
                    return defaultValue;
                }
                const data = localStorage.getItem(key);
                if (!data || data === 'undefined' || data === 'null') {
                    return defaultValue;
                }
                const parsed = JSON.parse(data);
                return parsed !== null ? parsed : defaultValue;
            } catch (error) {
                console.warn(`‚ö†Ô∏è Storage access blocked for ${key}. Using defaults.`, error.message);
                return defaultValue;
            }
        }
        window.safeGetFromStorage = safeGetFromStorage;
        
        // safeSetToStorage - Safely set data to localStorage
        function safeSetToStorage(key, value) {
            try {
                if (typeof localStorage === 'undefined' || localStorage === null) {
                    console.warn(`‚ö†Ô∏è localStorage not available. Cannot save ${key}.`);
            return false;
                }
                const stringified = JSON.stringify(value);
                localStorage.setItem(key, stringified);
                return true;
            } catch (error) {
                console.warn(`‚ö†Ô∏è Storage access blocked for ${key}.`, error.message);
                return false;
            }
        }
        window.safeSetToStorage = safeSetToStorage;
        
        // verifyLoginState - Verify and maintain login state
        function verifyLoginState() {
            try {
                const dashboard = document.getElementById('dashboard');
                const loginPage = document.getElementById('loginPage');
                
                if (!dashboard || !loginPage) return;
                
                const isDashboardActive = dashboard.classList.contains('active');
                
                // Check sessionStorage for login state
                const sessionLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
                const loginTime = sessionStorage.getItem('adminLoginTime');
                const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours
                const isValidSession = loginTime && (Date.now() - parseInt(loginTime)) < SESSION_DURATION;
                
                // If session is valid but DOM doesn't match, restore from session
                if (sessionLoggedIn && isValidSession && !isDashboardActive) {
                    console.log('üîÑ Restoring login state from session...');
                    dashboard.classList.add('active');
                    loginPage.style.display = 'none';
                }
                // If session is invalid but DOM shows logged in, clear it
                else if (!sessionLoggedIn || !isValidSession) {
                    if (isDashboardActive) {
                        console.log('‚ö†Ô∏è Session expired, logging out...');
                        dashboard.classList.remove('active');
                        loginPage.style.display = 'flex';
                        try {
                            sessionStorage.removeItem('adminLoggedIn');
                            sessionStorage.removeItem('adminLoginTime');
                            sessionStorage.removeItem('activeSection');
                        } catch (e) {
                            console.warn('Could not clear session:', e);
                        }
                    }
                }
                // Ensure state is consistent - if dashboard is active, hide login page
                else if (isDashboardActive) {
                    loginPage.style.display = 'none';
                } else {
                    loginPage.style.display = 'flex';
                }
            } catch (e) {
                console.warn('Error verifying login state:', e);
            }
        }
        window.verifyLoginState = verifyLoginState;
        
        // checkAndLoadTravelersTable - Check if travelers section is active and load table
        function checkAndLoadTravelersTable() {
            const travelersSection = document.getElementById('travelers');
            const travelersTable = document.getElementById('travelersTable');
            
            console.log('üîç checkAndLoadTravelersTable called');
            console.log('  - Travelers section exists:', !!travelersSection);
            console.log('  - Travelers section active:', travelersSection ? travelersSection.classList.contains('active') : false);
            console.log('  - travelersTable exists:', !!travelersTable);
            
            if (travelersSection && travelersSection.classList.contains('active')) {
                if (travelersTable && typeof loadTravelersTable === 'function') {
                    console.log('üîÑ Travelers section is active - loading table...');
                    loadTravelersTable().catch(err => {
                        console.error('Error loading travelers table:', err);
                    });
                } else {
                    console.warn('‚ö†Ô∏è loadTravelersTable function not available or table element missing');
                }
            }
        }
        window.checkAndLoadTravelersTable = checkAndLoadTravelersTable;
        
        // Auto-load travelers table when visible and empty
        // This runs every second to ensure data is always loaded
        setInterval(() => {
            const travelersSection = document.getElementById('travelers');
            const travelersTable = document.getElementById('travelersTable');
            const dashboard = document.getElementById('dashboard');
            
            // Only run if logged in (dashboard is active)
            if (!dashboard || !dashboard.classList.contains('active')) return;
            
            // Check if travelers section is visible and table is empty
            if (travelersSection && travelersSection.classList.contains('active')) {
                if (travelersTable && travelersTable.children.length === 0) {
                    console.log('üîÑ Auto-loading travelers table (section visible, table empty)...');
                    if (typeof loadTravelersTable === 'function') {
                        loadTravelersTable();
                    }
                }
            }
        }, 1000);
        
        // updateDashboard - Update dashboard statistics
        async function updateDashboard() {
            try {
                const safePosts = (typeof posts !== 'undefined' && Array.isArray(posts)) ? posts : [];
                
                // Get travelers from API if available, otherwise use cached
                let safeTravelers = [];
                if (typeof api !== 'undefined' && api.getTravelers) {
                    try {
                        safeTravelers = await api.getTravelers();
                        // Update global travelers variable
                        travelers = safeTravelers;
                        if (typeof window.travelers !== 'undefined') {
                            window.travelers = safeTravelers;
                        }
                    } catch (error) {
                        console.warn('Error loading travelers for dashboard:', error);
                        safeTravelers = (typeof travelers !== 'undefined' && Array.isArray(travelers)) ? travelers : [];
                    }
                } else {
                    safeTravelers = (typeof travelers !== 'undefined' && Array.isArray(travelers)) ? travelers : [];
                }
                
                const publicPosts = safePosts.filter(p => p && !p.isPrivate);
                const places = new Set(publicPosts.map(p => p.place).filter(Boolean)).size;
                const countries = new Set(publicPosts.map(p => p.country).filter(Boolean)).size;
                const cities = new Set(publicPosts.map(p => p.city || p.location).filter(Boolean)).size;
                
                const updateElement = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                
                updateElement('totalPosts', publicPosts.length);
                updateElement('totalTravelers', safeTravelers.length);
                updateElement('totalPlaces', places);
                updateElement('totalCountries', countries);
                updateElement('totalCities', cities);
                
                console.log('üìä Dashboard updated - Travelers:', safeTravelers.length);
            } catch (e) {
                console.warn('Error updating dashboard:', e);
            }
        }
        window.updateDashboard = updateDashboard;
        
        // loadTravelersTable - Load and display travelers table
        async function loadTravelersTable() {
            try {
                console.log('üìã Loading travelers table...');
                
                // Wait a bit to ensure DOM is ready
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Check if table element exists
                const tbody = document.getElementById('travelersTable');
                if (!tbody) {
                    console.error('‚ùå travelersTable element not found! Waiting and retrying...');
                    // Retry after a short delay
                    await new Promise(resolve => setTimeout(resolve, 200));
                    const retryTbody = document.getElementById('travelersTable');
                    if (!retryTbody) {
                        console.error('‚ùå travelersTable element still not found after retry!');
                        return;
                    }
                }
                
                // Load travelers from API
                if (typeof api !== 'undefined' && api.getTravelers) {
                    try {
                        // Clear cache to ensure fresh data
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/travelers');
                        }
                        
                        const loadedTravelers = await api.getTravelers();
                        console.log('‚úÖ Loaded travelers from API:', loadedTravelers.length);
                        console.log('üìã First traveler sample:', loadedTravelers.length > 0 ? loadedTravelers[0] : 'No travelers');
                        
                        // Update global travelers variable - ALWAYS set window.travelers
                            window.travelers = loadedTravelers;
                        travelers = loadedTravelers;
                        console.log('‚úÖ window.travelers updated with', loadedTravelers.length, 'travelers');
                    } catch (error) {
                        console.error('‚ùå Error loading travelers from API:', error);
                        // Fallback to localStorage
                        const storedTravelers = safeGetFromStorage('authorizedTravelers', []);
                        // ALWAYS set window.travelers
                            window.travelers = storedTravelers;
                        travelers = storedTravelers;
                        console.log('‚úÖ window.travelers updated from localStorage with', storedTravelers.length, 'travelers');
                    }
                } else {
                    console.warn('‚ö†Ô∏è API not available, using localStorage');
                    const storedTravelers = safeGetFromStorage('authorizedTravelers', []);
                    // ALWAYS set window.travelers
                        window.travelers = storedTravelers;
                    travelers = storedTravelers;
                    console.log('‚úÖ window.travelers updated from localStorage with', storedTravelers.length, 'travelers');
                }
                
                // Ensure travelers is an array
                if (!Array.isArray(travelers)) {
                    console.warn('‚ö†Ô∏è Travelers is not an array, converting...');
                    travelers = [];
                }
                
                console.log('üìä Displaying', travelers.length, 'travelers');
                
                // Get table element again (in case it wasn't ready before)
                const finalTbody = document.getElementById('travelersTable');
                if (!finalTbody) {
                    console.error('‚ùå travelersTable element not found after loading data!');
                    return;
                }
                
                finalTbody.innerHTML = '';
                
                if (travelers.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                            No travelers found. Add your first traveler to get started!
                        </td>
                    `;
                    finalTbody.appendChild(row);
                    console.log('‚ÑπÔ∏è No travelers to display');
                    return;
                }
                
                let rowsAdded = 0;
                console.log('üîÑ Starting to render travelers...');
                console.log('üìä Travelers array length:', travelers.length);
                console.log('üìä Travelers array:', JSON.stringify(travelers.slice(0, 2), null, 2));
                
                travelers.forEach((traveler, index) => {
                    if (!traveler) {
                        console.warn(`‚ö†Ô∏è Skipping null/undefined traveler at index ${index}`);
                        return; // Skip null/undefined entries
                    }
                    
                    console.log(`üìù Processing traveler ${index + 1}/${travelers.length}:`, {
                        id: traveler.id,
                        name: traveler.name || `${traveler.firstName || ''} ${traveler.lastName || ''}`.trim(),
                        email: traveler.email
                    });
                    
                    const row = document.createElement('tr');
                    const travelerProfiles = JSON.parse(localStorage.getItem('travelerProfiles') || '{}');
                    const imageUrl = traveler.image || travelerProfiles[traveler.email] || '';
                    const imageDisplay = imageUrl ? 
                        `<img src="${escapeHTML(imageUrl)}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; vertical-align: middle;">` :
                        `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--light-saffron); display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; vertical-align: middle; font-size: 1.2rem;">üë§</div>`;
                    
                    // Handle missing fields gracefully
                    const name = traveler.name || `${traveler.firstName || ''} ${traveler.lastName || ''}`.trim() || 'Unknown';
                    const email = traveler.email || '';
                    const phone = traveler.phone || '';
                    const city = traveler.city || '';
                    const id = traveler.id || 0;
                    
                    row.innerHTML = `
                        <td>${imageDisplay}${escapeHTML(name)}</td>
                        <td>${escapeHTML(email)}</td>
                        <td>${escapeHTML(phone)}</td>
                        <td>${escapeHTML(city)}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editTraveler(${id})" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn btn-delete" onclick="deleteTraveler(${id})" title="Delete">üóë</button>
                        </td>
                    `;
                    finalTbody.appendChild(row);
                    rowsAdded++;
                });
                
                console.log(`‚úÖ Travelers table loaded successfully - ${rowsAdded} rows displayed`);
                console.log(`üìä Table element children count: ${finalTbody.children.length}`);
                console.log(`üìä Table element HTML length: ${finalTbody.innerHTML.length} characters`);
            } catch (e) {
                console.error('‚ùå Error loading travelers table:', e);
                console.error('Error stack:', e.stack);
            }
        }
        window.loadTravelersTable = loadTravelersTable;
        
        // ==================== HANDLE FUNCTIONS ====================
        
        // Full version of handleAddTraveler - loaded directly to avoid errors
        let tempTravelerImage = '';
        
        window.handleAddTraveler = async function handleAddTraveler(event) {
            console.log('üöÄüöÄüöÄ handleAddTraveler FUNCTION CALLED!', event);
            
            // CRITICAL: Always prevent default form submission
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
                console.log('‚úÖ Event prevented and stopped');
            }
            
            // Prevent form submission
            const form = document.getElementById('travelerForm');
            if (form) {
                form.onsubmit = function(e) {
                    console.log('üõë Form onsubmit: Preventing default');
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    return false;
                };
            }
            
            // Login state managed by MySQL backend (no localStorage needed)
            
            // Ensure dashboard stays visible
            const dashboard = document.getElementById('dashboard');
            const loginPage = document.getElementById('loginPage');
            if (dashboard && !dashboard.classList.contains('active')) {
                dashboard.classList.add('active');
                console.log('üîß Dashboard activated');
            }
            if (loginPage) {
                loginPage.style.display = 'none';
            }
            
            // Check if API is available
            const apiAvailable = typeof api !== 'undefined' && api.createTraveler;
            console.log('üåê API Available:', apiAvailable);
            if (!apiAvailable) {
                console.error('‚ùå API not available! Make sure:');
                console.error('   1. Backend server is running (npm start)');
                console.error('   2. api-integration.js is loaded');
                alert('‚ö†Ô∏è Backend API not available!\n\nPlease:\n1. Start the backend server: npm start\n2. Make sure it\'s running on http://localhost:3000\n\nTraveler will be saved to localStorage as fallback.');
                return false; // Prevent form submission if API not available
            }
            
            const travelerId = document.getElementById('travelerId').value;
            console.log('üìã Traveler ID:', travelerId || 'NEW');
            const email = document.getElementById('travelerEmail').value;
            
            const firstName = document.getElementById('travelerFirstName').value;
            const middleName = document.getElementById('travelerMiddleName').value;
            const lastName = document.getElementById('travelerLastName').value;
            const fullName = middleName ? `${firstName} ${middleName} ${lastName}` : `${firstName} ${lastName}`;
            
            // Get vehicleId from form (if exists)
            const vehicleIdField = document.getElementById('travelerVehicleId') || document.getElementById('vehicleId');
            let vehicleId = null;
            if (vehicleIdField) {
                const fieldValue = vehicleIdField.value;
                console.log('üöå Vehicle field found, raw value:', fieldValue, 'type:', typeof fieldValue);
                if (fieldValue && fieldValue.trim() !== '' && fieldValue !== 'null' && fieldValue !== 'undefined') {
                    const parsed = parseInt(fieldValue);
                    vehicleId = isNaN(parsed) ? null : parsed;
                    console.log('üöå Parsed vehicleId:', vehicleId);
                } else {
                    console.log('üöå Vehicle field is empty, setting vehicleId to null');
                    vehicleId = null;
                }
            } else {
                console.warn('‚ö†Ô∏è Vehicle ID field not found in form!');
            }
            
            console.log('üöå Final Vehicle ID being sent:', vehicleId, 'Type:', typeof vehicleId);
            
            const travelerData = {
                tirthId: document.getElementById('travelerTirthId').value || `TY${String(Date.now()).slice(-3)}`,
                firstName: firstName,
                middleName: middleName || '',
                lastName: lastName,
                name: fullName,
                profileLine: document.getElementById('travelerProfileLine').value || '',
                aboutMe: document.getElementById('travelerAboutMe').value || '',
                birthDate: document.getElementById('travelerBirthDate').value || null,
                age: document.getElementById('travelerAge').value ? parseInt(document.getElementById('travelerAge').value) : null,
                passportNo: document.getElementById('travelerPassportNo').value || '',
                passportIssueDate: document.getElementById('travelerPassportIssue').value || null,
                passportExpiryDate: document.getElementById('travelerPassportExpiry').value || null,
                nationality: document.getElementById('travelerNationality').value || 'Indian',
                email: email,
                password: document.getElementById('travelerPassword').value,
                phone: document.getElementById('travelerPhone').value,
                city: document.getElementById('travelerCity').value,
                country: document.getElementById('travelerCountry').value || 'India',
                center: document.getElementById('travelerCenter').value || '',
                hoodiSize: document.getElementById('travelerHoodiSize').value || null,
                image: tempTravelerImage || '',
                gender: 'Male', // Default, can add field later
                vehicleId: vehicleId // Always include vehicleId (can be null to unassign)
            };
            
            console.log('üì¶ Complete travelerData object:', JSON.stringify(travelerData, null, 2));

            console.log('üìù Starting to save traveler:', email);
            console.log('üñºÔ∏è Profile image included:', tempTravelerImage ? `Yes (${tempTravelerImage.length} chars)` : 'No');
            
            try {
                // Save to travelerProfiles for sync with main website
                if (tempTravelerImage) {
                    const travelerProfiles = JSON.parse(localStorage.getItem('travelerProfiles') || '{}');
                    travelerProfiles[email] = tempTravelerImage;
                    localStorage.setItem('travelerProfiles', JSON.stringify(travelerProfiles));
                }

                if (travelerId) {
                    console.log('üîÑ Updating existing traveler:', travelerId);
                    console.log('üì§ Traveler data being sent:', JSON.stringify(travelerData, null, 2));
                    // Update existing traveler via API
                    if (typeof api !== 'undefined' && api.updateTraveler) {
                        const response = await api.updateTraveler(parseInt(travelerId), travelerData);
                        console.log('‚úÖ API response:', response);
                        
                        // Clear cache to refresh traveler data
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/travelers');
                            api.clearCacheFor('/travelers/public');
                            console.log('üóëÔ∏è Cleared traveler cache');
                        }
                        
                        // Reload travelers list to reflect changes
                        if (typeof loadTravelersTable === 'function') {
                            loadTravelersTable();
                        }
                        
                        showMessage('Traveler updated successfully! ‚úÖ');
                    } else {
                        // Fallback to localStorage
                        const travelers = await (typeof api !== 'undefined' && api.getTravelers ? api.getTravelers() : Promise.resolve(JSON.parse(localStorage.getItem('authorizedTravelers') || '[]')));
                        const index = travelers.findIndex(t => t.id === parseInt(travelerId));
                        if (index !== -1) {
                            travelers[index] = { ...travelerData, id: parseInt(travelerId) };
                            await safeSetToStorage('authorizedTravelers', travelers);
                            showMessage('Traveler updated successfully! ‚úÖ');
                        }
                    }
                } else {
                    console.log('‚ûï Adding new traveler');
                    // Add new traveler via API (REQUIRED - no localStorage fallback)
                    if (typeof api !== 'undefined' && api.createTraveler) {
                        console.log('üåê Using API to create traveler');
                        try {
                            // Ensure dashboard stays visible (login state managed by MySQL backend)
                    const dashboard = document.getElementById('dashboard');
                            const loginPage = document.getElementById('loginPage');
                            if (dashboard) dashboard.classList.add('active');
                            if (loginPage) loginPage.style.display = 'none';
                            
                            const result = await api.createTraveler(travelerData);
                            console.log('‚úÖ API response:', result);
                            
                            // Ensure dashboard stays visible after successful API call
                            if (dashboard) dashboard.classList.add('active');
                            if (loginPage) loginPage.style.display = 'none';
                            
                            showMessage('Traveler added successfully! üéâ');
                            // Clear cache to refresh data
                            if (api.clearCacheFor) {
                                api.clearCacheFor('authorizedTravelers');
                }
                        } catch (apiError) {
                            console.error('‚ùå API Error:', apiError);
                            
                            // Ensure dashboard stays visible even on API error
                const dashboard = document.getElementById('dashboard');
                const loginPage = document.getElementById('loginPage');
                            if (dashboard) dashboard.classList.add('active');
                            if (loginPage) loginPage.style.display = 'none';
                            
                            alert('‚ùå Failed to add traveler via API!\n\nError: ' + apiError.message + '\n\nPlease:\n1. Check if backend server is running (npm start)\n2. Check console for details');
                            return false; // Return false instead of throwing
                        }
                    } else {
                        console.error('‚ùå API not available - cannot add traveler!');
                        alert('‚ùå Cannot add traveler!\n\nBackend API is not available.\n\nPlease:\n1. Start the backend server: npm start\n2. Make sure it\'s running on http://localhost:3000\n3. Refresh this page');
                        return false; // Don't proceed without API
                    }
                }
                
                // SYNC TO WEBSITE: Update travelerProfileData with profile line and about me
                const allProfiles = JSON.parse(localStorage.getItem('travelerProfileData') || '{}');
                const travelerProfiles = JSON.parse(localStorage.getItem('travelerProfiles') || '{}');
                allProfiles[email] = {
                    email: email,
                    name: travelerData.name,
                    city: travelerData.city,
                    punchline: travelerData.profileLine || '',
                    about: travelerData.aboutMe || '',
                    photo: travelerProfiles[email] || ''
                };
                localStorage.setItem('travelerProfileData', JSON.stringify(allProfiles));
                
                console.log('üîí Ensuring dashboard stays visible before closing modal');
                // Login state managed by MySQL backend (no localStorage needed)
                
                // Ensure dashboard stays visible
                const dashboard = document.getElementById('dashboard');
                const loginPage = document.getElementById('loginPage');
                if (dashboard && !dashboard.classList.contains('active')) {
                    console.log('üîß Fixing dashboard - adding active class');
                    dashboard.classList.add('active');
                }
                if (loginPage) {
                    loginPage.style.display = 'none';
                }
                console.log('‚úÖ Dashboard state verified');
                
                console.log('üö™ Closing traveler modal');
                if (typeof closeTravelerModal === 'function') {
                    closeTravelerModal();
                }
                
                // Reload travelers from API and refresh table
                console.log('üîÑ Reloading travelers after save...');
                try {
                    // Clear cache first to ensure fresh data
                    if (api && api.clearCacheFor) {
                        api.clearCacheFor('/travelers');
                        console.log('‚úÖ Cache cleared for /travelers');
                    }
                    
                    // Small delay to ensure cache is cleared
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Load and display travelers
                    if (typeof loadTravelersTable === 'function') {
                        await loadTravelersTable();
                    } else {
                        console.error('‚ùå loadTravelersTable function not found!');
                    }
                } catch (apiError) {
                    console.warn('‚ö†Ô∏è Error reloading travelers:', apiError);
                    // Still try to load the table
                    if (typeof loadTravelersTable === 'function') {
                        await loadTravelersTable();
                    }
                }
                
                // Update dashboard safely
                try {
                    if (typeof updateDashboard === 'function') {
                        updateDashboard();
                    }
                } catch (dashboardError) {
                    console.warn('Dashboard update failed:', dashboardError);
                    // Don't let dashboard errors cause redirects
                }

                // Reset form and temp image
                const form = document.getElementById('travelerForm');
                if (form && typeof form.reset === 'function') {
                    form.reset();
                    console.log('‚úÖ Form reset successfully');
                } else {
                    // Manual reset if form.reset() not available
                    const formInputs = form ? form.querySelectorAll('input, textarea, select') : [];
                    formInputs.forEach(input => {
                        if (input.type !== 'button' && input.type !== 'submit') {
                            input.value = '';
                        }
                    });
                    console.log('‚úÖ Form fields cleared manually');
                }
                tempTravelerImage = '';
                
                // Reset image preview
                const imagePreview = document.getElementById('travelerImagePreview');
                if (imagePreview) {
                    imagePreview.innerHTML = 'üë§';
                    imagePreview.style.background = 'var(--light-saffron)';
                }
                
                // Final check: ensure we're still logged in
                if (typeof verifyLoginState === 'function') {
                    verifyLoginState();
                }
                
                console.log('‚úÖ Traveler saved successfully, returning false to prevent form submission');
                return false; // CRITICAL: Always return false to prevent form submission
            } catch (error) {
                console.error('‚ùå Error saving traveler:', error);
                if (typeof showMessage === 'function') {
                    showMessage('Error saving traveler. Please try again.', 'error');
                }
                
                // Ensure dashboard stays visible even on error (no localStorage - using MySQL now)
                    const dashboard = document.getElementById('dashboard');
                    const loginPage = document.getElementById('loginPage');
                    if (dashboard) dashboard.classList.add('active');
                    if (loginPage) loginPage.style.display = 'none';
                
                return false; // CRITICAL: Always return false even on error
            }
        };
        
        // Full version of openTravelerModal - loaded directly to avoid errors
        window.openTravelerModal = function openTravelerModal(event) {
            // Prevent any default behavior or event propagation
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            try {
                console.log('üîì openTravelerModal called');
                
                // Check login state from DOM (using MySQL backend, no localStorage)
                const dashboard = document.getElementById('dashboard');
                const loginPage = document.getElementById('loginPage');
                const isLoggedIn = dashboard && dashboard.classList.contains('active');
                
                if (!isLoggedIn) {
                    console.warn('‚ö†Ô∏è User not logged in, showing login page');
                    // User is not logged in, show login page
                    if (loginPage) {
                        loginPage.style.display = 'flex';
                    }
                    if (dashboard) {
                        dashboard.classList.remove('active');
                    }
                    alert('Please login first with your admin credentials to add travelers.');
                    return false;
                }
                
                // Ensure dashboard is visible (in case DOM state got out of sync)
                if (dashboard && !dashboard.classList.contains('active')) {
                    console.log('üîß Fixing dashboard state - adding active class');
                    dashboard.classList.add('active');
                }
                if (loginPage) {
                    loginPage.style.display = 'none';
                }
                
                // User is logged in, open the modal
                const modal = document.getElementById('travelerModal');
                if (modal) {
                    console.log('‚úÖ Opening traveler modal');
                    // Reset form and set defaults
                    const form = modal.querySelector('form');
                    if (form) {
                        form.reset();
                    }
                    // Set food preference default to Vegetarian
                    const foodPreference = document.getElementById('travelerFoodPreference');
                    if (foodPreference) {
                        foodPreference.value = 'Vegetarian';
                    }
                    // Populate vehicle dropdown
                    const vehicleIdField = document.getElementById('travelerVehicleId') || document.getElementById('vehicleId');
                    if (vehicleIdField) {
                        const vehiclesList = (typeof vehicles !== 'undefined' && Array.isArray(vehicles)) ? vehicles : [];
                        vehicleIdField.innerHTML = '<option value="">No vehicle assigned</option>';
                        vehiclesList.forEach(v => {
                            const option = document.createElement('option');
                            option.value = v.id;
                            option.textContent = `${v.name} (${v.type} - ${v.capacity} seats)`;
                            vehicleIdField.appendChild(option);
                        });
                        console.log('‚úÖ Populated vehicle dropdown with', vehiclesList.length, 'vehicles');
                    }
                    modal.style.display = 'block';
                    return false; // Prevent any further event handling
                } else {
                    console.error('‚ùå Traveler modal element not found');
                    alert('Error: Traveler form not found. Please refresh the page.');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error in openTravelerModal:', error);
                // Don't redirect on error - just show a message
                alert('Error opening traveler form. Please try again or refresh the page.\n\nError: ' + error.message);
                return false;
            }
        };
        
        // Full version of closeTravelerModal - loaded directly to avoid errors
        window.closeTravelerModal = function closeTravelerModal() {
                const modal = document.getElementById('travelerModal');
            if (modal) {
                modal.style.display = 'none';
                // Reset to Add mode
                const title = document.getElementById('travelerModalTitle');
                const submitBtn = document.getElementById('travelerSubmitBtn');
                const travelerId = document.getElementById('travelerId');
                const imagePreview = document.getElementById('travelerImagePreview');
                
                if (title) title.textContent = 'Add New Traveler';
                if (submitBtn) submitBtn.textContent = 'Add Traveler';
                if (travelerId) travelerId.value = '';
                if (imagePreview) {
                    imagePreview.innerHTML = 'üë§';
                    imagePreview.style.background = 'var(--light-saffron)';
                }
                // Reset form
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                // Set food preference default to Vegetarian
                const foodPreference = document.getElementById('travelerFoodPreference');
                if (foodPreference) {
                    foodPreference.value = 'Vegetarian';
                }
                tempTravelerImage = '';
            }
        };
        
        // Full version of calculateAge - loaded directly to avoid errors
        window.calculateAge = function calculateAge() {
                const birthDate = document.getElementById('travelerBirthDate');
                const ageField = document.getElementById('travelerAge');
                if (birthDate && birthDate.value && ageField) {
                    const today = new Date();
                    const birth = new Date(birthDate.value);
                    let age = today.getFullYear() - birth.getFullYear();
                    const monthDiff = today.getMonth() - birth.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                        age--;
                    }
                    ageField.value = age;
                }
        };
        
        // Note: Modal functions (openPairModal, openVehicleModal, etc.) are defined later in the file
        // and will be assigned to window directly - no stubs needed
        
        window.closeItineraryExcelModal = window.closeItineraryExcelModal || function() {
            try {
                const modal = document.getElementById('itineraryExcelModal');
                if (modal) modal.style.display = 'none';
            } catch (e) {}
        };
        
        window.openTagModal = window.openTagModal || function() {
            try {
                const modal = document.getElementById('tagModal');
                if (modal) modal.style.display = 'block';
            } catch (e) {}
        };
        
        window.closeTagModal = window.closeTagModal || function() {
            try {
                const modal = document.getElementById('tagModal');
                if (modal) modal.style.display = 'none';
            } catch (e) {}
        };
        
        window.closeAdminPostModal = window.closeAdminPostModal || function() {
            try {
                const modal = document.getElementById('adminPostModal');
                if (modal) modal.style.display = 'none';
            } catch (e) {}
        };
        
        window.closePostDetailModal = window.closePostDetailModal || function() {
            try {
                const modal = document.getElementById('postDetailModal');
                if (modal) modal.style.display = 'none';
            } catch (e) {}
        };
        
        window.closeCheckInReportModal = window.closeCheckInReportModal || function() {
            try {
                const modal = document.getElementById('checkInReportModal');
                if (modal) modal.style.display = 'none';
            } catch (e) {}
        };
        
        // Make action functions available globally early (will be replaced by full versions later)
        window.clearAllVehicleCheckIns = window.clearAllVehicleCheckIns || function() {
            try {
                if (confirm('Clear all vehicle check-ins?')) {
                    // Will be implemented by full function
                }
            } catch (e) {}
        };
        
        window.clearAllVehicleAllotments = window.clearAllVehicleAllotments || function() {
            try {
                if (confirm('Clear all vehicle allotments?')) {
                    // Will be implemented by full function
                }
            } catch (e) {}
        };
        
        window.saveVehicleAllotments = window.saveVehicleAllotments || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.clearAllAllotments = window.clearAllAllotments || function() {
            try {
                if (confirm('Clear all allotments?')) {
                    // Will be implemented by full function
                }
            } catch (e) {}
        };
        
        // Stub - will be replaced by full implementation below
        window.saveAllotments = window.saveAllotments || function() {
            console.warn('‚ö†Ô∏è saveAllotments stub called - full function should be available');
        };
        
        window.sendAnnouncement = window.sendAnnouncement || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.clearAnnouncementForm = window.clearAnnouncementForm || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.refreshScheduledAnnouncements = window.refreshScheduledAnnouncements || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.clearAnnouncementHistory = window.clearAnnouncementHistory || function() {
            try {
                if (confirm('Clear announcement history?')) {
                    // Will be implemented by full function
                }
            } catch (e) {}
        };
        
        window.saveHeaderImages = window.saveHeaderImages || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.saveAdminProfile = window.saveAdminProfile || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.saveEmergencyContact = window.saveEmergencyContact || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.setWakeUpAlarm = window.setWakeUpAlarm || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.testAlarm = window.testAlarm || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.saveSettings = window.saveSettings || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.addActivityField = window.addActivityField || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.addItineraryImageInput = window.addItineraryImageInput || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.saveItineraryFromExcel = window.saveItineraryFromExcel || function() {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
        
        window.viewImageFullscreen = window.viewImageFullscreen || function(imageUrl, postId) {
            try {
                // Will be implemented by full function
            } catch (e) {}
        };
    </script>
    
    <!-- Session Check Script - runs immediately to prevent login flash -->
    <script>
        (function() {
            try {
                const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
                const loginTime = sessionStorage.getItem('adminLoginTime');
                const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours
                const isValidSession = loginTime && (Date.now() - parseInt(loginTime)) < SESSION_DURATION;
                
                if (isLoggedIn && isValidSession) {
                    // Inject CSS to hide login page and show dashboard immediately
                    // Using !important to override default styles
                    document.write('<style>#loginPage { display: none !important; } #dashboard, .dashboard { display: block !important; }</style>');
                    console.log('üîê Valid session found - hiding login page immediately');
                    
                    // Also set a flag to indicate session is valid
                    window._sessionValid = true;
                    window._activeSection = sessionStorage.getItem('activeSection') || 'overview';
                } else if (loginTime) {
                    // Session expired - clear it
                    sessionStorage.removeItem('adminLoggedIn');
                    sessionStorage.removeItem('adminLoginTime');
                    sessionStorage.removeItem('activeSection');
                    console.log('‚ö†Ô∏è Session expired - cleared');
                }
            } catch (e) {
                console.warn('Session check failed:', e);
            }
        })();
    </script>
    
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">üïâÔ∏è Admin Panel</div>
            <form onsubmit="handleAdminLogin(event); return false;">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="adminUsername" required placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div style="position: relative;">
                        <input type="password" id="adminPassword" required placeholder="Enter password" style="width: 100%; padding-right: 40px;">
                        <button type="button" onclick="togglePasswordVisibility('adminPassword', this)" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; font-size: 1.2rem; 
                                       color: #666; padding: 5px;" 
                                title="Show/Hide Password">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <button type="submit" class="submit-btn">Login to Dashboard</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Header -->
        <div class="admin-header">
            <div class="admin-title">
                <span>üïâÔ∏è</span>
                <span>Yatra Admin Panel</span>
            </div>
            <div class="admin-user">
                <span id="adminName">Admin</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="dashboard-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <ul class="sidebar-menu">
                    <li class="sidebar-item active" onclick="showSection('overview')">
                        üìä Overview
                    </li>
                    <li class="sidebar-item" onclick="showSection('posts')">
                        üìù Manage Posts
                    </li>
                    <li class="sidebar-item" onclick="openAdminPostModal()">
                        ‚úèÔ∏è Create Post
                    </li>
                    <li class="sidebar-item" onclick="showSection('travelers'); setTimeout(function(){ if(typeof loadTravelersTable==='function') loadTravelersTable(); }, 100);">
                        üë• Travelers
                    </li>
                    <li class="sidebar-item" onclick="showSection('roomPairs'); setTimeout(function(){ if(typeof loadPairs === 'function') { console.log('üîÑ Sidebar: Calling loadPairs...'); loadPairs(); } else if(typeof window.loadPairs === 'function') { console.log('üîÑ Sidebar: Calling window.loadPairs...'); window.loadPairs(); } }, 300);">
                        ü§ù Room Pairs
                    </li>
                    <li class="sidebar-item" onclick="showSection('vehicles')">
                        üöå Vehicles
                    </li>
                    <li class="sidebar-item" onclick="showSection('vehicleAllotment')">
                        üöê Vehicle Allotment
                    </li>
                    <li class="sidebar-item" onclick="showSection('hotels')">
                        üè® Hotel / Utara
                    </li>
                    <li class="sidebar-item" onclick="showSection('hotelAllotment')">
                        üõèÔ∏è Hotel Allotment
                    </li>
                    <li class="sidebar-item" onclick="showSection('itinerary')">
                        üó∫Ô∏è Yatra Itinerary
                    </li>
                    <li class="sidebar-item" onclick="showSection('sections')">
                        üìÇ Sections
                    </li>
                    <li class="sidebar-item" onclick="showSection('tags')">
                        üè∑Ô∏è Tags
                    </li>
                    <li class="sidebar-item" onclick="showSection('announcements')">
                        üì¢ Announcements
                    </li>
                    <li class="sidebar-item" onclick="showSection('settings')">
                        ‚öôÔ∏è Settings
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Overview Section -->
                <div id="overview" class="content-section active">
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üèõÔ∏è</div>
                            <div class="stat-value" id="totalPlaces">0</div>
                            <div class="stat-label">Places</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üåç</div>
                            <div class="stat-value" id="totalCountries">0</div>
                            <div class="stat-label">Countries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üèôÔ∏è</div>
                            <div class="stat-value" id="totalCities">0</div>
                            <div class="stat-label">Cities</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìç</div>
                            <div class="stat-value" id="totalLocations">0</div>
                            <div class="stat-label">Visited</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-value" id="totalTravelers">0</div>
                            <div class="stat-label">Travelers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìù</div>
                            <div class="stat-value" id="totalPosts">0</div>
                            <div class="stat-label">Posts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚è≥</div>
                            <div class="stat-value" id="pendingPosts">0</div>
                            <div class="stat-label">Pending Approvals</div>
                        </div>
                    </div>

                    <div class="data-table" style="margin-top: 30px;">
                        <div class="table-header">
                            <div class="table-title">üëë Top Contributors</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Contributor</th>
                                    <th>Posts</th>
                                    <th>Photos</th>
                                    <th>Videos</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="topContributorsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 30px;">No contributors yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="data-table" style="margin-top: 30px;">
                        <div class="table-header">
                            <div class="table-title">‚ö° Recent Activities</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Activity</th>
                                    <th>User</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivities">
                                <tr>
                                    <td colspan="3" style="text-align: center; padding: 30px;">No recent activities</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Posts Section -->
                <div id="posts" class="content-section">
                    <div class="section-header">Manage Posts</div>
                    
                    <div class="data-table">
                        <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="table-title">All Posts</div>
                            <button class="add-btn" onclick="openAdminPostModal()" style="padding: 10px 20px; background: var(--saffron); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                ‚úèÔ∏è Create Post
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Post</th>
                                    <th>Author</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="postsTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 30px;">No posts available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Travelers Section -->
                <div id="travelers" class="content-section">
                    <div class="section-header">Manage Travelers</div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">Registered Travelers</div>
                            <button type="button" class="add-btn" onclick="openTravelerModal(); return false;">+ Add Traveler</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>City</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="travelersTable"></tbody>
                        </table>
                    </div>

                    <div style="margin-top: 30px;">
                        <div class="data-table">
                            <div class="table-header">
                                <div class="table-title">Bulk Upload Travelers</div>
                            </div>
                            <div style="padding: 30px;">
                                <div class="file-upload-area" onclick="document.getElementById('excelUpload').click()">
                                    <div style="font-size: 3rem; margin-bottom: 10px;">üìä</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">Upload Excel File</div>
                                    <div style="color: #666;">Click to select Excel file with traveler data</div>
                                    <div style="margin-top: 15px; font-size: 0.85rem; color: #999;">
                                        <strong>Required columns:</strong> First Name, Last Name, Email, Password, Phone, City, Country<br>
                                        <strong>Optional columns:</strong> Tirth ID, Middle Name, Birth Date, Profile Line, About Me, Passport #, Nationality, Passport Issue Date, Passport Expiry Date, Center, Hoodi Size
                                    </div>
                                </div>
                                <input type="file" id="excelUpload" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room Pairs Section -->
                <div id="roomPairs" class="content-section">
                    <div class="section-header">
                        <h2>ü§ù Room Pairs Management</h2>
                        <p>Create room sharing pairs or groups for travelers</p>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">Room Sharing Pairs</div>
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn" onclick="console.log('üîÑ Refresh button clicked'); console.log('  - window.loadPairs type:', typeof window.loadPairs); if(typeof window.loadPairs === 'function') { console.log('‚úÖ Calling window.loadPairs()...'); window.loadPairs().catch(err => { console.error('Error loading pairs:', err); }); } else { console.error('‚ùå window.loadPairs not found!'); alert('Error: loadPairs function not found. Please refresh the page.'); }" style="background: #007bff; color: white; padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer; font-weight: 600;" title="Refresh Pairs">üîÑ Refresh</button>
                                <button class="add-btn" onclick="openPairModal()">+ Create Pair</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 120px;">Pair No</th>
                                    <th>Travelers</th>
                                    <th style="width: 100px;">Count</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pairsTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Vehicles Section -->
                <div id="vehicles" class="content-section">
                    <div class="section-header">
                        <h2>üöå Vehicle Management</h2>
                        <p>Manage vehicles and assign group leaders for live tracking</p>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">All Vehicles</div>
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn" onclick="clearAllVehicleCheckIns()" style="background: #ff9800; color: white; padding: 10px 15px; font-weight: 600; font-size: 1.2rem;" title="Clear All Check-Ins">üîÑ</button>
                                <button class="add-btn" onclick="openVehicleModal()">+ Add Vehicle</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Vehicle Name</th>
                                    <th>Type</th>
                                    <th>Capacity</th>
                                    <th>Group Leader</th>
                                    <th>Status</th>
                                    <th>Check-In</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Vehicle Allotment Section -->
                <div id="vehicleAllotment" class="content-section">
                    <div class="section-header">
                        <h2>üöê Vehicle Allotment</h2>
                        <p>Assign travelers to vehicles day-wise for journey management</p>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">Day-wise Vehicle Allocation</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="vehicleAllotmentDateSelect" onchange="loadVehicleAllotmentGrid()" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; min-width: 250px;">
                                    <option value="">Select Day</option>
                                </select>
                                <button class="action-btn" onclick="document.getElementById('vehicleAllotmentExcelUpload').click()" style="background: var(--green); color: white; padding: 8px 15px; font-size: 1.2rem;" title="Bulk Upload (Excel)">üìä</button>
                                <button class="action-btn" onclick="clearAllVehicleAllotments()" style="background: #ff9800; color: white; padding: 8px 15px; font-size: 1.2rem;" title="Clear All">üîÑ</button>
                                <button class="action-btn" onclick="saveVehicleAllotments()" style="background: #28a745; color: white; padding: 8px 15px; font-size: 1.2rem;" title="Save">üíæ</button>
                            </div>
                        </div>
                        <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                            <details style="cursor: pointer;">
                                <summary style="font-weight: 600; color: var(--navy); margin-bottom: 10px;">üìã Bulk Upload Format Instructions</summary>
                                <div style="margin-top: 10px; padding: 15px; background: white; border-radius: 5px; font-size: 0.9rem;">
                                    <p style="margin-bottom: 10px;"><strong>Required Columns:</strong></p>
                                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                                        <li><code>Date</code> - Format: YYYY-MM-DD (e.g., 2024-11-25)</li>
                                        <li><code>Traveler Email</code> - Email of the traveler (text)</li>
                                        <li><code>Vehicle Name</code> - Exact name of vehicle (text)</li>
                                    </ul>
                                    <p style="margin-bottom: 5px;"><strong>Example Excel Format:</strong></p>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                        <thead>
                                            <tr style="background: var(--light-saffron);">
                                                <th style="border: 1px solid #ddd; padding: 5px;">Date</th>
                                                <th style="border: 1px solid #ddd; padding: 5px;">Traveler Email</th>
                                                <th style="border: 1px solid #ddd; padding: 5px;">Vehicle Name</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 5px;">2024-11-25</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="54263539143139353d387a373b39">[email&#160;protected]</a></td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">Bus 1</td>
                                            </tr>
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 5px;">2024-11-25</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8bf8e2ffeacbeee6eae2e7a5e8e4e6">[email&#160;protected]</a></td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">Bus 1</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                            <input type="file" id="vehicleAllotmentExcelUpload" accept=".xlsx,.xls" onchange="handleVehicleAllotmentExcelUpload(event)" style="display: none;">
                        </div>
                        <div id="vehicleAllotmentGridContainer" style="padding: 20px; overflow-x: auto;">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                Select a day to view vehicle allotment grid
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hotel / Utara Section -->
                <div id="hotels" class="content-section">
                    <div class="section-header">
                        <h2>üè® Hotel / Utara Management</h2>
                        <p>Manage hotels and accommodation facilities</p>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">All Hotels / Utaras</div>
                            <button class="add-btn" onclick="openHotelModal()">+ Add Hotel</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Hotel Name</th>
                                    <th>Location</th>
                                    <th>Total Floors</th>
                                    <th>Total Rooms</th>
                                    <th>Check-In Date</th>
                                    <th>Check-Out Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="hotelsTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Hotel Allotment Section -->
                <div id="hotelAllotment" class="content-section">
                    <div class="section-header">
                        <h2>üõèÔ∏è Hotel / Utara Allotment</h2>
                        <p>Assign travelers to hotel rooms day-wise</p>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">Room Allotment</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="allotmentHotelSelect" onchange="populateDateSelect(); loadAllotmentGrid();" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem;">
                                    <option value="">Select Hotel</option>
                                </select>
                                <select id="allotmentDateSelect" onchange="loadAllotmentGrid()" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem;">
                                    <option value="">Select Date</option>
                                </select>
                                <button class="action-btn" onclick="document.getElementById('roomAllotmentExcelUpload').click()" style="background: var(--green); color: white; padding: 8px 15px; font-size: 1.2rem;" title="Bulk Upload (Excel)">üìä</button>
                                <button class="action-btn" onclick="clearAllAllotments()" style="background: #ff9800; color: white; padding: 8px 15px; font-size: 1.2rem;" title="Clear All">üîÑ</button>
                                <button class="action-btn" onclick="saveAllotments()" style="background: #28a745; color: white; padding: 8px 15px; font-size: 1.2rem;" title="Save">üíæ</button>
                            </div>
                        </div>
                        <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                            <details style="cursor: pointer;">
                                <summary style="font-weight: 600; color: var(--navy); margin-bottom: 10px;">üìã Bulk Upload Format Instructions</summary>
                                <div style="margin-top: 10px; padding: 15px; background: white; border-radius: 5px; font-size: 0.9rem;">
                                    <p style="margin-bottom: 10px;"><strong>Required Columns:</strong></p>
                                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                                        <li><code>Hotel Name</code> - Exact name of hotel (text)</li>
                                        <li><code>Date</code> - Format: YYYY-MM-DD (e.g., 2024-11-25)</li>
                                        <li><code>Pair No</code> - Pair number (number, use 0 for unpaired travelers)</li>
                                        <li><code>Traveler Emails</code> - Comma-separated emails (text)</li>
                                        <li><code>Floor</code> - Floor number (text/number)</li>
                                        <li><code>Room</code> - Room number (text/number)</li>
                                    </ul>
                                    <p style="margin-bottom: 5px;"><strong>Example Excel Format:</strong></p>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                        <thead>
                                            <tr style="background: var(--light-saffron);">
                                                <th style="border: 1px solid #ddd; padding: 5px;">Hotel Name</th>
                                                <th style="border: 1px solid #ddd; padding: 5px;">Date</th>
                                                <th style="border: 1px solid #ddd; padding: 5px;">Pair No</th>
                                                <th style="border: 1px solid #ddd; padding: 5px;">Traveler Emails</th>
                                                <th style="border: 1px solid #ddd; padding: 5px;">Floor</th>
                                                <th style="border: 1px solid #ddd; padding: 5px;">Room</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 5px;">Hotel Varanasi</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">2024-11-25</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">1</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0674676b467f677274672865696b">[email&#160;protected]</a>, <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a0d3c9d4c1e0d9c1d4d2c18ec3cfcd">[email&#160;protected]</a></td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">2</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">201</td>
                                            </tr>
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 5px;">Hotel Varanasi</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">2024-11-25</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">2</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0a6178637962646b4a736b7e786b24696567">[email&#160;protected]</a></td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">2</td>
                                                <td style="border: 1px solid #ddd; padding: 5px;">202</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="margin-top: 10px; color: #666; font-size: 0.85rem;"><strong>Note:</strong> Travelers with the same Pair No will be assigned to the same room.</p>
                                </div>
                            </details>
                            <input type="file" id="roomAllotmentExcelUpload" accept=".xlsx,.xls" onchange="handleRoomAllotmentExcelUpload(event)" style="display: none;">
                        </div>
                        <div id="allotmentGridContainer" style="padding: 20px; overflow-x: auto;">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                Select a hotel and date to view allotment grid
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sections Section -->
                <div id="sections" class="content-section">
                    <div class="section-header">Manage Sections</div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">Post Sections</div>
                            <button class="add-btn" onclick="openSectionModal()">+ Add Section</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Section Name</th>
                                    <th>Description</th>
                                    <th>Posts Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sectionsTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Yatra Itinerary Section -->
                <div id="itinerary" class="content-section">
                    <div class="section-header">Yatra Itinerary Management</div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">Journey Timeline</div>
                            <div style="display: flex; gap: 10px;">
                                <button class="add-btn" onclick="openItineraryModal()">+ Add Day</button>
                                <button class="add-btn" onclick="openItineraryExcelUpload()" style="background: linear-gradient(135deg, #4CAF50, #45a049);">üìä Bulk Upload Excel</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Day</th>
                                    <th>Date</th>
                                    <th>Place</th>
                                    <th>City</th>
                                    <th>Country</th>
                                    <th style="width: 80px;">Activities</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="itineraryTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tags Section -->
                <div id="tags" class="content-section">
                    <div class="section-header">Manage Tags</div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <button class="add-btn" onclick="openTagModal()">+ Add Tag</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Tag Name</th>
                                    <th>Usage Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tagsTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div id="announcements" class="content-section">
                    <div class="section-header">
                        <h2>üì¢ Announcements</h2>
                        <p>Send notifications and announcements to travelers</p>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">Create Announcement</div>
                        </div>
                        <div style="padding: 30px;">
                            <!-- Recipient Selection -->
                            <div class="form-group">
                                <label style="font-weight: 600; color: var(--navy); font-size: 1rem;">Send To</label>
                                <select id="announcementRecipient" onchange="handleRecipientChange()" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                                    <option value="all-travelers">üë• All Travelers</option>
                                    <option value="all-group-leaders">üë®‚Äç‚úàÔ∏è All Group Leaders</option>
                                    <option value="specific-traveler">üë§ Specific Traveler</option>
                                    <option value="specific-group-leader">üë®‚Äç‚úàÔ∏è Specific Group Leader</option>
                                    <option value="by-vehicle">üöå By Vehicle</option>
                                </select>
                            </div>

                            <!-- Specific Traveler Selection (Hidden by default) -->
                            <div id="specificTravelerSelect" class="form-group" style="display: none;">
                                <label style="font-weight: 600; color: var(--navy);">Select Traveler</label>
                                <select id="specificTravelerId" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                                    <option value="">Choose a traveler</option>
                                </select>
                            </div>

                            <!-- Specific Group Leader Selection (Hidden by default) -->
                            <div id="specificGroupLeaderSelect" class="form-group" style="display: none;">
                                <label style="font-weight: 600; color: var(--navy);">Select Group Leader</label>
                                <select id="specificGroupLeaderId" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                                    <option value="">Choose a group leader</option>
                                </select>
                            </div>

                            <!-- Vehicle Selection (Hidden by default) -->
                            <div id="vehicleSelect" class="form-group" style="display: none;">
                                <label style="font-weight: 600; color: var(--navy);">Select Vehicle</label>
                                <select id="vehicleId" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                                    <option value="">Choose a vehicle</option>
                                </select>
                            </div>

                            <!-- Announcement Message -->
                            <div class="form-group">
                                <label style="font-weight: 600; color: var(--navy); font-size: 1rem;">Announcement Message</label>
                                <textarea id="announcementMessage" rows="5" placeholder="Enter your announcement message here..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
                                <small style="color: #666;">Keep it clear and concise for better readability</small>
                            </div>

                            <!-- Display Type -->
                            <div class="form-group">
                                <label style="font-weight: 600; color: var(--navy); font-size: 1rem;">Display As</label>
                                <div style="display: flex; gap: 20px; margin-top: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="displayType" value="notification" checked style="width: 20px; height: 20px;">
                                        <span style="font-size: 1rem;">üîî Notification (Auto-dismiss)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="displayType" value="dialog" style="width: 20px; height: 20px;">
                                        <span style="font-size: 1rem;">üí¨ Dialog Box (Requires OK)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Timing Options -->
                            <div class="form-group">
                                <label style="font-weight: 600; color: var(--navy); font-size: 1rem;">Send Timing</label>
                                <div style="display: flex; gap: 20px; margin-top: 10px; margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="timingType" value="instant" checked onchange="handleTimingChange()" style="width: 20px; height: 20px;">
                                        <span style="font-size: 1rem;">‚ö° Send Instantly</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="timingType" value="time" onchange="handleTimingChange()" style="width: 20px; height: 20px;">
                                        <span style="font-size: 1rem;">‚è∞ Time-based</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="timingType" value="datetime" onchange="handleTimingChange()" style="width: 20px; height: 20px;">
                                        <span style="font-size: 1rem;">üìÖ Date & Time</span>
                                    </label>
                                </div>

                                <!-- Time Selection (Hidden by default) -->
                                <div id="timeSelect" style="display: none; margin-top: 15px;">
                                    <label style="color: #666; font-size: 0.9rem;">Select Time (24-hour format)</label>
                                    <input type="time" id="scheduledTime" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                                    <small style="color: #666;">Announcement will be sent daily at this time</small>
                                </div>

                                <!-- DateTime Selection (Hidden by default) -->
                                <div id="datetimeSelect" style="display: none; margin-top: 15px;">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                        <div>
                                            <label style="color: #666; font-size: 0.9rem;">Select Date</label>
                                            <input type="date" id="scheduledDate" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                                        </div>
                                        <div>
                                            <label style="color: #666; font-size: 0.9rem;">Select Time</label>
                                            <input type="time" id="scheduledDateTime" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                                        </div>
                                    </div>
                                    <small style="color: #666;">Announcement will be sent once at the specified date and time</small>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button class="submit-btn" onclick="sendAnnouncement()" style="flex: 1; padding: 15px 30px; font-size: 1.1rem; background: linear-gradient(135deg, #FF9933, #138808); border: none; border-radius: 8px;">
                                    üì§ Send Announcement
                                </button>
                                <button type="button" onclick="clearAnnouncementForm()" style="flex: 1; padding: 15px 30px; font-size: 1.1rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    üîÑ Clear Form
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Scheduled Announcements -->
                    <div class="data-table" style="margin-top: 30px;">
                        <div class="table-header">
                            <div class="table-title">Scheduled Announcements</div>
                            <button class="action-btn" onclick="refreshScheduledAnnouncements()" style="background: #2196f3; color: white; padding: 8px 15px; font-size: 1.2rem;" title="Refresh">üîÑ</button>
                        </div>
                        <div id="scheduledAnnouncementsList" style="padding: 20px;">
                            <!-- Scheduled announcements will be listed here -->
                        </div>
                    </div>

                    <!-- Announcement History -->
                    <div class="data-table" style="margin-top: 30px;">
                        <div class="table-header">
                            <div class="table-title">Announcement History</div>
                            <button class="action-btn" onclick="clearAnnouncementHistory()" style="background: #dc3545; color: white; padding: 8px 15px; font-size: 1.2rem;" title="Clear History">üóëÔ∏è</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Recipients</th>
                                    <th>Message</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="announcementHistoryTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #666;">No announcements sent yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="content-section">
                    <div class="section-header">Yatra Settings</div>
                    
                    <div class="data-table" style="margin-bottom: 30px;">
                        <div class="table-header">
                            <div class="table-title">Header Images</div>
                        </div>
                        <div style="padding: 40px;">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--navy); font-size: 1rem;">Desktop Header Image</label>
                                <div class="file-upload-area" onclick="document.getElementById('desktopHeader').click()" style="border: 2px dashed #FF9933; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; background: #fff8f0;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">üì∑</div>
                                    <div style="font-weight: 600; color: var(--navy);">Upload Desktop Header (Recommended: 1920x200px)</div>
                                </div>
                                <input type="file" id="desktopHeader" accept="image/*" onchange="uploadHeaderImage(event, 'desktop')" style="display: none;">
                            </div>

                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--navy); font-size: 1rem;">Mobile Header Image</label>
                                <div class="file-upload-area" onclick="document.getElementById('mobileHeader').click()" style="border: 2px dashed #FF9933; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; background: #fff8f0;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">üì±</div>
                                    <div style="font-weight: 600; color: var(--navy);">Upload Mobile Header (Recommended: 800x150px)</div>
                                </div>
                                <input type="file" id="mobileHeader" accept="image/*" onchange="uploadHeaderImage(event, 'mobile')" style="display: none;">
                            </div>

                            <div class="header-images-grid" id="headerImagesGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;"></div>
                            
                            <button class="submit-btn" onclick="saveHeaderImages()" style="padding: 12px 30px; font-size: 1.1rem; background: linear-gradient(135deg, #FF9933, #138808); border: none; border-radius: 8px; min-width: 200px;">
                                üíæ Save Header Images
                            </button>
                        </div>
                    </div>

                    <div class="data-table" style="margin-bottom: 30px;">
                        <div class="table-header">
                            <div class="table-title">Admin Profile</div>
                        </div>
                        <div style="padding: 30px;">
                            <div class="form-group">
                                <label>Admin Profile Photo</label>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <div id="adminProfilePreview" style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; border: 3px solid var(--saffron); background: var(--light-gray); display: flex; align-items: center; justify-content: center; font-size: 3rem;">
                                        üë§
                                    </div>
                                    <div>
                                        <div class="file-upload-area" onclick="document.getElementById('adminProfileImage').click()" style="padding: 15px;">
                                            <div>üì∑ Upload Profile Photo</div>
                                        </div>
                                        <input type="file" id="adminProfileImage" accept="image/*" style="display: none;" onchange="uploadAdminProfileImage(event)">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Admin Name</label>
                                <input type="text" id="adminName" value="Admin" placeholder="Enter admin name">
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="adminIncludeInContributors" checked>
                                    <span>Include Admin in Top Contributors</span>
                                </label>
                                <small style="color: #666;">If checked, admin's posts will count towards top contributors list</small>
                            </div>

                            <div class="form-group">
                                <label>Image Compression Quality</label>
                                <select id="imageCompressionQuality" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                                    <option value="0.95">Maximum Quality (95%) - Larger file size, best quality</option>
                                    <option value="0.85" selected>High Quality (85%) - Balanced, recommended</option>
                                    <option value="0.75">Good Quality (75%) - Smaller size, good quality</option>
                                    <option value="0.60">Medium Quality (60%) - Small size, acceptable quality</option>
                                    <option value="0.45">Low Quality (45%) - Smallest size, lower quality</option>
                                </select>
                                <small style="color: #666;">Choose compression quality for uploaded images. Higher quality = larger file size.</small>
                            </div>

                            <button class="submit-btn" onclick="saveAdminProfile()">Save Admin Profile</button>
                        </div>
                    </div>

                    <div class="data-table" style="margin-bottom: 30px;">
                        <div class="table-header">
                            <div class="table-title">üö® Emergency Contact</div>
                        </div>
                        <div style="padding: 40px;">
                            <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #ff9800;">
                                <div style="font-weight: 600; color: var(--navy); margin-bottom: 8px;">üìã Important Information</div>
                                <div style="color: #666; font-size: 0.95rem; line-height: 1.6;">
                                    This doctor contact will be displayed first in the Emergency section for all travelers. 
                                    It will also be used to find nearby medical facilities based on travelers' locations.
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--navy); font-size: 1rem;">Doctor Name</label>
                                <input type="text" id="emergencyDoctorName" placeholder="Dr. Rajesh Kumar" style="width: 100%; padding: 12px 15px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px;">
                            </div>

                            <div class="form-group" style="margin-bottom: 30px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--navy); font-size: 1rem;">Doctor Phone Number</label>
                                <input type="tel" id="emergencyDoctorPhone" placeholder="+91-9876543210" style="width: 100%; padding: 12px 15px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px;">
                                <small style="color: #666;">Include country code (e.g., +91 for India)</small>
                            </div>

                            <button class="submit-btn" onclick="saveEmergencyContact()" style="padding: 12px 30px; font-size: 1.1rem; background: linear-gradient(135deg, #dc3545, #ff6b6b); border: none; border-radius: 8px; min-width: 200px;">
                                üíæ Save Emergency Contact
                            </button>
                        </div>
                    </div>

                    <div class="data-table" style="margin-bottom: 30px;">
                        <div class="table-header">
                            <div class="table-title">Wake-Up Alarm</div>
                        </div>
                        <div style="padding: 40px;">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--navy); font-size: 1rem;">Alarm Time</label>
                                <input type="time" id="wakeUpTime" value="06:00" style="width: 100%; padding: 12px 15px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--navy); font-size: 1rem;">Alarm Message</label>
                                <textarea id="alarmMessage" rows="4" placeholder="Good morning! Time to wake up for today's journey..." style="width: 100%; padding: 12px 15px; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; resize: vertical; font-family: inherit;">Good morning travelers! üåÖ Time to wake up and prepare for today's journey!</textarea>
                            </div>

                            <div class="form-group" style="margin-bottom: 30px; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="alarmEnabled" style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <label for="alarmEnabled" style="font-weight: 600; color: var(--navy); font-size: 1rem; cursor: pointer; margin: 0;">Enable Daily Alarm</label>
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 3px;">Alarm will ring on all traveler devices at the set time</div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                                <button class="submit-btn" onclick="setWakeUpAlarm()" style="width: auto; min-width: 180px; padding: 12px 30px; font-size: 1.1rem; background: linear-gradient(135deg, #FF9933, #138808); border: none; border-radius: 8px;">
                                    Set Alarm
                                </button>
                                <button class="submit-btn" onclick="testAlarm()" style="width: auto; min-width: 180px; padding: 12px 30px; font-size: 1.1rem; background: var(--navy); border: none; border-radius: 8px;">
                                    Test Alarm Now
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">General Settings</div>
                        </div>
                        <div style="padding: 30px;">
                            <div class="form-group">
                                <label>Yatra Title</label>
                                <input type="text" id="yatraTitle" value="SPIRITUAL YATRA" placeholder="Enter yatra title">
                            </div>
                            
                            <div class="form-group">
                                <label>Starting Location</label>
                                <input type="text" id="startLocation" placeholder="Enter starting location">
                            </div>

                            <div class="form-group">
                                <label>Destination</label>
                                <input type="text" id="destination" placeholder="Enter destination">
                            </div>

                            <div class="form-group">
                                <label>Journey Start Date</label>
                                <input type="date" id="startDate">
                            </div>

                            <div class="form-group">
                                <label>Journey End Date</label>
                                <input type="date" id="endDate">
                            </div>

                            <div class="form-group">
                                <label>Top Contributors to Display</label>
                                <input type="number" id="topContributorsCount" value="5" min="1" max="20" placeholder="Number of top contributors to show">
                                <small style="color: #666;">Set how many top contributors to display on the website</small>
                            </div>

                            <button class="submit-btn" onclick="saveSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Traveler Modal -->
    <div id="travelerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="travelerModalTitle">Add New Traveler</span>
                <span class="close-modal" onclick="closeTravelerModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="travelerForm" onsubmit="console.log('üî¥ FORM SUBMIT EVENT FIRED!'); event.preventDefault(); event.stopPropagation(); return false;">
                    <input type="hidden" id="travelerId" value="">
                    
                    <!-- Profile Image -->
                    <div class="form-group">
                        <label>Profile Image</label>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div id="travelerImagePreview" style="width: 80px; height: 80px; border-radius: 50%; background: var(--light-saffron); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden;">
                                üë§
                            </div>
                            <div style="flex: 1;">
                                <input type="file" id="travelerImageInput" accept="image/*" onchange="handleTravelerImagePreview(event)" style="display: none;">
                                <button type="button" onclick="document.getElementById('travelerImageInput').click()" style="padding: 8px 15px; background: var(--saffron); color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Choose Image
                                </button>
                                <small style="display: block; color: #666; margin-top: 5px;">Upload profile photo (JPG, PNG)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Tirth ID -->
                    <div class="form-group">
                        <label>Tirth ID</label>
                        <input type="text" id="travelerTirthId" placeholder="Auto-generated or custom ID">
                    </div>

                    <!-- Name Fields -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="travelerFirstName" required placeholder="First name">
                        </div>
                        <div class="form-group">
                            <label>Middle Name</label>
                            <input type="text" id="travelerMiddleName" placeholder="Middle name (optional)">
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="travelerLastName" required placeholder="Last name">
                        </div>
                    </div>

                    <!-- Profile Line -->
                    <div class="form-group">
                        <label>Profile Line</label>
                        <input type="text" id="travelerProfileLine" placeholder="Short tagline or designation">
                        <small style="color: #666;">E.g., "Travel Enthusiast", "Photographer", etc.</small>
                    </div>

                    <!-- About Me -->
                    <div class="form-group">
                        <label>About Me</label>
                        <textarea id="travelerAboutMe" rows="3" placeholder="Brief introduction about yourself" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
                    </div>

                    <!-- Birth Date & Age -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Birth Date *</label>
                            <input type="date" id="travelerBirthDate" required onchange="calculateAge()">
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" id="travelerAge" readonly placeholder="Auto-calculated" style="background: #f5f5f5;">
                        </div>
                    </div>

                    <!-- Passport Details -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>Passport #</label>
                            <input type="text" id="travelerPassportNo" placeholder="Passport number">
                        </div>
                        <div class="form-group">
                            <label>Nationality</label>
                            <input type="text" id="travelerNationality" placeholder="Nationality">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>Passport Issue Date</label>
                            <input type="date" id="travelerPassportIssue">
                        </div>
                        <div class="form-group">
                            <label>Passport Expiry Date</label>
                            <input type="date" id="travelerPassportExpiry">
                        </div>
                    </div>

                    <!-- Contact Details -->
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="travelerEmail" required placeholder="Email address">
                    </div>
                    
                    <div class="form-group">
                        <label>Password *</label>
                        <div style="position: relative;">
                            <input type="password" id="travelerPassword" required placeholder="Login password" style="width: 100%; padding-right: 40px;">
                            <button type="button" onclick="togglePasswordVisibility('travelerPassword', this)" 
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                           background: none; border: none; cursor: pointer; font-size: 1.2rem; 
                                           color: #666; padding: 5px;" 
                                    title="Show/Hide Password">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" id="travelerPhone" required placeholder="+91-XXXXXXXXXX">
                    </div>

                    <!-- Location Details -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>City *</label>
                            <input type="text" id="travelerCity" required placeholder="City">
                        </div>
                        <div class="form-group">
                            <label>Country *</label>
                            <input type="text" id="travelerCountry" required placeholder="Country">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Center</label>
                        <input type="text" id="travelerCenter" placeholder="Center name">
                    </div>

                    <!-- Hoodi Size -->
                    <div class="form-group">
                        <label>Hoodi Size</label>
                        <select id="travelerHoodiSize">
                            <option value="">Select Size</option>
                            <option value="XS">XS</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                            <option value="XXL">XXL</option>
                            <option value="3XL">3XL</option>
                        </select>
                    </div>

                    <!-- Vehicle Assignment -->
                    <div class="form-group">
                        <label>Assign Vehicle</label>
                        <select id="travelerVehicleId" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%;">
                            <option value="">No vehicle assigned</option>
                        </select>
                        <small style="color: #666;">Select a vehicle to assign this traveler</small>
                    </div>

                    <!-- Health & Preferences -->
                    <div style="background: #ffe8e8; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1rem; color: var(--navy);">üè• Health & Preferences</h3>
                        
                        <div class="form-group">
                            <label>Health Issues (if any)</label>
                            <textarea id="travelerHealthIssues" rows="2" placeholder="Any health conditions or issues"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Allergies</label>
                            <textarea id="travelerAllergies" rows="2" placeholder="Food, medication, environmental allergies"></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group">
                                <label>Food Preference</label>
                                <select id="travelerFoodPreference">
                                    <option value="">Select preference</option>
                                    <option value="Vegetarian" selected>Vegetarian</option>
                                    <option value="Non-Vegetarian">Non-Vegetarian</option>
                                    <option value="Vegan">Vegan</option>
                                    <option value="Jain">Jain</option>
                                    <option value="No Onion/Garlic">No Onion/Garlic</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Blood Group</label>
                                <select id="travelerBloodGroup">
                                    <option value="">Select blood group</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="submit-btn" id="travelerSubmitBtn" onclick="console.log('üî¥ BUTTON CLICKED!'); if(typeof window.handleAddTraveler === 'function') { console.log('‚úÖ Function exists, calling it...'); window.handleAddTraveler(event); } else { console.error('‚ùå handleAddTraveler not found!'); alert('Error: Form handler not loaded. Please refresh the page.'); } return false;">Add Traveler</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Section Modal -->
    <div id="sectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Add New Section
                <span class="close-modal" onclick="closeSectionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="handleAddSection(event)">
                    <div class="form-group">
                        <label>Section Name</label>
                        <input type="text" id="sectionName" required placeholder="E.g., Temples, Food, Travel">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="sectionDescription" required placeholder="Brief description of this section"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Add Section</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="vehicleModalTitle">Add Vehicle</span>
                <span class="close-modal" onclick="closeVehicleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="handleVehicleSubmit(event)">
                    <input type="hidden" id="vehicleId">
                    
                    <div class="form-group">
                        <label>Vehicle Name *</label>
                        <input type="text" id="vehicleName" required placeholder="E.g., Bus 1, Van A">
                    </div>

                    <div class="form-group">
                        <label>Vehicle Type *</label>
                        <select id="vehicleType" required>
                            <option value="">Select Type</option>
                            <option value="Bus">Bus</option>
                            <option value="Mini Bus">Mini Bus</option>
                            <option value="Van">Van</option>
                            <option value="Car">Car</option>
                            <option value="Tempo">Tempo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Capacity (Seats) *</label>
                        <input type="number" id="vehicleCapacity" required placeholder="50" min="1">
                    </div>

                    <div class="form-group">
                        <label>Registration Number</label>
                        <input type="text" id="vehicleRegNo" placeholder="DL-01-AB-1234">
                    </div>

                    <div class="form-group">
                        <label>Group Leader (For Live Tracking) *</label>
                        <select id="vehicleGroupLeader" required>
                            <option value="">Select Group Leader</option>
                        </select>
                        <small style="color: #666;">Vehicle will be tracked using this group leader's live location</small>
                    </div>

                    <div class="form-group">
                        <label>Vehicle Color (For Map Icon)</label>
                        <input type="color" id="vehicleColor" value="#FF9933">
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="vehicleStatus">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="vehicleNotes" rows="3" placeholder="Any additional information about this vehicle"></textarea>
                    </div>

                    <button type="submit" class="submit-btn">Save Vehicle</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Check-In Report Modal -->
    <div id="checkInReportModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                Check-In Report
                <span class="close-modal" onclick="closeCheckInReportModal()">&times;</span>
            </div>
            <div class="modal-body" id="checkInReportContent"></div>
        </div>
    </div>

    <!-- Hotel Modal -->
    <div id="hotelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="hotelModalTitle">Add New Hotel / Utara</span>
                <span class="close-modal" onclick="closeHotelModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="handleAddHotel(event)">
                    <input type="hidden" id="hotelId" value="">
                    
                    <div class="form-group">
                        <label>Hotel / Utara Name *</label>
                        <input type="text" id="hotelName" required placeholder="Enter hotel name">
                    </div>
                    
                    <div class="form-group">
                        <label>Location / City *</label>
                        <input type="text" id="hotelLocation" required placeholder="Enter location">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>Total Floors *</label>
                            <input type="number" id="hotelFloors" required min="1" placeholder="Number of floors">
                        </div>
                        <div class="form-group">
                            <label>Total Rooms *</label>
                            <input type="number" id="hotelRooms" required min="1" placeholder="Number of rooms">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group">
                            <label>Check-In Date *</label>
                            <input type="date" id="hotelCheckIn" required>
                        </div>
                        <div class="form-group">
                            <label>Check-Out Date *</label>
                            <input type="date" id="hotelCheckOut" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="hotelAddress" rows="2" placeholder="Full address (optional)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Contact Number</label>
                        <input type="tel" id="hotelContact" placeholder="Contact number (optional)">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="hotelNotes" rows="2" placeholder="Additional notes (optional)"></textarea>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="hotelSubmitBtn">Add Hotel</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div id="postDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Post Details
                <span class="close-modal" onclick="closePostDetailModal()">&times;</span>
            </div>
            <div class="modal-body" id="postDetailContent"></div>
        </div>
    </div>

    <!-- Itinerary Modal -->
    <div id="itineraryModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span id="itineraryModalTitle">Add Itinerary Day</span>
                <span class="close-modal" onclick="closeItineraryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="handleItinerarySubmit(event)">
                    <input type="hidden" id="itineraryId">
                    <div class="form-group">
                        <label>Day Number</label>
                        <input type="number" id="itineraryDay" required placeholder="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="itineraryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Place Name</label>
                        <input type="text" id="itineraryPlace" required placeholder="E.g., BAPS Dadar Mandir">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="itineraryCity" required placeholder="E.g., Mumbai">
                    </div>
                    <div class="form-group">
                        <label>State/Province</label>
                        <input type="text" id="itineraryState" placeholder="E.g., Maharashtra">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" id="itineraryCountry" required placeholder="E.g., India">
                    </div>
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="itineraryLat" step="any" required placeholder="19.0176">
                        <small style="color: #666;">Get from Google Maps</small>
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="itineraryLng" step="any" required placeholder="72.8561">
                        <small style="color: #666;">Get from Google Maps</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="itineraryDescription" rows="3" placeholder="Brief description of the day's significance"></textarea>
                    </div>
                    
                    <!-- Enhanced Activities Section -->
                    <div class="form-group">
                        <label style="font-size: 1.1rem; font-weight: 600; color: var(--navy); margin-bottom: 15px;">Activities Breakdown</label>
                        <div id="itineraryActivitiesContainer" style="display: flex; flex-direction: column; gap: 20px;">
                            <!-- Activities will be added here -->
                        </div>
                        <button type="button" class="add-image-btn" onclick="addActivityField()" style="margin-top: 15px;">+ Add Activity</button>
                        <small style="color: #666; display: block; margin-top: 5px;">Add detailed activities with place, description, and images</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Location Images (Main)</label>
                        <div id="itineraryImagesContainer" class="images-container">
                            <!-- Image inputs will be added here -->
                        </div>
                        <button type="button" class="add-image-btn" onclick="addItineraryImageInput()">+ Add Image</button>
                        <small style="color: #666;">Primary images for this location (shown first in itinerary)</small>
                    </div>
                    <button type="submit" class="submit-btn">Save Itinerary Day</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Itinerary Excel Upload Modal -->
    <div id="itineraryExcelModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <span>üìä Bulk Upload Itinerary Excel</span>
                <span class="close-modal" onclick="closeItineraryExcelModal()">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <div id="excelUploadStep" style="text-align: center; padding: 40px;">
                    <h3 style="color: var(--navy); margin-bottom: 20px;">Upload Your Itinerary Excel File</h3>
                    <p style="color: #666; margin-bottom: 30px;">
                        Required columns: <strong>Day, Date, Time, Activity, Location</strong>
                    </p>
                    <input type="file" id="itineraryExcelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleItineraryExcelUpload(event)">
                    <button onclick="document.getElementById('itineraryExcelFile').click()" 
                        style="background: linear-gradient(135deg, var(--saffron), var(--green)); color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 1.1rem; cursor: pointer; font-weight: 600;">
                        üìÅ Choose Excel File
                    </button>
                    <div id="uploadProgress" style="margin-top: 20px; display: none;">
                        <div style="color: var(--saffron); font-size: 1.5rem;">‚è≥ Processing...</div>
                    </div>
                </div>
                
                <div id="excelPreviewStep" style="display: none;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong style="color: var(--green);">‚úÖ File processed successfully!</strong>
                        <p style="margin: 10px 0 0 0; color: #666;">Review and edit the data below before saving. Coordinates and countries have been auto-detected.</p>
                    </div>
                    
                    <div id="previewContainer" style="overflow-y: auto; max-height: 500px;"></div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
                        <button onclick="closeItineraryExcelModal()" style="padding: 12px 30px; background: #999; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button onclick="saveItineraryFromExcel()" style="padding: 12px 30px; background: linear-gradient(135deg, var(--saffron), var(--green)); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">üíæ Save Itinerary</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div id="tagModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Add New Tag
                <span class="close-modal" onclick="closeTagModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="handleAddTag(event)">
                    <div class="form-group">
                        <label>Tag Name</label>
                        <input type="text" id="tagName" required placeholder="E.g., Sunset, Temple, Festival">
                    </div>
                    <button type="submit" class="submit-btn">Add Tag</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Create Post Modal -->
    <div id="adminPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Share Your Journey</span>
                <span class="close-modal" onclick="closeAdminPostModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="handleAdminPostSubmit(event)">
                    <div class="form-group">
                        <label>Place Name</label>
                        <input type="text" id="adminPlaceName" required placeholder="E.g., Kashi Vishwanath Mandir">
                        <small style="color: #666;">Temple, shrine, or specific place name</small>
                    </div>
                    <div class="form-group">
                        <label>Location (City)</label>
                        <input type="text" id="adminLocationCity" required placeholder="E.g., Varanasi">
                        <small style="color: #666;">City or town name</small>
                    </div>
                    <div class="form-group">
                        <label>Section</label>
                        <select id="adminPostSection" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select Section</option>
                            <option value="temples">Temples & Sacred Sites</option>
                            <option value="experiences">Spiritual Experiences</option>
                            <option value="food">Food & Prasad</option>
                            <option value="travel">Travel Updates</option>
                            <option value="accommodation">Accommodation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload Photos & Videos</label>
                        <div style="padding: 30px; border: 2px dashed var(--saffron); border-radius: 10px; text-align: center; cursor: pointer; background: var(--light-gray);" onclick="document.getElementById('adminMediaInput').click()">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üì∏ üé•</div>
                            <div>Click to upload photos and videos</div>
                            <small>You can upload multiple photos and videos</small>
                        </div>
                        <input type="file" id="adminMediaInput" accept="image/*,video/*" multiple style="display: none;" onchange="handleAdminMediaUpload(event)">
                        <div id="adminMediaPreviewContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Tags (Optional)</label>
                        <div id="adminTagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                        <small style="color: #666;">Select tags that describe your post</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="adminPostDescription" required rows="4" placeholder="Share your thoughts and experiences..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Use Current Location</label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="adminUseCurrentLocation" checked>
                            <span>Auto-detect my location</span>
                        </label>
                    </div>
                    <button type="submit" class="submit-btn">Submit Post</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message"></div>

    <!-- Removed unused Cloudflare email decode script (caused 404 in local file) -->
    <script>
        // ==================== SECURITY & UTILITY FUNCTIONS ====================
        
        // XSS Protection - Sanitize all user input
        function escapeHTML(str) {
            if (!str && str !== 0) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        // Safe localStorage operations with error handling
        function safeGetFromStorage(key, defaultValue = []) {
            try {
                // Check if localStorage is available
                if (typeof localStorage === 'undefined' || localStorage === null) {
                    console.warn(`‚ö†Ô∏è localStorage not available. Using defaults for ${key}.`);
                    return defaultValue;
                }
                const data = localStorage.getItem(key);
                if (!data || data === 'undefined' || data === 'null') {
                    return defaultValue;
                }
                const parsed = JSON.parse(data);
                return parsed !== null ? parsed : defaultValue;
            } catch (error) {
                // Silently handle storage errors (common with tracking prevention)
                console.warn(`‚ö†Ô∏è Storage access blocked for ${key}. Using defaults.`, error.message);
                // Don't show message during initialization to avoid blocking login
                return defaultValue;
            }
        }

        function safeSetToStorage(key, value) {
            try {
                // Check if localStorage is available
                if (typeof localStorage === 'undefined' || localStorage === null) {
                    console.warn(`‚ö†Ô∏è localStorage not available. Cannot save ${key}.`);
                    return false;
                }
                const stringified = JSON.stringify(value);
                localStorage.setItem(key, stringified);
                return true;
            } catch (error) {
                // Silently handle storage errors (common with tracking prevention)
                console.warn(`‚ö†Ô∏è Storage access blocked. Cannot save ${key}.`, error.message);
                // Don't show error messages that might block functionality
                return false;
            }
        }

        // Input validation functions
        function validateEmail(email) {
            if (!email) return true; // Optional field
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function validatePhone(phone) {
            if (!phone) return true; // Optional field
            const regex = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{4,}$/;
            return regex.test(phone);
        }

        function validateRequired(value, fieldName) {
            if (!value || String(value).trim() === '') {
                showMessage(`${fieldName} is required`, 'error');
                return false;
            }
            return true;
        }

        function validateDateRange(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                showMessage('Invalid date format', 'error');
                return false;
            }
            
            if (end < start) {
                showMessage('End date must be after start date', 'error');
                return false;
            }
            
            return true;
        }

        function validateURL(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Storage monitoring
        function checkStorageUsage() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                    const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
                    const percentUsed = ((estimate.usage / estimate.quota) * 100).toFixed(1);
                    
                    if (percentUsed > 80) {
                        showMessage(`‚ö†Ô∏è Storage ${percentUsed}% full! Please backup your data.`, 'warning');
                    }
                    
                    if (percentUsed > 95) {
                        showMessage('üö® CRITICAL: Storage almost full! Export and clear data NOW.', 'error');
                    }
                }).catch(err => console.error('Storage estimate error:', err));
            }
        }

        // Image compression
        // compressImage function moved to unified implementation below (handles both Promise and callback patterns)

        // ==================== END SECURITY & UTILITY FUNCTIONS ====================

        // Toggle password visibility
        function togglePasswordVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';
                button.title = 'Hide Password';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';
                button.title = 'Show Password';
            }
        }

        // Data storage
        // Load travelers from API or localStorage
        let travelers = [];
        window.travelers = travelers; // Make it globally accessible
        
        // Load travelers asynchronously
        (async function() {
            if (typeof api !== 'undefined' && api.getTravelers) {
                try {
                    travelers = await api.getTravelers();
                    window.travelers = travelers; // Update global reference
                    console.log('üìä Loaded travelers from API:', travelers.length);
                    // Load table if travelers section is active
                    if (document.getElementById('travelers') && document.getElementById('travelers').classList.contains('active')) {
                        if (typeof loadTravelersTable === 'function') {
                            await loadTravelersTable();
                        }
                    }
                } catch (error) {
                    console.error('Error loading travelers from API:', error);
                    travelers = safeGetFromStorage('authorizedTravelers', []);
                    window.travelers = travelers; // Update global reference
                    console.log('üìä Loaded travelers from storage (fallback):', travelers.length);
                }
            } else {
                travelers = safeGetFromStorage('authorizedTravelers', []);
                window.travelers = travelers; // Update global reference
                console.log('üìä Loaded travelers from storage:', travelers.length);
            }
        })();
        
        // Initialize with comprehensive sample data (70 travelers) if empty
        // DISABLED: Only use real data from API/database
        if (false && (!travelers || travelers.length === 0)) {
            console.log('üîÑ Initializing sample travelers data...');
            const firstNames = ["Aarav", "Vivaan", "Aditya", "Vihaan", "Arjun", "Sai", "Arnav", "Ayaan", "Krishna", "Ishaan", "Shaurya", "Atharva", "Advik", "Pranav", "Reyansh", "Aadhya", "Ananya", "Pari", "Aanya", "Diya", "Avni", "Sara", "Myra", "Saanvi", "Shanaya", "Navya", "Kiara", "Riya", "Aarohi", "Tara", "Lakshmi", "Priya", "Kavya", "Meera", "Anjali", "Divya", "Sneha", "Pooja", "Neha", "Swati", "Rajesh", "Suresh", "Mahesh", "Ramesh", "Dinesh", "Mukesh", "Rakesh", "Yogesh", "Hitesh", "Jitesh", "Amit", "Rohit", "Sumit", "Lalit", "Ajit", "Ravi", "Kiran", "Vijay", "Sanjay", "Manoj", "Vinod", "Pramod", "Deepak", "Ashok", "Pankaj", "Sandeep", "Manish", "Vikas", "Sachin", "Nitin"];
            const lastNames = ["Sharma", "Verma", "Patel", "Kumar", "Singh", "Gupta", "Reddy", "Rao", "Nair", "Iyer", "Mehta", "Shah", "Joshi", "Desai", "Kulkarni", "Agarwal", "Chopra", "Malhotra", "Bhatia", "Kapoor", "Khanna", "Trivedi", "Pandey", "Mishra", "Tiwari", "Dubey", "Jain", "Bansal", "Saxena", "Arora"];
            const cities = ["Mumbai", "Delhi", "Bangalore", "Hyderabad", "Chennai", "Kolkata", "Pune", "Ahmedabad", "Jaipur", "Surat", "Lucknow", "Kanpur", "Nagpur", "Indore", "Thane", "Bhopal", "Visakhapatnam", "Pimpri", "Patna", "Vadodara", "Ghaziabad", "Ludhiana", "Agra", "Nashik", "Ranchi", "Varanasi", "Srinagar", "Aurangabad", "Dhanbad", "Amritsar", "Allahabad", "Gwalior", "Chandigarh", "Coimbatore", "Kochi", "Mysore", "Madurai", "Jodhpur", "Gurgaon", "Noida"];
            const profileLines = ["Travel Enthusiast", "Spiritual Seeker", "Adventure Lover", "Photography Enthusiast", "Culture Explorer", "Nature Admirer", "History Buff", "Peace Seeker", "Divine Journey Follower", "Temple Devotee", "Mountain Lover", "River Explorer", "Ancient Sites Researcher", "Meditation Practitioner", "Yoga Enthusiast", "Spiritual Writer", "Documentary Maker", "Heritage Preserver", "Pilgrim", "Sacred Sites Visitor"];
            const centers = ["Nairobi", "Mombasa", "Kisumu", "Nakuru", "Eldoret", "Thika", "Malindi", "Kitale"];
            const hoodiSizes = ["S", "M", "L", "XL", "XXL"];
            
            travelers = [];
            for (let i = 1; i <= 70; i++) {
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const name = `${firstName} ${lastName}`;
                const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${i}@yatra.com`;
                const city = cities[Math.floor(Math.random() * cities.length)];
                const age = 18 + Math.floor(Math.random() * 52); // 18-70 years
                const birthYear = 2025 - age;
                const profileLine = profileLines[Math.floor(Math.random() * profileLines.length)];
                const center = centers[Math.floor(Math.random() * centers.length)];
                const hoodiSize = hoodiSizes[Math.floor(Math.random() * hoodiSizes.length)];
                const vehicleId = i <= 23 ? 1 : (i <= 46 ? 2 : (i <= 69 ? 3 : null)); // Distribute across 3 vehicles
                
                travelers.push({
                    id: i,
                    tirthId: `TY${String(i).padStart(3, '0')}`,
                    firstName: firstName,
                    middleName: "",
                    lastName: lastName,
                    name: name,
                    profileLine: profileLine,
                    aboutMe: `Excited to join this spiritual journey and explore sacred places. ${profileLine}.`,
                    birthDate: `${birthYear}-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    age: String(age),
                    passportNo: `BK${918758 + i}`,
                    passportIssueDate: "2024-03-15",
                    passportExpiryDate: "2034-03-14",
                    nationality: "Indian",
                    email: email,
                    password: `pass${i}123`,
                    phone: `+91-${9800000000 + i}`,
                    city: city,
                    country: "India",
                    center: center,
                    hoodiSize: hoodiSize,
                    vehicleId: vehicleId,
                    gender: Math.random() > 0.5 ? "Male" : "Female",
                    image: ""
                });
            }
            
            // Save to localStorage (may fail if blocked, but data is in memory)
            safeSetToStorage('authorizedTravelers', travelers);
            console.log('‚úÖ Initialized with 70 sample travelers (in memory). Storage save:', safeSetToStorage('authorizedTravelers', travelers) ? 'success' : 'blocked');
        } else {
            console.log('‚úÖ Using existing travelers data:', travelers.length);
        }

        // Admin user profile
        let adminUser = {
            id: 999,
            name: "Admin",
            email: "admin@yatra.com",
            image: "",
            includeInContributors: true,
            imageCompressionQuality: 0.85
        };

        // Load admin profile from API (will be loaded when admin logs in or when settings section is shown)
        // Default values are already set above

        // Traveler profile images (synced with main website)
        let travelerProfiles = safeGetFromStorage('travelerProfiles', {});

        // Yatra Itinerary Data - Initialize as empty, will load from API
        let itinerary = [];

        // Load itinerary from API (real data only)
        async function initializeItinerary() {
            try {
                if (typeof api !== 'undefined' && api.getItinerary) {
                    itinerary = await api.getItinerary();
                    if (itinerary && itinerary.length > 0) {
                        // Restore Date objects
                        itinerary = itinerary.map(day => ({
                            ...day,
                            dateObj: day.dateObj ? new Date(day.dateObj) : (day.date ? new Date(day.date) : new Date())
                        }));
                        // Save to localStorage for caching
                        localStorage.setItem('itinerary', JSON.stringify(itinerary));
                        console.log('‚úÖ Loaded itinerary from API:', itinerary.length, 'days');
                    } else {
                        // No itinerary in database yet
                        itinerary = [];
                        localStorage.removeItem('itinerary'); // Clear any old test data
                        console.log('‚ÑπÔ∏è No itinerary data in database yet');
                    }
                } else {
                    // Fallback: try to load from localStorage (but don't use test data)
                    const savedItinerary = localStorage.getItem('itinerary');
                    if (savedItinerary) {
                        try {
                            const parsedItinerary = JSON.parse(savedItinerary);
                            // Only use if it looks like real data (has proper structure)
                            if (Array.isArray(parsedItinerary) && parsedItinerary.length > 0) {
                                itinerary = parsedItinerary.map(day => ({
                                    ...day,
                                    dateObj: day.dateObj ? new Date(day.dateObj) : (day.date ? new Date(day.date) : new Date())
                                }));
                                console.log('‚ö†Ô∏è Using cached itinerary (API not available)');
                            } else {
                                itinerary = [];
                                localStorage.removeItem('itinerary');
                            }
                        } catch (e) {
                            console.error('Error parsing saved itinerary:', e);
                            itinerary = [];
                            localStorage.removeItem('itinerary');
                        }
                    } else {
                        itinerary = [];
                    }
                }
            } catch (error) {
                console.error('Error loading itinerary:', error);
                itinerary = [];
                localStorage.removeItem('itinerary'); // Clear any corrupted data
            }
        }
        
        // Initialize itinerary on page load
        initializeItinerary();
        
        // Clear any old test data from localStorage on first load
        // Check if we have test data (old hardcoded itinerary with specific dates)
        const checkForTestData = () => {
            try {
                const savedItinerary = localStorage.getItem('itinerary');
                if (savedItinerary) {
                    const parsed = JSON.parse(savedItinerary);
                    // Check if it contains test data (Dec 2025 dates)
                    const hasTestData = parsed.some(day => 
                        day.date && (day.date.includes('Dec 2025') || day.date.includes('14 Dec') || day.date.includes('15 Dec'))
                    );
                    if (hasTestData) {
                        console.log('üßπ Clearing test data from localStorage...');
                        localStorage.removeItem('itinerary');
                        itinerary = [];
                    }
                }
            } catch (e) {
                // Ignore errors
            }
        };
        
        // Run check after a short delay to ensure it runs after initialization
        setTimeout(checkForTestData, 1000);

        // Sample posts for initialization
        const samplePosts = [
            // Day 1-2: Mumbai and departure preparations
            {
                id: 1, author: "Aarav Sharma", email: "aarav.sharma1@yatra.com", place: "BAPS Dadar Mandir", location: "Mumbai", lat: 19.0176, lng: 72.8561, section: "temples",
                description: "Beautiful kickoff to our yatra at BAPS Dadar Mandir. The architectural beauty and spiritual ambiance set the perfect tone for our journey ahead.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=800" }],
                tags: ['Temple', 'Mumbai', 'Prayer'], timestamp: new Date("2024-12-14T16:30:00"), approved: true
            },
            {
                id: 2, author: "Vivaan Verma", email: "vivaan.verma25@yatra.com", place: "Pre-Departure Satsang", location: "Mumbai", lat: 19.0176, lng: 72.8561, section: "events",
                description: "Inspiring satsang before our journey. Feeling blessed and excited for the adventures ahead with this wonderful group!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1548013146-72479768bada?w=800" }],
                tags: ['Satsang', 'Community', 'Inspiration'], timestamp: new Date("2024-12-14T20:00:00"), approved: true
            },
            {
                id: 3, author: "Aditya Patel", email: "aditya.patel50@yatra.com", place: "Mumbai Airport", location: "Mumbai", lat: 19.0896, lng: 72.8656, section: "travel",
                description: "Group photo at Mumbai airport! 70 excited travelers ready for Nepal. Adventure begins! üõ´",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800" }],
                tags: ['Travel', 'Airport', 'Group'], timestamp: new Date("2024-12-15T07:30:00"), approved: true
            },
            // Day 3: Biratnagar
            {
                id: 4, author: "Vihaan Kumar", email: "vihaan.kumar2@yatra.com", place: "Nepal Border Crossing", location: "Jogbani-Biratnagar", lat: 26.4525, lng: 87.2718, section: "travel",
                description: "Historic moment - crossing into Nepal! The border formalities went smoothly. Nepal, here we come! üá≥üáµ",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1583037189850-1921ae7c6c22?w=800" }],
                tags: ['Border', 'Nepal', 'International'], timestamp: new Date("2024-12-15T17:30:00"), approved: true
            },
            {
                id: 5, author: "Arjun Singh", email: "arjun.singh3@yatra.com", place: "Biratnagar City", location: "Biratnagar", lat: 26.4525, lng: 87.2718, section: "culture",
                description: "First evening in Nepal. The warm Nepali hospitality is overwhelming. Beautiful sunset over Biratnagar city.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1609137144813-7d9921338f24?w=800" }],
                tags: ['Sunset', 'Nepal', 'Culture'], timestamp: new Date("2024-12-15T18:45:00"), approved: true
            },
            // Day 4: Janakpur
            {
                id: 6, author: "Sai Gupta", email: "sai.gupta4@yatra.com", place: "Janaki Mandir", location: "Janakpur", lat: 26.7288, lng: 85.9266, section: "temples",
                description: "The magnificent Janaki Mandir! Birthplace of Goddess Sita. The temple architecture is stunning with intricate Mughal-Rajput style.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=800" }],
                tags: ['Temple', 'Janakpur', 'Heritage'], timestamp: new Date("2024-12-16T10:30:00"), approved: true
            },
            {
                id: 7, author: "Arnav Reddy", email: "arnav.reddy5@yatra.com", place: "Janakpur Dham", location: "Janakpur", lat: 26.7288, lng: 85.9266, section: "temples",
                description: "Incredible spiritual energy in Janakpur Dham. The evening aarti was mesmerizing. Feeling deeply blessed.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1609137144813-7d9921338f24?w=800" }],
                tags: ['Aarti', 'Spirituality', 'Blessing'], timestamp: new Date("2024-12-16T19:00:00"), approved: true
            },
            // Day 5: Chitwan
            {
                id: 8, author: "Ayaan Rao", email: "ayaan.rao6@yatra.com", place: "Chitwan National Park", location: "Chitwan", lat: 27.5291, lng: 84.3542, section: "nature",
                description: "Amazing elephant safari in Chitwan! Spotted rhinos, deer, and countless bird species. Nature at its finest! üêò",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1564760055775-d63b17a55c44?w=800" }],
                tags: ['Wildlife', 'Safari', 'Nature'], timestamp: new Date("2024-12-17T09:00:00"), approved: true
            },
            {
                id: 9, author: "Krishna Nair", email: "krishna.nair7@yatra.com", place: "Rapti River Sunset", location: "Chitwan", lat: 27.5291, lng: 84.3542, section: "nature",
                description: "Breathtaking sunset by the Rapti River. The reflection of the sky in the water was magical. Perfect end to wildlife day!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800" }],
                tags: ['Sunset', 'River', 'Photography'], timestamp: new Date("2024-12-17T18:30:00"), approved: true
            },
            // Day 6: Kathmandu arrival
            {
                id: 10, author: "Ishaan Iyer", email: "ishaan.iyer8@yatra.com", place: "Kathmandu Valley View", location: "Kathmandu", lat: 27.7172, lng: 85.3240, section: "scenic",
                description: "First glimpse of Kathmandu valley from the hills. The entire city spread below surrounded by mountains. Spectacular!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1571898223382-a7458302a2ea?w=800" }],
                tags: ['Valley', 'Mountains', 'View'], timestamp: new Date("2024-12-18T15:00:00"), approved: true
            },
            {
                id: 11, author: "Shaurya Mehta", email: "shaurya.mehta9@yatra.com", place: "Thamel Market", location: "Kathmandu", lat: 27.7172, lng: 85.3240, section: "culture",
                description: "Evening walk through vibrant Thamel market. Colorful prayer flags, handicrafts, and delicious momos! Shopping paradise!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1605640840605-14ac1855827b?w=800" }],
                tags: ['Market', 'Shopping', 'Culture'], timestamp: new Date("2024-12-18T19:30:00"), approved: true
            },
            // Day 7: Kathmandu sightseeing
            {
                id: 12, author: "Atharva Shah", email: "atharva.shah10@yatra.com", place: "Swayambhunath Stupa", location: "Kathmandu", lat: 27.7149, lng: 85.2903, section: "temples",
                description: "Monkey Temple! Ancient Buddhist stupa with panoramic Kathmandu views. The eyes of Buddha watching over the valley. üêí",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1605640840604-3e5aaaac88b7?w=800" }],
                tags: ['Stupa', 'Buddhist', 'Heritage'], timestamp: new Date("2024-12-19T10:00:00"), approved: true
            },
            {
                id: 13, author: "Advik Joshi", email: "advik.joshi11@yatra.com", place: "Boudhanath Stupa", location: "Kathmandu", lat: 27.7215, lng: 85.3622, section: "temples",
                description: "Massive Boudhanath Stupa! One of the largest Buddhist stupas in the world. Prayer wheels, incense, and peaceful monks.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1626621341580-356d0cb9c9f9?w=800" }],
                tags: ['Buddhist', 'UNESCO', 'Peace'], timestamp: new Date("2024-12-19T14:30:00"), approved: true
            },
            {
                id: 14, author: "Pranav Desai", email: "pranav.desai12@yatra.com", place: "Durbar Square", location: "Kathmandu", lat: 27.7047, lng: 85.3070, section: "heritage",
                description: "Ancient Durbar Square with royal palaces and temples. UNESCO World Heritage Site showcasing Newari architecture.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1605640840605-14ac1855827b?w=800" }],
                tags: ['Heritage', 'Palace', 'Architecture'], timestamp: new Date("2024-12-19T16:00:00"), approved: true
            },
            // Day 8: Pashupatinath
            {
                id: 15, author: "Reyansh Kulkarni", email: "reyansh.kulkarni13@yatra.com", place: "Pashupatinath Temple", location: "Kathmandu", lat: 27.7104, lng: 85.3489, section: "temples",
                description: "Sacred Pashupatinath Jyotirlingam darshan! One of the most important Shiva temples. Deeply moving spiritual experience. üïâÔ∏è",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1626621341517-bbf3d9990a23?w=800" }],
                tags: ['Jyotirlingam', 'Shiva', 'Sacred'], timestamp: new Date("2024-12-20T06:00:00"), approved: true
            },
            {
                id: 16, author: "Aadhya Agarwal", email: "aadhya.agarwal14@yatra.com", place: "Bagmati River Ghats", location: "Kathmandu", lat: 27.7104, lng: 85.3489, section: "culture",
                description: "Morning rituals at Bagmati River ghats near Pashupatinath. Witnessing ancient traditions and ceremonies.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1548013146-72479768bada?w=800" }],
                tags: ['Ritual', 'River', 'Tradition'], timestamp: new Date("2024-12-20T07:30:00"), approved: true
            },
            // Day 9: Pokhara
            {
                id: 17, author: "Ananya Chopra", email: "ananya.chopra15@yatra.com", place: "Phewa Lake", location: "Pokhara", lat: 28.2096, lng: 83.9856, section: "nature",
                description: "Serene Phewa Lake with Annapurna range reflection! Rented a boat for sunrise - absolutely magical experience! üö£",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1605640635484-f969f2f7f6c7?w=800" }],
                tags: ['Lake', 'Annapurna', 'Sunrise'], timestamp: new Date("2024-12-21T06:30:00"), approved: true
            },
            {
                id: 18, author: "Pari Malhotra", email: "pari.malhotra16@yatra.com", place: "World Peace Pagoda", location: "Pokhara", lat: 28.2096, lng: 83.9856, section: "temples",
                description: "Hiked to World Peace Pagoda. Panoramic views of Pokhara valley, Phewa Lake, and Himalayan peaks. Worth every step!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1605640635484-f969f2f7f6c7?w=800" }],
                tags: ['Pagoda', 'Peace', 'Himalaya'], timestamp: new Date("2024-12-21T16:00:00"), approved: true
            },
            {
                id: 19, author: "Aanya Bhatia", email: "aanya.bhatia17@yatra.com", place: "Evening Satsang Pokhara", location: "Pokhara", lat: 28.2096, lng: 83.9856, section: "events",
                description: "Beautiful group satsang by the lake. The unity and devotion of our group is inspiring. Blessed to be part of this journey!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1548013146-72479768bada?w=800" }],
                tags: ['Satsang', 'Community', 'Evening'], timestamp: new Date("2024-12-21T19:00:00"), approved: true
            },
            // Day 10: Journey to Muktinath
            {
                id: 20, author: "Diya Kapoor", email: "diya.kapoor18@yatra.com", place: "Jomsom", location: "Mustang", lat: 28.7806, lng: 83.7230, section: "travel",
                description: "Incredible mountain road to Jomsom! Hairpin bends with stunning valley views. Adventure of a lifetime! üèîÔ∏è",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800" }],
                tags: ['Mountains', 'Road', 'Adventure'], timestamp: new Date("2024-12-22T11:00:00"), approved: true
            },
            {
                id: 21, author: "Avni Khanna", email: "avni.khanna19@yatra.com", place: "Kagbeni Village", location: "Mustang", lat: 28.8384, lng: 83.7951, section: "culture",
                description: "Ancient Kagbeni village at the gateway to Upper Mustang. Tibetan Buddhist culture, prayer wheels, and mountain hospitality.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1626621341580-356d0cb9c9f9?w=800" }],
                tags: ['Village', 'Tibetan', 'Culture'], timestamp: new Date("2024-12-22T13:30:00"), approved: true
            },
            {
                id: 22, author: "Sara Trivedi", email: "sara.trivedi20@yatra.com", place: "Muktinath Temple", location: "Mustang", lat: 28.8170, lng: 83.8717, section: "temples",
                description: "Finally reached Muktinath! Sacred temple of Lord Vishnu. Bathing under 108 water spouts - spiritual cleansing. üôè",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1626621341517-bbf3d9990a23?w=800" }],
                tags: ['Muktinath', 'Sacred', 'Vishnu'], timestamp: new Date("2024-12-22T16:30:00"), approved: true
            },
            {
                id: 23, author: "Myra Pandey", email: "myra.pandey21@yatra.com", place: "Muktinath Evening Aarti", location: "Mustang", lat: 28.8170, lng: 83.8717, section: "temples",
                description: "Evening aarti at Muktinath in freezing cold but warm hearts. The flame that burns eternally from natural gas and water.",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=800" }],
                tags: ['Aarti', 'Evening', 'Eternal'], timestamp: new Date("2024-12-22T18:00:00"), approved: true
            },
            // Day 11: Morning at Muktinath
            {
                id: 24, author: "Saanvi Mishra", email: "saanvi.mishra22@yatra.com", place: "Sunrise at Muktinath", location: "Mustang", lat: 28.8170, lng: 83.8717, section: "scenic",
                description: "Magical sunrise at 3,710m altitude! Snow-capped peaks glowing golden. Coldest morning but warmest spiritual experience!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800" }],
                tags: ['Sunrise', 'Mountains', 'Sacred'], timestamp: new Date("2024-12-23T05:30:00"), approved: true
            },
            {
                id: 25, author: "Shanaya Tiwari", email: "shanaya.tiwari23@yatra.com", place: "Muktinath to Tatopani", location: "Mustang-Pokhara", lat: 28.5, lng: 83.7, section: "travel",
                description: "Long journey back from Muktinath. Stopped at natural hot springs in Tatopani - perfect relief after mountain cold! ‚ô®Ô∏è",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1564760055775-d63b17a55c44?w=800" }],
                tags: ['HotSprings', 'Tatopani', 'Relax'], timestamp: new Date("2024-12-23T14:00:00"), approved: true
            },
            // Additional cultural and scenic posts
            {
                id: 26, author: "Navya Dubey", email: "navya.dubey24@yatra.com", place: "Nepali Cuisine Experience", location: "Pokhara", lat: 28.2096, lng: 83.9856, section: "food",
                description: "Delicious dal bhat tarkari! Traditional Nepali thali with unlimited refills. The local cuisine has been amazing throughout! üçõ",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1609137144813-7d9921338f24?w=800" }],
                tags: ['Food', 'Nepali', 'Cuisine'], timestamp: new Date("2024-12-23T19:00:00"), approved: true
            },
            {
                id: 27, author: "Kiara Jain", email: "kiara.jain25@yatra.com", place: "Group Bond Moments", location: "Pokhara", lat: 28.2096, lng: 83.9856, section: "memories",
                description: "Our group of 70 has become family! Late night chats, singing, and sharing stories. These bonds will last forever! ‚ù§Ô∏è",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1548013146-72479768bada?w=800" }],
                tags: ['Friendship', 'Group', 'Memories'], timestamp: new Date("2024-12-23T21:00:00"), approved: true
            },
            {
                id: 28, author: "Riya Bansal", email: "riya.bansal26@yatra.com", place: "Traditional Dance Performance", location: "Kathmandu", lat: 27.7172, lng: 85.3240, section: "culture",
                description: "Witnessed traditional Newari dance performance. The colorful costumes and rhythmic music were captivating!",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1605640840605-14ac1855827b?w=800" }],
                tags: ['Dance', 'Culture', 'Performance'], timestamp: new Date("2024-12-19T20:00:00"), approved: true
            },
            {
                id: 29, author: "Aarohi Saxena", email: "aarohi.saxena27@yatra.com", place: "Himalayan Wildlife", location: "Chitwan", lat: 27.5291, lng: 84.3542, section: "nature",
                description: "Spotted one-horned rhino family! Baby rhino playing with mother. Such majestic creatures in their natural habitat! ü¶è",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1564760055775-d63b17a55c44?w=800" }],
                tags: ['Wildlife', 'Rhino', 'Conservation'], timestamp: new Date("2024-12-17T11:30:00"), approved: true
            },
            {
                id: 30, author: "Tara Arora", email: "tara.arora28@yatra.com", place: "Prayer Flag Mountain", location: "Pokhara", lat: 28.2096, lng: 83.9856, section: "spiritual",
                description: "Thousands of colorful prayer flags fluttering in the wind. Each flag carries prayers to heaven. So peaceful! üôè",
                media: [{ type: 'image', url: "https://images.unsplash.com/photo-1626621341580-356d0cb9c9f9?w=800" }],
                tags: ['PrayerFlags', 'Spiritual', 'Peace'], timestamp: new Date("2024-12-21T15:00:00"), approved: true
            }
        ];

        // Load posts from localStorage or use sample posts
        let posts = safeGetFromStorage('posts', []);
        console.log('üìä Loaded posts from storage:', posts.length);
        
        // Initialize with sample posts if empty (first time load)
        // DISABLED: Only use real data from API/database
        if (false && (!posts || posts.length === 0)) {
            console.log('üîÑ Initializing sample posts data...');
            posts = [...samplePosts];
            safeSetToStorage('posts', posts);
            console.log('‚úÖ Admin: Initialized with sample posts (in memory). Storage save:', safeSetToStorage('posts', posts) ? 'success' : 'blocked');
        } else {
            console.log('‚úÖ Using existing posts data:', posts.length);
        }

        // Load vehicles from localStorage or use default
        let vehicles = safeGetFromStorage('vehicles', []);
        console.log('üìä Loaded vehicles from storage:', vehicles.length);

        // Cache for day-wise vehicle allotments pulled from backend
        let vehicleAllotmentsByDate = {};
        window.vehicleAllotmentsByDate = vehicleAllotmentsByDate;
        
        // Add sample vehicles if none exist (3 vehicles for 70 travelers)
        // DISABLED: Only use real data from API/database
        if (false && (!vehicles || vehicles.length === 0)) {
            console.log('üîÑ Initializing sample vehicles data...');
            vehicles = [
                {
                    id: 1,
                    name: "Luxury Coach Alpha",
                    type: "Luxury Bus",
                    capacity: 25,
                    regNo: "KA-01-YT-2024",
                    groupLeaderEmail: "aarav.sharma1@yatra.com",
                    groupLeaderName: "Aarav Sharma",
                    color: "#FF9933",
                    status: "Active",
                    notes: "Premium luxury coach with reclining seats, AC, entertainment system",
                    driver: "Rajesh Kumar",
                    driverPhone: "+91-9800001111",
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    name: "Comfort Express Beta",
                    type: "Deluxe Bus",
                    capacity: 25,
                    regNo: "KA-02-YT-2024",
                    groupLeaderEmail: "vivaan.verma25@yatra.com",
                    groupLeaderName: "Vivaan Verma",
                    color: "#138808",
                    status: "Active",
                    notes: "Deluxe bus with comfortable seating, AC, music system",
                    driver: "Suresh Patel",
                    driverPhone: "+91-9800002222",
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    name: "Swift Journey Gamma",
                    type: "Tourist Bus",
                    capacity: 25,
                    regNo: "KA-03-YT-2024",
                    groupLeaderEmail: "aditya.patel50@yatra.com",
                    groupLeaderName: "Aditya Patel",
                    color: "#000080",
                    status: "Active",
                    notes: "Standard tourist bus with AC, spacious luggage area",
                    driver: "Mahesh Singh",
                    driverPhone: "+91-9800003333",
                    createdAt: new Date().toISOString()
                }
            ];
            safeSetToStorage('vehicles', vehicles);
            console.log('‚úÖ Initialized with 3 sample vehicles (in memory). Storage save:', safeSetToStorage('vehicles', vehicles) ? 'success' : 'blocked');
        } else {
            console.log('‚úÖ Using existing vehicles data:', vehicles.length);
        }
        
        // Check-in data structure
        let checkInData = safeGetFromStorage('checkInData', {});
        // Format: { vehicleId: { active: true/false, checkedIn: [email1, email2], timestamp: Date } }

        // Room Pairs - Initialize as empty array, will load from API
        let roomPairs = [];
        window.roomPairs = roomPairs; // Make globally accessible
        
        // Load room pairs from API on startup
        (async function() {
            // Wait a bit for API to be available
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (typeof api !== 'undefined' && api.getRoomPairs) {
                try {
                    console.log('üîÑ Loading room pairs on startup...');
                    roomPairs = await api.getRoomPairs();
                    window.roomPairs = roomPairs;
                    console.log('üìä Loaded room pairs from API on startup:', roomPairs.length);
                    if (roomPairs.length > 0) {
                        console.log('üìä Sample pair:', roomPairs[0]);
                    }
                    
                    // If roomPairs section is already visible, load the table
                    setTimeout(() => {
                        const roomPairsSection = document.getElementById('roomPairs');
                        if (roomPairsSection && roomPairsSection.classList.contains('active')) {
                            console.log('üîÑ Room pairs section is active - calling loadPairs()...');
                            if (typeof window.loadPairs === 'function') {
                                window.loadPairs();
                            }
                        }
                    }, 1000);
                } catch (error) {
                    console.error('‚ùå Error loading room pairs from API on startup:', error);
                    roomPairs = [];
                    window.roomPairs = [];
                }
            } else {
                console.warn('‚ö†Ô∏è API not available on startup for room pairs');
            }
        })();
        
        // NOTE: loadPairs function is already defined early (line ~1422)
        // No need to redefine it here - it's already available globally
        console.log('‚úÖ loadPairs function already defined early - skipping duplicate definition');
        
        // Auto-load pairs when section becomes visible (MutationObserver + Periodic Check)
        (function() {
            let lastCheck = 0;
            const checkAndLoad = () => {
                const roomPairsSection = document.getElementById('roomPairs');
                if (!roomPairsSection) return;
                
                const isActive = roomPairsSection.classList.contains('active');
                const tbody = document.getElementById('pairsTable');
                const isEmpty = !tbody || tbody.children.length === 0 || 
                              (tbody.children.length === 1 && 
                               (tbody.children[0].textContent.includes('No room pairs') || 
                                tbody.children[0].textContent.includes('created yet')));
                
                if (isActive && isEmpty && typeof loadPairs === 'function') {
                    const now = Date.now();
                    // Only load once per 2 seconds to avoid spam
                    if (now - lastCheck > 2000) {
                        console.log('üëÅÔ∏è Room pairs section is visible and empty - auto-loading pairs...');
                        lastCheck = now;
                        setTimeout(() => loadPairs(), 100);
                    }
                }
            };
            
            // Set up MutationObserver
            const roomPairsSection = document.getElementById('roomPairs');
            if (roomPairsSection) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            checkAndLoad();
                        }
                    });
                });
                
                observer.observe(roomPairsSection, {
                    attributes: true,
                    attributeFilter: ['class']
                });
                console.log('üëÅÔ∏è MutationObserver set up for roomPairs section');
            }
            
            // Also check periodically (every 1 second) as backup
            setInterval(checkAndLoad, 1000);
            console.log('üëÅÔ∏è Periodic checker set up for roomPairs section');
            
            // Initial check after DOM is ready
            setTimeout(checkAndLoad, 2000);
        })();
        
        // Edit pair function
        function editPair(pairId) {
            window.openPairModal(pairId);
        }
        window.editPair = editPair;
        
        // Delete pair function  
        async function deletePair(pairId) {
            if (!confirm('Are you sure you want to delete this room pair?')) {
                return;
            }
            
            try {
                if (typeof api !== 'undefined' && api.deleteRoomPair) {
                    await api.deleteRoomPair(pairId);
                    if (api.clearCacheFor) {
                        api.clearCacheFor('/room-pairs');
                    }
                    showMessage('‚úÖ Room pair deleted successfully');
                    loadPairs();
                } else {
                    showMessage('API not available', 'error');
                }
            } catch (error) {
                console.error('Error deleting room pair:', error);
                showMessage('Error deleting room pair', 'error');
            }
        }
        window.deletePair = deletePair;

        let sections = [];

        // Load sections from API (MySQL backend)
        async function loadSectionsFromAPI() {
            try {
                if (typeof api !== 'undefined' && api.getSections) {
                    sections = await api.getSections();
                    console.log('‚úÖ Loaded sections from API:', sections.length);
                    return sections;
                } else {
                    console.warn('API not available, using empty sections array');
                    return [];
                }
            } catch (error) {
                console.error('Error loading sections from API:', error);
                // Continue with empty array if API fails
                return [];
            }
        }
        
        // Load sections when page loads (if API is available)
        if (typeof window !== 'undefined') {
            // Load sections after API is ready
            window.addEventListener('load', async () => {
                if (typeof api !== 'undefined' && api.getSections) {
                    await loadSectionsFromAPI();
                }
            });
        }

        let tags = ['Temple', 'Food', 'Nature', 'Culture', 'Festival', 'Sunrise', 'Sunset', 'Prayer', 'Meditation', 'Architecture', 'People', 'Journey'];

        // Load tags from localStorage
        const savedTags = localStorage.getItem('tags');
        if (savedTags) {
            tags = JSON.parse(savedTags);
        }

        let headerImages = {
            desktop: null,
            mobile: null
        };

        // Default settings (used as fallback if API fails)
        const defaultSettings = {
            yatraTitle: "SPIRITUAL NEPAL YATRA 2025",
            startLocation: "Mumbai, India",
            destination: "Muktinath, Nepal",
            startDate: "2025-12-14",
            endDate: "2025-12-24",
            topContributorsCount: 10,
            emergencyDoctorName: "Dr. Rajesh Kumar",
            emergencyDoctorPhone: "+91-9876543210",
            wakeUpTime: "06:00",
            alarmMessage: "Good morning travelers! üåÖ Time to wake up and prepare for today's sacred journey. Jay Swaminarayan!",
            alarmEnabled: true
        };
        
        let settings = { ...defaultSettings };
        
        // Load settings from API on page load
        (async () => {
            try {
                const apiSettings = await api.getSettings();
                if (apiSettings && Object.keys(apiSettings).length > 0) {
                    settings = { ...defaultSettings, ...apiSettings };
                }
            } catch (error) {
                console.warn('Could not load settings from API, using defaults:', error);
            }
        })();
        
        // Global form submit prevention for traveler form
        document.addEventListener('DOMContentLoaded', function() {
            // Clear cached sample data if it exists (to force fresh API data)
            (function clearSampleDataCache() {
                try {
                    const cachedTravelers = localStorage.getItem('authorizedTravelers');
                    const cachedPosts = localStorage.getItem('posts');
                    
                    // If we have cached data with sample-like patterns, clear it
                    if (cachedTravelers) {
                        try {
                            const travelers = JSON.parse(cachedTravelers);
                            // If we have 70 travelers (sample data count), clear it
                            if (travelers.length === 70) {
                                console.log('üóëÔ∏è Clearing cached sample travelers data (70 travelers detected)');
                                localStorage.removeItem('authorizedTravelers');
                            }
                        } catch (e) {}
                    }
                    
                    if (cachedPosts) {
                        try {
                            const posts = JSON.parse(cachedPosts);
                            // If we have 30 posts (sample data count), clear it
                            if (posts.length === 30) {
                                console.log('üóëÔ∏è Clearing cached sample posts data (30 posts detected)');
                                localStorage.removeItem('posts');
                            }
                        } catch (e) {}
                    }
                } catch (error) {
                    console.warn('Error clearing cache:', error);
                }
            })();
            
            // Check API connection on startup (for localhost)
            (async function checkAPIConnection() {
                try {
                    console.log('üîç Checking backend API connection...');
                    console.log('   Expected URL: http://localhost:3000/api');
                    
                    // Try to fetch travelers endpoint as a health check
                    if (typeof api !== 'undefined' && api.getTravelers) {
                        try {
                            await api.getTravelers();
                            console.log('‚úÖ Backend API is connected and working!');
                            console.log('   Server: http://localhost:3000');
                        } catch (apiError) {
                            if (apiError.message && apiError.message.includes('Failed to fetch')) {
                                console.error('‚ùå Cannot connect to backend API!');
                                console.error('   URL: http://localhost:3000/api');
                                console.error('   Error: Network request failed');
                                console.error('');
                                console.error('üìã To fix this:');
                                console.error('   1. Make sure your backend server is running');
                                console.error('   2. Run: npm start (in your backend directory)');
                                console.error('   3. Check that the server is on http://localhost:3000');
                                console.error('   4. Verify MySQL is running and connected');
                                
                                // Show user-friendly message
                                setTimeout(() => {
                                    const dashboard = document.getElementById('dashboard');
                                    if (dashboard && dashboard.classList.contains('active')) {
                                        if (typeof showMessage === 'function') {
                                            showMessage('‚ö†Ô∏è Cannot connect to backend API. Please start your server (npm start)', 'error');
                                        }
                                    }
                                }, 2000);
                            } else {
                                console.log('‚úÖ Backend API is reachable (connection OK)');
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è API object not fully loaded yet');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not check API connection:', error.message);
                }
            })();
            
            // Prevent ALL form submissions from causing page reloads
            document.addEventListener('submit', function(e) {
                const form = e.target;
                if (form && form.id === 'travelerForm') {
                    console.log('üõë Global form submit handler: Preventing default for travelerForm');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    // Call handleAddTraveler manually
                    if (typeof handleAddTraveler === 'function') {
                        handleAddTraveler(e);
                    }
                    return false;
                }
            }, true); // Use capture phase
            
            // Restore login state from sessionStorage (survives page refresh)
            // Check if early script already validated session
            const sessionValidFromEarly = window._sessionValid === true;
            const activeSectionFromEarly = window._activeSection;
            
            try {
                const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
                const loginTime = sessionStorage.getItem('adminLoginTime');
                const activeSection = activeSectionFromEarly || sessionStorage.getItem('activeSection') || 'overview';
                
                // Check if session is still valid (24 hours)
                const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours
                const isValidSession = loginTime && (Date.now() - parseInt(loginTime)) < SESSION_DURATION;
                
                console.log('üîç Session check:', { isLoggedIn, isValidSession, sessionValidFromEarly, activeSection });
                
                if ((isLoggedIn && isValidSession) || sessionValidFromEarly) {
                    console.log('‚úÖ Restoring login state from sessionStorage...');
                    console.log('  - Active section to restore:', activeSection);
                    
                    const loginPage = document.getElementById('loginPage');
                    const dashboard = document.getElementById('dashboard');
                    
                    // Hide login page and show dashboard
                    if (loginPage) {
                        loginPage.style.display = 'none';
                        console.log('  ‚úÖ Login page hidden');
                    }
                    if (dashboard) {
                        dashboard.classList.add('active');
                        dashboard.style.display = 'block';
                        console.log('  ‚úÖ Dashboard activated');
                    }
                    
                    // Set admin name
                    const adminName = document.getElementById('adminName');
                    if (adminName) adminName.textContent = 'Admin';
                    
                    // Restore active section
                    if (activeSection && typeof showSection === 'function') {
                        setTimeout(() => {
                            showSection(activeSection);
                            console.log(`‚úÖ Restored active section: ${activeSection}`);
                            
                            // If restoring to travelers section, load the table
                            if (activeSection === 'travelers' && typeof loadTravelersTable === 'function') {
                                setTimeout(() => {
                                    console.log('üîÑ Loading travelers table after section restore...');
                                    loadTravelersTable();
                                }, 200);
                            }
                            
                            // If restoring to roomPairs section, load the table
                            if (activeSection === 'roomPairs' && typeof loadPairs === 'function') {
                                setTimeout(() => {
                                    console.log('üîÑ Loading room pairs table after section restore...');
                                    loadPairs();
                                }, 300);
                            }
                        }, 100);
                    }
                    
                    // Update dashboard (load data first, then update)
                    if (typeof updateDashboard === 'function') {
                        // Call updateDashboard which will load data from API if needed
                        updateDashboard().catch(err => {
                            console.error('Error updating dashboard:', err);
                        });
                    }
                    
                    // Always load travelers table when logged in (for dashboard stats)
                    if (typeof loadTravelersTable === 'function') {
                        setTimeout(() => {
                            loadTravelersTable();
                        }, 500);
                    }
                    
                    console.log('‚úÖ Login state restored successfully');
                } else {
                    // Session expired or invalid
                    if (loginTime) {
                        sessionStorage.removeItem('adminLoggedIn');
                        sessionStorage.removeItem('adminLoginTime');
                        sessionStorage.removeItem('activeSection');
                        console.log('‚ö†Ô∏è Session expired, please login again');
                    }
                }
            } catch (e) {
                console.warn('Could not restore login state:', e);
            }
            
            // Verify login state periodically to keep it in sync
            setInterval(verifyLoginState, 2000); // Check every 2 seconds
            
            // Verify data initialization completed
            console.log('üìä Data check on DOMContentLoaded:');
            
            // Check if travelers section is active and load table
            setTimeout(() => {
                checkAndLoadTravelersTable();
            }, 500);
            
            // Check if roomPairs section is active and load table
            setTimeout(() => {
                const roomPairsSection = document.getElementById('roomPairs');
                if (roomPairsSection && roomPairsSection.classList.contains('active')) {
                    console.log('üîÑ Room pairs section is active on page load - loading table...');
                    console.log('  - loadPairs type:', typeof loadPairs);
                    console.log('  - window.loadPairs type:', typeof window.loadPairs);
                    
                    const loadFn = typeof loadPairs === 'function' ? loadPairs : 
                                  (typeof window.loadPairs === 'function' ? window.loadPairs : null);
                    
                    if (loadFn) {
                        console.log('‚úÖ Calling loadPairs function...');
                        loadFn().catch(err => {
                            console.error('‚ùå Error loading pairs:', err);
                            console.error('Error stack:', err.stack);
                        });
                    } else {
                        console.error('‚ùå loadPairs function not found! Retrying in 1 second...');
                        setTimeout(() => {
                            const retryFn = typeof loadPairs === 'function' ? loadPairs : 
                                          (typeof window.loadPairs === 'function' ? window.loadPairs : null);
                            if (retryFn) {
                                console.log('‚úÖ Retry: Calling loadPairs function...');
                                retryFn().catch(err => console.error('Error loading pairs:', err));
                            } else {
                                console.error('‚ùå loadPairs still not found after retry!');
                            }
                        }, 1000);
                    }
                }
            }, 600);
            
            // Also preload travelers data regardless of which section is active
            setTimeout(() => {
                const dashboard = document.getElementById('dashboard');
                if (dashboard && dashboard.classList.contains('active')) {
                    console.log('üîÑ Preloading travelers data...');
                    if (typeof loadTravelersTable === 'function') {
                        loadTravelersTable().catch(err => console.error('Preload error:', err));
                    }
                }
            }, 800);
            
            console.log('  - Travelers:', typeof travelers !== 'undefined' ? travelers.length : 'undefined');
            console.log('  - Posts:', typeof posts !== 'undefined' ? posts.length : 'undefined');
            console.log('  - Vehicles:', typeof vehicles !== 'undefined' ? vehicles.length : 'undefined');
            
            try {
                if (typeof updateDashboard === 'function') {
            updateDashboard();
                } else {
                    console.warn('‚ö†Ô∏è updateDashboard function not available yet');
                }
            } catch (error) {
                console.warn('Dashboard initialization failed (storage may be blocked):', error);
                // Don't block page load if dashboard update fails
            }
            
            // Verify login function is available
            if (typeof handleAdminLogin === 'function') {
                console.log('‚úÖ Login function loaded successfully');
            } else {
                console.error('‚ùå Login function not found!');
            }
            
            // Check if travelers section is active and load table
            setTimeout(() => {
                checkAndLoadTravelersTable();
            }, 1000);
        });

        // ‚úÖ Monitor for new traveler posts with notifications
        setInterval(() => {
            const newPosts = safeGetFromStorage('posts', []);
            
            if (JSON.stringify(posts) !== JSON.stringify(newPosts)) {
                const previousPosts = [...posts];
                const oldCount = posts.length;
                posts = newPosts;
                console.log(`üìä Admin: Posts updated ${oldCount} ‚Üí ${posts.length}`);
                
                // Detect new traveler posts (unapproved public posts only)
                newPosts.forEach(newPost => {
                    const oldPost = previousPosts.find(p => p.id === newPost.id);
                    
                    if (!oldPost && !newPost.approved && !newPost.isPrivate) {
                        // New public post awaiting approval (exclude private posts)
                        console.log('üÜï New traveler post received:', newPost.place);
                        showAdminNotification(newPost);
                    } else if (oldPost && !oldPost.approved && newPost.approved) {
                        // Post was just approved - notify admin
                        console.log('‚úÖ Post approved:', newPost.place);
                        showMessage(`‚úÖ Post "${newPost.place}" by ${newPost.author} has been approved!`, 'success');
                    }
                });
                
                // Refresh posts table if on posts section
                const postsSection = document.getElementById('posts');
                if (postsSection && postsSection.classList.contains('active')) {
                    loadPostsTable();
                }
                
                // Update dashboard counts
                updateDashboard();
            }
        }, 3000); // Check every 3 seconds

        function showAdminNotification(post) {
            const firstMedia = post.media && post.media.length > 0 ? post.media[0] : null;
            const mediaUrl = firstMedia ? firstMedia.url : 'https://via.placeholder.com/80';
            const isVideo = firstMedia && firstMedia.type === 'video';
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                min-width: 320px;
                max-width: 400px;
                animation: slideInRight 0.5s ease;
                display: flex;
                gap: 15px;
                align-items: center;
                border-left: 4px solid #ff9800;
            `;
            
            notification.innerHTML = `
                <div style="flex-shrink: 0;">
                    ${isVideo ? 
                        `<video src="${mediaUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" muted></video>` :
                        `<img src="${mediaUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">`
                    }
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--navy); margin-bottom: 5px;">üì¨ New Post for Approval</div>
                    <div style="font-size: 0.9rem; color: #333; margin-bottom: 3px;">${post.place}</div>
                    <div style="font-size: 0.85rem; color: #666;">by ${post.author}</div>
                    <div style="font-size: 0.85rem; color: #666;">üìç ${post.location}</div>
                </div>
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999;">‚úï</button>
            `;
            
            document.body.appendChild(notification);
            
            // Play notification sound
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCiJ0fPTgjMGHm7A7+OZSA0PVKzi8LNlHgs+ltryxnMpBSt9zPLaizsIGGS57OihUBELTKXh8bllHAU2jdXvyX0vBSl+zPDaizwHGGO36+mjUhIMTafe8L1nHgo5kdXwyX4yBSh8zO/bjz4IG2W46Oikzx0=');
            audio.play().catch(() => {});
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                notification.remove();
            }, 8000);
            
            // Show message
            showMessage('üì¨ New post received from ' + post.author + ' - Check Posts section!', 'info');
        }

        // Add CSS animation for notification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        // Backup login handler (only used if primary is missing)
        if (typeof handleAdminLogin === 'undefined') {
            async function handleAdminLogin(event) {
                if (event) event.preventDefault();
                alert('Login unavailable. Please refresh and try again.');
                        return false;
            }
        }

        function logout() {
            console.log('üö™ Logging out...');
            
            // Immediately hide dashboard and show login page
            const loginPage = document.getElementById('loginPage');
            const dashboard = document.getElementById('dashboard');
            const adminUsername = document.getElementById('adminUsername');
            const adminPassword = document.getElementById('adminPassword');
            
            if (dashboard) {
                dashboard.classList.remove('active');
                dashboard.style.display = 'none';
            }
            
            if (loginPage) {
                loginPage.style.display = 'flex';
            }
            
            if (adminUsername) {
                adminUsername.value = '';
            }
            
            if (adminPassword) {
                adminPassword.value = '';
            }
            
            // Close any open modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Clear sessionStorage on logout
            try {
                sessionStorage.removeItem('adminLoggedIn');
                sessionStorage.removeItem('adminLoginTime');
                sessionStorage.removeItem('activeSection');
                console.log('‚úÖ Login state cleared from sessionStorage');
            } catch (e) {
                console.warn('Could not clear login state:', e);
            }
            
            // Clear any cached data
            if (typeof api !== 'undefined' && api.clearCache) {
                api.clearCache();
            }
            
            console.log('‚úÖ Logout complete');
        }
        window.logout = logout;

        // Navigation
        // Make showSection globally accessible (this overrides the early stub)
        window.showSection = function showSection(sectionId) {
            try {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

                const targetSection = document.getElementById(sectionId);
                if (!targetSection) {
                    console.error('Section not found:', sectionId);
                    return;
                }
                
                targetSection.classList.add('active');
                
                // Save active section to sessionStorage (survives page refresh)
                try {
                    sessionStorage.setItem('activeSection', sectionId);
                    console.log(`üíæ Saved active section: ${sectionId}`);
                } catch (e) {
                    console.warn('Could not save active section:', e);
                }
                
                // Get the clicked element from the event if available
                if (typeof event !== 'undefined' && event && event.target) {
            event.target.classList.add('active');
                } else {
                    // Fallback: find the sidebar item by sectionId
                    const sidebarItems = document.querySelectorAll('.sidebar-item');
                    sidebarItems.forEach(item => {
                        if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(sectionId)) {
                            item.classList.add('active');
                        }
                    });
                }

            if (sectionId === 'posts') {
                if (typeof loadPostsTable === 'function') {
                    loadPostsTable();
                }
            }
            if (sectionId === 'travelers') {
                console.log('üîÑ Travelers section shown - loading table...');
                if (typeof loadTravelersTable === 'function') {
                    // Load immediately and also with a delay to ensure DOM is ready
                    loadTravelersTable().catch(err => {
                        console.error('Error loading travelers table:', err);
                        // Retry after delay
                        setTimeout(async () => {
                            console.log('üîÑ Retrying loadTravelersTable...');
                            await loadTravelersTable();
                        }, 300);
                    });
                } else {
                    console.error('‚ùå loadTravelersTable function not found!');
                }
            }
            if (sectionId === 'roomPairs') {
                if (typeof loadPairs === 'function') {
                    loadPairs();
                }
            }
            if (sectionId === 'vehicles') {
                loadVehiclesTable();
                // Pre-populate group leaders dropdown when vehicles section is shown
                setTimeout(async () => {
                    if (typeof populateGroupLeadersDropdown === 'function') {
                        console.log('üìã Pre-populating group leaders dropdown for vehicles section...');
                        await populateGroupLeadersDropdown();
                    }
                }, 500);
            }
            if (sectionId === 'hotels') loadHotelsTable();
            if (sectionId === 'hotelAllotment') {
                // Refresh hotels from API to ensure newly added hotels appear
                (async () => {
                    try {
                        if (typeof api !== 'undefined' && api.getHotels) {
                            // Clear cache to get fresh data
                            if (api.clearCacheFor) {
                                api.clearCacheFor('hotels');
                            }
                            hotels = await api.getHotels();
                            console.log('‚úÖ Refreshed hotels for allotment dropdown:', hotels.length);
                        }
                    } catch (error) {
                        console.error('Error refreshing hotels:', error);
                    }
                    // Populate dropdown with latest hotels
                populateHotelSelects();
                loadAllotmentGrid();
                })();
            }
            if (sectionId === 'vehicleAllotment') {
                (async () => {
                    await populateVehicleAllotmentDateSelect();
                })();
            }
            if (sectionId === 'itinerary') loadItineraryTable();
            if (sectionId === 'sections') loadSectionsTable();
            if (sectionId === 'tags') loadTagsTable();
            if (sectionId === 'announcements') {
                loadScheduledAnnouncements();
                loadAnnouncementHistory();
                // Make sure data is loaded before populating dropdowns
                populateAnnouncementRecipients().catch(err => {
                    console.error('Error populating announcement recipients:', err);
                });
            }
            if (sectionId === 'settings') {
                loadAdminProfile();
                loadAlarmSettings();
                loadEmergencyContact();
                loadSettings();
                loadHeaderImages();
            }
            if (sectionId === 'overview') {
                // Update dashboard when overview section is shown
                if (typeof updateDashboard === 'function') {
                    updateDashboard().catch(err => {
                        console.error('Error updating dashboard in overview:', err);
                    });
                }
            }
            } catch (error) {
                console.error('Error in showSection:', error);
            }
        };
        
        // Also keep the function name for backward compatibility
        function showSection(sectionId) {
            return window.showSection(sectionId);
        }

        // Update Dashboard - Load data from API if needed
        async function updateDashboard() {
            try {
                // Load data from API if not already loaded
                if (typeof api !== 'undefined') {
                    // Load posts if empty or undefined
                    if (!posts || posts.length === 0) {
                        try {
                            console.log('üìù Loading posts from API for dashboard...');
                            posts = await api.getPosts({});
                            console.log('‚úÖ Loaded posts for dashboard:', posts.length);
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Could not load posts from API:', error);
                        }
                    }
                    
                    // Load travelers if empty or undefined
                    if (!travelers || travelers.length === 0) {
                        try {
                            console.log('üìù Loading travelers from API for dashboard...');
                            travelers = await api.getTravelers();
                            console.log('‚úÖ Loaded travelers for dashboard:', travelers.length);
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Could not load travelers from API:', error);
                        }
                    }
                }
                
                // Ensure posts and travelers are defined (fallback to empty arrays if storage blocked)
                const safePosts = (typeof posts !== 'undefined' && Array.isArray(posts)) ? posts : [];
                const safeTravelers = (typeof travelers !== 'undefined' && Array.isArray(travelers)) ? travelers : [];
                
                console.log('üìä updateDashboard - Posts:', safePosts.length, 'Travelers:', safeTravelers.length);
                
            // Filter out private posts from dashboard stats
                const publicPosts = (typeof posts !== 'undefined' && Array.isArray(posts)) ? posts.filter(p => p && !p.isPrivate) : [];
            
            // Calculate unique places, countries, and cities
            const places = new Set(publicPosts.map(p => p.place).filter(Boolean)).size;
            const countries = new Set(publicPosts.map(p => p.country).filter(Boolean)).size;
            const cities = new Set(publicPosts.map(p => p.city || p.location).filter(Boolean)).size;
            const locations = new Set(publicPosts.map(p => p.location).filter(Boolean)).size;
            
                // Update dashboard cards safely
                const updateElement = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                
                const finalTravelers = (typeof travelers !== 'undefined' && Array.isArray(travelers)) ? travelers : safeTravelers;
                
                updateElement('totalPlaces', places);
                updateElement('totalCountries', countries);
                updateElement('totalCities', cities);
                updateElement('totalLocations', locations);
                updateElement('totalTravelers', finalTravelers.length);
                updateElement('totalPosts', publicPosts.length);
                updateElement('pendingPosts', publicPosts.filter(p => !p.approved).length);
            
                console.log('‚úÖ Dashboard updated - Places:', places, 'Countries:', countries, 'Travelers:', finalTravelers.length, 'Posts:', publicPosts.length);
                
                // Try to update contributors table, but don't fail if it errors
                try {
            updateTopContributorsTable();
                } catch (contribError) {
                    console.warn('Contributors table update failed:', contribError);
                }
            } catch (error) {
                console.error('Dashboard update error:', error);
                // Don't throw - allow dashboard to display even with errors
            }
        }

        function updateTopContributorsTable() {
            const tbody = document.getElementById('topContributorsTable');
            
            // Count posts and media per contributor (exclude private posts)
            const stats = {};
            
            posts.filter(p => p.approved && !p.isPrivate).forEach(post => {
                // Skip admin posts if not included in contributors
                if (post.author === 'Admin' && !adminUser.includeInContributors) return;
                
                const key = post.email || post.author;
                
                if (!stats[key]) {
                    stats[key] = {
                        name: post.author,
                        photos: 0,
                        videos: 0,
                        posts: 0
                    };
                }
                
                stats[key].posts++;
                
                if (post.media) {
                    post.media.forEach(m => {
                        if (m.type === 'image') stats[key].photos++;
                        else if (m.type === 'video') stats[key].videos++;
                    });
                }
            });
            
            // Convert to array and sort by total contributions
            const contributors = Object.values(stats).sort((a, b) => {
                const totalA = a.posts + a.photos + a.videos;
                const totalB = b.posts + b.photos + b.videos;
                return totalB - totalA;
            });
            
            tbody.innerHTML = '';
            
            if (contributors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No contributors yet</td></tr>';
                return;
            }
            
            // Get top N from settings
            const topCount = settings.topContributorsCount || 5;
            const topN = contributors.slice(0, topCount);
            
            topN.forEach((contributor, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                const total = contributor.posts + contributor.photos + contributor.videos;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; font-size: 1.2rem;">${medal}</td>
                    <td style="font-weight: 600;">${escapeHTML(contributor.name)}</td>
                    <td style="text-align: center;">${contributor.posts}</td>
                    <td style="text-align: center;">${contributor.photos}</td>
                    <td style="text-align: center;">${contributor.videos}</td>
                    <td style="text-align: center; font-weight: 700; color: var(--saffron);">${total}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Posts Management
        // ==================== POSTS LOAD OPERATIONS (MySQL Backend) ====================
        async function loadPostsTable() {
            const tbody = document.getElementById('postsTable');
            tbody.innerHTML = '';

            // Load posts from API
            try {
                if (typeof api !== 'undefined' && api.getPosts) {
                    posts = await api.getPosts({});
                } else {
                    console.warn('API not available, using cached posts');
                }
            } catch (error) {
                console.error('Error loading posts from API:', error);
                // Continue with existing posts array
            }

            // Filter out private posts - admin should not see them
            const publicPosts = posts.filter(p => !p.isPrivate);
            
            if (publicPosts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No posts available</td></tr>';
                return;
            }

            publicPosts.forEach(post => {
                // Handle media format - can be array of objects {url, type} or array of strings
                let firstMedia = null;
                // Use data URI placeholder instead of external URL
                let firstMediaUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBNZWRpYTwvdGV4dD48L3N2Zz4=';
                let isVideo = false;
                
                if (post.media && post.media.length > 0) {
                    const mediaItem = post.media[0];
                    // Check if it's an object with url property or just a string
                    if (typeof mediaItem === 'object' && mediaItem !== null) {
                        firstMedia = mediaItem;
                        firstMediaUrl = mediaItem.url || mediaItem.data || firstMediaUrl;
                        isVideo = mediaItem.type === 'video' || (firstMediaUrl && firstMediaUrl.startsWith('data:video/'));
                    } else if (typeof mediaItem === 'string') {
                        // Legacy format - just a URL string
                        firstMediaUrl = mediaItem;
                        isVideo = firstMediaUrl.startsWith('data:video/');
                    }
                    
                    // Debug: Log what we received
                    if (firstMediaUrl) {
                        console.log(`üîç Post ${post.id} media URL: length=${firstMediaUrl.length}, starts with: ${firstMediaUrl.substring(0, 50)}...`);
                    }
                    
                    // Validate URL - ensure it's a valid absolute URL or data URI
                    if (firstMediaUrl) {
                        // Check if URL is valid
                        const isValidUrl = firstMediaUrl.startsWith('data:') || 
                                         firstMediaUrl.startsWith('http://') || 
                                         firstMediaUrl.startsWith('https://') ||
                                         firstMediaUrl.startsWith('/'); // Allow relative URLs starting with /
                        
                        if (!isValidUrl) {
                            // URL doesn't start with valid prefix - might be corrupted base64 data
                            console.error(`‚ùå Invalid URL format for post ${post.id}: ${firstMediaUrl.substring(0, 50)}...`);
                            console.error(`   Full URL preview: ${firstMediaUrl.substring(0, 200)}...`);
                            firstMediaUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbnZhbGlkPC90ZXh0Pjwvc3ZnPg==';
                        } else if (firstMediaUrl.startsWith('data:image/') || firstMediaUrl.startsWith('data:video/')) {
                            // Base64 URLs should have a comma separator
                            if (!firstMediaUrl.includes(',')) {
                                console.error(`‚ùå Data URL missing comma for post ${post.id}: ${firstMediaUrl.substring(0, 100)}...`);
                                // Use a data URI placeholder instead of external URL
                                firstMediaUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
                            } else if (firstMediaUrl.length < 100) {
                                console.error(`‚ùå Suspiciously short URL for post ${post.id}: length=${firstMediaUrl.length}`);
                                // Use a data URI placeholder instead of external URL
                                firstMediaUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5UcnVuY2F0ZWQ8L3RleHQ+PC9zdmc+';
                            } else {
                                console.log(`‚úÖ Valid data URL for post ${post.id}: length=${firstMediaUrl.length}`);
                            }
                        }
                    }
                    
                    // Default placeholder if no media
                    if (!firstMediaUrl || firstMediaUrl === 'https://via.placeholder.com/80x80?text=No+Media') {
                        firstMediaUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBNZWRpYTwvdGV4dD48L3N2Zz4=';
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="post-preview">
                            ${isVideo ? 
                                `<video src="${escapeHTML(firstMediaUrl)}" class="post-image" muted onclick="viewImageFullscreen('${escapeHTML(firstMediaUrl)}', ${post.id})" style="cursor: pointer;"></video>` :
                                `<img src="${escapeHTML(firstMediaUrl)}" class="post-image" alt="${escapeHTML(post.place)}" onclick="viewImageFullscreen('${escapeHTML(firstMediaUrl)}', ${post.id})" style="cursor: pointer;">`
                            }
                            <div class="post-details">
                                <div class="post-location">${escapeHTML(post.place)}</div>
                                <div style="font-size: 0.8rem; color: var(--saffron); margin-bottom: 3px;">üìç ${escapeHTML(post.location)}</div>
                                <div class="post-description">${escapeHTML(post.description.substring(0, 80))}...</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="post-author">${escapeHTML(post.author)}</div>
                        <div style="font-size: 0.8rem; color: #666;">${escapeHTML(post.email)}</div>
                    </td>
                    <td>${new Date(post.timestamp).toLocaleDateString()}</td>
                    <td>
                        <span class="badge ${post.approved ? 'badge-approved' : 'badge-pending'}">
                            ${post.approved ? 'Approved' : 'Pending'}
                        </span>
                    </td>
                    <td>
                        ${!post.approved ? `<button class="action-btn btn-approve" onclick="approvePost(${post.id})" title="Approve">‚úì</button>` : ''}
                        <button class="action-btn btn-edit" onclick="viewPost(${post.id})" title="View">üëÅ</button>
                        <button class="action-btn btn-delete" onclick="deletePost(${post.id})" title="Delete">üóë</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== POSTS CRUD OPERATIONS (MySQL Backend) ====================
        async function approvePost(id) {
            try {
                console.log(`üìù Attempting to approve post ${id}...`);
                console.log(`üìù Current posts array length: ${posts.length}`);
                console.log(`üìù Post ${id} current status:`, posts.find(p => p.id === id));
                
                // Check if user is authenticated (check both adminToken and adminData)
                const adminToken = localStorage.getItem('adminToken');
                const adminData = localStorage.getItem('adminData');
                let token = adminToken;
                
                if (!token && adminData) {
                    try {
                        const admin = JSON.parse(adminData);
                        token = admin.token;
                    } catch (e) {
                        console.error('Error parsing adminData:', e);
                    }
                }
                
                if (!token) {
                    console.error('‚ùå No admin token found! adminToken:', adminToken, 'adminData:', adminData);
                    showMessage('Please login first to approve posts.', 'error');
                    return;
                }
                
                console.log(`‚úÖ Admin token found, proceeding with approval...`);
                
                // Update via API
                if (typeof api !== 'undefined' && api.approvePost) {
                    console.log(`üì§ Sending approval request for post ${id}...`);
                    const response = await api.approvePost(id, true);
                    console.log('‚úÖ Post approval response:', response);
                    
                    if (!response || !response.post) {
                        throw new Error('Invalid response from server');
                    }
                    
                    if (!response.post.approved) {
                        console.error('‚ùå Post was not approved! Response:', response);
                        showMessage('Error: Post approval failed. Please check console for details.', 'error');
                        return;
                    }
                    
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('/posts');
                    }
                    
                    // Reload posts from API to get latest data
                    posts = await api.getPosts({});
                    
                    // Update the post in the local array
                    const postIndex = posts.findIndex(p => p.id === id);
                    if (postIndex >= 0) {
                        posts[postIndex].approved = response.post.approved;
                        console.log(`‚úÖ Updated post ${id} approval status: ${response.post.approved}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Post ${id} not found in posts array after reload`);
                    }
                    
                    showMessage('Post approved successfully! üéâ Now visible on website.');
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('‚ùå Error approving post:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response
                });
                showMessage(`Error approving post: ${error.message}. Please try again.`, 'error');
                return;
            }
                
                loadPostsTable();
                updateDashboard();
            }
        
        // Make sure approvePost is available globally
        window.approvePost = approvePost;
        console.log('‚úÖ approvePost function assigned to window:', typeof window.approvePost);

        function viewPost(id) {
            const post = posts.find(p => p.id === id);
            if (!post) {
                console.error('Post not found with id:', id);
                return;
            }

            // Handle media format - can be array of objects {url, type} or array of strings
            // Filter out corrupted/invalid URLs first
            const mediaArray = (post.media || []).filter(m => {
                let url = '';
                if (typeof m === 'object' && m !== null) {
                    url = m.url || m.data || '';
                } else if (typeof m === 'string') {
                    url = m;
                }
                
                // Validate base64 URLs
                if (url && (url.startsWith('data:image/') || url.startsWith('data:video/'))) {
                    // Must have comma separator and be long enough
                    if (!url.includes(',') || url.length < 100) {
                        return false; // Skip corrupted URLs
                    }
                }
                return url && url.length > 0;
            });
            
            const imageCount = mediaArray.filter(m => {
                if (typeof m === 'object' && m !== null) {
                    return m.type === 'image';
                } else if (typeof m === 'string') {
                    return !m.startsWith('data:video/');
                }
                return false;
            }).length;
            const videoCount = mediaArray.filter(m => {
                if (typeof m === 'object' && m !== null) {
                    return m.type === 'video';
                } else if (typeof m === 'string') {
                    return m.startsWith('data:video/');
                }
                return false;
            }).length;
            const tagsDisplay = post.tags && post.tags.length > 0 ? post.tags.join(', ') : 'No tags';

            const content = document.getElementById('postDetailContent');
            content.innerHTML = `
                <div class="form-group">
                    <label>Place</label>
                    <input type="text" value="${post.place}" readonly>
                </div>
                <div class="form-group">
                    <label>Location (City)</label>
                    <input type="text" value="${post.location}" readonly>
                </div>
                <div class="form-group">
                    <label>Author</label>
                    <input type="text" value="${post.author}" readonly>
                </div>
                <div class="form-group">
                    <label>Section</label>
                    <input type="text" value="${post.section}" readonly>
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    <input type="text" value="${tagsDisplay}" readonly>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea readonly style="min-height: 100px;">${post.description}</textarea>
                </div>
                <div class="form-group">
                    <label>Media (${imageCount} Photos, ${videoCount} Videos)</label>
                    <div class="image-gallery">
                        ${mediaArray.map(media => {
                            // Handle both object format {url, type} and string format
                            let mediaUrl = '';
                            let mediaType = 'image';
                            
                            if (typeof media === 'object' && media !== null) {
                                mediaUrl = media.url || media.data || '';
                                mediaType = media.type || (mediaUrl.startsWith('data:video/') ? 'video' : 'image');
                            } else if (typeof media === 'string') {
                                mediaUrl = media;
                                mediaType = mediaUrl.startsWith('data:video/') ? 'video' : 'image';
                            }
                            
                            // Validate URL before using it
                            if (!mediaUrl) return '';
                            
                            // Additional validation for base64 URLs
                            if (mediaUrl.startsWith('data:image/') || mediaUrl.startsWith('data:video/')) {
                                // Must have comma separator
                                if (!mediaUrl.includes(',')) {
                                    console.warn(`Skipping corrupted media URL in viewPost for post ${post.id}`);
                                    return ''; // Skip this corrupted URL
                                }
                                // Must be long enough
                                if (mediaUrl.length < 100) {
                                    console.warn(`Skipping suspiciously short media URL in viewPost for post ${post.id}`);
                                    return ''; // Skip this truncated URL
                                }
                            }
                            
                            // Ensure URL is properly escaped
                            const safeUrl = escapeHTML(mediaUrl);
                            
                            if (mediaType === 'video') {
                                return `<video src="${safeUrl}" class="gallery-image" controls onerror="this.style.display='none';"></video>`;
                            } else {
                                return `<img src="${safeUrl}" class="gallery-image" onclick="viewImageFullscreen('${safeUrl}', ${post.id})" style="cursor: pointer;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5FcnJvcjwvdGV4dD48L3N2Zz4='; this.onerror=null;">`;
                            }
                        }).filter(html => html.length > 0).join('') || '<p style="color: #999; padding: 20px; text-align: center;">No valid media available</p>'}
                    </div>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <input type="text" value="Lat: ${post.lat}, Lng: ${post.lng}" readonly>
                </div>
            `;

            document.getElementById('postDetailModal').style.display = 'block';
        }
        window.viewPost = viewPost;

        function viewImageFullscreen(imageUrl, postId) {
            // Validate URL before opening
            if (!imageUrl) {
                console.error('No image URL provided');
                return;
            }
            
            // Validate base64 URLs
            if (imageUrl.startsWith('data:image/') || imageUrl.startsWith('data:video/')) {
                if (!imageUrl.includes(',') || imageUrl.length < 100) {
                    console.error('Invalid or corrupted image URL');
                    alert('This image cannot be displayed because it is corrupted. Please re-upload the image.');
                    return;
                }
            }
            const post = posts.find(p => p.id === postId);
            
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.id = 'fullscreenImageView';
            fullscreenDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const approveButton = post && !post.approved ? 
                `<button onclick="approvePostFromFullscreen(${postId})" style="position: absolute; top: 20px; left: 20px; background: var(--green); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                    ‚úì Approve Post
                </button>` : '';
            
            // Escape the URL to prevent XSS and ensure proper rendering
            const safeImageUrl = escapeHTML(imageUrl);
            
            fullscreenDiv.innerHTML = `
                ${approveButton}
                <button onclick="closeFullscreenImage()" style="position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5);">‚úï</button>
                <img src="${safeImageUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjI0IiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+RXJyb3I6IENhbm5vdCBkaXNwbGF5IGltYWdlPC90ZXh0Pjwvc3ZnPg=='; this.onerror=null; alert('Failed to load image. The image may be corrupted.');">
            `;
            document.body.appendChild(fullscreenDiv);
        }

        async function approvePostFromFullscreen(postId) {
            try {
                // Update via API
                if (typeof api !== 'undefined' && api.approvePost) {
                    await api.approvePost(postId, true);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('posts');
                    }
                    posts = await api.getPosts({});
                closeFullscreenImage();
                loadPostsTable();
                updateDashboard();
                showMessage('Post approved successfully! üéâ');
                } else {
                    throw new Error('API not available');
            }
            } catch (error) {
                console.error('Error approving post:', error);
                showMessage('Error approving post. Please try again.', 'error');
        }
        }
        window.approvePostFromFullscreen = approvePostFromFullscreen;

        function closeFullscreenImage() {
            const fullscreenDiv = document.getElementById('fullscreenImageView');
            if (fullscreenDiv) {
                fullscreenDiv.remove();
            }
        }

        async function deletePost(id) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            
            try {
                // Delete via API
                if (typeof api !== 'undefined' && api.deletePost) {
                    await api.deletePost(id);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('posts');
                    }
                    posts = await api.getPosts({});
                showMessage('Post deleted successfully');
            } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                showMessage('Error deleting post. Please try again.', 'error');
                return;
            }
            
            loadPostsTable();
            updateDashboard();
        }
        window.deletePost = deletePost;

        function closePostDetailModal() {
            document.getElementById('postDetailModal').style.display = 'none';
        }

        // Travelers Management
        // Note: loadTravelersTable is already defined earlier in the file (line 1137)
        // Note: editTraveler and deleteTraveler are defined early in the file (around line 924)
        
        // Set up button click handler when modal opens
        function setupTravelerFormButton() {
            const submitBtn = document.getElementById('travelerSubmitBtn');
            if (submitBtn) {
                // Remove any existing listeners
                const newBtn = submitBtn.cloneNode(true);
                submitBtn.parentNode.replaceChild(newBtn, submitBtn);
                const btn = document.getElementById('travelerSubmitBtn');
                
                // Add click handler
                btn.addEventListener('click', function(e) {
                    console.log('üî¥ BUTTON CLICKED - Setting up handler!');
                    e.preventDefault();
                    e.stopPropagation();
                    handleAddTraveler(e);
                    return false;
                });
                console.log('‚úÖ Button click handler set up');
            }
        }

        // Note: tempTravelerImage is already declared earlier in the file

        function handleTravelerImagePreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempTravelerImage = e.target.result;
                    const preview = document.getElementById('travelerImagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    preview.style.background = 'transparent';
                };
                reader.readAsDataURL(file);
            }
        }

        function calculateAge() {
            const birthDate = document.getElementById('travelerBirthDate');
            const ageField = document.getElementById('travelerAge');
            if (birthDate && birthDate.value && ageField) {
                const today = new Date();
                const birth = new Date(birthDate.value);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                ageField.value = age;
            }
        }
        
        // Note: handleAddTraveler, openTravelerModal, closeTravelerModal, and calculateAge
        // are already defined earlier in the file and assigned to window objects.
        // The main implementation is at line 2087: window.handleAddTraveler
        // No wrapper needed - the function is already globally accessible via window.handleAddTraveler

        // Note: deleteTraveler is now defined early in the file (around line 924)
        
        // Old delete function (kept for reference)
        function deleteTravelerOld(id) {
            if (confirm('Are you sure you want to delete this traveler?')) {
                // Get traveler email before deleting
                const traveler = travelers.find(t => t.id === id);
                const email = traveler ? traveler.email : null;
                
                // Remove from travelers array
                travelers = travelers.filter(t => t.id !== id);
                localStorage.setItem('authorizedTravelers', JSON.stringify(travelers));
                
                // SYNC: Remove from travelerProfileData
                if (email) {
                    const allProfiles = JSON.parse(localStorage.getItem('travelerProfileData') || '{}');
                    delete allProfiles[email];
                    localStorage.setItem('travelerProfileData', JSON.stringify(allProfiles));
                    
                    // Also remove from travelerProfiles
                    delete travelerProfiles[email];
                    localStorage.setItem('travelerProfiles', JSON.stringify(travelerProfiles));
                }
                
                loadTravelersTable();
                updateDashboard();
                showMessage('Traveler deleted successfully');
            }
        }

        // ==================== TRAVELERS EXCEL UPLOAD (MySQL Backend) ====================
        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showMessage('üìä Processing Excel file...', 'info');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (rows.length === 0) {
                        showMessage('‚ùå Excel file is empty', 'error');
                        return;
                    }
                    
                    // Check if API is available
                    if (typeof api === 'undefined' || !api.createTraveler) {
                        showMessage('‚ùå API not available. Please start the backend server.', 'error');
                        return;
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    // Process rows sequentially to avoid overwhelming the API
                    for (const row of rows) {
                        try {
                            // Required fields validation (Birth Date is now optional)
                            if (!row['First Name'] || !row['Last Name'] || !row['Email'] || 
                                !row['Password'] || !row['Phone'] || !row['City'] || 
                                !row['Country']) {
                                errorCount++;
                                continue;
                            }
                            
                            // Check if email already exists (load fresh from API)
                            const existingTravelers = await api.getTravelers();
                            if (existingTravelers.some(t => t.email === row['Email'])) {
                                errorCount++;
                                continue;
                            }
                            
                            // Calculate age from birth date (if provided)
                            let age = null;
                            let birthDate = row['Birth Date'] || null;
                            if (birthDate) {
                                const birthDateObj = new Date(birthDate);
                                age = new Date().getFullYear() - birthDateObj.getFullYear();
                            }
                            
                            // Create new traveler with all fields
                            const newTraveler = {
                                tirthId: row['Tirth ID'] || `TY${String(Date.now()).slice(-3)}`,
                                firstName: row['First Name'],
                                middleName: row['Middle Name'] || '',
                                lastName: row['Last Name'],
                                name: `${row['First Name']} ${row['Middle Name'] ? row['Middle Name'] + ' ' : ''}${row['Last Name']}`,
                                profileLine: row['Profile Line'] || '',
                                aboutMe: row['About Me'] || '',
                                birthDate: birthDate,
                                age: age ? parseInt(age) : null,
                                passportNo: row['Passport #'] || '',
                                nationality: row['Nationality'] || 'Indian',
                                passportIssueDate: row['Passport Issue Date'] || null,
                                passportExpiryDate: row['Passport Expiry Date'] || null,
                                email: row['Email'],
                                password: row['Password'],
                                phone: row['Phone'],
                                city: row['City'],
                                country: row['Country'],
                                center: row['Center'] || '',
                                hoodiSize: row['Hoodi Size'] || null,
                                image: null,
                                gender: 'Male' // Default
                            };
                            
                            // Create via API
                            await api.createTraveler(newTraveler);
                            successCount++;
                            
                            // Small delay to avoid overwhelming the API
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (err) {
                            console.error('Error creating traveler from Excel:', err);
                            errorCount++;
                        }
                    }
                    
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('authorizedTravelers');
                    }
                    travelers = await api.getTravelers();
                    
                    // Update UI
                    loadTravelersTable();
                    updateDashboard();
                    
                    showMessage(`‚úÖ Bulk upload complete! ${successCount} travelers added, ${errorCount} skipped/errors`, 'success');
                    
                } catch (error) {
                    showMessage('‚ùå Error processing Excel file. Please check the format.', 'error');
                    console.error('Excel parsing error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset file input
        }


        // Sections Management
        let editingSectionId = null;

        async function loadSectionsTable() {
            const tbody = document.getElementById('sectionsTable');
            tbody.innerHTML = '';

            // Load sections from API
            try {
                if (typeof api !== 'undefined' && api.getSections) {
                    sections = await api.getSections();
                } else {
                    console.warn('API not available, using cached sections');
                }
            } catch (error) {
                console.error('Error loading sections from API:', error);
                // Continue with existing sections array
            }

            if (sections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">No sections found</td></tr>';
                return;
            }

            sections.forEach(section => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${section.name}</td>
                    <td>${section.description || ''}</td>
                    <td>${section.count || 0}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editSection(${section.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="action-btn btn-delete" onclick="deleteSection(${section.id})" title="Delete">üóë</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openSectionModal() {
            document.getElementById('sectionModal').style.display = 'block';
        }
        window.openSectionModal = openSectionModal;

        function closeSectionModal() {
            document.getElementById('sectionModal').style.display = 'none';
            editingSectionId = null;
            document.getElementById('sectionModalTitle').textContent = 'Add Section';
        }
        window.closeSectionModal = closeSectionModal;

        async function handleAddSection(event) {
            event.preventDefault();
            
            const name = document.getElementById('sectionName').value.trim();
            const description = document.getElementById('sectionDescription').value.trim();
            
            if (!name) {
                showMessage('Please enter a section name', 'error');
                return;
            }

            try {
                if (editingSectionId) {
                    // Update existing section via API
                    if (typeof api !== 'undefined' && api.updateSection) {
                        await api.updateSection(editingSectionId, { name, description });
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/sections');
                        }
                        sections = await api.getSections();
                        showMessage('Section updated successfully! üéâ');
                    } else {
                        throw new Error('API not available');
                    }
                } else {
                    // Add new section via API
                    if (typeof api !== 'undefined' && api.createSection) {
                        await api.createSection({ name, description });
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/sections');
                        }
                        sections = await api.getSections();
                        showMessage('Section added successfully! üéâ');
                    } else {
                        throw new Error('API not available');
                    }
                }
            } catch (error) {
                console.error('Error saving section:', error);
                showMessage('Error saving section. Please try again.', 'error');
                return;
            }

            editingSectionId = null;
            document.getElementById('sectionModalTitle').textContent = 'Add Section';
            closeSectionModal();
            await loadSectionsTable();
            event.target.reset();
        }

        async function deleteSection(id) {
            if (!confirm('Are you sure you want to delete this section?')) {
                return;
            }
            
            try {
                // Delete via API
                if (typeof api !== 'undefined' && api.deleteSection) {
                    await api.deleteSection(id);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('/sections');
                    }
                    sections = await api.getSections();
                    showMessage('Section deleted successfully');
                    await loadSectionsTable();
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('Error deleting section:', error);
                const errorMsg = error.message || 'Error deleting section. Please try again.';
                showMessage(errorMsg.includes('being used by') ? errorMsg : 'Error deleting section. Please try again.', 'error');
            }
        }
        window.deleteSection = deleteSection;

        function editSection(id) {
            const section = sections.find(s => s.id === id);
            if (!section) {
                console.warn('Section not found for edit', id);
                return;
            }
            editingSectionId = id;
            document.getElementById('sectionModal').style.display = 'block';
            document.getElementById('sectionName').value = section.name;
            document.getElementById('sectionDescription').value = section.description;
            document.getElementById('sectionModalTitle').textContent = 'Edit Section';
        }
        window.editSection = editSection;

        // Tags Management
        // ==================== TAGS LOAD OPERATIONS (MySQL Backend) ====================
        async function loadTagsTable() {
            const tbody = document.getElementById('tagsTable');
            tbody.innerHTML = '';

            // Load tags from API
            try {
                if (typeof api !== 'undefined' && api.getTags) {
                    tags = await api.getTags();
                } else {
                    console.warn('API not available, using cached tags');
                }
            } catch (error) {
                console.error('Error loading tags from API:', error);
                // Continue with existing tags array
            }

            tags.forEach((tag, index) => {
                const usageCount = posts.filter(p => p.tags && p.tags.includes(tag)).length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge badge-approved">${tag}</span></td>
                    <td>${usageCount} posts</td>
                    <td>
                        <button class="action-btn btn-delete" onclick="deleteTag(${index})" title="Delete">üóë</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openTagModal() {
            document.getElementById('tagModal').style.display = 'block';
        }
        window.openTagModal = openTagModal;

        function closeTagModal() {
            document.getElementById('tagModal').style.display = 'none';
        }
        window.closeTagModal = closeTagModal;

        // ==================== TAGS CRUD OPERATIONS (MySQL Backend) ====================
        async function handleAddTag(event) {
            event.preventDefault();
            
            const tagName = document.getElementById('tagName').value.trim();
            
            if (!tagName) {
                showMessage('Please enter a tag name', 'error');
                return;
            }
            
            if (tags.includes(tagName)) {
                showMessage('Tag already exists', 'error');
                return;
            }

            try {
                // Add tag via API
                if (typeof api !== 'undefined' && api.addTag) {
                    await api.addTag(tagName);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('tags');
                    }
                    tags = await api.getTags();
            showMessage('Tag added successfully! üéâ');
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('Error adding tag:', error);
                showMessage('Error adding tag. Please try again.', 'error');
                return;
            }

            closeTagModal();
            loadTagsTable();
            event.target.reset();
        }

        async function deleteTag(index) {
            if (!confirm('Are you sure you want to delete this tag?')) {
                return;
            }
            
            const tagName = tags[index];
            if (!tagName) return;
            
            try {
                // Delete tag via API (if API supports it)
                // Note: API may need deleteTag method added
                if (typeof api !== 'undefined' && api.deleteTag) {
                    await api.deleteTag(tagName);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('tags');
                    }
                    tags = await api.getTags();
                showMessage('Tag deleted successfully');
                } else {
                    // Fallback: remove from local array (API method may need to be added)
                    tags.splice(index, 1);
                    console.warn('API deleteTag method not available, using local removal');
                    showMessage('Tag deleted successfully (local only - API method may need to be added)');
            }
            } catch (error) {
                console.error('Error deleting tag:', error);
                showMessage('Error deleting tag. Please try again.', 'error');
                return;
        }
            
            loadTagsTable();
        }
        window.deleteTag = deleteTag;

        // Itinerary Management
        // ==================== ITINERARY LOAD OPERATIONS (MySQL Backend) ====================
        // Guard to prevent multiple simultaneous calls
        let isLoadingItineraryTable = false;
        
        async function loadItineraryTable() {
            // Prevent multiple simultaneous calls
            if (isLoadingItineraryTable) {
                console.log('‚è∏Ô∏è loadItineraryTable already in progress, skipping...');
                return;
            }
            
            isLoadingItineraryTable = true;
            
            try {
                const tbody = document.getElementById('itineraryTable');
                if (!tbody) {
                    console.warn('itineraryTable tbody not found');
                    return;
                }
                
                // Clear table first
                tbody.innerHTML = '';

                // Clear cache first to ensure fresh data
                if (typeof api !== 'undefined' && api.clearCacheFor) {
                    api.clearCacheFor('/itinerary');
                    console.log('üóëÔ∏è Cleared itinerary cache to prevent duplicates');
                }

                // Load itinerary from API (fresh, not cached)
                try {
                    if (typeof api !== 'undefined' && api.getItinerary) {
                        itinerary = await api.getItinerary();
                        // Ensure dateObj is a Date object for each day
                        if (itinerary && Array.isArray(itinerary)) {
                            itinerary = itinerary.map(day => {
                                if (day.dateObj) {
                                    // Convert dateObj to Date if it's a string
                                    day.dateObj = day.dateObj instanceof Date 
                                        ? day.dateObj 
                                        : new Date(day.dateObj);
                                } else if (day.date) {
                                    // Fallback: create dateObj from date string
                                    day.dateObj = new Date(day.date);
                                }
                                return day;
                            });
                        }
                        console.log(`üì• Loaded ${itinerary ? itinerary.length : 0} itinerary days from API`);
                    } else {
                        console.warn('API not available, using cached itinerary');
                    }
                } catch (error) {
                    console.error('Error loading itinerary from API:', error);
                    // Continue with existing itinerary array
                }

                if (!itinerary || itinerary.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No itinerary days added yet</td></tr>';
                    return;
                }

                // Remove duplicates - keep only the first occurrence of each ID or day
                // Use a Map to track both by ID and by day number to catch all duplicates
                const seenById = new Set();
                const seenByDay = new Set();
                const uniqueItinerary = [];
                const duplicatesRemoved = [];

                itinerary.forEach(day => {
                    let isDuplicate = false;
                    
                    // Check by ID first (most reliable)
                    if (day.id) {
                        if (seenById.has(day.id)) {
                            isDuplicate = true;
                            duplicatesRemoved.push({ type: 'id', value: day.id, day: day });
                        } else {
                            seenById.add(day.id);
                        }
                    }
                    
                    // Also check by day number (in case IDs are missing or duplicated)
                    if (day.day !== undefined && day.day !== null) {
                        if (seenByDay.has(day.day)) {
                            // Only mark as duplicate if we haven't already marked it by ID
                            if (!isDuplicate) {
                                isDuplicate = true;
                                duplicatesRemoved.push({ type: 'day', value: day.day, day: day });
                            }
                        } else {
                            seenByDay.add(day.day);
                        }
                    }
                    
                    if (!isDuplicate) {
                        uniqueItinerary.push(day);
                    }
                });

                if (duplicatesRemoved.length > 0) {
                    console.warn(`‚ö†Ô∏è Removed ${duplicatesRemoved.length} duplicate itinerary entries:`, duplicatesRemoved);
                    showMessage(`‚ö†Ô∏è Removed ${duplicatesRemoved.length} duplicate itinerary entry(ies)`, 'warning');
                }

                // Update the itinerary array with deduplicated data
                itinerary = uniqueItinerary;

                // Sort by day number
                itinerary.sort((a, b) => a.day - b.day);

                itinerary.forEach(day => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600; color: var(--saffron); white-space: nowrap;">Day ${day.day}</td>
                        <td>${day.date}</td>
                        <td style="font-weight: 500;">${day.place}</td>
                        <td>${day.city}</td>
                        <td>${day.country}</td>
                        <td style="text-align: center;">${day.activities ? day.activities.length : 0}</td>
                        <td style="white-space: nowrap;">
                            <button class="action-btn btn-edit" onclick="editItinerary(${day.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn btn-delete" onclick="deleteItinerary(${day.id})" title="Delete">üóë</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error in loadItineraryTable:', error);
            } finally {
                // Always reset the loading flag
                isLoadingItineraryTable = false;
            }
        }

        // ==================== ENHANCED ACTIVITIES MANAGEMENT ====================
        
        let activityFieldCounter = 0;
        
        function addActivityField(time = '', place = '', description = '', imageUrl = '') {
            const container = document.getElementById('itineraryActivitiesContainer');
            const activityId = `activity_${activityFieldCounter++}`;
            
            const activityCard = document.createElement('div');
            activityCard.className = 'activity-field-card';
            activityCard.id = activityId;
            activityCard.style.cssText = 'background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid var(--saffron); position: relative;';
            
            activityCard.innerHTML = `
                <button type="button" onclick="removeActivityField('${activityId}')" 
                    style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; 
                    width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; line-height: 1;">
                    ‚úï
                </button>
                
                <div style="display: grid; grid-template-columns: 150px 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--navy);">Time</label>
                        <input type="text" class="activity-time" value="${escapeHTML(time)}" 
                            placeholder="2:00 PM" 
                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--navy);">Place/Activity Name</label>
                        <input type="text" class="activity-place" value="${escapeHTML(place)}" 
                            placeholder="E.g., BAPS Dadar Mandir" 
                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--navy);">Description</label>
                    <textarea class="activity-description" rows="2" 
                        placeholder="Brief description of what happens at this activity" 
                        style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px; resize: vertical;">${escapeHTML(description)}</textarea>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--navy);">Image URL or File Upload</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="url" class="activity-image-url" value="${escapeHTML(imageUrl)}" 
                            placeholder="https://example.com/image.jpg or leave blank to upload" 
                            style="flex: 1; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        <label style="background: var(--green); color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                            üìÅ Upload
                            <input type="file" class="activity-image-file" accept="image/*" onchange="handleActivityImageUpload(event, '${activityId}')" style="display: none;">
                        </label>
                    </div>
                    <div class="activity-image-preview" style="margin-top: 10px; display: none;">
                        <img style="max-width: 200px; max-height: 150px; border-radius: 5px; border: 2px solid var(--saffron);">
                    </div>
                </div>
            `;
            
            container.appendChild(activityCard);
        }
        window.addActivityField = addActivityField;
        
        function removeActivityField(activityId) {
            const card = document.getElementById(activityId);
            if (card) {
                // Ensure the card is removed from DOM completely
                if (card.parentElement) {
                    card.parentElement.removeChild(card);
                } else {
                    card.remove();
                }
                console.log(`‚úÖ Removed activity field: ${activityId}`);
            } else {
                console.warn(`‚ö†Ô∏è Activity field not found: ${activityId}`);
            }
        }
        window.removeActivityField = removeActivityField;
        
        async function handleActivityImageUpload(event, activityId) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const compressedImage = await compressImage(file, 800, 0.85);
                const card = document.getElementById(activityId);
                const urlInput = card.querySelector('.activity-image-url');
                const preview = card.querySelector('.activity-image-preview');
                const previewImg = preview.querySelector('img');
                
                urlInput.value = compressedImage;
                previewImg.src = compressedImage;
                preview.style.display = 'block';
                
                showMessage('‚úÖ Activity image uploaded successfully');
            } catch (error) {
                console.error('Image upload error:', error);
                showMessage('‚ùå Failed to upload image', 'error');
            }
        }
        
        function loadActivitiesIntoForm(activities) {
            const container = document.getElementById('itineraryActivitiesContainer');
            if (!container) {
                console.warn('‚ö†Ô∏è Activities container not found');
                return;
            }
            
            // Clear container completely to prevent duplication
            // Remove all child nodes
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            container.innerHTML = ''; // Double-clear to be safe
            
            // Reset activity counter to prevent ID conflicts
            activityFieldCounter = 0;
            
            // Deduplicate activities before loading
            const uniqueActivities = [];
            const seenActivities = new Set();
            
            if (activities && Array.isArray(activities) && activities.length > 0) {
                activities.forEach(activity => {
                    const time = activity.time || '';
                    const place = activity.place || activity.activity || '';
                    const description = activity.description || '';
                    const image = activity.image || '';
                    
                    // Create unique key
                    const activityKey = `${time}|${place}|${description}`;
                    
                    // Only add if not seen before
                    if (!seenActivities.has(activityKey)) {
                        seenActivities.add(activityKey);
                        uniqueActivities.push(activity);
                    } else {
                        console.warn('‚ö†Ô∏è Duplicate activity removed during load:', { time, place });
                    }
                });
            }
            
            if (uniqueActivities.length > 0) {
                uniqueActivities.forEach(activity => {
                    addActivityField(
                        activity.time || '',
                        activity.place || activity.activity || '',
                        activity.description || '',
                        activity.image || ''
                    );
                });
            } else {
                // Add one empty field by default
                addActivityField();
            }
            
            console.log(`‚úÖ Loaded ${uniqueActivities.length} unique activities into form`);
        }
        
        function collectActivitiesFromForm() {
            // Only query cards within the specific activities container to avoid duplicates
            const container = document.getElementById('itineraryActivitiesContainer');
            if (!container) {
                console.warn('‚ö†Ô∏è Activities container not found');
                return [];
            }
            
            // Only get cards that are direct children of the container
            const activityCards = container.querySelectorAll(':scope > .activity-field-card');
            const activities = [];
            const seenActivities = new Set(); // Track seen activities to prevent duplicates
            
            activityCards.forEach(card => {
                // Skip if card is not actually in the DOM or has been removed
                if (!card.parentElement || !container.contains(card)) {
                    return;
                }
                
                const time = card.querySelector('.activity-time')?.value.trim() || '';
                const place = card.querySelector('.activity-place')?.value.trim() || '';
                const description = card.querySelector('.activity-description')?.value.trim() || '';
                const imageUrl = card.querySelector('.activity-image-url')?.value.trim() || '';
                
                // At least time or place should be filled
                if (time || place) {
                    // Create a unique key for this activity to detect duplicates
                    const activityKey = `${time}|${place}|${description}`;
                    
                    // Only add if we haven't seen this exact activity before
                    if (!seenActivities.has(activityKey)) {
                        seenActivities.add(activityKey);
                        activities.push({
                            time: time,
                            activity: place,
                            place: place,
                            description: description,
                            image: imageUrl
                        });
                    } else {
                        console.warn('‚ö†Ô∏è Duplicate activity detected and skipped:', { time, place });
                    }
                }
            });
            
            console.log(`‚úÖ Collected ${activities.length} unique activities from form`);
            return activities;
        }
        
        // ==================== END ENHANCED ACTIVITIES MANAGEMENT ====================

        function openItineraryModal() {
            // Clear activities and images containers FIRST
            const activitiesContainer = document.getElementById('itineraryActivitiesContainer');
            if (activitiesContainer) {
                activitiesContainer.innerHTML = '';
            }
            const imagesContainer = document.getElementById('itineraryImagesContainer');
            if (imagesContainer) {
                imagesContainer.innerHTML = '';
            }
            
            // Reset activity counter for new entry
            activityFieldCounter = 0;
            
            // Reset form and clear ID for new entry
            const form = document.querySelector('#itineraryModal form');
            if (form) {
                form.reset();
            }
            const idField = document.getElementById('itineraryId');
            if (idField) {
                idField.value = '';
                console.log('‚úÖ Cleared itinerary ID for new entry');
            }
            
            document.getElementById('itineraryModalTitle').textContent = 'Add Itinerary Day';
            document.getElementById('itineraryModal').style.display = 'block';
            // Set next day number
            const nextDay = itinerary.length > 0 ? Math.max(...itinerary.map(d => d.day)) + 1 : 1;
            document.getElementById('itineraryDay').value = nextDay;
            
            // Add one empty activity field by default
            addActivityField();
            
            // Add one image input
            addItineraryImageInput();
            
            // Initialize with one empty activity field
            loadActivitiesIntoForm([]);
        }
        window.openItineraryModal = openItineraryModal;

        function closeItineraryModal() {
            const modal = document.getElementById('itineraryModal');
            if (modal) {
                modal.style.display = 'none';
                // Reset form and clear ID AFTER modal is closed
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                const idField = document.getElementById('itineraryId');
                if (idField) {
                    idField.value = '';
                }
                const imagesContainer = document.getElementById('itineraryImagesContainer');
                if (imagesContainer) {
                    imagesContainer.innerHTML = '';
                }
                const activitiesContainer = document.getElementById('itineraryActivitiesContainer');
                if (activitiesContainer) {
                    activitiesContainer.innerHTML = '';
                }
                // Reset modal title
                const title = document.getElementById('itineraryModalTitle');
                if (title) {
                    title.textContent = 'Add Itinerary Day';
                }
            }
        }
        window.closeItineraryModal = closeItineraryModal;

        let imageInputCounter = 0;

        function addItineraryImageInput() {
            const container = document.getElementById('itineraryImagesContainer');
            const inputId = `imageInput_${imageInputCounter++}`;
            
            const row = document.createElement('div');
            row.className = 'image-input-row';
            row.id = `row_${inputId}`;
            row.innerHTML = `
                <input type="url" id="${inputId}" placeholder="https://example.com/image.jpg" class="itinerary-image-input">
                <button type="button" class="delete-image-btn" onclick="removeItineraryImageInput('row_${inputId}')">‚úï</button>
            `;
            container.appendChild(row);
        }
        window.addItineraryImageInput = addItineraryImageInput;

        function removeItineraryImageInput(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
        }
        window.removeItineraryImageInput = removeItineraryImageInput;

        // ==================== ITINERARY CRUD OPERATIONS (MySQL Backend) ====================
        async function handleItinerarySubmit(event) {
            event.preventDefault();

            const idField = document.getElementById('itineraryId');
            const id = idField ? String(idField.value).trim() : '';
            
            // Debug logging
            console.log('üì§ Submitting itinerary form. ID field value:', id, 'Type:', typeof id, 'Is valid number:', !isNaN(parseInt(id)));
            
            // Collect activities from structured form
            const activities = collectActivitiesFromForm();
            
            if (activities.length === 0) {
                showMessage('‚ö†Ô∏è Please add at least one activity', 'error');
                return;
            }
            
            // Collect all image URLs
            const imageInputs = document.querySelectorAll('.itinerary-image-input');
            const images = Array.from(imageInputs)
                .map(input => input.value.trim())
                .filter(url => url !== '');

            const dayData = {
                day: parseInt(document.getElementById('itineraryDay').value),
                date: new Date(document.getElementById('itineraryDate').value).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }),
                dateObj: new Date(document.getElementById('itineraryDate').value),
                place: document.getElementById('itineraryPlace').value,
                city: document.getElementById('itineraryCity').value,
                state: document.getElementById('itineraryState').value,
                country: document.getElementById('itineraryCountry').value,
                lat: parseFloat(document.getElementById('itineraryLat').value),
                lng: parseFloat(document.getElementById('itineraryLng').value),
                description: document.getElementById('itineraryDescription').value,
                activities: activities,
                images: images
            };

            try {
            // Improved ID validation - check if ID exists and is a valid positive integer
            const parsedId = parseInt(id);
            const isValidId = id !== '' && !isNaN(parsedId) && parsedId > 0;
            
            if (isValidId) {
                    // Update existing itinerary day via API
                    console.log('üìù Updating itinerary day with ID:', parsedId);
                    if (typeof api !== 'undefined' && api.updateItineraryDay) {
                        await api.updateItineraryDay(parsedId, dayData);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/itinerary');
                        }
                        // Clear cache first
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/itinerary');
                        }
                        // Get fresh data from API (not from cache)
                        itinerary = await api.getItinerary();
                        showMessage('Itinerary day updated successfully! üéâ');
                    } else {
                        throw new Error('API not available');
                }
            } else {
                    // Add new itinerary day - ID is empty or invalid
                    console.log('‚ûï Creating new itinerary day (ID is empty or invalid)');
                    // Check for duplicate day number before creating
                    if (typeof api !== 'undefined' && api.getItinerary) {
                        // Clear cache to get fresh data
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/itinerary');
                        }
                        const existingItinerary = await api.getItinerary();
                        const duplicateDay = existingItinerary.find(d => d.day === dayData.day);
                        if (duplicateDay) {
                            showMessage(`‚ö†Ô∏è Day ${dayData.day} already exists! Please edit the existing entry or use a different day number.`, 'error');
                            return;
                        }
                    }
                    
                    // Add new itinerary day via API
                    if (typeof api !== 'undefined' && api.createItineraryDay) {
                        await api.createItineraryDay(dayData);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/itinerary');
                        }
                        // Get fresh data from API (not from cache)
                        itinerary = await api.getItinerary();
                        showMessage('Itinerary day added successfully! üéâ');
                    } else {
                        throw new Error('API not available');
                    }
                }
            } catch (error) {
                console.error('Error saving itinerary:', error);
                showMessage('Error saving itinerary. Please try again.', 'error');
                return;
            }
            
            closeItineraryModal();
            // Force reload table with cache cleared
            await loadItineraryTable();
        }

        // ==================== ITINERARY SYNC SYSTEM (MySQL Backend) ====================
        // Note: Itinerary is now saved directly via API in handleItinerarySubmit
        // This function is kept for backward compatibility but does minimal work
        async function saveItineraryAndSync() {
            // Itinerary is already saved via API in handleItinerarySubmit
            // Just set update timestamp for website sync
            try {
                if (typeof api !== 'undefined' && api.updateSetting) {
                    await api.updateSetting('itineraryLastUpdate', Date.now().toString());
                }
            } catch (error) {
                console.warn('Could not update itinerary timestamp:', error);
            }
            console.log('‚úÖ Itinerary saved and synced to website');
        }
        
        // ==================== END ITINERARY SYNC SYSTEM ====================


        function editItinerary(id) {
            const day = itinerary.find(d => d.id === id);
            if (!day) {
                console.error('‚ùå Itinerary day not found with ID:', id);
                return;
            }

            console.log('‚úèÔ∏è Editing itinerary day:', day);
            
            // Clear activities and images containers FIRST before resetting form
            const activitiesContainer = document.getElementById('itineraryActivitiesContainer');
            if (activitiesContainer) {
                activitiesContainer.innerHTML = '';
            }
            const imagesContainer = document.getElementById('itineraryImagesContainer');
            if (imagesContainer) {
                imagesContainer.innerHTML = '';
            }
            
            // Set ID FIRST before resetting form to ensure it's preserved
            const idField = document.getElementById('itineraryId');
            if (idField) {
                idField.value = String(day.id); // Ensure it's a string
                console.log('‚úÖ Set itinerary ID to:', day.id, '(type:', typeof idField.value, ')');
            }
            
            // Reset form AFTER setting ID (but hidden fields aren't affected by reset)
            const form = document.querySelector('#itineraryModal form');
            if (form) {
                form.reset();
                // Re-set the ID after reset to ensure it's not cleared
                if (idField) {
                    idField.value = String(day.id);
                }
            }
            
            document.getElementById('itineraryModalTitle').textContent = 'Edit Itinerary Day';
            document.getElementById('itineraryDay').value = day.day;
            
            // Safely convert dateObj to Date and format for input
            let dateValue = '';
            if (day.dateObj) {
                const dateObj = day.dateObj instanceof Date ? day.dateObj : new Date(day.dateObj);
                if (!isNaN(dateObj.getTime())) {
                    dateValue = dateObj.toISOString().split('T')[0];
                }
            }
            // Fallback to date string if dateObj is not available
            if (!dateValue && day.date) {
                // Try to parse the date string
                const parsedDate = new Date(day.date);
                if (!isNaN(parsedDate.getTime())) {
                    dateValue = parsedDate.toISOString().split('T')[0];
                }
            }
            document.getElementById('itineraryDate').value = dateValue;
            document.getElementById('itineraryPlace').value = day.place;
            document.getElementById('itineraryCity').value = day.city;
            document.getElementById('itineraryState').value = day.state || '';
            document.getElementById('itineraryCountry').value = day.country;
            document.getElementById('itineraryLat').value = day.lat;
            document.getElementById('itineraryLng').value = day.lng;
            document.getElementById('itineraryDescription').value = day.description || '';
            
            // Load activities into structured form
            loadActivitiesIntoForm(day.activities || []);
            
            // Populate image inputs
            const container = document.getElementById('itineraryImagesContainer');
            container.innerHTML = '';
            
            if (day.images && day.images.length > 0) {
                day.images.forEach(url => {
                    const inputId = `imageInput_${imageInputCounter++}`;
                    const row = document.createElement('div');
                    row.className = 'image-input-row';
                    row.id = `row_${inputId}`;
                    row.innerHTML = `
                        <input type="url" id="${inputId}" value="${escapeHTML(url)}" placeholder="https://example.com/image.jpg" class="itinerary-image-input">
                        <button type="button" class="delete-image-btn" onclick="removeItineraryImageInput('row_${inputId}')">‚úï</button>
                    `;
                    container.appendChild(row);
                });
            } else {
                addItineraryImageInput();
            }

            document.getElementById('itineraryModal').style.display = 'block';
        }
        window.editItinerary = editItinerary;

        async function deleteItinerary(id) {
            if (!confirm('Are you sure you want to delete this itinerary day?')) {
                return;
            }
            
            try {
                // Delete via API
                if (typeof api !== 'undefined' && api.deleteItineraryDay) {
                    await api.deleteItineraryDay(id);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('/itinerary');
                    }
                    // Get fresh data from API (not from cache)
                    itinerary = await api.getItinerary();
                    showMessage('Itinerary day deleted successfully');
                } else {
                    throw new Error('API not available');
            }
            } catch (error) {
                console.error('Error deleting itinerary:', error);
                showMessage('Error deleting itinerary. Please try again.', 'error');
                return;
        }
            
            loadItineraryTable();
        }
        window.deleteItinerary = deleteItinerary;

        // ==================== EXCEL BULK UPLOAD ====================
        
        let parsedItineraryData = [];
        
        function openItineraryExcelUpload() {
            document.getElementById('itineraryExcelModal').style.display = 'flex';
            document.getElementById('excelUploadStep').style.display = 'block';
            document.getElementById('excelPreviewStep').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
        }
        
        function closeItineraryExcelModal() {
            document.getElementById('itineraryExcelModal').style.display = 'none';
            document.getElementById('itineraryExcelFile').value = '';
            parsedItineraryData = [];
        }
        
        async function handleItineraryExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('‚ùå Please upload an Excel file (.xlsx or .xls)');
                return;
            }
            
            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                // Read file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet);
                
                if (rows.length === 0) {
                    throw new Error('Excel file is empty');
                }
                
                // Validate columns
                const firstRow = rows[0];
                const requiredColumns = ['Day', 'Date', 'Time', 'Activity', 'Location'];
                const missingColumns = requiredColumns.filter(col => !(col in firstRow));
                
                if (missingColumns.length > 0) {
                    throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
                }
                
                // Process rows
                await processItineraryExcel(rows);
                
            } catch (error) {
                document.getElementById('uploadProgress').style.display = 'none';
                alert('‚ùå Error processing Excel file: ' + error.message);
                console.error(error);
            }
        }
        
        async function processItineraryExcel(rows) {
            // Group rows by Day and Date
            const grouped = {};
            
            rows.forEach(row => {
                const dayNum = extractDayNumber(row.Day);
                const dateStr = parseDateString(row.Date);
                const key = `${dayNum}_${dateStr}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        day: dayNum,
                        date: dateStr,
                        location: row.Location || '',
                        activities: []
                    };
                }
                
                grouped[key].activities.push({
                    time: normalizeTime(row.Time),
                    place: row.Location || '',
                    description: row.Activity || ''
                });
            });
            
            // Convert to itinerary format
            parsedItineraryData = [];
            const groupValues = Object.values(grouped);
            
            // Process each day with geocoding
            for (let i = 0; i < groupValues.length; i++) {
                const group = groupValues[i];
                
                // Sort activities by time
                group.activities.sort((a, b) => parseTimeForSort(a.time) - parseTimeForSort(b.time));
                
                // Get location details from first activity
                const firstLocation = group.activities[0].place;
                
                // Auto-geocode location (with delay to respect API limits)
                if (i > 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                }
                const locationData = await geocodeLocation(firstLocation);
                
                parsedItineraryData.push({
                    id: Date.now() + i,
                    day: group.day,
                    date: group.date,
                    place: firstLocation,
                    city: locationData.city || extractCity(firstLocation),
                    state: locationData.state || '',
                    country: locationData.country || 'India',
                    lat: locationData.lat || 0,
                    lng: locationData.lng || 0,
                    description: `Day ${group.day} - ${firstLocation}`,
                    activities: group.activities.map(a => ({
                        time: a.time,
                        place: a.place,
                        description: a.description,
                        image: ''
                    })),
                    images: []
                });
            }
            
            // Show preview
            showItineraryPreview();
        }
        
        function extractDayNumber(dayStr) {
            if (typeof dayStr === 'number') return dayStr;
            const match = String(dayStr).match(/\d+/);
            return match ? parseInt(match[0]) : 1;
        }
        
        function parseDateString(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            // Try parsing different date formats
            let date;
            
            // Format: "14 Mar 2025" or "14 March 2025"
            const monthNames = {
                'jan': 0, 'january': 0,
                'feb': 1, 'february': 1,
                'mar': 2, 'march': 2,
                'apr': 3, 'april': 3,
                'may': 4,
                'jun': 5, 'june': 5,
                'jul': 6, 'july': 6,
                'aug': 7, 'august': 7,
                'sep': 8, 'september': 8,
                'oct': 9, 'october': 9,
                'nov': 10, 'november': 10,
                'dec': 11, 'december': 11
            };
            
            const strDate = String(dateStr).toLowerCase().trim();
            const parts = strDate.split(/[\s,/-]+/);
            
            if (parts.length >= 3) {
                const day = parseInt(parts[0]);
                const monthStr = parts[1].toLowerCase();
                const year = parseInt(parts[2]);
                
                if (monthNames.hasOwnProperty(monthStr)) {
                    date = new Date(year, monthNames[monthStr], day);
                }
            }
            
            // Fallback: try standard Date parsing
            if (!date || isNaN(date.getTime())) {
                date = new Date(dateStr);
            }
            
            // Format as YYYY-MM-DD
            if (date && !isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return new Date().toISOString().split('T')[0];
        }
        
        function normalizeTime(timeStr) {
            if (!timeStr) return '12:00 PM';
            
            let str = String(timeStr).trim().toUpperCase();
            
            // Handle formats like "5:00 am", "17:00", "5 am"
            const match = str.match(/(\d+):?(\d+)?\s*(AM|PM)?/i);
            
            if (match) {
                let hours = parseInt(match[1]);
                let minutes = match[2] ? parseInt(match[2]) : 0;
                let period = match[3] || '';
                
                // Convert 24-hour to 12-hour
                if (!period && hours > 12) {
                    period = 'PM';
                    hours = hours - 12;
                } else if (!period && hours === 0) {
                    hours = 12;
                    period = 'AM';
                } else if (!period) {
                    period = hours >= 12 ? 'PM' : 'AM';
                    if (hours > 12) hours -= 12;
                }
                
                if (hours === 0) hours = 12;
                
                return `${hours}:${String(minutes).padStart(2, '0')} ${period}`;
            }
            
            return timeStr;
        }
        
        function parseTimeForSort(timeStr) {
            const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
            if (!match) return 0;
            
            let hours = parseInt(match[1]);
            const minutes = parseInt(match[2]);
            const period = match[3].toUpperCase();
            
            if (period === 'PM' && hours !== 12) hours += 12;
            if (period === 'AM' && hours === 12) hours = 0;
            
            return hours * 60 + minutes;
        }
        
        function extractCity(locationStr) {
            if (!locationStr) return '';
            
            // If comma-separated, take last part as city
            const parts = locationStr.split(',').map(p => p.trim());
            if (parts.length > 1) {
                return parts[parts.length - 1];
            }
            
            return locationStr;
        }
        
        async function geocodeLocation(locationName) {
            if (!locationName) {
                return {lat: 0, lng: 0, city: '', state: '', country: 'India'};
            }
            
            try {
                // Use Nominatim (OpenStreetMap) geocoding API
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationName)}&format=json&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'YatraItineraryApp/1.0'
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Geocoding failed');
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const result = data[0];
                    
                    // Parse address components
                    const address = result.address || {};
                    
                    return {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon),
                        city: address.city || address.town || address.village || '',
                        state: address.state || '',
                        country: address.country || 'India'
                    };
                }
            } catch (error) {
                console.warn('Geocoding error for', locationName, error);
            }
            
            // Return defaults if geocoding fails
            return {
                lat: 0,
                lng: 0,
                city: extractCity(locationName),
                state: '',
                country: 'India'
            };
        }
        
        function showItineraryPreview() {
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('excelUploadStep').style.display = 'none';
            document.getElementById('excelPreviewStep').style.display = 'block';
            
            const container = document.getElementById('previewContainer');
            container.innerHTML = '';
            
            parsedItineraryData.forEach((day, index) => {
                const dayCard = document.createElement('div');
                dayCard.style.cssText = 'background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid var(--saffron);';
                
                dayCard.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">Day Number</label>
                            <input type="number" value="${day.day}" onchange="updateParsedDay(${index}, 'day', this.value)" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">Date</label>
                            <input type="date" value="${day.date}" onchange="updateParsedDay(${index}, 'date', this.value)" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">Place</label>
                            <input type="text" value="${escapeHTML(day.place)}" onchange="updateParsedDay(${index}, 'place', this.value)" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">City</label>
                            <input type="text" value="${escapeHTML(day.city)}" onchange="updateParsedDay(${index}, 'city', this.value)" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">State</label>
                            <input type="text" value="${escapeHTML(day.state)}" onchange="updateParsedDay(${index}, 'state', this.value)" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">Country</label>
                            <input type="text" value="${escapeHTML(day.country)}" onchange="updateParsedDay(${index}, 'country', this.value)" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">Latitude</label>
                            <input type="number" step="any" value="${day.lat}" onchange="updateParsedDay(${index}, 'lat', parseFloat(this.value))" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">Longitude</label>
                            <input type="number" step="any" value="${day.lng}" onchange="updateParsedDay(${index}, 'lng', parseFloat(this.value))" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 5px;">Description</label>
                        <textarea onchange="updateParsedDay(${index}, 'description', this.value)" 
                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px; resize: vertical;" rows="2">${escapeHTML(day.description)}</textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 10px;">Activities (${day.activities.length})</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${day.activities.map((activity, actIdx) => `
                                <div style="background: white; padding: 10px; border-radius: 5px; display: flex; gap: 10px; align-items: start;">
                                    <input type="text" value="${escapeHTML(activity.time)}" onchange="updateParsedActivity(${index}, ${actIdx}, 'time', this.value)" 
                                        placeholder="Time" style="width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                    <input type="text" value="${escapeHTML(activity.place)}" onchange="updateParsedActivity(${index}, ${actIdx}, 'place', this.value)" 
                                        placeholder="Place" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                    <input type="text" value="${escapeHTML(activity.description)}" onchange="updateParsedActivity(${index}, ${actIdx}, 'description', this.value)" 
                                        placeholder="Description" style="flex: 2; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(dayCard);
            });
        }
        
        function updateParsedDay(index, field, value) {
            if (parsedItineraryData[index]) {
                parsedItineraryData[index][field] = value;
            }
        }
        
        function updateParsedActivity(dayIndex, activityIndex, field, value) {
            if (parsedItineraryData[dayIndex] && parsedItineraryData[dayIndex].activities[activityIndex]) {
                parsedItineraryData[dayIndex].activities[activityIndex][field] = value;
            }
        }
        
        // ==================== ITINERARY EXCEL UPLOAD SAVE (MySQL Backend) ====================
        async function saveItineraryFromExcel() {
            if (parsedItineraryData.length === 0) {
                alert('‚ùå No data to save');
                return;
            }
            
            // Check if API is available
            if (typeof api === 'undefined' || !api.createItineraryDay || !api.updateItineraryDay) {
                showMessage('‚ùå API not available. Please start the backend server.', 'error');
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                // Load current itinerary to check for existing days
                const currentItinerary = await api.getItinerary();
                
                // Process each day from Excel
                for (const newDay of parsedItineraryData) {
                    try {
                        // Find existing day with same day number
                        const existingDay = currentItinerary.find(d => d.day === newDay.day);
                        
                        // Prepare day data (remove id for new entries)
                        const dayData = {
                            day: newDay.day,
                            date: newDay.date,
                            dateObj: newDay.dateObj,
                            place: newDay.place,
                            city: newDay.city,
                            state: newDay.state || '',
                            country: newDay.country,
                            lat: newDay.lat,
                            lng: newDay.lng,
                            description: newDay.description || '',
                            activities: newDay.activities || [],
                            images: newDay.images || []
                        };
                        
                        if (existingDay) {
                            // Update existing day via API
                            await api.updateItineraryDay(existingDay.id, dayData);
                } else {
                            // Create new day via API
                            await api.createItineraryDay(dayData);
                        }
                        
                        successCount++;
                        
                        // Small delay to avoid overwhelming the API
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (err) {
                        console.error('Error saving itinerary day from Excel:', err);
                        errorCount++;
                    }
                }
                
                // Clear cache and reload
                if (api.clearCacheFor) {
                    api.clearCacheFor('/itinerary');
                }
                itinerary = await api.getItinerary();
                
                // Update timestamp
                if (api.updateSetting) {
                    await api.updateSetting('itineraryLastUpdate', Date.now().toString());
                }
                
                // Refresh UI
            loadItineraryTable();
            closeItineraryExcelModal();
            
                showMessage(`‚úÖ Successfully imported ${successCount} itinerary days! ${errorCount > 0 ? `(${errorCount} errors)` : ''}`);
            } catch (error) {
                console.error('Error saving itinerary from Excel:', error);
                showMessage('‚ùå Error saving itinerary. Please try again.', 'error');
            }
        }

        // Settings
        function uploadHeaderImage(event, type) {
            const file = event.target.files[0];
            if (file) {
                // Compress header images to save space
                compressImage(file, (compressedUrl) => {
                    if (compressedUrl) {
                        headerImages[type] = compressedUrl;
                        updateHeaderImagesGrid();
                        showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} header image uploaded and compressed! Click 'Save' to apply changes. üì∑`);
                    } else {
                        showMessage('Error processing header image. Please try again.', 'error');
                    }
                });
            }
        }

        function updateHeaderImagesGrid() {
            const grid = document.getElementById('headerImagesGrid');
            if (!grid) return;
            
            grid.innerHTML = '';

            Object.keys(headerImages).forEach(type => {
                if (headerImages[type]) {
                    const card = document.createElement('div');
                    card.style.cssText = 'position: relative; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);';
                    card.innerHTML = `
                        <div style="position: absolute; top: 10px; left: 10px; background: var(--saffron); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; z-index: 1;">
                            ${type.charAt(0).toUpperCase() + type.slice(1)} View
                        </div>
                        <button onclick="removeHeaderImage('${type}')" style="position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; background: #dc3545; border: none; border-radius: 50%; color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            √ó
                        </button>
                        <img src="${headerImages[type]}" style="width: 100%; height: 150px; object-fit: cover;">
                    `;
                    grid.appendChild(card);
                }
            });
        }

        function removeHeaderImage(type) {
            if (confirm('Remove this header image?')) {
                headerImages[type] = null;
                updateHeaderImagesGrid();
                showMessage('Header image removed. Click \'Save\' to apply changes.');
            }
        }
        
        async function saveHeaderImages() {
            try {
                console.log('üíæ Saving header images to database...');
                console.log('üì∏ Current headerImages:', headerImages);
                
                // Verify we have at least one image
                if (!headerImages.desktop && !headerImages.mobile) {
                    showMessage('Please upload at least one header image before saving.', 'error');
                    return;
                }
                
                // Save header images to database via API
                // The backend will automatically detect it's an object and save as JSON type
                console.log('üì§ Sending to API...');
                const result = await api.updateSetting('headerImages', headerImages);
                console.log('üì¶ API response:', result);
                
                // Verify the save worked by immediately fetching it back
                console.log('üîç Verifying save by fetching back...');
                const verifyResult = await api.getSetting('headerImages');
                console.log('‚úÖ Verification - header images in database:', verifyResult);
                
                // Also clear API cache to force refresh
                if (typeof api !== 'undefined' && api.clearCacheFor) {
                    api.clearCacheFor('settings');
                }
                
                console.log('‚úÖ Header images saved successfully to database');
                showMessage('‚úÖ Header images saved successfully! Changes applied to website.');
            } catch (error) {
                console.error('‚ùå Error saving header images:', error);
                console.error('‚ùå Error details:', error.message);
                console.error('‚ùå Full error:', error);
                showMessage(`Failed to save header images: ${error.message}. Please check console for details.`, 'error');
            }
        }
        
        async function loadHeaderImages() {
            try {
                console.log('üì• Loading header images from database...');
                // Load header images from API
                const result = await api.getSetting('headerImages');
                console.log('üì¶ Header images from API:', result);
                
                if (result && result.value) {
                    // Merge with existing, but prioritize database values
                    headerImages = { desktop: null, mobile: null, ...result.value };
                    updateHeaderImagesGrid();
                    console.log('‚úÖ Header images loaded from database:', headerImages);
                } else {
                    console.log('‚ÑπÔ∏è No header images found in database, keeping current state');
                    // Don't reset if we already have images loaded
                    if (!headerImages.desktop && !headerImages.mobile) {
                        headerImages = { desktop: null, mobile: null };
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error loading header images from API:', error);
                // If setting doesn't exist yet, use empty object
                headerImages = { desktop: null, mobile: null };
                console.log('‚ÑπÔ∏è Using empty header images state');
            }
        }

        // Alarm Functions
        async function setWakeUpAlarm() {
            try {
                const alarmData = {
                    wakeUpTime: document.getElementById('wakeUpTime').value,
                    alarmMessage: document.getElementById('alarmMessage').value,
                    alarmEnabled: document.getElementById('alarmEnabled').checked
                };
                
                console.log('üíæ Saving alarm settings to database:', alarmData);
                
                // Save to database via API
                await api.updateSettings(alarmData);
                
                // Verify the save worked
                const verifyResult = await api.getSettings();
                console.log('‚úÖ Alarm settings saved and verified:', {
                    wakeUpTime: verifyResult.wakeUpTime,
                    alarmEnabled: verifyResult.alarmEnabled
                });
                
                showMessage('Wake-up alarm set successfully! üîî');
            } catch (error) {
                console.error('‚ùå Error saving alarm settings:', error);
                showMessage(`Failed to save alarm settings: ${error.message}. Please try again.`, 'error');
            }
        }

        async function testAlarm() {
            try {
                const message = document.getElementById('alarmMessage').value;
                const alarmData = {
                    wakeUpTime: new Date().toTimeString().slice(0, 5),
                    alarmMessage: message,
                    alarmEnabled: true,
                    alarmTest: true,
                    alarmTestTimestamp: Date.now()
                };
                
                // Save test alarm to database via API
                await api.updateSettings(alarmData);
                
                showMessage('Test alarm triggered! Check traveler devices. üîî', 'info');
            } catch (error) {
                console.error('Error triggering test alarm:', error);
                showMessage('Failed to trigger test alarm. Please try again.', 'error');
            }
        }

        async function loadAlarmSettings() {
            try {
                // Load alarm settings from API
                const apiSettings = await api.getSettings();
                
                if (apiSettings.wakeUpTime) {
                    document.getElementById('wakeUpTime').value = apiSettings.wakeUpTime;
                } else {
                    document.getElementById('wakeUpTime').value = '06:00';
                }
                
                if (apiSettings.alarmMessage) {
                    document.getElementById('alarmMessage').value = apiSettings.alarmMessage;
                } else {
                    document.getElementById('alarmMessage').value = 'Good morning travelers! üåÖ Time to wake up and prepare for today\'s journey!';
                }
                
                document.getElementById('alarmEnabled').checked = apiSettings.alarmEnabled !== false;
            } catch (error) {
                console.warn('Error loading alarm settings from API:', error);
                // Use default values if API fails
                if (settings.wakeUpTime) {
                    document.getElementById('wakeUpTime').value = settings.wakeUpTime;
                }
                if (settings.alarmMessage) {
                    document.getElementById('alarmMessage').value = settings.alarmMessage;
                }
                document.getElementById('alarmEnabled').checked = settings.alarmEnabled !== false;
            }
        }

        async function saveSettings() {
            try {
                const settingsData = {
                    yatraTitle: document.getElementById('yatraTitle').value,
                    startLocation: document.getElementById('startLocation').value,
                    destination: document.getElementById('destination').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    topContributorsCount: parseInt(document.getElementById('topContributorsCount').value) || 5
                };

                // Save to database via API
                await api.updateSettings(settingsData);
                
                // Update local settings object
                Object.assign(settings, settingsData);

                console.log('Settings saved:', settingsData);
                showMessage('Settings saved successfully! üéâ');
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('Failed to save settings. Please try again.', 'error');
            }
        }
        
        async function loadSettings() {
            try {
                // Load settings from API
                const apiSettings = await api.getSettings();
                
                // Update local settings object
                Object.assign(settings, apiSettings);
                
                // Load into form fields
                if (apiSettings.yatraTitle) {
                    document.getElementById('yatraTitle').value = apiSettings.yatraTitle;
                }
                if (apiSettings.startLocation) {
                    document.getElementById('startLocation').value = apiSettings.startLocation;
                }
                if (apiSettings.destination) {
                    document.getElementById('destination').value = apiSettings.destination;
                }
                if (apiSettings.startDate) {
                    document.getElementById('startDate').value = apiSettings.startDate;
                }
                if (apiSettings.endDate) {
                    document.getElementById('endDate').value = apiSettings.endDate;
                }
                if (apiSettings.topContributorsCount) {
                    document.getElementById('topContributorsCount').value = apiSettings.topContributorsCount;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                // Use default values if API fails
                if (settings.yatraTitle) {
                    document.getElementById('yatraTitle').value = settings.yatraTitle;
                }
                if (settings.startLocation) {
                    document.getElementById('startLocation').value = settings.startLocation;
                }
                if (settings.destination) {
                    document.getElementById('destination').value = settings.destination;
                }
                if (settings.startDate) {
                    document.getElementById('startDate').value = settings.startDate;
                }
                if (settings.endDate) {
                    document.getElementById('endDate').value = settings.endDate;
                }
                if (settings.topContributorsCount) {
                    document.getElementById('topContributorsCount').value = settings.topContributorsCount;
                }
            }
        }

        // Utility Functions
        function showMessage(message, type = 'success') {
            const msgDiv = document.getElementById('successMessage');
            msgDiv.textContent = message;
            msgDiv.style.background = type === 'error' ? '#dc3545' : (type === 'info' ? '#007bff' : 'var(--green)');
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 3000);
        }

        // Admin Post Creation Functions
        let adminSelectedMedia = [];
        let adminSelectedTags = [];
        
        // Admin location tracking
        let adminCurrentLocation = {
            lat: null,
            lng: null,
            accuracy: null,
            lastUpdated: null,
            permissionGranted: false
        };

        // Make openAdminPostModal globally accessible
        window.openAdminPostModal = function openAdminPostModal() {
            try {
                const modal = document.getElementById('adminPostModal');
                if (!modal) {
                    console.error('adminPostModal element not found');
                    return;
                }
                modal.style.display = 'block';
                if (typeof adminSelectedMedia !== 'undefined') {
                    adminSelectedMedia = [];
                }
                if (typeof adminSelectedTags !== 'undefined') {
                    adminSelectedTags = [];
                }
                
                // Populate tags
                if (typeof renderAdminTags === 'function') {
                    renderAdminTags();
                }
            } catch (error) {
                console.error('Error in openAdminPostModal:', error);
            }
        };

        function closeAdminPostModal() {
            document.getElementById('adminPostModal').style.display = 'none';
            document.querySelector('#adminPostModal form').reset();
            adminSelectedMedia = [];
            adminSelectedTags = [];
            document.getElementById('adminMediaPreviewContainer').innerHTML = '';
            // Clear size display
            const sizeDisplay = document.getElementById('mediaSizeDisplay');
            if (sizeDisplay) {
                sizeDisplay.remove();
            }
        }

        function renderAdminTags() {
            const container = document.getElementById('adminTagsContainer');
            if (tags.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: #999; font-size: 0.85rem;">No tags available. Add tags in Tags section first.</div>';
                return;
            }
            container.innerHTML = tags.map(tag => `
                <label style="display: inline-flex; align-items: center; gap: 5px; padding: 8px 15px; background: white; border: 2px solid var(--navy); border-radius: 20px; cursor: pointer; transition: all 0.3s ease;">
                    <input type="checkbox" value="${tag}" onchange="toggleAdminTag('${tag}')" style="cursor: pointer;">
                    <span style="font-weight: 500;">${tag}</span>
                </label>
            `).join('');
        }

        function toggleAdminTag(tagName) {
            const index = adminSelectedTags.indexOf(tagName);
            if (index > -1) {
                adminSelectedTags.splice(index, 1);
            } else {
                adminSelectedTags.push(tagName);
            }
        }

        function handleAdminMediaUpload(event) {
            const files = Array.from(event.target.files);
            const container = document.getElementById('adminMediaPreviewContainer');
            
            // Maximum file sizes (in bytes) - stricter limits
            const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB per image (will be compressed)
            const MAX_VIDEO_SIZE = 2 * 1024 * 1024; // 2MB per video (reduced - videos are huge as base64)
            const MAX_TOTAL_SIZE = 1 * 1024 * 1024; // 1MB total payload limit (very strict)
            const MAX_IMAGES = 4; // Maximum 4 images
            const MAX_VIDEOS = 1; // Maximum 1 video
            
            // Count existing media
            const imageCount = adminSelectedMedia.filter(m => m.type === 'image').length;
            const videoCount = adminSelectedMedia.filter(m => m.type === 'video').length;
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    // Check image count limit
                    if (imageCount >= MAX_IMAGES) {
                        showMessage(`‚ö†Ô∏è Maximum ${MAX_IMAGES} images allowed. Please remove some images first.`, 'error');
                        return;
                    }
                    
                    // Check image size
                    if (file.size > MAX_IMAGE_SIZE) {
                        showMessage(`‚ö†Ô∏è Image "${file.name}" is too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Max size: 10MB. Please use a smaller image.`, 'error');
                        return;
                    }
                    
                    // Compress image before upload
                    compressImage(file, (compressedDataUrl) => {
                        // Check actual compressed size
                        const compressedSize = (compressedDataUrl.length * 3) / 4;
                        if (compressedSize > 300 * 1024) { // 300KB limit per compressed image
                            showMessage(`‚ö†Ô∏è Image "${file.name}" is still too large after compression (${(compressedSize / 1024).toFixed(2)}KB). Please use a smaller or simpler image.`, 'error');
                            return;
                        }
                        
                        adminSelectedMedia.push({
                            type: 'image',
                            url: compressedDataUrl,
                            name: file.name
                        });
                        
                        const preview = document.createElement('div');
                        preview.style.cssText = 'position: relative; width: 100px; height: 100px;';
                        preview.innerHTML = `
                            <img src="${compressedDataUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            <button type="button" onclick="removeAdminMedia(${adminSelectedMedia.length - 1})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold;">‚úï</button>
                        `;
                        container.appendChild(preview);
                        
                        // Check total payload size
                        checkTotalPayloadSize();
                    });
                } else if (file.type.startsWith('video/')) {
                    // Check video count limit
                    if (videoCount >= MAX_VIDEOS) {
                        showMessage(`‚ö†Ô∏è Maximum ${MAX_VIDEOS} video allowed. Please remove the existing video first.`, 'error');
                        return;
                    }
                    
                    // Check video size - videos as base64 are VERY large
                    if (file.size > MAX_VIDEO_SIZE) {
                        showMessage(`‚ö†Ô∏è Video "${file.name}" is too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Max size: 2MB. Videos are converted to base64 which makes them ~33% larger. Please use a smaller video or upload to a video hosting service (YouTube, Vimeo) and use the URL instead.`, 'error');
                        return;
                    }
                    
                    // Warn user about video size
                    const estimatedBase64Size = file.size * 1.33; // Base64 is ~33% larger
                    if (estimatedBase64Size > 500 * 1024) { // 500KB limit
                        const proceed = confirm(`‚ö†Ô∏è Warning: This video will be ${(estimatedBase64Size / 1024).toFixed(2)}KB when converted to base64. This uses a lot of space. Consider using a video URL instead. Continue anyway?`);
                        if (!proceed) {
                            return;
                        }
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        adminSelectedMedia.push({
                            type: 'video',
                            url: e.target.result,
                            name: file.name
                        });
                        
                        const preview = document.createElement('div');
                        preview.style.cssText = 'position: relative; width: 100px; height: 100px;';
                        preview.innerHTML = `
                            <video src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></video>
                            <button type="button" onclick="removeAdminMedia(${adminSelectedMedia.length - 1})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold;">‚úï</button>
                        `;
                        container.appendChild(preview);
                        
                        // Check total payload size
                        checkTotalPayloadSize();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Check total payload size and warn if too large
        function checkTotalPayloadSize() {
            let totalSize = 0;
            adminSelectedMedia.forEach(media => {
                if (media.url) {
                    // Calculate actual base64 size
                    const base64Length = media.url.length;
                    const actualBytes = (base64Length * 3) / 4;
                    totalSize += actualBytes;
                }
            });
            
            const totalKB = totalSize / 1024;
            const totalMB = totalSize / 1024 / 1024;
            
            // Show size in preview
            const sizeDisplay = document.getElementById('mediaSizeDisplay');
            if (!sizeDisplay) {
                const container = document.getElementById('adminMediaPreviewContainer');
                if (container && container.parentElement) {
                    const display = document.createElement('div');
                    display.id = 'mediaSizeDisplay';
                    display.style.cssText = 'margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 5px; font-size: 0.9rem; color: #666;';
                    container.parentElement.insertBefore(display, container.nextSibling);
                }
            }
            
            if (sizeDisplay) {
                const color = totalKB > 800 ? '#ff9800' : totalKB > 600 ? '#ffc107' : '#4caf50';
                sizeDisplay.innerHTML = `üìä Total media size: <strong style="color: ${color};">${totalKB.toFixed(2)}KB</strong> ${totalKB > 800 ? '‚ö†Ô∏è (May be too large!)' : totalKB > 600 ? '‚ö†Ô∏è (Getting large)' : '‚úÖ (OK)'}`;
            }
            
            if (totalKB > 900) {
                showMessage(`‚ö†Ô∏è Total media size: ${totalKB.toFixed(2)}KB (${totalMB.toFixed(2)}MB). This is likely too large! Please remove some media.`, 'error');
            } else if (totalKB > 700) {
                showMessage(`‚ö†Ô∏è Total media size: ${totalKB.toFixed(2)}KB. This may be too large. Consider removing some media.`, 'warning');
            }
        }

        // Unified compressImage - handles both callback and Promise patterns
        function compressImage(file, maxWidthOrCallback, qualityOrUndefined) {
            // If second parameter is a function, use callback pattern
            if (typeof maxWidthOrCallback === 'function') {
                const callback = maxWidthOrCallback;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Much smaller dimensions to ensure small payload (800x600 max)
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 600;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions maintaining aspect ratio
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = height * (MAX_WIDTH / width);
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = width * (MAX_HEIGHT / height);
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Much lower quality (0.5) to ensure small file size
                    let quality = 0.5;
                    let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    // Check size and progressively reduce quality if needed
                    let sizeInBytes = (compressedDataUrl.length * 3) / 4;
                    let attempts = 0;
                    const maxAttempts = 3;
                    
                    while (sizeInBytes > 200 * 1024 && attempts < maxAttempts) { // Target: 200KB per image
                        quality -= 0.1;
                        if (quality < 0.3) quality = 0.3; // Don't go below 0.3
                        compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        sizeInBytes = (compressedDataUrl.length * 3) / 4;
                        attempts++;
                    }
                    
                    console.log(`üì∏ Image compressed: ${(sizeInBytes / 1024).toFixed(2)}KB at quality ${quality.toFixed(2)}`);
                    if (callback && typeof callback === 'function') {
                        callback(compressedDataUrl);
                    }
                };
                img.onerror = () => {
                    console.error('Failed to load image for compression');
                    if (callback && typeof callback === 'function') {
                        callback(null);
                    }
                };
                img.src = e.target.result;
            };
            reader.onerror = () => {
                console.error('Failed to read file');
                if (callback && typeof callback === 'function') {
                    callback(null);
                }
            };
            reader.readAsDataURL(file);
            return; // Exit early for callback pattern
            }
            
            // Promise pattern - second parameter is NOT a function
            const maxWidth = maxWidthOrCallback || 800;
            const quality = qualityOrUndefined || 0.85;
            
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    reject(new Error('File is not an image'));
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    reject(new Error('Image too large (max 10MB)'));
                    return;
                }

                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.onload = (e) => {
                    const img = new Image();
                    img.onerror = () => reject(new Error('Invalid image file'));
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = Math.floor((height * maxWidth) / width);
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob(
                                (blob) => {
                                    const reader = new FileReader();
                                    reader.onload = (e) => resolve(e.target.result);
                                    reader.onerror = () => reject(new Error('Compression failed'));
                                    reader.readAsDataURL(blob);
                                },
                                'image/jpeg',
                                quality
                            );
                        } catch (error) {
                            reject(error);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function removeAdminMedia(index) {
            adminSelectedMedia.splice(index, 1);
            const container = document.getElementById('adminMediaPreviewContainer');
            container.innerHTML = '';
            adminSelectedMedia.forEach((media, idx) => {
                const preview = document.createElement('div');
                preview.style.cssText = 'position: relative; width: 100px; height: 100px;';
                
                if (media.type === 'image') {
                    preview.innerHTML = `
                        <img src="${media.url || media.data}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        <button type="button" onclick="removeAdminMedia(${idx})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold;">‚úï</button>
                    `;
                } else {
                    preview.innerHTML = `
                        <video src="${media.url || media.data}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></video>
                        <button type="button" onclick="removeAdminMedia(${idx})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold;">‚úï</button>
                    `;
                }
                container.appendChild(preview);
            });
            // Recheck payload size after removal
            checkTotalPayloadSize();
        }

        function handleAdminPostSubmit(event) {
            event.preventDefault();
            
            // Validate payload size before submitting
            let totalPayloadSize = 0;
            adminSelectedMedia.forEach(media => {
                if (media.url) {
                    const base64Length = media.url.length;
                    const estimatedBytes = (base64Length * 3) / 4;
                    totalPayloadSize += estimatedBytes;
                }
            });
            
            // Add estimated size for other post data (JSON)
            const postDataSize = JSON.stringify({
                place: document.getElementById('adminPlaceName').value,
                description: document.getElementById('adminPostDescription').value
            }).length;
            totalPayloadSize += postDataSize;
            
            const totalKB = totalPayloadSize / 1024;
            const totalMB = totalPayloadSize / 1024 / 1024;
            
            // Stricter limit - block if over 900KB
            if (totalKB > 900) {
                showMessage(`‚ùå Total payload size is ${totalKB.toFixed(2)}KB (${totalMB.toFixed(2)}MB), which is too large! Maximum allowed: ~900KB.\n\nPlease:\n- Remove some media (currently ${adminSelectedMedia.length} items)\n- Use smaller images\n- Use video URLs instead of uploading videos\n- Maximum 4 images recommended`, 'error');
                return;
            }
            
            // Warn if getting close to limit
            if (totalKB > 700) {
                const proceed = confirm(`‚ö†Ô∏è Warning: Total payload size is ${totalKB.toFixed(2)}KB (${totalMB.toFixed(2)}MB), which is close to the limit (~900KB). This may cause a "Payload Too Large" error.\n\nConsider:\n- Removing some media\n- Using smaller images\n- Using video URLs instead of uploading videos\n\nContinue anyway?`);
                if (!proceed) {
                    return;
                }
            }
            
            console.log(`üì¶ Submitting post with payload size: ${totalKB.toFixed(2)}KB (${totalMB.toFixed(2)}MB)`);
            
            const place = document.getElementById('adminPlaceName').value;
            const locationCity = document.getElementById('adminLocationCity').value;
            const section = document.getElementById('adminPostSection').value;
            const description = document.getElementById('adminPostDescription').value;
            const useCurrentLocation = document.getElementById('adminUseCurrentLocation').checked;
            
            if (useCurrentLocation) {
                // Check if we have admin's current location stored
                if (adminCurrentLocation.lat && adminCurrentLocation.lng && adminCurrentLocation.permissionGranted) {
                    // Use stored location - no permission prompt
                    createAdminPost(adminCurrentLocation.lat, adminCurrentLocation.lng, place, locationCity, section, description);
                } else if (navigator.geolocation) {
                    // Request location permission only if not already granted
                    showMessage('Getting your location...', 'info');
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            adminCurrentLocation.lat = position.coords.latitude;
                            adminCurrentLocation.lng = position.coords.longitude;
                            adminCurrentLocation.accuracy = position.coords.accuracy;
                            adminCurrentLocation.permissionGranted = true;
                            adminCurrentLocation.lastUpdated = new Date();
                            createAdminPost(position.coords.latitude, position.coords.longitude, place, locationCity, section, description);
                        },
                        (error) => {
                            showMessage('Could not get location. Using default location.', 'warning');
                            createAdminPost(23.5937, 78.9629, place, locationCity, section, description);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000 // Allow cached location up to 1 minute old
                        }
                    );
                } else {
                    // Fallback to default India location
                    createAdminPost(23.5937, 78.9629, place, locationCity, section, description);
                }
            } else {
                // Default to India center
                createAdminPost(23.5937, 78.9629, place, locationCity, section, description);
            }
        }

        async function createAdminPost(lat, lng, place, locationCity, section, description) {
            try {
            // Helper function to convert undefined to null
            const toNull = (val) => (val === undefined || val === '') ? null : val;
            const toEmpty = (val) => (val === undefined || val === null) ? '' : val;
            
            // Extract media URLs (convert media objects to URLs)
            const mediaUrls = adminSelectedMedia.map(media => media.url || media.data || '').filter(url => url);
            
            const newPost = {
                authorEmail: 'admin@yatra.com',  // Backend expects authorEmail, not email
                authorName: adminUser.name || 'Admin',  // Backend expects authorName, not author
                authorImage: toEmpty(adminUser.image),  // Convert undefined to empty string
                place: place || '',
                location: locationCity || '',
                section: toNull(section),  // Convert undefined to null for optional fields
                description: description || '',
                lat: toNull(lat),  // Convert undefined to null
                lng: toNull(lng),  // Convert undefined to null
                media: mediaUrls,  // Send array of URLs, not objects
                tags: adminSelectedTags || [],
                approved: true
            };
            
            // Log the post data for debugging
            console.log('üì§ Creating post with data:', {
                ...newPost,
                media: `${newPost.media.length} items`,
                mediaSize: JSON.stringify(newPost.media).length
            });
            
                // Create via API
                if (typeof api !== 'undefined' && api.createPost) {
                    await api.createPost(newPost);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('posts');
                    }
                    posts = await api.getPosts({});
                    console.log('‚úÖ Admin post created via API:', newPost.place);
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('Error creating post:', error);
                showMessage('Error creating post. Please try again.', 'error');
                return;
            }
            
            loadPostsTable();
            updateDashboard();
            closeAdminPostModal();
            showMessage('üìç Post created successfully! Now live on website.');
        }

        // Admin Profile Functions
        function uploadAdminProfileImage(event) {
            const file = event.target.files[0];
            if (file) {
                compressImage(file, (compressedUrl) => {
                    adminUser.image = compressedUrl;
                    const preview = document.getElementById('adminProfilePreview');
                    preview.innerHTML = `<img src="${compressedUrl}" style="width: 100%; height: 100%; object-fit: cover;">`;
                });
            }
        }

        async function saveAdminProfile() {
            try {
                adminUser.name = document.getElementById('adminName').value;
                adminUser.includeInContributors = document.getElementById('adminIncludeInContributors').checked;
                adminUser.imageCompressionQuality = parseFloat(document.getElementById('imageCompressionQuality').value);
                
                // Save to database via API
                await api.updateAdminProfile(adminUser);
                
                showMessage('Admin profile saved successfully!');
            } catch (error) {
                console.error('Error saving admin profile:', error);
                showMessage('Failed to save admin profile. Please try again.', 'error');
            }
        }

        async function loadAdminProfile() {
            try {
                // Load admin profile from API
                const adminData = localStorage.getItem('adminData');
                if (adminData) {
                    const admin = JSON.parse(adminData);
                    if (admin.email) {
                        const profile = await api.getAdminProfile(admin.email);
                        if (profile) {
                            Object.assign(adminUser, profile);
                        }
                    }
                }
            } catch (error) {
                console.warn('Error loading admin profile from API:', error);
            }
            
            // Load into form fields
            document.getElementById('adminName').value = adminUser.name || 'Admin';
            document.getElementById('adminIncludeInContributors').checked = adminUser.includeInContributors !== false;
            document.getElementById('imageCompressionQuality').value = adminUser.imageCompressionQuality || 0.85;
            
            if (adminUser.image) {
                const preview = document.getElementById('adminProfilePreview');
                preview.innerHTML = `<img src="${adminUser.image}" style="width: 100%; height: 100%; object-fit: cover;">`;
            }
        }

        // Emergency Contact Functions
        async function saveEmergencyContact() {
            try {
                const doctorName = document.getElementById('emergencyDoctorName').value.trim();
                const doctorPhone = document.getElementById('emergencyDoctorPhone').value.trim();
                
                if (!doctorName || !doctorPhone) {
                    showMessage('Please enter both doctor name and phone number', 'error');
                    return;
                }
                
                const emergencySettings = {
                    emergencyDoctorName: doctorName,
                    emergencyDoctorPhone: doctorPhone,
                    updatedAt: new Date().toISOString()
                };
                
                // Save to database via API
                await api.updateSettings(emergencySettings);
                
                showMessage('‚úÖ Emergency contact saved successfully!');
            } catch (error) {
                console.error('Error saving emergency contact:', error);
                showMessage('Failed to save emergency contact. Please try again.', 'error');
            }
        }

        async function loadEmergencyContact() {
            try {
                // Load emergency contact from API
                const apiSettings = await api.getSettings();
                
                if (apiSettings.emergencyDoctorName) {
                    document.getElementById('emergencyDoctorName').value = apiSettings.emergencyDoctorName;
                }
                if (apiSettings.emergencyDoctorPhone) {
                    document.getElementById('emergencyDoctorPhone').value = apiSettings.emergencyDoctorPhone;
                }
            } catch (error) {
                console.warn('Error loading emergency contact from API:', error);
                // Use default values if API fails
                if (settings.emergencyDoctorName) {
                    document.getElementById('emergencyDoctorName').value = settings.emergencyDoctorName;
                }
                if (settings.emergencyDoctorPhone) {
                    document.getElementById('emergencyDoctorPhone').value = settings.emergencyDoctorPhone;
                }
            }
        }

        // ==================== NEW FEATURES FUNCTIONS ====================

        // ===== 1. PUSH NOTIFICATIONS =====
        let notificationsEnabled = JSON.parse(localStorage.getItem('notificationsEnabled') || 'false');

        window.addEventListener('load', () => {
            const checkbox = document.getElementById('enableNotifications');
            if (checkbox) {
                checkbox.checked = notificationsEnabled;
            }
        });

        function toggleNotifications() {
            notificationsEnabled = document.getElementById('enableNotifications').checked;
            localStorage.setItem('notificationsEnabled', JSON.stringify(notificationsEnabled));
            
            if (notificationsEnabled) {
                requestNotificationPermission();
                showMessage('üîî Notifications enabled! Travelers will be notified of new approved posts.');
            } else {
                showMessage('üîï Notifications disabled.');
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'granted') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showMessage('‚úÖ Notification permission granted!');
                }
            }
        }

        function sendTestNotification() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('Test Notification', {
                        body: 'This is a test notification from Yatra Admin Panel!',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FF9933"/></svg>'
                    });
                    showMessage('üîî Test notification sent!');
                } else {
                    requestNotificationPermission();
                }
            } else {
                showMessage('‚ùå Notifications not supported in this browser');
            }
        }

        function notifyAllNewPost() {
            if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                new Notification('New Yatra Update!', {
                    body: 'A new post has been approved. Check the website for updates!',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FF9933"/></svg>'
                });
                showMessage('üì¢ Notification broadcast to all travelers!');
            } else {
                showMessage('‚ö†Ô∏è Please enable notifications first');
            }
        }

        // OLD FUNCTION - REMOVED: This was using localStorage only
        // The correct async approvePost function is defined at line 5892
        // This function is kept for reference but should not be used
        function approvePostOldLocalStorageOnly(postId) {
            console.warn('‚ö†Ô∏è Old approvePost function called - this should not happen!');
            const postIndex = posts.findIndex(p => p.id === postId);
            if (postIndex !== -1) {
                posts[postIndex].approved = true;
                localStorage.setItem('posts', JSON.stringify(posts));
                loadPostsTable();
                updateDashboard();
                showMessage('Post approved successfully! ‚úÖ');
                
                // Send notification
                if (notificationsEnabled) {
                    notifyAllNewPost();
                }
            }
        }

        // ===== 2. SHARE POSTS TO SOCIAL MEDIA (Admin View) =====
        function sharePost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            const shareUrl = `${window.location.origin}?post=${postId}`;
            const shareText = `${post.place} - ${post.description.substring(0, 100)}...`;
            
            // Show share options
            const shareMenu = prompt('Share to:\n1. Facebook\n2. Twitter\n3. WhatsApp\n4. Copy Link\n\nEnter number (1-4):');
            
            switch(shareMenu) {
                case '1':
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
                    break;
                case '2':
                    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`, '_blank');
                    break;
                case '3':
                    window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`, '_blank');
                    break;
                case '4':
                    navigator.clipboard.writeText(shareUrl);
                    showMessage('üîó Link copied to clipboard!');
                    break;
            }
        }

        // ===== 3. JOURNAL ENTRIES MANAGEMENT =====
        function refreshJournalEntries() {
            loadJournalEntriesTable();
        }

        function loadJournalEntriesTable() {
            // Personal journals are private and not accessible to admin
            const container = document.getElementById('journalEntriesTableContainer');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; background: #f9f9f9; border-radius: 15px; margin: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üîí</div>
                    <h3 style="color: var(--navy); margin-bottom: 15px;">Personal Journals Are Private</h3>
                    <p style="color: #666; max-width: 600px; margin: 0 auto; line-height: 1.6;">
                        Daily journals are personal to each traveler. They are only visible to the traveler who wrote them.
                        Admin does not have access to view personal journal entries to maintain traveler privacy.
                    </p>
                </div>
            `;
        }

        // Load journal entries when section is shown
        const originalShowSection = window.showSection || function() {};
        window.showSection = function(sectionId) {
            // Call original showSection if it exists
            if (typeof originalShowSection === 'function') {
                originalShowSection(sectionId);
            }
            
            // Remove active class from all sections and sidebar items
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected section and sidebar item
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            // Find and activate corresponding sidebar item
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                if (item.textContent.toLowerCase().includes(sectionId)) {
                    item.classList.add('active');
                }
            });
            
            // Load data when sections are shown
            if (sectionId === 'travelers' && typeof loadTravelersTable === 'function') {
                console.log('üîÑ Travelers section shown (second showSection) - loading table...');
                setTimeout(async () => {
                    await loadTravelersTable();
                }, 100);
            }
            if (sectionId === 'posts' && typeof loadPostsTable === 'function') {
                loadPostsTable();
            }
            if (sectionId === 'vehicles' && typeof loadVehiclesTable === 'function') {
                loadVehiclesTable();
            }
            if (sectionId === 'hotels' && typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            // Note: loadItineraryTable is already called above at line 5623, no need to call again
            // if (sectionId === 'itinerary' && typeof loadItineraryTable === 'function') {
            //     loadItineraryTable();
            // }
            
            // Load room pairs if roomPairs section
            if (sectionId === 'roomPairs') {
                console.log('üîÑ Room pairs section shown - loading pairs...');
                console.log('  - loadPairs type:', typeof loadPairs);
                console.log('  - window.loadPairs type:', typeof window.loadPairs);
                
                // Use the most available version of loadPairs
                const loadFn = typeof loadPairs === 'function' ? loadPairs : 
                              (typeof window.loadPairs === 'function' ? window.loadPairs : null);
                
                if (loadFn) {
                    console.log('‚úÖ loadPairs function found - calling it...');
                    // Wait a bit to ensure DOM is ready
                    setTimeout(async () => {
                        try {
                            const tbody = document.getElementById('pairsTable');
                            console.log('  - pairsTable element exists:', !!tbody);
                            if (!tbody) {
                                console.warn('‚ö†Ô∏è pairsTable not found, retrying in 500ms...');
                                setTimeout(async () => {
                                    await loadFn();
                                }, 500);
                                return;
                            }
                            await loadFn();
                            console.log('‚úÖ loadPairs completed');
                            
                            // Verify pairs were rendered
                            setTimeout(() => {
                                const checkTbody = document.getElementById('pairsTable');
                                if (checkTbody) {
                                    console.log(`üìä Pairs table now has ${checkTbody.children.length} rows`);
                                    if (checkTbody.children.length === 0) {
                                        console.warn('‚ö†Ô∏è Table is still empty after loadPairs!');
                                    }
                                }
                            }, 300);
                        } catch (error) {
                            console.error('‚ùå Error in loadPairs:', error);
                            console.error('Error stack:', error.stack);
                        }
                    }, 200);
                } else {
                    console.error('‚ùå loadPairs function not found anywhere!');
                }
            }
            
            // Load journal entries if journal section
            if (sectionId === 'journal') {
                loadJournalEntriesTable();
            }
            
            // Load vehicles if vehicles section
            if (sectionId === 'vehicles') {
                loadVehiclesTable();
            }
            
            // Initialize announcements if announcements section
            if (sectionId === 'announcements') {
                if (typeof initializeAnnouncementsSystem === 'function') {
                    initializeAnnouncementsSystem();
                } else {
                    console.warn('‚ö†Ô∏è initializeAnnouncementsSystem function not found');
                }
            }
            
            // Load emergency contact if settings section
            if (sectionId === 'settings') {
                loadEmergencyContact();
            }
        };

        // ===== 4. EXPORT FUNCTIONALITY =====
        async function exportPostsToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(255, 153, 51);
                doc.text('Spiritual Yatra - Posts Report', 20, yPosition);
                yPosition += 10;
                
                // Subtitle
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text('Generated from Admin Panel', 20, yPosition);
                yPosition += 5;
                doc.text('Date: ' + new Date().toLocaleString(), 20, yPosition);
                yPosition += 15;
                
                // Stats
                doc.setFontSize(10);
                doc.setTextColor(0);
                doc.text(`Total Posts: ${posts.length} | Approved: ${posts.filter(p => p.approved).length} | Pending: ${posts.filter(p => !p.approved).length}`, 20, yPosition);
                yPosition += 15;
                
                // Posts
                posts.forEach((post, index) => {
                    if (yPosition > pageHeight - 50) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 128);
                    doc.text(`${index + 1}. ${post.place}`, 20, yPosition);
                    yPosition += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.text(`Author: ${post.author} | Location: ${post.location}`, 25, yPosition);
                    yPosition += 6;
                    doc.text(`Date: ${new Date(post.date || post.timestamp).toLocaleDateString()} | Status: ${post.approved ? 'Approved' : 'Pending'}`, 25, yPosition);
                    yPosition += 6;
                    
                    // Description
                    const splitDescription = doc.splitTextToSize(post.description, 160);
                    doc.text(splitDescription, 25, yPosition);
                    yPosition += (splitDescription.length * 6) + 10;
                });
                
                doc.save('yatra_posts_admin_' + Date.now() + '.pdf');
                showMessage('üìÑ Posts report exported to PDF!');
            } catch (error) {
                console.error('PDF export error:', error);
                showMessage('‚ùå Error exporting to PDF');
            }
        }

        async function exportPostsToExcel() {
            try {
                const XLSX = window.XLSX;
                
                const data = posts.map(post => ({
                    'ID': post.id,
                    'Author': post.author,
                    'Email': post.email || '',
                    'Place': post.place,
                    'Location': post.location,
                    'Section': post.section || '',
                    'Description': post.description,
                    'Date': new Date(post.date || post.timestamp).toLocaleString(),
                    'Latitude': post.lat,
                    'Longitude': post.lng,
                    'Tags': post.tags ? post.tags.join(', ') : '',
                    'Media Count': post.media ? post.media.length : 0,
                    'Approved': post.approved ? 'Yes' : 'No'
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Posts');
                
                XLSX.writeFile(wb, 'yatra_posts_admin_' + Date.now() + '.xlsx');
                showMessage('üìä Posts exported to Excel!');
            } catch (error) {
                console.error('Excel export error:', error);
                showMessage('‚ùå Error exporting to Excel');
            }
        }

        async function exportJournalToPDF() {
            try {
                const journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(156, 39, 176);
                doc.text('Daily Journal Entries', 20, yPosition);
                yPosition += 10;
                
                // Subtitle
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text('Yatra Journal Report', 20, yPosition);
                yPosition += 5;
                doc.text('Generated: ' + new Date().toLocaleString(), 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.text(`Total Entries: ${journalEntries.length}`, 20, yPosition);
                yPosition += 15;
                
                // Sort by date
                const sortedEntries = [...journalEntries].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedEntries.forEach((entry, index) => {
                    if (yPosition > pageHeight - 50) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(255, 153, 51);
                    doc.text(new Date(entry.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }), 20, yPosition);
                    yPosition += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.text(`Mood: ${entry.mood}`, 25, yPosition);
                    yPosition += 6;
                    
                    if (entry.location) {
                        doc.text(`Location: ${entry.location}`, 25, yPosition);
                        yPosition += 6;
                    }
                    
                    yPosition += 4;
                    const splitContent = doc.splitTextToSize(entry.content, 160);
                    doc.text(splitContent, 25, yPosition);
                    yPosition += (splitContent.length * 6) + 15;
                });
                
                doc.save('yatra_journal_admin_' + Date.now() + '.pdf');
                showMessage('üìì Journal exported to PDF!');
            } catch (error) {
                console.error('Journal PDF export error:', error);
                showMessage('‚ùå Error exporting journal to PDF');
            }
        }

        async function exportJournalToExcel() {
            try {
                const journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                const XLSX = window.XLSX;
                
                const data = journalEntries.map(entry => ({
                    'Date': entry.date,
                    'Mood': entry.mood,
                    'Location': entry.location || '',
                    'Content': entry.content,
                    'Created At': new Date(entry.createdAt).toLocaleString()
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Journal');
                
                XLSX.writeFile(wb, 'yatra_journal_admin_' + Date.now() + '.xlsx');
                showMessage('üìî Journal exported to Excel!');
            } catch (error) {
                console.error('Journal Excel export error:', error);
                showMessage('‚ùå Error exporting journal to Excel');
            }
        }

        async function exportItineraryToPDF() {
            try {
                const itinerary = JSON.parse(localStorage.getItem('itinerary') || '[]');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(255, 153, 51);
                doc.text('Yatra Itinerary', 20, yPosition);
                yPosition += 15;
                
                // Date
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Generated: ' + new Date().toLocaleString(), 20, yPosition);
                yPosition += 10;
                doc.text(`Total Days: ${itinerary.length}`, 20, yPosition);
                yPosition += 15;
                
                // Itinerary
                itinerary.forEach((day, index) => {
                    if (yPosition > pageHeight - 40) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 128);
                    doc.text(`Day ${day.day}: ${day.date}`, 20, yPosition);
                    yPosition += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.text(`Place: ${day.place}`, 25, yPosition);
                    yPosition += 6;
                    doc.text(`City: ${day.city}, ${day.state}, ${day.country}`, 25, yPosition);
                    yPosition += 6;
                    doc.text(`Coordinates: ${day.lat}, ${day.lng}`, 25, yPosition);
                    yPosition += 10;
                });
                
                doc.save('yatra_itinerary_' + Date.now() + '.pdf');
                showMessage('üó∫Ô∏è Itinerary exported to PDF!');
            } catch (error) {
                console.error('Itinerary PDF export error:', error);
                showMessage('‚ùå Error exporting itinerary to PDF');
            }
        }

        async function exportItineraryToExcel() {
            try {
                const itinerary = JSON.parse(localStorage.getItem('itinerary') || '[]');
                const XLSX = window.XLSX;
                
                const data = itinerary.map(day => ({
                    'Day': day.day,
                    'Date': day.date,
                    'Place': day.place,
                    'City': day.city,
                    'State': day.state,
                    'Country': day.country,
                    'Latitude': day.lat,
                    'Longitude': day.lng
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Itinerary');
                
                XLSX.writeFile(wb, 'yatra_itinerary_' + Date.now() + '.xlsx');
                showMessage('üó∫Ô∏è Itinerary exported to Excel!');
            } catch (error) {
                console.error('Itinerary Excel export error:', error);
                showMessage('‚ùå Error exporting itinerary to Excel');
            }
        }

        async function exportFullDataToExcel() {
            try {
                const XLSX = window.XLSX;
                const wb = XLSX.utils.book_new();
                
                // Posts sheet
                const postsData = posts.map(post => ({
                    'ID': post.id,
                    'Author': post.author,
                    'Email': post.email || '',
                    'Place': post.place,
                    'Location': post.location,
                    'Section': post.section || '',
                    'Description': post.description,
                    'Date': new Date(post.date || post.timestamp).toLocaleString(),
                    'Latitude': post.lat,
                    'Longitude': post.lng,
                    'Tags': post.tags ? post.tags.join(', ') : '',
                    'Media Count': post.media ? post.media.length : 0,
                    'Approved': post.approved ? 'Yes' : 'No'
                }));
                const postsWs = XLSX.utils.json_to_sheet(postsData);
                XLSX.utils.book_append_sheet(wb, postsWs, 'Posts');
                
                // Journal sheet
                const journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                const journalData = journalEntries.map(entry => ({
                    'Date': entry.date,
                    'Mood': entry.mood,
                    'Location': entry.location || '',
                    'Content': entry.content,
                    'Created At': new Date(entry.createdAt).toLocaleString()
                }));
                const journalWs = XLSX.utils.json_to_sheet(journalData);
                XLSX.utils.book_append_sheet(wb, journalWs, 'Journal');
                
                // Itinerary sheet
                const itinerary = JSON.parse(localStorage.getItem('itinerary') || '[]');
                const itineraryData = itinerary.map(day => ({
                    'Day': day.day,
                    'Date': day.date,
                    'Place': day.place,
                    'City': day.city,
                    'State': day.state,
                    'Country': day.country,
                    'Latitude': day.lat,
                    'Longitude': day.lng
                }));
                const itineraryWs = XLSX.utils.json_to_sheet(itineraryData);
                XLSX.utils.book_append_sheet(wb, itineraryWs, 'Itinerary');
                
                // Statistics sheet
                const stats = {
                    'Total Posts': posts.length,
                    'Approved Posts': posts.filter(p => p.approved).length,
                    'Pending Posts': posts.filter(p => !p.approved).length,
                    'Total Journal Entries': journalEntries.length,
                    'Total Itinerary Days': itinerary.length,
                    'Total Locations': new Set(posts.map(p => p.location)).size,
                    'Total Contributors': new Set(posts.map(p => p.author)).size,
                    'Export Date': new Date().toLocaleString()
                };
                const statsWs = XLSX.utils.json_to_sheet([stats]);
                XLSX.utils.book_append_sheet(wb, statsWs, 'Statistics');
                
                XLSX.writeFile(wb, 'yatra_complete_data_admin_' + Date.now() + '.xlsx');
                showMessage('üìÅ Complete data exported to Excel!');
            } catch (error) {
                console.error('Full data export error:', error);
                showMessage('‚ùå Error exporting complete data');
            }
        }

        // ==================== END NEW FEATURES FUNCTIONS ====================

        // ==================== VEHICLE MANAGEMENT FUNCTIONS ====================

        // ==================== VEHICLES LOAD OPERATIONS (MySQL Backend) ====================
        async function loadVehiclesTable() {
            const table = document.getElementById('vehiclesTable');
            if (!table) return;
            
            // Load vehicles from API
            try {
                if (typeof api !== 'undefined' && api.getVehicles) {
                    vehicles = await api.getVehicles();
                } else {
                    console.warn('API not available, using cached vehicles');
                }
            } catch (error) {
                console.error('Error loading vehicles from API:', error);
                // Continue with existing vehicles array
            }
            
            // Load check-in data from API for all vehicles with error handling
            if (typeof api !== 'undefined' && api.getCheckIns) {
                for (const vehicle of vehicles) {
                    try {
                        const apiData = await api.getCheckIns(vehicle.id);
                        if (apiData) {
                            if (!checkInData[vehicle.id]) {
                                checkInData[vehicle.id] = { checkedIn: [], active: false };
                            }
                            // Update check-in data from API response
                            if (apiData.checkedIn !== undefined) {
                                checkInData[vehicle.id].checkedIn = apiData.checkedIn || [];
                            }
                            // Check-in is active if vehicle has travelers (API returns active: true/false)
                            // Default to true if vehicle has allocated travelers, false otherwise
                            const hasTravelers = travelers.filter(t => t.vehicleId == vehicle.id).length > 0;
                            checkInData[vehicle.id].active = apiData.active !== undefined ? apiData.active : hasTravelers;
                            checkInData[vehicle.id].apiSynced = true;
                        }
                    } catch (error) {
                        console.warn(`Could not load check-ins for vehicle ${vehicle.id}:`, error);
                        // Set default active status based on whether vehicle has travelers
                        const hasTravelers = travelers.filter(t => t.vehicleId == vehicle.id).length > 0;
                        if (!checkInData[vehicle.id]) {
                            checkInData[vehicle.id] = { checkedIn: [], active: hasTravelers };
                        } else {
                            checkInData[vehicle.id].active = hasTravelers;
                        }
                    }
                }
                // Save to localStorage with error handling
                try {
                    // Check-in data is stored in database only, not localStorage
                } catch (error) {
                    console.error('‚ùå Error loading check-in data:', error);
                }
            }
            
            if (vehicles.length === 0) {
                table.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No vehicles added yet. Click "+ Add Vehicle" to get started.</td></tr>';
                return;
            }
            
            // Sort vehicles: Active first, then Maintenance, then Inactive at bottom
            const sortedVehicles = [...vehicles].sort((a, b) => {
                const statusOrder = { 'Active': 1, 'Maintenance': 2, 'Inactive': 3 };
                return (statusOrder[a.status] || 3) - (statusOrder[b.status] || 3);
            });
            
            table.innerHTML = sortedVehicles.map(vehicle => {
                const allocatedCount = travelers.filter(t => t.vehicleId == vehicle.id).length;
                const checkIn = checkInData[vehicle.id] || { checkedIn: [], active: false };
                const checkedInCount = checkIn.checkedIn.length;
                
                return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: ${vehicle.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                üöå
                            </div>
                            <strong>${vehicle.name}</strong>
                        </div>
                    </td>
                    <td>${vehicle.type}</td>
                    <td>${vehicle.capacity} seats</td>
                    <td>${vehicle.groupLeaderName || 'Not Assigned'}</td>
                    <td>
                        <span style="padding: 5px 12px; background: ${vehicle.status === 'Active' ? '#28a745' : vehicle.status === 'Maintenance' ? '#ffc107' : '#6c757d'}; color: white; border-radius: 15px; font-size: 0.85rem;">
                            ${vehicle.status}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="font-weight: 600; color: ${checkedInCount === allocatedCount && allocatedCount > 0 ? '#28a745' : '#ff9800'}; cursor: pointer; text-decoration: underline;" onclick="viewCheckInReport(${vehicle.id})" title="Click to view Check-In Report">
                                ${checkedInCount}/${allocatedCount}
                            </div>
                            ${allocatedCount > 0 ? `
                                <span style="padding: 3px 8px; background: ${checkIn.active !== false ? '#4caf50' : '#9e9e9e'}; color: white; border-radius: 10px; font-size: 0.75rem; font-weight: 600;" title="${checkIn.active !== false ? 'Check-In Active' : 'Check-In Inactive'}">
                                    ${checkIn.active !== false ? '‚úì Active' : '‚óã Inactive'}
                                </span>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <button class="action-btn" onclick='editVehicle(${JSON.stringify(vehicle).replace(/'/g, "&#39;")})' title="Edit">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="viewCheckInReport(${vehicle.id})" title="Check-In Report" style="background: #2196f3;">üìã</button>
                        <button class="action-btn" onclick="clearCheckIns(${vehicle.id})" title="Clear Check-Ins" style="background: #ff9800;">üîÑ</button>
                        <button class="action-btn" onclick="deleteVehicle(${vehicle.id})" title="Delete" style="background: #dc3545;">üóëÔ∏è</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function openVehicleModal() {
            document.getElementById('vehicleModal').style.display = 'block';
            document.getElementById('vehicleModalTitle').textContent = 'Add Vehicle';
            document.getElementById('vehicleId').value = '';
            document.getElementById('vehicleName').value = '';
            document.getElementById('vehicleType').value = '';
            document.getElementById('vehicleCapacity').value = '';
            document.getElementById('vehicleRegNo').value = '';
            document.getElementById('vehicleGroupLeader').value = '';
            document.getElementById('vehicleColor').value = '#FF9933';
            document.getElementById('vehicleStatus').value = 'Active';
            document.getElementById('vehicleNotes').value = '';
            
            // Populate group leaders dropdown
            await populateGroupLeadersDropdown();
        }
        window.openVehicleModal = openVehicleModal;

        async function populateGroupLeadersDropdown() {
            console.log('üîÑ populateGroupLeadersDropdown called');
            const dropdown = document.getElementById('vehicleGroupLeader');
            
            if (!dropdown) {
                console.warn('‚ö†Ô∏è Group leader dropdown not found');
                return;
            }
            
            try {
                // Check if travelers are loaded - try multiple sources
                let travelersToUse = null;
                
                // Try window.travelers first (most reliable)
                if (window.travelers && Array.isArray(window.travelers) && window.travelers.length > 0) {
                    travelersToUse = window.travelers;
                    console.log('‚úÖ Using window.travelers:', travelersToUse.length);
                }
                // Try local travelers variable
                else if (typeof travelers !== 'undefined' && Array.isArray(travelers) && travelers.length > 0) {
                    travelersToUse = travelers;
                    console.log('‚úÖ Using local travelers variable:', travelersToUse.length);
                }
                // Try to get from global scope
                else {
                    // Check if travelers exist in any form
                    const globalTravelers = (typeof travelers !== 'undefined') ? travelers : 
                                          (window.travelers || []);
                    
                    if (globalTravelers && globalTravelers.length > 0) {
                        travelersToUse = globalTravelers;
                        console.log('‚úÖ Using global travelers:', travelersToUse.length);
                    }
                }
                
                // If still no travelers, fetch them
                if (!travelersToUse || travelersToUse.length === 0) {
                    console.log('üìã Travelers not loaded, fetching...');
                    
                    // Try to fetch from API first
                    if (typeof api !== 'undefined' && api.getTravelers) {
                        try {
                            travelersToUse = await api.getTravelers();
                            if (travelersToUse && travelersToUse.length > 0) {
                                // Update all references
                                if (typeof travelers !== 'undefined') travelers = travelersToUse;
                                window.travelers = travelersToUse;
                                console.log('‚úÖ Loaded travelers from API:', travelersToUse.length);
                            }
                        } catch (apiError) {
                            console.warn('‚ö†Ô∏è API fetch failed, trying localStorage:', apiError);
                            // Fallback to localStorage
                            if (typeof safeGetFromStorage === 'function') {
                                travelersToUse = await safeGetFromStorage('authorizedTravelers', []);
                            } else {
                                try {
                                    const stored = localStorage.getItem('authorizedTravelers');
                                    travelersToUse = stored ? JSON.parse(stored) : [];
                                } catch (e) {
                                    travelersToUse = [];
                                }
                            }
                            if (travelersToUse && travelersToUse.length > 0) {
                                if (typeof travelers !== 'undefined') travelers = travelersToUse;
                                window.travelers = travelersToUse;
                                console.log('‚úÖ Loaded travelers from localStorage:', travelersToUse.length);
                            }
                        }
                    } else {
                        // No API available, use localStorage
                        if (typeof safeGetFromStorage === 'function') {
                            travelersToUse = await safeGetFromStorage('authorizedTravelers', []);
                        } else {
                            try {
                                const stored = localStorage.getItem('authorizedTravelers');
                                travelersToUse = stored ? JSON.parse(stored) : [];
                            } catch (e) {
                                travelersToUse = [];
                            }
                        }
                        if (travelersToUse && travelersToUse.length > 0) {
                            if (typeof travelers !== 'undefined') travelers = travelersToUse;
                            window.travelers = travelersToUse;
                            console.log('‚úÖ Loaded travelers from localStorage:', travelersToUse.length);
                        }
                    }
                }
                
                // Populate dropdown
                if (travelersToUse && travelersToUse.length > 0) {
            dropdown.innerHTML = '<option value="">Select Group Leader</option>' + 
                        travelersToUse.map(traveler => {
                            const name = traveler.name || `${traveler.firstName || ''} ${traveler.lastName || ''}`.trim() || 'Unknown';
                            const email = traveler.email || '';
                            return `<option value="${email}" data-name="${name}">${name} (${email})</option>`;
                        }).join('');
                    console.log('‚úÖ Group leader dropdown populated with', travelersToUse.length, 'travelers');
                } else {
                    dropdown.innerHTML = '<option value="">No travelers available</option>';
                    console.warn('‚ö†Ô∏è No travelers available to populate dropdown');
                }
            } catch (error) {
                console.error('‚ùå Error populating group leaders dropdown:', error);
                dropdown.innerHTML = '<option value="">Error loading travelers</option>';
            }
        }
        
        // Make it globally accessible
        window.populateGroupLeadersDropdown = populateGroupLeadersDropdown;

        async function editVehicle(vehicle) {
            if (!vehicle || !vehicle.id) {
                console.error('‚ùå Invalid vehicle data:', vehicle);
                return;
            }
            
            console.log('‚úèÔ∏è Editing vehicle:', vehicle);
            
            // Set ID FIRST before resetting form to ensure it's preserved
            const idField = document.getElementById('vehicleId');
            if (idField) {
                idField.value = String(vehicle.id); // Ensure it's a string
                console.log('‚úÖ Set vehicle ID to:', vehicle.id, '(type:', typeof idField.value, ')');
            }
            
            // Reset form AFTER setting ID (but hidden fields aren't affected by reset)
            const form = document.querySelector('#vehicleModal form');
            if (form) {
                form.reset();
                // Re-set the ID after reset to ensure it's not cleared
                if (idField) {
                    idField.value = String(vehicle.id);
                }
            }
            
            document.getElementById('vehicleModal').style.display = 'block';
            document.getElementById('vehicleModalTitle').textContent = 'Edit Vehicle';
            document.getElementById('vehicleName').value = vehicle.name;
            document.getElementById('vehicleType').value = vehicle.type;
            document.getElementById('vehicleCapacity').value = vehicle.capacity;
            document.getElementById('vehicleRegNo').value = vehicle.regNo || '';
            document.getElementById('vehicleColor').value = vehicle.color;
            document.getElementById('vehicleStatus').value = vehicle.status;
            document.getElementById('vehicleNotes').value = vehicle.notes || '';
            
            await populateGroupLeadersDropdown();
            document.getElementById('vehicleGroupLeader').value = vehicle.groupLeaderEmail;
        }
        window.editVehicle = editVehicle;

        function closeVehicleModal() {
            const modal = document.getElementById('vehicleModal');
            if (modal) {
                modal.style.display = 'none';
                // Reset form and clear ID AFTER modal is closed
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                const idField = document.getElementById('vehicleId');
                if (idField) {
                    idField.value = '';
                }
                // Reset modal title
                const title = document.getElementById('vehicleModalTitle');
                if (title) {
                    title.textContent = 'Add Vehicle';
                }
            }
        }
        window.closeVehicleModal = closeVehicleModal;

        // ==================== VEHICLES CRUD OPERATIONS (MySQL Backend) ====================
        async function handleVehicleSubmit(event) {
            event.preventDefault();
            
            const idField = document.getElementById('vehicleId');
            const id = idField ? String(idField.value).trim() : '';
            
            // Debug logging
            console.log('üì§ Submitting vehicle form. ID field value:', id, 'Type:', typeof id, 'Is valid number:', !isNaN(parseInt(id)));
            
            const name = document.getElementById('vehicleName').value;
            const type = document.getElementById('vehicleType').value;
            const capacity = parseInt(document.getElementById('vehicleCapacity').value);
            const regNo = document.getElementById('vehicleRegNo').value;
            const leaderDropdown = document.getElementById('vehicleGroupLeader');
            const groupLeaderEmail = leaderDropdown.value;
            const groupLeaderName = leaderDropdown.options[leaderDropdown.selectedIndex].getAttribute('data-name');
            const color = document.getElementById('vehicleColor').value;
            const status = document.getElementById('vehicleStatus').value;
            const notes = document.getElementById('vehicleNotes').value;
            
            // Get driver info if available
            const driver = document.getElementById('vehicleDriver')?.value || '';
            const driverPhone = document.getElementById('vehicleDriverPhone')?.value || '';
            
            const vehicleData = {
                name,
                type,
                capacity,
                regNo,
                groupLeaderEmail,
                groupLeaderName,
                driver: driver,
                driverPhone: driverPhone,
                color,
                status,
                notes
            };
            
            console.log('üì§ Sending vehicle data:', vehicleData);
            
            try {
            // Improved ID validation - check if ID exists and is a valid positive integer
            const parsedId = parseInt(id);
            const isValidId = id !== '' && !isNaN(parsedId) && parsedId > 0;
            
            if (isValidId) {
                    // Update existing vehicle via API
                    console.log('üìù Updating vehicle with ID:', parsedId);
                    if (typeof api !== 'undefined' && api.updateVehicle) {
                        await api.updateVehicle(parsedId, vehicleData);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('vehicles');
                        }
                        vehicles = await api.getVehicles();
                    showMessage('Vehicle updated successfully!');
                    } else {
                        throw new Error('API not available');
                }
            } else {
                    // Add new vehicle - ID is empty or invalid
                    console.log('‚ûï Creating new vehicle (ID is empty or invalid)');
                    // Add new vehicle via API
                    if (typeof api !== 'undefined' && api.createVehicle) {
                        console.log('üì§ Creating vehicle with data:', vehicleData);
                        const response = await api.createVehicle(vehicleData);
                        console.log('‚úÖ Vehicle creation response:', response);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('vehicles');
                        }
                        vehicles = await api.getVehicles();
                        showMessage('Vehicle added successfully!');
                    } else {
                        throw new Error('API not available');
                    }
                }
            } catch (error) {
                console.error('Error saving vehicle:', error);
                showMessage('Error saving vehicle. Please try again.', 'error');
                return;
            }
            
            loadVehiclesTable();
            updateDashboard();
            closeVehicleModal();
        }

        async function deleteVehicle(id) {
            if (!confirm('Are you sure you want to delete this vehicle?')) {
                return;
            }
            
            try {
                // Delete via API
                if (typeof api !== 'undefined' && api.deleteVehicle) {
                    await api.deleteVehicle(id);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('/vehicles');
                    }
                    vehicles = await api.getVehicles();
                showMessage('Vehicle deleted successfully!');
                } else {
                    throw new Error('API not available');
            }
            } catch (error) {
                console.error('Error deleting vehicle:', error);
                showMessage('Error deleting vehicle. Please try again.', 'error');
                return;
        }
            
            loadVehiclesTable();
            updateDashboard();
        }
        window.deleteVehicle = deleteVehicle;

        function clearCheckIns(vehicleId) {
            console.log('üîò Button clicked: Clear Check-Ins');
            console.log(`üîò Vehicle ID: ${vehicleId}`);
            if (confirm('Clear all check-ins for this vehicle? This will reset the check-in list.')) {
                console.log('‚úÖ User confirmed - proceeding with check-in activation...');
                clearCheckIn(vehicleId);
                loadVehiclesTable();
            } else {
                console.log('‚ùå User cancelled check-in activation');
            }
        }

        function clearAllVehicleCheckIns() {
            if (confirm('Clear check-ins for ALL vehicles? This will reset all check-in lists.')) {
                vehicles.forEach(vehicle => {
                    clearCheckIn(vehicle.id);
                });
                loadVehiclesTable();
                showMessage('‚úÖ All vehicle check-ins cleared successfully!');
            }
        }

        // ==================== HOTEL / UTARA MANAGEMENT ====================
        
        let hotels = safeGetFromStorage('hotels', []);
        let hotelAllotments = safeGetFromStorage('hotelAllotments', {});
        
        // Initialize with comprehensive hotel data if empty
        if (hotels.length === 0) {
            hotels = [
                {
                    id: 1,
                    name: "Himalaya Crown Hotel",
                    location: "Biratnagar, Nepal",
                    floors: 4,
                    rooms: 40,
                    checkIn: "2025-12-15",
                    checkOut: "2025-12-16",
                    address: "Main Road, Biratnagar - 56600, Nepal",
                    contact: "+977-21-530100",
                    notes: "First night stay after crossing Nepal border. AC rooms, restaurant, wifi"
                },
                {
                    id: 2,
                    name: "Janakpur Heritage Hotel",
                    location: "Janakpur, Nepal",
                    floors: 3,
                    rooms: 35,
                    checkIn: "2025-12-16",
                    checkOut: "2025-12-17",
                    address: "Station Road, Janakpur Dham, Nepal",
                    contact: "+977-41-520445",
                    notes: "Near Janaki Mandir. Traditional Mithila architecture, vegetarian restaurant"
                },
                {
                    id: 3,
                    name: "Chitwan Safari Lodge",
                    location: "Chitwan, Nepal",
                    floors: 2,
                    rooms: 40,
                    checkIn: "2025-12-17",
                    checkOut: "2025-12-18",
                    address: "Sauraha, Chitwan National Park, Nepal",
                    contact: "+977-56-580080",
                    notes: "Jungle resort near national park. Nature rooms, evening cultural program"
                },
                {
                    id: 4,
                    name: "Hotel Kathmandu Grand",
                    location: "Kathmandu, Nepal",
                    floors: 5,
                    rooms: 45,
                    checkIn: "2025-12-18",
                    checkOut: "2025-12-21",
                    address: "Thamel, Kathmandu - 44600, Nepal",
                    contact: "+977-1-4700111",
                    notes: "3 nights stay. Central Thamel location. Multi-cuisine restaurant, rooftop view"
                },
                {
                    id: 5,
                    name: "Hotel Pokhara Paradise",
                    location: "Pokhara, Nepal",
                    floors: 4,
                    rooms: 40,
                    checkIn: "2025-12-21",
                    checkOut: "2025-12-22",
                    address: "Lakeside, Pokhara - 33700, Nepal",
                    contact: "+977-61-465108",
                    notes: "Lake view rooms. Beautiful sunrise view of Annapurna range"
                },
                {
                    id: 6,
                    name: "Muktinath Guest House",
                    location: "Muktinath, Nepal",
                    floors: 3,
                    rooms: 35,
                    checkIn: "2025-12-22",
                    checkOut: "2025-12-23",
                    address: "Ranipauwa, Muktinath, Mustang, Nepal",
                    contact: "+977-69-440123",
                    notes: "High altitude stay (3,710m). Basic amenities, heaters provided, hot water"
                },
                {
                    id: 7,
                    name: "Hotel Pokhara Paradise",
                    location: "Pokhara, Nepal",
                    floors: 4,
                    rooms: 40,
                    checkIn: "2025-12-23",
                    checkOut: "2025-12-24",
                    address: "Lakeside, Pokhara - 33700, Nepal",
                    contact: "+977-61-465108",
                    notes: "Return stay. Rest and relaxation after mountain journey"
                }
            ];
            safeSetToStorage('hotels', hotels);
            console.log('‚úÖ Initialized with 7 comprehensive hotels');
        }
        
        // ==================== HOTELS LOAD OPERATIONS (MySQL Backend) ====================
        async function loadHotelsTable() {
            const tbody = document.getElementById('hotelsTable');
            if (!tbody) return;
            
            // Load hotels from API
            try {
                if (typeof api !== 'undefined' && api.getHotels) {
                    hotels = await api.getHotels();
                } else {
                    console.warn('API not available, using cached hotels');
                }
            } catch (error) {
                console.error('Error loading hotels from API:', error);
                // Continue with existing hotels array
            }
            
            if (hotels.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No hotels added yet. Click "+ Add Hotel" to get started.</td></tr>';
                return;
            }
            
            tbody.innerHTML = hotels.map(hotel => {
                // Build location string from city, state, country
                const locationParts = [];
                if (hotel.city) locationParts.push(hotel.city);
                if (hotel.state) locationParts.push(hotel.state);
                if (hotel.country) locationParts.push(hotel.country);
                const location = locationParts.length > 0 ? locationParts.join(', ') : (hotel.address || 'N/A');
                
                // Get floors and rooms from database fields
                const floors = (hotel.total_floors !== null && hotel.total_floors !== undefined) ? hotel.total_floors : 'N/A';
                const rooms = (hotel.total_rooms !== null && hotel.total_rooms !== undefined) ? hotel.total_rooms : 'N/A';
                
                // Check-in and check-out dates from database fields
                const checkIn = hotel.check_in_date || null;
                const checkOut = hotel.check_out_date || null;
                
                return `
                <tr>
                    <td><strong>${escapeHTML(hotel.name || 'N/A')}</strong></td>
                    <td>${escapeHTML(location)}</td>
                    <td>${escapeHTML(String(floors))}</td>
                    <td>${escapeHTML(String(rooms))}</td>
                    <td>${formatDate(checkIn)}</td>
                    <td>${formatDate(checkOut)}</td>
                    <td>
                        <button class="action-btn" onclick='editHotel(${JSON.stringify(hotel).replace(/'/g, "&#39;")})' title="Edit">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="deleteHotel(${hotel.id})" title="Delete" style="background: #dc3545;">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        function openHotelModal() {
            document.getElementById('hotelModal').style.display = 'block';
            document.getElementById('hotelModalTitle').textContent = 'Add New Hotel / Utara';
            document.getElementById('hotelId').value = '';
            document.getElementById('hotelName').value = '';
            document.getElementById('hotelLocation').value = '';
            document.getElementById('hotelFloors').value = '';
            document.getElementById('hotelRooms').value = '';
            document.getElementById('hotelCheckIn').value = '';
            document.getElementById('hotelCheckOut').value = '';
            document.getElementById('hotelAddress').value = '';
            document.getElementById('hotelContact').value = '';
            document.getElementById('hotelNotes').value = '';
            document.getElementById('hotelSubmitBtn').textContent = 'Add Hotel';
        }
        window.openHotelModal = openHotelModal;
        
        function closeHotelModal() {
            document.getElementById('hotelModal').style.display = 'none';
        }
        window.closeHotelModal = closeHotelModal;
        
        function editHotel(hotel) {
            document.getElementById('hotelModal').style.display = 'block';
            document.getElementById('hotelModalTitle').textContent = 'Edit Hotel / Utara';
            document.getElementById('hotelId').value = hotel.id || '';
            document.getElementById('hotelName').value = hotel.name || '';
            
            // Build location from city, state, country
            const locationParts = [];
            if (hotel.city) locationParts.push(hotel.city);
            if (hotel.state) locationParts.push(hotel.state);
            if (hotel.country) locationParts.push(hotel.country);
            const location = locationParts.length > 0 ? locationParts.join(', ') : (hotel.location || '');
            document.getElementById('hotelLocation').value = location;
            
            document.getElementById('hotelFloors').value = hotel.total_floors || hotel.floors || '';
            document.getElementById('hotelRooms').value = hotel.total_rooms || hotel.rooms || '';
            
            // Format dates for date input fields (must be yyyy-MM-dd format)
            const formatDateForInput = (dateValue) => {
                if (!dateValue) return '';
                // If it's already in yyyy-MM-dd format, return as is
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                    return dateValue;
                }
                // Try to parse and format
                try {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().split('T')[0]; // Returns yyyy-MM-dd
                    }
                } catch (e) {
                    console.warn('Could not parse date:', dateValue, e);
                }
                return '';
            };
            
            document.getElementById('hotelCheckIn').value = formatDateForInput(hotel.check_in_date || hotel.checkIn);
            document.getElementById('hotelCheckOut').value = formatDateForInput(hotel.check_out_date || hotel.checkOut);
            document.getElementById('hotelAddress').value = hotel.address || '';
            document.getElementById('hotelContact').value = hotel.phone || hotel.contact || '';
            document.getElementById('hotelNotes').value = hotel.notes || '';
            document.getElementById('hotelSubmitBtn').textContent = 'Update Hotel';
        }
        window.editHotel = editHotel;
        
        // ==================== HOTELS CRUD OPERATIONS (MySQL Backend) ====================
        async function handleAddHotel(event) {
            event.preventDefault();
            
            const id = document.getElementById('hotelId').value;
            
            // Map frontend form fields to database fields
            // Database has: name, address, city, state, country, lat, lng, phone, email,
            //               total_floors, total_rooms, check_in_date, check_out_date, notes
            const location = document.getElementById('hotelLocation').value.trim();
            // Try to parse location into city/state/country (simple: assume first part is city)
            const locationParts = location.split(',').map(p => p.trim());
            
            const hotelData = {
                name: document.getElementById('hotelName').value.trim(),
                address: document.getElementById('hotelAddress').value.trim() || null,
                city: locationParts[0] || location || null, // Use first part as city, or whole location
                state: locationParts[1] || null,
                country: locationParts[2] || null,
                phone: document.getElementById('hotelContact').value.trim() || null,
                email: null, // Not in form, can be null
                lat: null, // Not in form, can be null
                lng: null, // Not in form, can be null
                // Hotel-specific fields
                total_floors: document.getElementById('hotelFloors').value ? parseInt(document.getElementById('hotelFloors').value) : null,
                total_rooms: document.getElementById('hotelRooms').value ? parseInt(document.getElementById('hotelRooms').value) : null,
                check_in_date: document.getElementById('hotelCheckIn').value || null,
                check_out_date: document.getElementById('hotelCheckOut').value || null,
                notes: document.getElementById('hotelNotes').value.trim() || null
            };
            
            try {
            if (id) {
                    // Update existing hotel via API
                    // Note: updateHotel API method may need to be added to backend
                    if (typeof api !== 'undefined' && api.updateHotel) {
                        await api.updateHotel(parseInt(id), hotelData);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('hotels');
                        }
                        hotels = await api.getHotels();
                        showMessage('Hotel updated successfully! üè®');
                    } else {
                        // Fallback: update locally (API method may need to be added)
                const index = hotels.findIndex(h => h.id == id);
                if (index !== -1) {
                    hotels[index] = { ...hotels[index], ...hotelData };
                            console.warn('Hotel updated locally - API updateHotel method may need to be added');
                            showMessage('Hotel updated successfully! üè® (Note: API update method may need to be added)');
                        }
                }
            } else {
                    // Add new hotel via API
                    if (typeof api !== 'undefined' && api.createHotel) {
                        await api.createHotel(hotelData);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('hotels');
                        }
                        hotels = await api.getHotels();
                showMessage('Hotel added successfully! üè®');
                    } else {
                        throw new Error('API not available');
                    }
                }
            } catch (error) {
                console.error('Error saving hotel:', error);
                showMessage('Error saving hotel. Please try again.', 'error');
                return;
            }
            
            loadHotelsTable();
            populateHotelSelects();
            closeHotelModal();
        }
        
        async function deleteHotel(id) {
            if (!confirm('Are you sure you want to delete this hotel? All room allotments will be lost.')) {
                return;
            }
            
            try {
                // Delete via API
                // Note: deleteHotel API method may need to be added to backend
                if (typeof api !== 'undefined' && api.deleteHotel) {
                    await api.deleteHotel(id);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('/hotels');
                        api.clearCacheFor('/roomAllotments');
                    }
                    hotels = await api.getHotels();
                    hotelAllotments = await api.getRoomAllotments({});
                    showMessage('Hotel deleted successfully!');
                } else {
                    // Fallback: delete locally (API method may need to be added)
                    hotels = hotels.filter(h => h.id !== id);
                // Remove all allotments for this hotel
                Object.keys(hotelAllotments).forEach(key => {
                    if (key.startsWith(`${id}-`)) {
                        delete hotelAllotments[key];
                    }
                });
                    console.warn('Hotel deleted locally - API deleteHotel method may need to be added');
                    showMessage('Hotel deleted successfully! (Note: API delete method may need to be added)');
                }
            } catch (error) {
                console.error('Error deleting hotel:', error);
                showMessage('Error deleting hotel. Please try again.', 'error');
                return;
            }
            
                loadHotelsTable();
                populateHotelSelects();
            }
        window.deleteHotel = deleteHotel;
        
        // ==================== HOTEL ALLOTMENT ====================
        
        function populateHotelSelects() {
            const select = document.getElementById('allotmentHotelSelect');
            if (!select) return;
            
            // Build location string from city, state, country (new schema) or use location (old schema)
            const getLocationString = (hotel) => {
                // New schema: city, state, country
                if (hotel.city || hotel.state || hotel.country) {
                    const locationParts = [];
                    if (hotel.city) locationParts.push(hotel.city);
                    if (hotel.state) locationParts.push(hotel.state);
                    if (hotel.country) locationParts.push(hotel.country);
                    return locationParts.length > 0 ? locationParts.join(', ') : 'Location not set';
                }
                // Old schema: location
                return hotel.location || 'Location not set';
            };
            
            select.innerHTML = '<option value="">Select Hotel</option>' + 
                hotels.map(h => `<option value="${h.id}">${h.name} - ${getLocationString(h)}</option>`).join('');
        }
        
        function populateDateSelect() {
            const select = document.getElementById('allotmentDateSelect');
            const hotelId = document.getElementById('allotmentHotelSelect').value;
            
            if (!select || !hotelId) {
                // Clear date select if no hotel selected
                if (select) {
                    select.innerHTML = '<option value="">Select Date</option>';
                }
                return;
            }
            
            const hotel = hotels.find(h => h.id == hotelId);
            if (!hotel) {
                select.innerHTML = '<option value="">Select Date</option>';
                return;
            }
            
            // Use new schema fields (check_in_date, check_out_date) or fallback to old schema (checkIn, checkOut)
            const checkInDate = hotel.check_in_date || hotel.checkIn;
            const checkOutDate = hotel.check_out_date || hotel.checkOut;
            
            if (!checkInDate || !checkOutDate) {
                select.innerHTML = '<option value="">No dates available (set check-in/out dates)</option>';
                console.warn('‚ö†Ô∏è Hotel missing check-in/out dates:', hotel);
                return;
            }
            
            const dates = [];
            const start = new Date(checkInDate);
            const end = new Date(checkOutDate);
            
            // Validate dates
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                select.innerHTML = '<option value="">Invalid dates</option>';
                console.error('‚ùå Invalid dates for hotel:', hotel);
                return;
            }
            
            // Generate date range
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d));
            }
            
            if (dates.length === 0) {
                select.innerHTML = '<option value="">No dates available</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select Date</option>' + 
                dates.map(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                    const formattedDate = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    return `<option value="${dateStr}">${dayName}, ${formattedDate}</option>`;
                }).join('');
            
            console.log(`‚úÖ Populated ${dates.length} dates for hotel ${hotel.name}`);
        }
        
        function loadAllotmentGrid() {
            const hotelId = document.getElementById('allotmentHotelSelect').value;
            const date = document.getElementById('allotmentDateSelect').value;
            const container = document.getElementById('allotmentGridContainer');
            
            if (!hotelId) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Please select a hotel</div>';
                return;
            }
            
            // Populate date select if hotel just selected
            if (hotelId && !date) {
                populateDateSelect();
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Please select a date</div>';
                return;
            }
            
            if (!date) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Please select a date</div>';
                return;
            }
            
            const hotel = hotels.find(h => h.id == hotelId);
            if (!hotel) return;
            
            const key = `${hotelId}-${date}`;
            const allotments = hotelAllotments[key] || {};
            
            // Create grid
            let html = '<div style="min-width: 800px;"><table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: var(--navy); color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd; width: 100px;">Pair No</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Travelers Names</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd; width: 150px;">Floor No</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd; width: 150px;">Room No</th>';
            html += '</tr></thead><tbody>';
            
            // Get room pairs
            const pairs = JSON.parse(localStorage.getItem('roomPairs') || '[]');
            
            if (pairs.length === 0) {
                // Fallback: Show individual travelers if no pairs exist
                travelers.forEach(traveler => {
                    const allotment = allotments[traveler.id] || { floor: '', room: '' };
                    html += '<tr>';
                    html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">-</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;"><strong>${traveler.name}</strong><br><small style="color: #666;">${traveler.email}</small></td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="number" data-traveler-id="${traveler.id}" class="floor-input" value="${allotment.floor || ''}" min="1" max="${hotel.floors}" placeholder="Floor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="text" data-traveler-id="${traveler.id}" class="room-input" value="${allotment.room}" placeholder="Room No" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </td>`;
                    html += '</tr>';
                });
            } else {
                // Show pairs
                pairs.forEach(pair => {
                    // Get first traveler's allotment as representative
                    const firstTravelerId = pair.travelerIds[0];
                    const allotment = allotments[firstTravelerId] || { floor: '', room: '' };
                    
                    // Get names of all travelers in pair
                    const travelerNames = pair.travelerIds.map(id => {
                        const t = travelers.find(tr => tr.id == id);
                        return t ? t.name : 'Unknown';
                    }).join(', ');
                    
                    html += '<tr>';
                    html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: var(--saffron);">Pair ${pair.pairNo}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;"><strong>${travelerNames}</strong><br><small style="color: #666;">${pair.travelerIds.length} travelers</small></td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="number" data-pair-id="${pair.id}" class="pair-floor-input" value="${allotment.floor || ''}" min="1" max="${hotel.floors}" placeholder="Floor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">
                        <input type="text" data-pair-id="${pair.id}" class="pair-room-input" value="${allotment.room}" placeholder="Room No" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </td>`;
                    html += '</tr>';
                });
                
                // Show unpaired travelers at the end
                const pairedTravelerIds = pairs.flatMap(p => p.travelerIds);
                const unpairedTravelers = travelers.filter(t => !pairedTravelerIds.includes(t.id));
                
                if (unpairedTravelers.length > 0) {
                    unpairedTravelers.forEach(traveler => {
                        const allotment = allotments[traveler.id] || { floor: '', room: '' };
                        html += '<tr style="background: #fff9e6;">';
                        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #999;">-</td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;"><strong>${traveler.name}</strong><br><small style="color: #666;">${traveler.email}</small><br><span style="color: #ff9800; font-size: 0.85rem;">‚ö†Ô∏è Not in any pair</span></td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">
                            <input type="number" data-traveler-id="${traveler.id}" class="floor-input" value="${allotment.floor || ''}" min="1" max="${hotel.floors}" placeholder="Floor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">
                            <input type="text" data-traveler-id="${traveler.id}" class="room-input" value="${allotment.room}" placeholder="Room No" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </td>`;
                        html += '</tr>';
                    });
                }
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        async function saveAllotments() {
            console.log('üíæ saveAllotments() called');
            
            const hotelId = document.getElementById('allotmentHotelSelect').value;
            const date = document.getElementById('allotmentDateSelect').value;
            
            console.log('üìã Hotel ID:', hotelId, 'Date:', date);
            
            if (!hotelId || !date) {
                showMessage('Please select hotel and date', 'error');
                return;
            }
            
            // Check if API is available
            if (typeof api === 'undefined' || !api.createRoomAllotment) {
                console.error('‚ùå API not available!', typeof api, api?.createRoomAllotment);
                showMessage('‚ö†Ô∏è API not available. Saving to localStorage only.', 'error');
                // Fallback to localStorage
                const key = `${hotelId}-${date}`;
                const allotments = {};
                const pairs = JSON.parse(localStorage.getItem('roomPairs') || '[]');
                
                document.querySelectorAll('.pair-floor-input').forEach(input => {
                    const pairId = input.dataset.pairId;
                    const floor = input.value;
                    const room = document.querySelector(`.pair-room-input[data-pair-id="${pairId}"]`)?.value || '';
                    
                    const pair = pairs.find(p => p.id == pairId);
                    if (pair && (floor || room)) {
                        pair.travelerIds.forEach(travelerId => {
                            allotments[travelerId] = { floor, room };
                        });
                    }
                });
                
                document.querySelectorAll('.floor-input').forEach(input => {
                    const travelerId = input.dataset.travelerId;
                    const floor = input.value;
                    const room = document.querySelector(`.room-input[data-traveler-id="${travelerId}"]`)?.value || '';
                    
                    if (floor || room) {
                        allotments[travelerId] = { floor, room };
                    }
                });
                
                hotelAllotments[key] = allotments;
                localStorage.setItem('hotelAllotments', JSON.stringify(hotelAllotments));
                showMessage('‚úÖ Room allotments saved to localStorage!');
                return;
            }
            
            try {
                // First, delete all existing allotments for this hotel/date
                if (api.deleteRoomAllotments) {
                    await api.deleteRoomAllotments(hotelId, date);
                    console.log('üóëÔ∏è Deleted existing allotments for hotel/date');
                }
                
                const pairs = JSON.parse(localStorage.getItem('roomPairs') || '[]');
                const allotmentsToSave = [];
                
                console.log('üîç Collecting allotments from form...');
                console.log('üìä Found pairs:', pairs.length);
                
                // Collect pair-based allotments
                const pairFloorInputs = document.querySelectorAll('.pair-floor-input');
                console.log('üîç Found pair floor inputs:', pairFloorInputs.length);
                
                pairFloorInputs.forEach(input => {
                    const pairId = input.dataset.pairId;
                    const floor = input.value;
                    const roomInput = document.querySelector(`.pair-room-input[data-pair-id="${pairId}"]`);
                    const room = roomInput ? roomInput.value : '';
                    
                    console.log(`  Pair ${pairId}: floor="${floor}", room="${room}"`);
                    
                    const pair = pairs.find(p => p.id == pairId);
                    if (pair && (floor || room)) {
                        // Get pair number
                        const pairNo = pair.pairNo || null;
                        console.log(`  ‚úÖ Pair ${pairId} has ${pair.travelerIds.length} travelers, pairNo: ${pairNo}`);
                        // Assign same room to all travelers in pair
                        pair.travelerIds.forEach(travelerId => {
                            const allotment = {
                                hotelId: parseInt(hotelId),
                                travelerId: parseInt(travelerId),
                                date: date,
                                floor: floor || null,
                                room: room || null,
                                pairNo: pairNo
                            };
                            allotmentsToSave.push(allotment);
                            console.log(`    ‚Üí Adding allotment for traveler ${travelerId}:`, allotment);
                        });
                    }
                });
                
                // Collect individual traveler allotments (unpaired)
                const floorInputs = document.querySelectorAll('.floor-input');
                console.log('üîç Found individual floor inputs:', floorInputs.length);
                
                floorInputs.forEach(input => {
                    const travelerId = input.dataset.travelerId;
                    const floor = input.value;
                    const roomInput = document.querySelector(`.room-input[data-traveler-id="${travelerId}"]`);
                    const room = roomInput ? roomInput.value : '';
                    
                    console.log(`  Traveler ${travelerId}: floor="${floor}", room="${room}"`);
                    
                    // Check if this traveler is not already in a pair allotment
                    const alreadyInPair = allotmentsToSave.some(a => a.travelerId == travelerId);
                    
                    if (!alreadyInPair && (floor || room)) {
                        const allotment = {
                            hotelId: parseInt(hotelId),
                            travelerId: parseInt(travelerId),
                            date: date,
                            floor: floor || null,
                            room: room || null,
                            pairNo: null
                        };
                        allotmentsToSave.push(allotment);
                        console.log(`    ‚Üí Adding allotment for traveler ${travelerId}:`, allotment);
                    } else if (alreadyInPair) {
                        console.log(`    ‚è≠Ô∏è Traveler ${travelerId} already in pair, skipping`);
                    }
                });
                
                console.log(`üì¶ Total allotments to save: ${allotmentsToSave.length}`);
                if (allotmentsToSave.length === 0) {
                    showMessage('‚ö†Ô∏è No room assignments found. Please assign floors/rooms first.', 'error');
                    return;
                }
                
                // Save all allotments to database
                let successCount = 0;
                let errorCount = 0;
                
                console.log('üíæ Starting to save allotments to database...');
                
                for (const allotment of allotmentsToSave) {
                    try {
                        console.log(`  Saving allotment:`, allotment);
                        const result = await api.createRoomAllotment(allotment);
                        console.log(`  ‚úÖ Saved successfully:`, result);
                        successCount++;
                    } catch (error) {
                        console.error(`  ‚ùå Error saving allotment for traveler ${allotment.travelerId}:`, error);
                        console.error('  Error details:', error.message, error.stack);
                        errorCount++;
                    }
                }
                
                // Clear cache to refresh data
                if (api.clearCacheFor) {
                    api.clearCacheFor('/hotels/allotments');
                }
                
                if (errorCount === 0) {
                    showMessage(`‚úÖ Room allotments saved successfully! (${successCount} travelers)`);
                } else {
                    showMessage(`‚ö†Ô∏è Saved ${successCount} allotments, ${errorCount} failed.`, 'error');
                }
                
                // Also update localStorage for backward compatibility
                const key = `${hotelId}-${date}`;
                const localAllotments = {};
                allotmentsToSave.forEach(a => {
                    localAllotments[a.travelerId] = { floor: a.floor, room: a.room };
                });
                hotelAllotments[key] = localAllotments;
                localStorage.setItem('hotelAllotments', JSON.stringify(hotelAllotments));
                
            } catch (error) {
                console.error('‚ùå Fatal error saving room allotments:', error);
                console.error('Error stack:', error.stack);
                showMessage('‚ùå Error saving room allotments. Please check console for details.', 'error');
            }
        }
        
        // Make sure the function is globally accessible
        window.saveAllotments = saveAllotments;
        
        function clearAllAllotments() {
            if (confirm('Clear all room assignments for this date? This cannot be undone.')) {
                travelers.forEach(traveler => {
                    const floorInput = document.getElementById(`floor-${traveler.id}`);
                    const roomInput = document.getElementById(`room-${traveler.id}`);
                    if (floorInput) floorInput.value = '';
                    if (roomInput) roomInput.value = '';
                });
                showMessage('üîÑ All room assignments cleared');
            }
        }

        // ==================== VEHICLE ALLOTMENT FUNCTIONS ====================

        async function populateVehicleAllotmentDateSelect() {
            const select = document.getElementById('vehicleAllotmentDateSelect');
            if (!select) return;
            
            // Try to load fresh itinerary from API first
            try {
                if (typeof api !== 'undefined' && api.getItinerary) {
                    const apiItinerary = await api.getItinerary();
                    if (apiItinerary && apiItinerary.length > 0) {
                        itinerary = apiItinerary.map(day => ({
                            ...day,
                            dateObj: day.dateObj ? new Date(day.dateObj) : (day.date ? new Date(day.date) : new Date())
                        }));
                        localStorage.setItem('itinerary', JSON.stringify(itinerary));
                    }
                }
            } catch (error) {
                console.warn('Could not load itinerary from API, using cached data:', error);
            }
            
            // Use current itinerary array (from API or cached)
            if (!itinerary || itinerary.length === 0) {
                select.innerHTML = '<option value="">No itinerary days available. Please add days in Itinerary section.</option>';
                return;
            }
            
            // Sort by day number
            const sortedDays = [...itinerary].sort((a, b) => (a.day || 0) - (b.day || 0));
            
            let options = '<option value="">Select Day</option>';
            sortedDays.forEach(day => {
                const dateObj = day.dateObj ? new Date(day.dateObj) : (day.date ? new Date(day.date) : null);
                const isoDate = dateObj && !isNaN(dateObj.getTime()) ? dateObj.toISOString().split('T')[0] : '';
                const displayDate = dateObj && !isNaN(dateObj.getTime())
                    ? dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
                    : (day.date || 'Date TBD');
                const dayNum = day.day || '';
                const place = day.place || '';
                options += `<option value="${isoDate || displayDate}">Day ${dayNum} - ${displayDate} - ${place}</option>`;
            });
            
            select.innerHTML = options;
        }

        async function loadVehicleAllotmentGrid() {
            const date = document.getElementById('vehicleAllotmentDateSelect').value;
            const container = document.getElementById('vehicleAllotmentGridContainer');
            
            if (!date) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Please select a day</div>';
                return;
            }

            container.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">Loading vehicle assignments...</div>';

            // Load existing allotments for the date from API
            let allotmentsForDate = [];
            if (typeof api !== 'undefined' && api.getVehicleAllotments) {
                try {
                    allotmentsForDate = await api.getVehicleAllotments({ date });
                    vehicleAllotmentsByDate[date] = allotmentsForDate;
                } catch (err) {
                    console.error('‚ùå Could not load vehicle allotments from API:', err);
                }
            } else if (vehicleAllotmentsByDate[date]) {
                allotmentsForDate = vehicleAllotmentsByDate[date];
            }

            const allotmentMap = {};
            if (Array.isArray(allotmentsForDate)) {
                allotmentsForDate.forEach(a => {
                    const travelerId = a.traveler_id ?? a.travelerId;
                    const vehicleId = a.vehicle_id ?? a.vehicleId;
                    if (travelerId) {
                        allotmentMap[travelerId] = vehicleId;
                    }
                });
            }
            
            // Get active vehicles
            const activeVehicles = vehicles.filter(v => v.status === 'Active');
            
            if (activeVehicles.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff9800;">‚ö†Ô∏è No active vehicles available. Please create vehicles first.</div>';
                return;
            }
            
            // Sort travelers by Tirth ID
            const sortedTravelers = [...travelers].sort((a, b) => {
                const tirthA = a.tirthId || '';
                const tirthB = b.tirthId || '';
                return tirthA.localeCompare(tirthB);
            });
            
            // Create grid
            let html = '<div style="min-width: 900px;"><table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: var(--navy); color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd; width: 120px;">Yatri ID</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Traveler Name</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd; width: 300px;">Allocated Vehicle</th>';
            html += '</tr></thead><tbody>';
            
            sortedTravelers.forEach(traveler => {
                // Prefer day-wise assignment; fall back to traveler's base vehicle_id
                const allocatedVehicleId = allotmentMap[traveler.id] ?? traveler.vehicleId ?? traveler.vehicle_id ?? '';
                
                html += '<tr>';
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: var(--saffron); font-weight: 600;">${traveler.tirthId || '-'}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">
                    <strong>${traveler.name}</strong><br>
                    <small style="color: #666;">${traveler.email}</small>
                </td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">
                    <select id="vehicle-${traveler.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">No Vehicle Assigned</option>`;
                
                activeVehicles.forEach(vehicle => {
                    const selected = vehicle.id == allocatedVehicleId ? 'selected' : '';
                    html += `<option value="${vehicle.id}" ${selected}>${vehicle.name} (${vehicle.type} - ${vehicle.capacity} seats)</option>`;
                });
                
                html += `</select>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function saveVehicleAllotments() {
            const date = document.getElementById('vehicleAllotmentDateSelect').value;
            
            if (!date) {
                showMessage('Please select a day', 'error');
                return;
            }
            
            // Check if API is available
            if (typeof api === 'undefined' || !api.saveVehicleAllotments) {
                showMessage('‚ùå Backend API not available. Cannot save vehicle assignments.', 'error');
                console.error('‚ùå API not available - cannot save to database');
                return;
            }
            
            // Collect allocations from form
            const assignments = [];
            travelers.forEach(traveler => {
                const vehicleSelect = document.getElementById(`vehicle-${traveler.id}`);
                if (vehicleSelect && vehicleSelect.value) {
                    assignments.push({
                        travelerId: traveler.id,
                        vehicleId: parseInt(vehicleSelect.value)
                    });
                }
            });
            
            // Enhanced logging for vehicle allotments
            console.log('‚úÖ ========================================');
            console.log('‚úÖ SAVING VEHICLE ALLOTMENTS TO DATABASE');
            console.log('‚úÖ ========================================');
            console.log('üìÖ Date:', date);
            console.log('üìä Total allotments:', assignments.length);
            
            // Show summary by vehicle
            const vehicleSummary = {};
            assignments.forEach(data => {
                const vehicleId = data.vehicleId;
                if (vehicleId) {
                    if (!vehicleSummary[vehicleId]) {
                        vehicleSummary[vehicleId] = [];
                    }
                    const travelerId = parseInt(data.travelerId);
                    const traveler = travelers.find(t => t.id == travelerId);
                    vehicleSummary[vehicleId].push({
                        id: travelerId,
                        name: traveler ? traveler.name : `Traveler ${travelerId}`,
                        email: traveler ? traveler.email : ''
                    });
                }
            });
            
            console.log('üöå Vehicle Assignments Summary:');
            if (Object.keys(vehicleSummary).length === 0) {
                console.log('   ‚ö†Ô∏è No vehicles assigned');
                // If nothing selected, clear assignments for this date
                try {
                    await api.deleteVehicleAllotments({ date });
                    vehicleAllotmentsByDate[date] = [];
                    await loadVehicleAllotmentGrid();
                    showMessage('‚úÖ Cleared all vehicle assignments for this date');
                } catch (err) {
                    console.error('‚ùå Failed clearing vehicle assignments:', err);
                    showMessage('‚ùå Failed to clear vehicle assignments for this date', 'error');
                }
                return;
            } else {
                // Get vehicles array safely
                const vehiclesList = (typeof vehicles !== 'undefined' && Array.isArray(vehicles)) 
                    ? vehicles 
                    : ((typeof window.vehicles !== 'undefined' && Array.isArray(window.vehicles))
                        ? window.vehicles
                        : []);
                
                Object.entries(vehicleSummary).forEach(([vehicleId, travelersList]) => {
                    const vehicle = vehiclesList.find(v => v.id == vehicleId || v.id === parseInt(vehicleId));
                    const vehicleName = vehicle ? vehicle.name : `Vehicle ${vehicleId}`;
                    console.log(`   üöå ${vehicleName} (ID: ${vehicleId}): ${travelersList.length} traveler(s)`);
                    travelersList.forEach(t => {
                        console.log(`      - ${t.name} (${t.email})`);
                    });
                });
            }
            
            try {
                await api.saveVehicleAllotments(date, assignments, true);
                vehicleAllotmentsByDate[date] = assignments.map(a => ({
                    date,
                    traveler_id: a.travelerId,
                    vehicle_id: a.vehicleId
                }));
                console.log('‚úÖ Vehicle assignments saved to database successfully');
                showMessage('‚úÖ Vehicle allotments saved to database successfully!');
                await loadVehicleAllotmentGrid();
                
                // Clear cache to refresh data
                if (api.clearCacheFor) {
                    api.clearCacheFor('/travelers');
                    api.clearCacheFor('/travelers/public');
                    api.clearCacheFor('/vehicles/allotments');
                }
                
                // Reload travelers if function exists
                if (typeof loadTravelersTable === 'function') {
                    loadTravelersTable();
                }
            } catch (error) {
                console.error('‚ùå Error saving vehicle assignments:', error);
                showMessage('‚ùå Failed to save vehicle assignments. Please try again.', 'error');
            }
            
            console.log('‚úÖ ========================================');
        }

        async function clearAllVehicleAllotments() {
            const date = document.getElementById('vehicleAllotmentDateSelect').value;
            
            if (!date) {
                showMessage('Please select a day', 'error');
                return;
            }
            
            if (!confirm('Clear all vehicle assignments? This will remove vehicle assignments from the database. This cannot be undone.')) {
                return;
            }
            
            // Check if API is available
            if (typeof api === 'undefined' || !api.deleteVehicleAllotments) {
                showMessage('‚ùå Backend API not available. Cannot clear vehicle assignments.', 'error');
                return;
            }
            
            try {
                const result = await api.deleteVehicleAllotments({ date });
                console.log('‚úÖ Vehicle allotments deleted:', result);
                vehicleAllotmentsByDate[date] = [];
                await loadVehicleAllotmentGrid();
                
                // Clear cache and reload
                if (api.clearCacheFor) {
                    api.clearCacheFor('/travelers');
                    api.clearCacheFor('/travelers/public');
                    api.clearCacheFor('/vehicles/allotments');
                }
                if (typeof loadTravelersTable === 'function') {
                    loadTravelersTable();
                }
                
                console.log('‚úÖ All vehicle assignments cleared from database for selected date');
                showMessage('‚úÖ All vehicle assignments cleared for selected date');
            } catch (error) {
                console.error('‚ùå Error clearing vehicle assignments:', error);
                showMessage('‚ùå Failed to clear some vehicle assignments. Check console for details.', 'error');
            }
        }

        // Bulk upload handler for vehicle allotment
        function handleVehicleAllotmentExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showMessage('üìä Processing vehicle allotment file...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (rows.length === 0) {
                        showMessage('‚ùå Excel file is empty', 'error');
                        return;
                    }
                    
                    // Check if API is available
                    if (typeof api === 'undefined' || !api.saveVehicleAllotments) {
                        showMessage('‚ùå Backend API not available. Cannot save vehicle assignments.', 'error');
                        return;
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    const assignmentsByDate = {};

                    const normalizeDateFromSheet = (value) => {
                        if (!value) return null;
                        const parsed = new Date(value);
                        if (isNaN(parsed.getTime())) return null;
                        return parsed.toISOString().split('T')[0];
                    };
                    
                    rows.forEach(row => {
                        try {
                            // Validate required fields
                            if (!row['Date'] || !row['Traveler Email'] || !row['Vehicle Name']) {
                                errorCount++;
                                return;
                            }

                            const normalizedDate = normalizeDateFromSheet(row['Date']);
                            if (!normalizedDate) {
                                errorCount++;
                                return;
                            }
                            
                            // Find traveler by email
                            const traveler = travelers.find(t => t.email === row['Traveler Email']);
                            if (!traveler) {
                                errorCount++;
                                return;
                            }
                            
                            // Find vehicle by name
                            const vehicle = vehicles.find(v => v.name === row['Vehicle Name']);
                            if (!vehicle) {
                                errorCount++;
                                return;
                            }
                            
                            if (!assignmentsByDate[normalizedDate]) {
                                assignmentsByDate[normalizedDate] = [];
                            }
                            assignmentsByDate[normalizedDate].push({
                                travelerId: traveler.id,
                                vehicleId: vehicle.id
                            });
                            successCount++;
                        } catch (err) {
                            errorCount++;
                        }
                    });
                    
                    const savePromises = Object.entries(assignmentsByDate).map(([dateStr, assignments]) => {
                        return api.saveVehicleAllotments(dateStr, assignments, true).then(() => {
                            vehicleAllotmentsByDate[dateStr] = assignments.map(a => ({
                                date: dateStr,
                                traveler_id: a.travelerId,
                                vehicle_id: a.vehicleId
                            }));
                        }).catch(err => {
                            console.error(`‚ùå Failed saving allotments for ${dateStr}:`, err);
                            errorCount += assignments.length;
                        });
                    });

                    Promise.all(savePromises).then(() => {
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('/travelers');
                            api.clearCacheFor('/travelers/public');
                            api.clearCacheFor('/vehicles/allotments');
                        }
                        if (typeof loadTravelersTable === 'function') {
                            loadTravelersTable();
                        }
                        loadVehicleAllotmentGrid();

                        if (errorCount === 0) {
                            showMessage(`‚úÖ Vehicle allotments updated for ${successCount} traveler(s) across ${Object.keys(assignmentsByDate).length} date(s)`, 'success');
                        } else {
                            showMessage(`‚ö†Ô∏è Processed ${successCount} entries, ${errorCount} failed.`, 'error');
                        }
                    }).catch(error => {
                        console.error('Error in bulk upload:', error);
                        showMessage(`‚ö†Ô∏è Bulk upload completed with errors. ${successCount} saved, ${errorCount} failed.`, 'error');
                    });
                    
                } catch (error) {
                    showMessage('‚ùå Error processing Excel file. Please check the format.', 'error');
                    console.error('Excel parsing error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset file input
        }

        // Bulk upload handler for room allotment
        function handleRoomAllotmentExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showMessage('üìä Processing room allotment file...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (rows.length === 0) {
                        showMessage('‚ùå Excel file is empty', 'error');
                        return;
                    }
                    
                    const roomAllotments = JSON.parse(localStorage.getItem('roomAllotments') || '{}');
                    let successCount = 0;
                    let errorCount = 0;
                    
                    rows.forEach(row => {
                        try {
                            // Validate required fields
                            if (!row['Hotel Name'] || !row['Date'] || !row['Traveler Emails'] || 
                                !row['Floor'] || !row['Room']) {
                                errorCount++;
                                return;
                            }
                            
                            // Find hotel by name
                            const hotel = hotels.find(h => h.name === row['Hotel Name']);
                            if (!hotel) {
                                errorCount++;
                                return;
                            }
                            
                            // Process comma-separated emails
                            const emails = row['Traveler Emails'].toString().split(',').map(e => e.trim());
                            const key = `${hotel.id}-${row['Date']}`;
                            if (!roomAllotments[key]) {
                                roomAllotments[key] = {};
                            }
                            
                            // Assign all travelers in the pair/group to the same room
                            emails.forEach(email => {
                                const traveler = travelers.find(t => t.email === email);
                                if (traveler) {
                                    roomAllotments[key][traveler.id] = {
                                        floor: row['Floor'].toString(),
                                        room: row['Room'].toString(),
                                        pairNo: row['Pair No'] || 0
                                    };
                                    successCount++;
                                } else {
                                    errorCount++;
                                }
                            });
                            
                        } catch (err) {
                            errorCount++;
                        }
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('roomAllotments', JSON.stringify(roomAllotments));
                    
                    showMessage(`‚úÖ Bulk upload complete! ${successCount} allocations added, ${errorCount} errors`, 'success');
                    
                } catch (error) {
                    showMessage('‚ùå Error processing Excel file. Please check the format.', 'error');
                    console.error('Excel parsing error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset file input
        }

        // ==================== CHECK-IN MANAGEMENT ====================
        
        async function initializeCheckIn(vehicleId) {
            // Clear check-ins via API to activate check-in (database only)
            try {
                if (typeof api !== 'undefined' && api.clearVehicleCheckIns) {
                    await api.clearVehicleCheckIns(vehicleId);
                    showMessage('‚úÖ Check-in activated for vehicle!');
                } else {
                    showMessage('API not available', 'error');
                }
            } catch (error) {
                console.error('Failed to activate check-in:', error);
                showMessage('‚ùå Failed to activate check-in. Please try again.', 'error');
            }
        }
        
        async function clearCheckIn(vehicleId) {
            // Get vehicle name for logging
            const vehicle = vehicles.find(v => v.id == vehicleId);
            const vehicleName = vehicle ? vehicle.name : `Vehicle ${vehicleId}`;
            
            console.log('üîÑ ========================================');
            console.log('üîÑ RESET & ACTIVATE CHECK-IN INITIATED');
            console.log('üîÑ ========================================');
            console.log(`üöå Vehicle ID: ${vehicleId}`);
            console.log(`üöå Vehicle Name: ${vehicleName}`);
            console.log(`üïê Timestamp: ${new Date().toISOString()}`);
            console.log('üîÑ Starting check-in activation process...');
            
            let apiSuccess = false;
            let retryCount = 0;
            const maxRetries = 3;
            
            // Try to clear check-ins via API with retry logic
            while (!apiSuccess && retryCount < maxRetries) {
                try {
                    if (typeof api !== 'undefined' && api.clearVehicleCheckIns) {
                        console.log(`üì° Attempting to clear check-ins via API (Attempt ${retryCount + 1}/${maxRetries})...`);
                        const response = await api.clearVehicleCheckIns(vehicleId);
                        console.log('‚úÖ Check-ins cleared via API successfully!');
                        console.log('üì¶ API Response:', response);
                        apiSuccess = true;
                    } else {
                        console.warn('‚ö†Ô∏è API not available - api.clearVehicleCheckIns is undefined');
                        break; // No API available, use localStorage
                    }
                } catch (error) {
                    retryCount++;
                    console.warn(`‚ö†Ô∏è Attempt ${retryCount} failed to clear check-ins via API:`, error);
                    console.warn(`‚ö†Ô∏è Error details:`, {
                        message: error.message,
                        stack: error.stack
                    });
                    if (retryCount < maxRetries) {
                        // Wait before retry (exponential backoff)
                        const waitTime = 1000 * retryCount;
                        console.log(`‚è≥ Waiting ${waitTime}ms before retry...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    } else {
                        console.error('‚ùå Failed to clear check-ins via API after all retries');
                        console.error('‚ùå Error details:', error);
                    }
                }
            }
            
            // Check-in data is now stored only in database, not localStorage
            // No need to update localStorage - all data is in database
            
            // Broadcast to other tabs/windows (for same browser)
            if (typeof BroadcastChannel !== 'undefined') {
                try {
                    const channel = new BroadcastChannel('yatra-checkin');
                    const activationMessage = { 
                        type: 'checkin-activated', 
                        vehicleId, 
                        timestamp: new Date().toISOString(),
                        apiSynced: apiSuccess
                    };
                    channel.postMessage(activationMessage);
                    console.log('üì¢ Broadcasted check-in activation:', activationMessage);
                } catch (broadcastError) {
                    console.warn('Could not broadcast check-in activation:', broadcastError);
                }
            }
            
            // Also trigger a storage event for cross-tab sync (same browser)
            try {
                // Force a storage event by setting a temporary value
                const tempKey = `checkInActivation_${vehicleId}_${Date.now()}`;
                localStorage.setItem(tempKey, new Date().toISOString());
                setTimeout(() => localStorage.removeItem(tempKey), 100);
            } catch (e) {
                console.warn('Could not trigger storage event:', e);
            }
            
            // Log final status
            if (apiSuccess) {
                console.log('‚úÖ ========================================');
                console.log('‚úÖ CHECK-IN ACTIVATION SUCCESSFUL');
                console.log('‚úÖ ========================================');
                console.log(`‚úÖ Vehicle: ${vehicleName} (ID: ${vehicleId})`);
                console.log(`‚úÖ Check-in is now ACTIVE for travelers`);
                console.log(`‚úÖ Travelers can now check in for this vehicle`);
                console.log(`‚úÖ Timestamp: ${new Date().toISOString()}`);
                console.log('‚úÖ ========================================');
                showMessage(`‚úÖ Check-in activated for ${vehicleName}! Travelers will be notified.`, 'success');
            } else {
                console.warn('‚ö†Ô∏è ========================================');
                console.warn('‚ö†Ô∏è CHECK-IN ACTIVATION (LOCAL ONLY)');
                console.warn('‚ö†Ô∏è ========================================');
                console.warn(`‚ö†Ô∏è Vehicle: ${vehicleName} (ID: ${vehicleId})`);
                console.warn(`‚ö†Ô∏è API unavailable - check-in activated locally only`);
                console.warn(`‚ö†Ô∏è Timestamp: ${new Date().toISOString()}`);
                console.warn('‚ö†Ô∏è ========================================');
                showMessage(`‚ö†Ô∏è Check-in activated for ${vehicleName} (local only - API unavailable).`, 'warning');
            }
            
            // Also show a more prominent notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #4caf50, #8bc34a);
                color: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                min-width: 300px;
                max-width: 400px;
                animation: slideInRight 0.5s ease;
                border-left: 4px solid #2e7d32;
            `;
            notification.innerHTML = `
                <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 8px;">üöå Check-In Activated!</div>
                <div style="font-size: 0.9rem; opacity: 0.95;">${vehicleName} - Travelers can now check in</div>
                ${!apiSuccess ? '<div style="font-size: 0.8rem; opacity: 0.9; margin-top: 5px; color: #ffeb3b;">‚ö†Ô∏è Saved locally (API unavailable)</div>' : ''}
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.3); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">‚úï</button>
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        async function viewCheckInReport(vehicleId) {
            const vehicle = vehicles.find(v => v.id == vehicleId);
            if (!vehicle) return;
            
            // Get allocated travelers - check both vehicleId and vehicle_id field names
            const allocatedTravelers = travelers.filter(t => 
                (t.vehicleId == vehicleId) || (t.vehicle_id == vehicleId)
            );
            
            console.log('üìä Check-In Report for Vehicle:', vehicleId);
            console.log('üìä Allocated travelers:', allocatedTravelers.length);
            console.log('üìä Travelers list:', travelers.length);
            if (allocatedTravelers.length === 0) {
                console.warn('‚ö†Ô∏è No travelers found for vehicle', vehicleId);
                console.warn('‚ö†Ô∏è Sample traveler structure:', travelers[0]);
                console.warn('‚ö†Ô∏è Checking vehicle assignments...');
                travelers.forEach(t => {
                    if (t.vehicleId || t.vehicle_id) {
                        console.log('  - Traveler:', t.email, 'vehicleId:', t.vehicleId, 'vehicle_id:', t.vehicle_id);
                    }
                });
            }
            
            // Try to load check-ins from API first with retry logic
            let checkIn = checkInData[vehicleId] || { checkedIn: [], active: false };
            let apiSuccess = false;
            let retryCount = 0;
            const maxRetries = 3;
            
            while (!apiSuccess && retryCount < maxRetries) {
                try {
                    if (typeof api !== 'undefined' && api.getCheckIns) {
                        // Clear cache to get fresh data
                        if (api.clearCacheFor) {
                            api.clearCacheFor(`/check-ins/vehicle/${vehicleId}`);
                        }
                        const apiData = await api.getCheckIns(vehicleId);
                        console.log('üì• Check-in API data for vehicle', vehicleId, ':', apiData);
                        if (apiData && apiData.checkedIn !== undefined) {
                            checkIn.checkedIn = apiData.checkedIn || [];
                            checkIn.active = apiData.active !== false;
                            checkIn.apiSynced = true;
                            // Update local storage
                            checkInData[vehicleId] = checkIn;
                            console.log('‚úÖ Updated check-in data:', {
                                vehicleId,
                                checkedInCount: checkIn.checkedIn.length,
                                checkedIn: checkIn.checkedIn
                            });
                            try {
                                // Check-in data is stored in database only, not localStorage
                            } catch (error) {
                                console.error('Error loading check-in data:', error);
                            }
                            apiSuccess = true;
                        }
                    } else {
                        break; // No API available
                    }
                } catch (error) {
                    retryCount++;
                    console.warn(`‚ö†Ô∏è Attempt ${retryCount} to load check-ins from API failed:`, error);
                    if (retryCount < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    } else {
                        console.warn('Could not load check-ins from API after retries, using local data');
                    }
                }
            }
            
            const checkedInCount = checkIn.checkedIn.length;
            const totalCount = allocatedTravelers.length;
            
            let reportHTML = `
                <div style="padding: 20px;">
                    <h3 style="color: var(--navy); margin-bottom: 20px;">üöå ${vehicle.name} - Check-In Report</h3>
                    
                    <div style="background: linear-gradient(135deg, ${vehicle.color}, ${vehicle.color}dd); color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 3rem; font-weight: bold;">${checkedInCount}/${totalCount}</div>
                        <div style="font-size: 1.2rem; margin-top: 10px;">Travelers Checked In</div>
                    </div>
                    
                    <h4 style="color: var(--navy); margin: 20px 0 10px 0;">‚úÖ Checked In (${checkedInCount})</h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin-bottom: 20px;">
            `;
            
            if (checkedInCount > 0) {
                checkIn.checkedIn.forEach(email => {
                    const traveler = travelers.find(t => t.email === email);
                    if (traveler) {
                        reportHTML += `
                            <div style="padding: 10px; margin: 5px 0; background: #e8f5e9; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">‚úÖ</span>
                                <div>
                                    <div style="font-weight: 600;">${traveler.name}</div>
                                    <div style="font-size: 0.85rem; color: #666;">${traveler.email}</div>
                                </div>
                            </div>
                        `;
                    }
                });
            } else {
                reportHTML += `<div style="text-align: center; padding: 20px; color: #999;">No check-ins yet</div>`;
            }
            
            reportHTML += `
                    </div>
                    
                    <h4 style="color: var(--navy); margin: 20px 0 10px 0;">‚è≥ Pending (${totalCount - checkedInCount})</h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; padding: 10px;">
            `;
            
            const pending = allocatedTravelers.filter(t => !checkIn.checkedIn.includes(t.email));
            if (pending.length > 0) {
                pending.forEach(traveler => {
                    reportHTML += `
                        <div style="padding: 10px; margin: 5px 0; background: #fff3e0; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">‚è≥</span>
                            <div>
                                <div style="font-weight: 600;">${traveler.name}</div>
                                <div style="font-size: 0.85rem; color: #666;">${traveler.email}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                reportHTML += `<div style="text-align: center; padding: 20px; color: #999;">All travelers checked in!</div>`;
            }
            
            reportHTML += `
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="console.log('üîò Modal Button Clicked: Reset & Activate Check-In'); console.log('üîò Vehicle ID: ${vehicleId}'); clearCheckIn(${vehicleId}); closeCheckInReportModal(); loadVehiclesTable();" style="padding: 12px 30px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Reset & Activate Check-In
                        </button>
                        <button onclick="closeCheckInReportModal()" style="padding: 12px 30px; background: #9e9e9e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            // Show in modal
            const modal = document.getElementById('checkInReportModal');
            const content = document.getElementById('checkInReportContent');
            content.innerHTML = reportHTML;
            modal.style.display = 'block';
        }
        window.viewCheckInReport = viewCheckInReport;
        
        function closeCheckInReportModal() {
            document.getElementById('checkInReportModal').style.display = 'none';
        }

        // ==================== END VEHICLE MANAGEMENT ====================

        // Note: Room Pair Management functions (loadPairs, openPairModal, etc.) are defined earlier in the file
        // Duplicate functions removed - using early definitions instead
        
        // Duplicate openPairModal removed
        function _openPairModal_duplicate(pairId = null) {
            const pair = pairId ? roomPairs.find(p => p.id === pairId) : null;
            const isEdit = !!pair;
            
            const modal = document.createElement('div');
            modal.id = 'pairModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const selectedIds = pair ? pair.travelerIds : [];
            
            // Get all traveler IDs that are already in other pairs
            const pairedTravelerIds = roomPairs
                .filter(p => !isEdit || p.id !== pairId) // Exclude current pair when editing
                .flatMap(p => p.travelerIds);
            
            // Filter travelers - when creating new pair, exclude already paired travelers
            let availableTravelers = travelers;
            if (!isEdit) {
                // Creating new pair - only show unpaired travelers
                availableTravelers = travelers.filter(t => !pairedTravelerIds.includes(t.id));
            } else {
                // Editing pair - show all travelers but those in OTHER pairs will be disabled
                availableTravelers = travelers;
            }
            
            const travelerCheckboxes = availableTravelers.map(t => {
                const isInOtherPair = isEdit && pairedTravelerIds.includes(t.id);
                const isSelected = selectedIds.includes(t.id);
                const isDisabled = isInOtherPair && !isSelected;
                
                return `
                    <label class="traveler-item" data-name="${t.name.toLowerCase()}" data-email="${t.email.toLowerCase()}" style="display: flex; align-items: center; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'}; background: ${isSelected ? '#e8f5e9' : (isDisabled ? '#f5f5f5' : 'white')}; opacity: ${isDisabled ? '0.5' : '1'};">
                        <input type="checkbox" value="${t.id}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} style="margin-right: 10px; width: 18px; height: 18px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};">
                        <div>
                            <strong>${t.name}</strong>${isDisabled ? ' <span style="color: #ff9800; font-size: 0.85rem;">(In another pair)</span>' : ''}<br>
                            <small style="color: #666;">${t.email}</small>
                        </div>
                    </label>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <h2 style="color: var(--navy); margin-bottom: 20px;">${isEdit ? 'Edit' : 'Create'} Room Pair</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--navy); font-weight: 500;">Pair Number</label>
                        <input type="number" id="pairNumber" value="${pair && pair.pairNo ? pair.pairNo : (typeof getNextPairNumber === 'function' ? getNextPairNumber() : 1)}" min="1" style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: 10px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <label style="display: block; margin-bottom: 8px; color: var(--navy); font-weight: 500;">Select Travelers${isEdit ? '' : ' (only unpaired travelers shown)'}</label>
                        
                        <!-- Search Box -->
                        <div style="margin-bottom: 10px;">
                            <input type="text" id="travelerSearch" placeholder="üîç Search by name or email..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem;" oninput="filterTravelers()">
                        </div>
                        
                        <div id="travelerCheckboxes" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; max-height: 300px;">
                            ${travelerCheckboxes}
                        </div>
                        <div id="travelerCount" style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                            ${availableTravelers.length} traveler${availableTravelers.length !== 1 ? 's' : ''} available
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closePairModal()" style="padding: 12px 30px; background: #999; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button onclick="savePair(${pairId || 'null'})" style="padding: 12px 30px; background: linear-gradient(135deg, var(--saffron), var(--green)); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Save Pair</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        // window.openPairModal already defined earlier
        
        // Filter travelers based on search input - duplicate
        function _filterTravelers_duplicate() {
            const searchText = document.getElementById('travelerSearch').value.toLowerCase();
            const items = document.querySelectorAll('.traveler-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                const email = item.getAttribute('data-email');
                const matches = name.includes(searchText) || email.includes(searchText);
                
                if (matches) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update count
            const countDiv = document.getElementById('travelerCount');
            if (countDiv) {
                countDiv.textContent = `${visibleCount} traveler${visibleCount !== 1 ? 's' : ''} ${searchText ? 'found' : 'available'}`;
            }
        }
        // window.filterTravelers already defined earlier
        
        // Get next pair number - using early version
        function _getNextPairNumber_duplicate() {
            if (roomPairs.length === 0) return 1;
            return Math.max(...roomPairs.map(p => p.pairNo)) + 1;
        }
        
        // Get next pair number - main function
        function getNextPairNumber() {
            if (!roomPairs || roomPairs.length === 0) return 1;
            const pairNumbers = roomPairs.map(p => p.pairNo || 0).filter(n => n > 0);
            if (pairNumbers.length === 0) return 1;
            return Math.max(...pairNumbers) + 1;
        }
        window.getNextPairNumber = getNextPairNumber;
        
        // ==================== ROOM PAIRS CRUD OPERATIONS (MySQL Backend) - DUPLICATE ====================
        async function _savePair_duplicate(pairId) {
            const pairNo = parseInt(document.getElementById('pairNumber').value);
            const checkboxes = document.querySelectorAll('#travelerCheckboxes input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (!pairNo) {
                alert('Please enter a pair number');
                return;
            }
            
            if (selectedIds.length < 1) {
                alert('Please select at least 1 traveler');
                return;
            }
            
            // Check if pair number already exists (except when editing same pair)
            const existingPair = roomPairs.find(p => p.pairNo === pairNo && p.id !== pairId);
            if (existingPair) {
                alert(`Pair number ${pairNo} already exists. Please use a different number.`);
                return;
            }
            
            const pairData = {
                    pairNo: pairNo,
                    travelerIds: selectedIds,
                    createdAt: new Date().toISOString()
            };
            
            try {
                if (pairId) {
                    // Update existing pair via API
                    if (typeof api !== 'undefined' && api.updateRoomPair) {
                        await api.updateRoomPair(pairId, pairData);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('roomPairs');
                        }
                        roomPairs = await api.getRoomPairs();
                        showMessage(`‚úÖ Pair ${pairNo} updated successfully!`);
                    } else {
                        throw new Error('API not available');
                    }
                } else {
                    // Create new pair via API
                    if (typeof api !== 'undefined' && api.createRoomPair) {
                        await api.createRoomPair(pairData);
                        // Clear cache and reload
                        if (api.clearCacheFor) {
                            api.clearCacheFor('roomPairs');
                        }
                        roomPairs = await api.getRoomPairs();
                        showMessage(`‚úÖ Pair ${pairNo} created successfully!`);
                    } else {
                        throw new Error('API not available');
                    }
                }
            } catch (error) {
                console.error('Error saving room pair:', error);
                showMessage('Error saving room pair. Please try again.', 'error');
                return;
            }
            
            closePairModal();
            loadPairs();
        }
        // window.savePair already defined earlier
        
        // Edit pair - duplicate
        function _editPair_duplicate(pairId) {
            openPairModal(pairId);
        }
        // window.editPair already defined earlier
        
        async function _deletePair_duplicate(pairId) {
            const pair = roomPairs.find(p => p.id === pairId);
            if (!pair) return;
            
            if (!confirm(`Delete Pair ${pair.pairNo}? This will not affect room allotments.`)) {
                return;
            }
            
            try {
                // Delete via API
                if (typeof api !== 'undefined' && api.deleteRoomPair) {
                    await api.deleteRoomPair(pairId);
                    // Clear cache and reload
                    if (api.clearCacheFor) {
                        api.clearCacheFor('roomPairs');
                    }
                    roomPairs = await api.getRoomPairs();
                    showMessage('Pair deleted successfully');
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('Error deleting room pair:', error);
                showMessage('Error deleting room pair. Please try again.', 'error');
                return;
            }
            
            loadPairs();
        }
        // window.deletePair already defined earlier
        
        // Close pair modal - duplicate
        function _closePairModal_duplicate() {
            const modal = document.getElementById('pairModal');
            if (modal) modal.remove();
        }
        // window.closePairModal already defined earlier

        // ==================== END ROOM PAIR MANAGEMENT (duplicates renamed) ====================

        // ==================== ANNOUNCEMENTS MANAGEMENT ====================
        
        // Initialize announcement data structures
        let scheduledAnnouncements = safeGetFromStorage('scheduledAnnouncements', []);
        let announcementHistory = safeGetFromStorage('announcementHistory', []);
        let announcementCheckInterval = null;

        // Populate announcement recipient dropdowns
        async function populateAnnouncementRecipients() {
            console.log('üìã Populating announcement recipients...');
            
            // Try to load from API if localStorage is empty or data seems outdated
            let travelers = safeGetFromStorage('authorizedTravelers', []);
            let vehicles = safeGetFromStorage('vehicles', []);
            
            // Load travelers from API if needed
            if ((!travelers || travelers.length === 0) && typeof api !== 'undefined' && api.getTravelers) {
                console.log('üì• Loading travelers from API...');
                try {
                    travelers = await api.getTravelers();
                    if (travelers && travelers.length > 0) {
                        localStorage.setItem('authorizedTravelers', JSON.stringify(travelers));
                        console.log(`‚úÖ Loaded ${travelers.length} travelers from API`);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading travelers:', error);
                }
            }
            
            // Load vehicles from API if needed
            if ((!vehicles || vehicles.length === 0) && typeof api !== 'undefined' && api.getVehicles) {
                console.log('üì• Loading vehicles from API...');
                try {
                    vehicles = await api.getVehicles();
                    if (vehicles && vehicles.length > 0) {
                        localStorage.setItem('vehicles', JSON.stringify(vehicles));
                        console.log(`‚úÖ Loaded ${vehicles.length} vehicles from API`);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading vehicles:', error);
                }
            }
            
            // Ensure we have arrays
            if (!Array.isArray(travelers)) travelers = [];
            if (!Array.isArray(vehicles)) vehicles = [];
            
            console.log(`üìä Using ${travelers.length} travelers and ${vehicles.length} vehicles for dropdowns`);
            
            // Populate specific traveler dropdown
            const specificTravelerSelect = document.getElementById('specificTravelerId');
            if (specificTravelerSelect) {
                specificTravelerSelect.innerHTML = '<option value="">Choose a traveler</option>';
                travelers.forEach(traveler => {
                    const option = document.createElement('option');
                    option.value = traveler.email;
                    option.textContent = `${traveler.name} (${traveler.email})`;
                    option.setAttribute('data-name', traveler.name);
                    specificTravelerSelect.appendChild(option);
                });
                console.log(`‚úÖ Populated ${travelers.length} travelers in dropdown`);
            }
            
            // Populate group leader dropdown
            const groupLeaderSelect = document.getElementById('specificGroupLeaderId');
            if (groupLeaderSelect) {
                groupLeaderSelect.innerHTML = '<option value="">Choose a group leader</option>';
                const uniqueLeaders = new Map();
                vehicles.forEach(vehicle => {
                    if (vehicle.groupLeaderEmail && !uniqueLeaders.has(vehicle.groupLeaderEmail)) {
                        uniqueLeaders.set(vehicle.groupLeaderEmail, vehicle.groupLeaderName);
                        const option = document.createElement('option');
                        option.value = vehicle.groupLeaderEmail;
                        option.textContent = `${vehicle.groupLeaderName || 'Unknown'} - ${vehicle.name || 'Unknown Vehicle'}`;
                        option.setAttribute('data-name', vehicle.groupLeaderName);
                        groupLeaderSelect.appendChild(option);
                    }
                });
                console.log(`‚úÖ Populated ${uniqueLeaders.size} group leaders in dropdown`);
            }
            
            // Populate vehicle dropdown
            const vehicleSelect = document.getElementById('vehicleId');
            if (vehicleSelect) {
                vehicleSelect.innerHTML = '<option value="">Choose a vehicle</option>';
                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.name || 'Unknown'} (${vehicle.groupLeaderName || 'N/A'})`;
                    vehicleSelect.appendChild(option);
                });
                console.log(`‚úÖ Populated ${vehicles.length} vehicles in dropdown`);
            }
        }

        // Handle recipient type change
        async function handleRecipientChange() {
            const recipientType = document.getElementById('announcementRecipient').value;
            
            // Load fresh data if needed
            let travelers = safeGetFromStorage('authorizedTravelers', []);
            let vehicles = safeGetFromStorage('vehicles', []);
            
            if (travelers.length === 0 && typeof api !== 'undefined' && api.getTravelers) {
                try {
                    travelers = await api.getTravelers();
                    localStorage.setItem('authorizedTravelers', JSON.stringify(travelers));
                } catch (error) {
                    console.error('Error loading travelers:', error);
                }
            }
            
            if (vehicles.length === 0 && typeof api !== 'undefined' && api.getVehicles) {
                try {
                    vehicles = await api.getVehicles();
                    localStorage.setItem('vehicles', JSON.stringify(vehicles));
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                }
            }
            
            // Ensure arrays
            if (!Array.isArray(travelers)) travelers = [];
            if (!Array.isArray(vehicles)) vehicles = [];
            
            // Hide all specific selects first
            document.getElementById('specificTravelerSelect').style.display = 'none';
            document.getElementById('specificGroupLeaderSelect').style.display = 'none';
            document.getElementById('vehicleSelect').style.display = 'none';
            
            // Show appropriate select based on recipient type
            if (recipientType === 'specific-traveler') {
                const select = document.getElementById('specificTravelerId');
                select.innerHTML = '<option value="">Choose a traveler</option>' +
                    travelers.map(t => `<option value="${t.email || ''}">${t.name || 'Unknown'} (${t.email || 'No email'})</option>`).join('');
                document.getElementById('specificTravelerSelect').style.display = 'block';
            } else if (recipientType === 'specific-group-leader') {
                const select = document.getElementById('specificGroupLeaderId');
                const groupLeadersMap = new Map();
                vehicles.forEach(v => {
                    if (v.groupLeaderEmail && !groupLeadersMap.has(v.groupLeaderEmail)) {
                        groupLeadersMap.set(v.groupLeaderEmail, v.groupLeaderName);
                    }
                });
                select.innerHTML = '<option value="">Choose a group leader</option>' +
                    Array.from(groupLeadersMap.entries()).map(([email, name]) => {
                        const traveler = travelers.find(t => t.email === email);
                        return `<option value="${email}">${traveler ? traveler.name : (name || email)} (${email})</option>`;
                    }).join('');
                document.getElementById('specificGroupLeaderSelect').style.display = 'block';
            } else if (recipientType === 'by-vehicle') {
                const select = document.getElementById('vehicleId');
                select.innerHTML = '<option value="">Choose a vehicle</option>' +
                    vehicles.map(v => `<option value="${v.id || ''}">${v.name || 'Unknown'} ${v.regNo ? '(' + v.regNo + ')' : ''}</option>`).join('');
                document.getElementById('vehicleSelect').style.display = 'block';
            }
        }

        // Handle timing type change
        function handleTimingChange() {
            const timingType = document.querySelector('input[name="timingType"]:checked').value;
            
            document.getElementById('timeSelect').style.display = 'none';
            document.getElementById('datetimeSelect').style.display = 'none';
            
            if (timingType === 'time') {
                document.getElementById('timeSelect').style.display = 'block';
            } else if (timingType === 'datetime') {
                document.getElementById('datetimeSelect').style.display = 'block';
            }
        }

        // Send announcement
        async function sendAnnouncement() {
            const recipientType = document.getElementById('announcementRecipient').value;
            const message = document.getElementById('announcementMessage').value.trim();
            const displayType = document.querySelector('input[name="displayType"]:checked').value;
            const timingType = document.querySelector('input[name="timingType"]:checked').value;
            
            if (!message) {
                showMessage('Please enter an announcement message', 'error');
                return;
            }
            
            // Load fresh data from API if needed
            let travelers = safeGetFromStorage('authorizedTravelers', []);
            let vehicles = safeGetFromStorage('vehicles', []);
            
            if ((!travelers || travelers.length === 0) && typeof api !== 'undefined' && api.getTravelers) {
                try {
                    travelers = await api.getTravelers();
                    localStorage.setItem('authorizedTravelers', JSON.stringify(travelers));
                } catch (error) {
                    console.error('Error loading travelers:', error);
                    showMessage('Error loading travelers data. Please try again.', 'error');
                    return;
                }
            }
            
            if ((!vehicles || vehicles.length === 0) && typeof api !== 'undefined' && api.getVehicles) {
                try {
                    vehicles = await api.getVehicles();
                    localStorage.setItem('vehicles', JSON.stringify(vehicles));
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                }
            }
            
            // Ensure arrays
            if (!Array.isArray(travelers)) travelers = [];
            if (!Array.isArray(vehicles)) vehicles = [];
            
            // Get recipients
            let recipients = [];
            let recipientLabel = '';
            
            if (recipientType === 'all-travelers') {
                recipients = travelers.filter(t => t.email).map(t => t.email);
                recipientLabel = 'All Travelers';
                console.log(`üì¢ Sending to all ${recipients.length} travelers`);
            } else if (recipientType === 'all-group-leaders') {
                recipients = [...new Set(vehicles.filter(v => v.groupLeaderEmail).map(v => v.groupLeaderEmail))];
                recipientLabel = 'All Group Leaders';
                console.log(`üì¢ Sending to all ${recipients.length} group leaders`);
            } else if (recipientType === 'specific-traveler') {
                const email = document.getElementById('specificTravelerId').value;
                if (!email) {
                    showMessage('Please select a traveler', 'error');
                    return;
                }
                recipients = [email];
                const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
                const traveler = travelers.find(t => t.email === email);
                recipientLabel = traveler ? traveler.name : email;
            } else if (recipientType === 'specific-group-leader') {
                const email = document.getElementById('specificGroupLeaderId').value;
                if (!email) {
                    showMessage('Please select a group leader', 'error');
                    return;
                }
                recipients = [email];
                const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
                const traveler = travelers.find(t => t.email === email);
                recipientLabel = traveler ? traveler.name : email;
            } else if (recipientType === 'by-vehicle') {
                const vehicleId = document.getElementById('vehicleId').value;
                if (!vehicleId) {
                    showMessage('Please select a vehicle', 'error');
                    return;
                }
                const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
                const vehicle = vehicles.find(v => v.id == vehicleId);
                const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
                recipients = travelers.filter(t => t.vehicleId == vehicleId).map(t => t.email);
                recipientLabel = vehicle ? vehicle.name : `Vehicle #${vehicleId}`;
            }
            
            if (recipients.length === 0) {
                showMessage('No recipients found', 'error');
                return;
            }
            
            // Create announcement object
            const announcement = {
                id: Date.now(),
                message: message,
                recipients: recipients,
                recipientType: recipientType,
                recipientValue: recipientType === 'by-vehicle' ? document.getElementById('vehicleId').value : 
                               (recipientType === 'specific-traveler' ? document.getElementById('specificTravelerId').value :
                               (recipientType === 'specific-group-leader' ? document.getElementById('specificGroupLeaderId').value : null)),
                recipientLabel: recipientLabel,
                displayType: displayType,
                timingType: timingType,
                createdAt: new Date().toISOString(),
                status: 'pending'
            };
            
            // Handle timing
            if (timingType === 'instant') {
                // Send immediately via API
                try {
                    await sendAnnouncementNow(announcement);
                    
                    // Save to history (local for admin panel display)
                    announcement.status = 'sent';
                    announcement.sentAt = new Date().toISOString();
                    announcementHistory.unshift(announcement);
                    localStorage.setItem('announcementHistory', JSON.stringify(announcementHistory));
                    
                    loadAnnouncementHistory();
                    showMessage('‚úÖ Announcement sent successfully to ' + recipients.length + ' recipient(s)!');
                    clearAnnouncementForm();
                } catch (error) {
                    console.error('Error sending announcement:', error);
                    showMessage('Error sending announcement. Please try again.', 'error');
                }
            } else if (timingType === 'time') {
                const time = document.getElementById('scheduledTime').value;
                if (!time) {
                    showMessage('Please select a time', 'error');
                    return;
                }
                announcement.scheduledTime = time;
                announcement.status = 'scheduled-recurring';
                
                scheduledAnnouncements.push(announcement);
                localStorage.setItem('scheduledAnnouncements', JSON.stringify(scheduledAnnouncements));
                
                loadScheduledAnnouncements();
                showMessage('‚úÖ Announcement scheduled for daily at ' + time);
                clearAnnouncementForm();
                
                // Start checking for scheduled announcements
                startAnnouncementChecker();
            } else if (timingType === 'datetime') {
                const date = document.getElementById('scheduledDate').value;
                const time = document.getElementById('scheduledDateTime').value;
                if (!date || !time) {
                    showMessage('Please select both date and time', 'error');
                    return;
                }
                announcement.scheduledDate = date;
                announcement.scheduledTime = time;
                announcement.status = 'scheduled-once';
                
                scheduledAnnouncements.push(announcement);
                localStorage.setItem('scheduledAnnouncements', JSON.stringify(scheduledAnnouncements));
                
                loadScheduledAnnouncements();
                showMessage(`‚úÖ Announcement scheduled for ${date} at ${time}`);
                clearAnnouncementForm();
                
                // Start checking for scheduled announcements
                startAnnouncementChecker();
            }
        }

        // Send announcement immediately via API
        async function sendAnnouncementNow(announcement) {
            try {
                // Store recipients as JSON string for complex recipient types
                let recipientValue = null;
                if (announcement.recipientType === 'specific-traveler' || 
                    announcement.recipientType === 'specific-group-leader') {
                    recipientValue = announcement.recipients[0] || null;
                } else if (announcement.recipientType === 'by-vehicle' || 
                          announcement.recipientType === 'specific-vehicle') {
                    recipientValue = announcement.recipientValue || null;
                }
                
                const announcementData = {
                    recipientType: announcement.recipientType,
                    recipientValue: recipientValue,
                    recipients: announcement.recipients || [],
                    message: announcement.message || '',
                    displayType: announcement.displayType || 'notification',
                    timingType: 'instant',
                    scheduledTime: null
                };
                
                if (typeof api !== 'undefined' && api.createAnnouncement) {
                    await api.createAnnouncement(announcementData);
                    console.log('‚úÖ Announcement sent via API:', announcementData.message, 'to', announcementData.recipients.length, 'recipients');
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('‚ùå Error sending announcement via API:', error);
                throw error;
            }
        }

        // Start announcement checker
        function startAnnouncementChecker() {
            if (announcementCheckInterval) return; // Already running
            
            announcementCheckInterval = setInterval(() => {
                checkScheduledAnnouncements();
            }, 30000); // Check every 30 seconds
            
            console.log('‚úÖ Announcement checker started');
        }

        // Check scheduled announcements
        function checkScheduledAnnouncements() {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM
            const currentDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
            
            let updated = false;
            
            scheduledAnnouncements.forEach(announcement => {
                if (announcement.status === 'scheduled-recurring') {
                    // Time-based (daily)
                    if (announcement.scheduledTime === currentTime) {
                        // Check if already sent today
                        const lastSent = announcement.lastSent ? new Date(announcement.lastSent).toISOString().split('T')[0] : null;
                        if (lastSent !== currentDate) {
                            sendAnnouncementNow(announcement);
                            announcement.lastSent = now.toISOString();
                            
                            // Add to history
                            const historyEntry = {...announcement};
                            historyEntry.status = 'sent';
                            historyEntry.sentAt = now.toISOString();
                            announcementHistory.unshift(historyEntry);
                            
                            updated = true;
                        }
                    }
                } else if (announcement.status === 'scheduled-once') {
                    // Date-time based (one-time)
                    if (announcement.scheduledDate === currentDate && announcement.scheduledTime === currentTime) {
                        sendAnnouncementNow(announcement);
                        announcement.status = 'sent';
                        announcement.sentAt = now.toISOString();
                        
                        // Add to history
                        announcementHistory.unshift(announcement);
                        
                        updated = true;
                    }
                }
            });
            
            if (updated) {
                // Remove sent one-time announcements
                scheduledAnnouncements = scheduledAnnouncements.filter(a => a.status !== 'sent');
                
                localStorage.setItem('scheduledAnnouncements', JSON.stringify(scheduledAnnouncements));
                localStorage.setItem('announcementHistory', JSON.stringify(announcementHistory));
                
                loadScheduledAnnouncements();
                loadAnnouncementHistory();
                
                console.log('‚úÖ Scheduled announcements sent');
            }
        }

        // Load scheduled announcements
        function loadScheduledAnnouncements() {
            const container = document.getElementById('scheduledAnnouncementsList');
            scheduledAnnouncements = safeGetFromStorage('scheduledAnnouncements', []);
            
            if (scheduledAnnouncements.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No scheduled announcements</div>';
                return;
            }
            
            container.innerHTML = scheduledAnnouncements.map(announcement => {
                const scheduleInfo = announcement.status === 'scheduled-recurring' 
                    ? `‚è∞ Daily at ${announcement.scheduledTime}`
                    : `üìÖ ${new Date(announcement.scheduledDate).toLocaleDateString()} at ${announcement.scheduledTime}`;
                
                return `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--saffron);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--navy); margin-bottom: 8px;">${escapeHTML(announcement.recipientLabel)}</div>
                                <div style="color: #666; margin-bottom: 8px;">${escapeHTML(announcement.message)}</div>
                                <div style="font-size: 0.85rem; color: #999;">
                                    ${scheduleInfo} ‚Ä¢ ${announcement.displayType === 'notification' ? 'üîî Notification' : 'üí¨ Dialog'}
                                </div>
                            </div>
                            <button onclick="deleteScheduledAnnouncement(${announcement.id})" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Delete scheduled announcement
        function deleteScheduledAnnouncement(id) {
            if (confirm('Delete this scheduled announcement?')) {
                scheduledAnnouncements = scheduledAnnouncements.filter(a => a.id !== id);
                localStorage.setItem('scheduledAnnouncements', JSON.stringify(scheduledAnnouncements));
                loadScheduledAnnouncements();
                showMessage('Scheduled announcement deleted');
            }
        }
        window.deleteScheduledAnnouncement = deleteScheduledAnnouncement;

        // Load announcement history
        function loadAnnouncementHistory() {
            const tbody = document.getElementById('announcementHistoryTable');
            announcementHistory = safeGetFromStorage('announcementHistory', []);
            
            if (announcementHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No announcements sent yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = announcementHistory.slice(0, 50).map(announcement => `
                <tr>
                    <td>${new Date(announcement.sentAt || announcement.createdAt).toLocaleString()}</td>
                    <td>${escapeHTML(announcement.recipientLabel)} (${announcement.recipients.length})</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHTML(announcement.message)}</td>
                    <td>${announcement.displayType === 'notification' ? 'üîî Notification' : 'üí¨ Dialog'}</td>
                    <td><span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">‚úì Sent</span></td>
                </tr>
            `).join('');
        }

        // Clear announcement history
        function clearAnnouncementHistory() {
            if (confirm('Clear all announcement history? This cannot be undone.')) {
                announcementHistory = [];
                localStorage.setItem('announcementHistory', JSON.stringify(announcementHistory));
                loadAnnouncementHistory();
                showMessage('Announcement history cleared');
            }
        }

        // Refresh scheduled announcements
        function refreshScheduledAnnouncements() {
            loadScheduledAnnouncements();
            showMessage('Scheduled announcements refreshed');
        }

        // Clear announcement form
        function clearAnnouncementForm() {
            document.getElementById('announcementRecipient').value = 'all-travelers';
            document.getElementById('announcementMessage').value = '';
            document.querySelector('input[name="displayType"][value="notification"]').checked = true;
            document.querySelector('input[name="timingType"][value="instant"]').checked = true;
            document.getElementById('scheduledTime').value = '';
            document.getElementById('scheduledDate').value = '';
            document.getElementById('scheduledDateTime').value = '';
            handleRecipientChange();
            handleTimingChange();
        }

        // Initialize announcements system
        function initializeAnnouncementsSystem() {
            try {
                loadScheduledAnnouncements();
                loadAnnouncementHistory();
                startAnnouncementChecker();
            } catch (error) {
                console.error('‚ùå Announcements initialization failed:', error);
            }
        }

        // ==================== GLOBAL FUNCTION ASSIGNMENTS ====================
        // Ensure all action button functions are globally accessible
        // Using direct assignments (not conditional) to ensure they're available
        
        // Travelers
        window.deleteTraveler = window.deleteTraveler || deleteTraveler;
        window.editTraveler = window.editTraveler || editTraveler;
        
        // Posts
        window.deletePost = window.deletePost || deletePost;
        // approvePost is already assigned at line 5971 - don't override with old function
        if (!window.approvePost) {
            console.error('‚ùå approvePost not found on window! This should not happen.');
        } else {
            console.log('‚úÖ approvePost correctly assigned to window');
        }
        window.viewPost = window.viewPost || viewPost;
        window.approvePostFromFullscreen = window.approvePostFromFullscreen || approvePostFromFullscreen;
        
        // Vehicles
        window.deleteVehicle = window.deleteVehicle || deleteVehicle;
        window.editVehicle = window.editVehicle || editVehicle;
        
        // Hotels
        window.deleteHotel = window.deleteHotel || deleteHotel;
        window.editHotel = window.editHotel || editHotel;
        
        // Tags
        window.deleteTag = window.deleteTag || deleteTag;
        
        // Itinerary
        window.deleteItinerary = window.deleteItinerary || deleteItinerary;
        window.editItinerary = window.editItinerary || editItinerary;
        
        // Room Pairs
        window.deletePair = window.deletePair || deletePair;
        window.editPair = window.editPair || editPair;
        
        // Sections
        window.editSection = window.editSection || (typeof editSection !== 'undefined' ? editSection : function() { console.warn('editSection function not defined'); });
        window.deleteSection = window.deleteSection || (typeof deleteSection !== 'undefined' ? deleteSection : function() { console.warn('deleteSection function not defined'); });
        
        // Check-in
        window.viewCheckInReport = window.viewCheckInReport || viewCheckInReport;
        
        // Announcements
        window.deleteScheduledAnnouncement = window.deleteScheduledAnnouncement || deleteScheduledAnnouncement;
        
        console.log('‚úÖ All action button functions assigned to window object');

        // Global error handlers
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error);
            showMessage('‚ö†Ô∏è An unexpected error occurred. Please refresh if issues persist.', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showMessage('‚ö†Ô∏è An operation failed. Please try again.', 'error');
        });

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        function initializeApp() {
            console.log('‚úÖ Application initialized');
        }
    </script>
    
    <!-- ==================== LIVE RELOAD SCRIPT ==================== -->
    <!-- This script automatically reloads the page when the HTML file is modified -->
    <script>
        (function() {
            // Only enable in development (when file:// protocol or localhost)
            const isDevelopment = window.location.protocol === 'file:' || 
                                 window.location.hostname === 'localhost' || 
                                 window.location.hostname === '127.0.0.1';
            
            if (!isDevelopment) {
                return; // Don't enable live reload in production
            }
            
            // Check if user wants to disable live reload
            const disableLiveReload = sessionStorage.getItem('disableLiveReload') === 'true';
            if (disableLiveReload) {
                console.log('‚ÑπÔ∏è Live reload is disabled. Press Ctrl+Shift+L to enable.');
                return;
            }
            
            const STORAGE_KEY = 'liveReload_lastModified';
            const RELOAD_COOLDOWN = 3000; // 3 seconds cooldown between reloads
            let lastReloadTime = parseInt(sessionStorage.getItem('liveReload_lastReloadTime') || '0');
            let checkInterval = null;
            let isReloading = false;
            let checkCount = 0;
            
            // Get stored last modified time from previous session
            let storedLastModified = sessionStorage.getItem(STORAGE_KEY);
            
            // Function to check if file has been modified
            async function checkForChanges() {
                // Check if live reload is disabled FIRST
                if (sessionStorage.getItem('disableLiveReload') === 'true') {
                    return; // Live reload is disabled, don't check
                }
                
                if (isReloading) {
                    console.log('‚è∏Ô∏è Already reloading, skipping check');
                    return;
                }
                
                // Prevent reload loops - check cooldown
                const timeSinceLastReload = Date.now() - lastReloadTime;
                if (timeSinceLastReload < RELOAD_COOLDOWN) {
                    return; // Too soon after last reload
                }
                
                try {
                    let currentModified = null;
                    
                    // Method 1: For http:// protocol, use document.lastModified (more reliable)
                    // Avoid HEAD requests that can cause ERR_CONTENT_LENGTH_MISMATCH
                    if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                        // Use document.lastModified which is more reliable and doesn't cause content-length issues
                        currentModified = document.lastModified;
                        
                        // Only use fetch as fallback if document.lastModified is not available
                        if (!currentModified || currentModified === 'Invalid Date') {
                            try {
                                // Use a small delay to avoid content-length mismatch
                                await new Promise(resolve => setTimeout(resolve, 100));
                                const response = await fetch(window.location.href + '?t=' + Date.now(), {
                                    method: 'HEAD',
                                    cache: 'no-cache',
                                    // Add headers to prevent caching issues
                                    headers: {
                                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                                        'Pragma': 'no-cache'
                                    }
                                });
                                
                                if (response.ok) {
                                    currentModified = response.headers.get('Last-Modified');
                                }
                            } catch (e) {
                                // Fetch failed, skip this check
                                console.warn('Live reload check failed (will retry):', e.message);
                                return;
                            }
                        }
                    } else {
                        // Method 2: For file:// protocol, use document.lastModified
                        currentModified = document.lastModified;
                    }
                    
                    // Only check after initial setup (skip first few checks to avoid false positives)
                    checkCount++;
                    if (checkCount < 5) {
                        // Store initial value but don't reload yet (increased from 3 to 5)
                        if (!storedLastModified) {
                            sessionStorage.setItem(STORAGE_KEY, currentModified);
                            storedLastModified = currentModified;
                        }
                        return;
                    }
                    
                    // Compare with stored value - only reload if actually different
                    if (storedLastModified && currentModified && currentModified !== storedLastModified) {
                        // Double-check: make sure we're not in a reload loop
                        const reloadKey = 'liveReload_reloadCount';
                        const reloadCount = parseInt(sessionStorage.getItem(reloadKey) || '0');
                        
                        if (reloadCount > 3) {
                            console.warn('‚ö†Ô∏è Too many reloads detected, disabling live reload to prevent loop');
                            sessionStorage.setItem('disableLiveReload', 'true');
                            if (checkInterval) {
                                clearInterval(checkInterval);
                                checkInterval = null;
                            }
                            return;
                        }
                        
                        console.log('üîÑ File modified! Reloading...');
                        console.log('   Old:', storedLastModified);
                        console.log('   New:', currentModified);
                        
                        isReloading = true;
                        lastReloadTime = Date.now();
                        sessionStorage.setItem('liveReload_lastReloadTime', lastReloadTime.toString());
                        sessionStorage.setItem(reloadKey, (reloadCount + 1).toString());
                        sessionStorage.setItem(STORAGE_KEY, currentModified);
                        
                        // Reset reload count after cooldown
                        setTimeout(() => {
                            sessionStorage.setItem(reloadKey, '0');
                        }, RELOAD_COOLDOWN);
                        
                        // Small delay to ensure storage is saved
                        setTimeout(() => {
                            window.location.reload();
                        }, 100);
                        return;
                    }
                    
                    // Reset reload count if no reload happened
                    if (checkCount % 10 === 0) {
                        sessionStorage.setItem('liveReload_reloadCount', '0');
                    }
                    
                    // Update stored value if it's the first time or if it changed (but don't reload)
                    if (!storedLastModified || storedLastModified !== currentModified) {
                        sessionStorage.setItem(STORAGE_KEY, currentModified);
                        storedLastModified = currentModified;
                    }
                } catch (error) {
                    console.warn('Live reload check failed:', error);
                }
            }
            
            // Start checking for changes
            function startLiveReload() {
                if (checkInterval) return; // Already started
                
                console.log('üîÑ Live reload enabled - checking for changes every 5 seconds...');
                if (storedLastModified) {
                    console.log('üìù Last known modification:', storedLastModified);
                }
                
                // Wait longer before starting checks to avoid false positives and content-length issues
                setTimeout(() => {
                    // Check every 5 seconds (increased to reduce server load and prevent ERR_CONTENT_LENGTH_MISMATCH)
                    checkInterval = setInterval(checkForChanges, 5000);
                }, 5000); // Increased initial delay to 5 seconds
            }
            
            // Start live reload after page is fully loaded
            if (document.readyState === 'complete') {
                startLiveReload();
            } else {
                window.addEventListener('load', startLiveReload);
            }
            
            // Add keyboard shortcut: Ctrl+Shift+R to manually trigger reload
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    console.log('üîÑ Manual reload triggered (Ctrl+Shift+R)');
                    window.location.reload();
                }
                // Ctrl+Shift+L to toggle live reload
                if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                    e.preventDefault();
                    const currentlyDisabled = sessionStorage.getItem('disableLiveReload') === 'true';
                    const newState = (!currentlyDisabled).toString();
                    sessionStorage.setItem('disableLiveReload', newState);
                    
                    if (currentlyDisabled) {
                        // Enabling live reload - need to reload page
                        console.log('‚úÖ Live reload ENABLED. Reloading page...');
                        if (checkInterval) {
                            clearInterval(checkInterval);
                            checkInterval = null;
                        }
                        setTimeout(() => {
                            window.location.reload();
                        }, 100);
                    } else {
                        // Disabling live reload - stop immediately
                        console.log('‚è∏Ô∏è Live reload DISABLED. Press Ctrl+Shift+L to enable again.');
                        if (checkInterval) {
                            clearInterval(checkInterval);
                            checkInterval = null;
                            console.log('‚úÖ Live reload interval cleared');
                        }
                        // Prevent any pending reloads
                        isReloading = false;
                    }
                }
            });
            
            // Expose function to manually trigger reload
            window.triggerLiveReload = function() {
                console.log('üîÑ Manual reload triggered via window.triggerLiveReload()');
                window.location.reload();
            };
            
            // Expose function to disable/enable live reload
            window.toggleLiveReload = function() {
                const currentlyDisabled = sessionStorage.getItem('disableLiveReload') === 'true';
                sessionStorage.setItem('disableLiveReload', (!currentlyDisabled).toString());
                console.log(currentlyDisabled ? '‚úÖ Live reload enabled' : '‚è∏Ô∏è Live reload disabled');
                if (currentlyDisabled) {
                    window.location.reload();
                } else {
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                }
            };
            
            console.log('‚úÖ Live reload script loaded. Changes will be detected automatically.');
            console.log('üí° Press Ctrl+Shift+L to toggle live reload on/off');
        })();
    </script>
</body>
</html>