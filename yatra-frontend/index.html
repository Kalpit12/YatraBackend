<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spiritual Yatra - Live Journey</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïâÔ∏è</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïâÔ∏è</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üïâÔ∏è</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Libraries for Export Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --saffron: #FF9933;
            --white: #FFFFFF;
            --green: #138808;
            --navy: #000080;
            --light-saffron: #FFB366;
            --dark-green: #0A5504;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            background: #f5f5f5;
        }

        /* Header Section */
        .header-banner {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, var(--saffron) 0%, var(--light-saffron) 50%, var(--white) 50%, var(--green) 100%);
            position: relative;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header-banner.hidden {
            height: 0;
            opacity: 0;
            margin-top: -120px;
        }

        /* Header Toggle Button */
        .header-toggle-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            border: 3px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1001;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .header-toggle-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        }

        .header-toggle-btn:active {
            transform: scale(0.95);
        }

        /* Journey Information Strip */
        .journey-strip {
            width: 100%;
            background: linear-gradient(90deg, var(--navy) 0%, #000099 100%);
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 999;
            transition: all 0.3s ease;
        }

        .journey-strip.hidden {
            height: 0;
            padding: 0;
            opacity: 0;
            margin-top: -48px;
            overflow: hidden;
        }

        .journey-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 15px;
        }

        .journey-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .journey-icon {
            font-size: 1.2rem;
        }

        .journey-label {
            font-weight: 500;
            opacity: 0.9;
        }

        .journey-value {
            font-weight: 600;
            color: var(--light-saffron);
        }

        .journey-current .journey-value {
            color: #FFD700;
            font-weight: 700;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
        }

        .header-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .yatra-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--navy);
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            letter-spacing: 3px;
            text-align: center;
            padding: 0 20px;
        }

        .header-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .om-symbol {
            position: absolute;
            font-size: 4rem;
            opacity: 0.1;
            color: var(--navy);
            animation: float 6s ease-in-out infinite;
        }

        .om-left {
            top: 50%;
            left: 5%;
            transform: translateY(-50%);
        }

        .om-right {
            top: 50%;
            right: 5%;
            transform: translateY(-50%);
            animation-delay: 3s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(-50%) rotate(0deg); }
            50% { transform: translateY(-60%) rotate(5deg); }
        }

        /* Floating Action Buttons */
        .fab-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            color: white;
        }

        /* Combined Actions Menu */
        .fab-actions-menu {
            background: linear-gradient(135deg, #FF9933, #138808);
        }

        .actions-menu-popup {
            position: fixed;
            right: 90px;
            bottom: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            padding: 10px;
            display: none;
            z-index: 998;
            min-width: 200px;
        }

        .actions-menu-popup.active {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        .action-menu-item {
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #333;
        }

        .action-menu-item:hover {
            background: rgba(255, 153, 51, 0.1);
            transform: translateX(5px);
        }

        .action-menu-icon {
            font-size: 1.5rem;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .action-menu-icon.post {
            background: linear-gradient(135deg, #FF9933, #FFB366);
        }

        .action-menu-icon.journal {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
        }

        .action-menu-icon.profile {
            background: linear-gradient(135deg, #FF9933, #138808);
        }

        /* User Name Strip */
        .user-name-strip {
            position: fixed;
            left: 90px;
            bottom: 25px;
            background: linear-gradient(135deg, #FF9933, #138808);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            z-index: 1499;
            font-weight: 600;
            font-size: 0.95rem;
            display: none;
            animation: slideInLeft 0.5s ease;
        }

        .user-name-strip.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .fab-post {
            background: linear-gradient(135deg, var(--saffron), var(--light-saffron));
        }

        .fab-journey {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            animation: pulse-journey 2s ease-in-out infinite;
        }

        @keyframes pulse-journey {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(255, 107, 53, 0.7); }
        }

        .fab-profile {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .fab-login {
            background: linear-gradient(135deg, var(--green), var(--dark-green));
        }

        .fab-filter {
            background: linear-gradient(135deg, var(--navy), #0000cc);
        }

        .fab-button:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }

        .fab-button:active {
            transform: scale(0.95);
        }

        /* Map Container */
        #map {
            position: absolute;
            top: 168px;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: calc(100vh - 168px);
            z-index: 1;
            transition: all 0.3s ease;
        }

        #map.expanded {
            top: 0;
            height: 100vh;
        }

        /* Custom Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 15px;
            padding: 0;
            overflow: hidden;
        }

        .post-popup {
            min-width: 280px;
            max-width: 350px;
        }

        .popup-header {
            background: linear-gradient(135deg, var(--saffron), var(--light-saffron));
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        .popup-content {
            padding: 15px;
        }

        .popup-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .popup-author {
            font-size: 0.9rem;
            color: var(--green);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .popup-description {
            font-size: 0.85rem;
            color: #333;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .popup-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .popup-time {
            font-size: 0.75rem;
            color: #666;
        }

        .view-all-btn {
            background: var(--green);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            top: 50%;
            transform: translateY(-50%);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50%) scale(0.7); opacity: 0; }
            to { transform: translateY(-50%) scale(1); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 20px 20px 0 0;
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            text-align: center;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            z-index: 1;
        }

        .close-modal:hover {
            transform: scale(1.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--navy);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--saffron);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .photo-upload-section {
            border: 2px dashed var(--saffron);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload-section:hover {
            background: rgba(255, 153, 51, 0.1);
            border-color: var(--green);
        }

        .photo-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-preview {
            position: relative;
            padding-top: 100%;
            border-radius: 10px;
            overflow: hidden;
        }

        .photo-preview img,
        .photo-preview video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-type-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(255,153,51,0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 1;
        }

        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* Gallery Modal */
        .gallery-modal {
            display: none;
            position: fixed;
            z-index: 2001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.98);
        }

        .gallery-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-media-container {
            max-width: 95%;
            max-height: 85vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-image,
        .gallery-video {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .gallery-video {
            width: 100%;
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,153,51,0.8);
            color: white;
            border: none;
            padding: 20px 15px;
            font-size: 2rem;
            cursor: pointer;
            border-radius: 10px;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .gallery-nav:hover {
            background: rgba(255,153,51,1);
            transform: translateY(-50%) scale(1.1);
        }

        .gallery-nav:active {
            transform: translateY(-50%) scale(0.95);
        }

        .gallery-prev {
            left: 20px;
        }

        .gallery-next {
            right: 20px;
        }

        .gallery-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 4rem;
            color: white;
            cursor: pointer;
            z-index: 20;
            background: rgba(220,53,69,0.8);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .gallery-close:hover {
            transform: scale(1.2) rotate(90deg);
            background: rgba(220,53,69,1);
        }

        .gallery-close:active {
            transform: scale(1) rotate(90deg);
        }

        .gallery-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }

        .gallery-control-btn {
            background: rgba(255,153,51,0.9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .gallery-control-btn:hover {
            background: rgba(255,153,51,1);
            transform: scale(1.05);
        }

        .gallery-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 80%;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .gallery-info.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(20px);
        }

        .toggle-info-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,153,51,0.9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            z-index: 25;
        }

        .toggle-info-btn:hover {
            background: rgba(255,153,51,1);
            transform: scale(1.05);
        }

        /* Filter Panel */
        .filter-panel {
            position: fixed;
            right: -350px;
            top: 168px;
            width: 320px;
            background: white;
            height: calc(100vh - 168px);
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 1500;
            padding: 20px;
            overflow-y: auto;
        }

        .filter-panel.active {
            right: 0;
        }

        .filter-header {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--navy);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--saffron);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-filter-btn {
            background: transparent;
            border: none;
            font-size: 1.8rem;
            color: var(--navy);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-filter-btn:hover {
            color: var(--saffron);
            transform: rotate(90deg);
        }

        .filter-option {
            margin-bottom: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .checkbox-label:hover {
            background: rgba(255, 153, 51, 0.1);
        }

        .checkbox-label input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Current Location Indicator */
        .current-location-pulse {
            width: 20px;
            height: 20px;
            background: var(--saffron);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 153, 51, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(255, 153, 51, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 153, 51, 0);
            }
        }

        @keyframes pulse-vehicle {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 3px 15px rgba(0,0,0,0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 5px 25px rgba(0,0,0,0.6);
            }
        }

        @keyframes pulse-checkin {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.6);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 6px 25px rgba(76, 175, 80, 0.8);
            }
        }

        /* Vehicle Marker Styles */
        .vehicle-marker-icon {
            transition: all 0.3s ease;
        }

        .vehicle-popup .leaflet-popup-content-wrapper {
            border-radius: 10px;
            padding: 10px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .yatra-title {
                font-size: 1.5rem;
                letter-spacing: 1px;
            }

            .header-banner {
                height: 80px;
            }

            .header-banner.hidden {
                margin-top: -80px;
            }

            .header-toggle-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                top: 10px;
                right: 10px;
            }

            .journey-strip {
                padding: 8px 10px;
            }

            .journey-info {
                gap: 8px;
            }

            .journey-item {
                font-size: 0.75rem;
                gap: 4px;
            }

            .journey-icon {
                font-size: 1rem;
            }

            .journey-label {
                display: none;
            }

            #map {
                top: 124px;
                height: calc(100vh - 124px);
            }

            .fab-container {
                right: 15px;
                bottom: 15px;
                gap: 10px;
            }

            .fab-button {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .contributors-toggle-btn {
                left: 15px;
                bottom: 15px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .user-name-strip {
                left: 75px;
                bottom: 20px;
                padding: 10px 20px;
                font-size: 0.85rem;
            }

            .actions-menu-popup {
                right: 70px;
                bottom: 15px;
                min-width: 180px;
            }

            .action-menu-item {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            .action-menu-icon {
                width: 30px;
                height: 30px;
                font-size: 1.2rem;
            }

            .om-symbol {
                font-size: 2rem;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .modal-header {
                font-size: 1.2rem;
                padding: 15px;
                margin: -15px -15px 15px -15px;
            }

            .filter-panel {
                width: 280px;
                top: 124px;
                height: calc(100vh - 124px);
            }

            .top-contributors-panel {
                width: 280px;
                top: 124px;
                height: calc(100vh - 124px);
            }

            .post-popup {
                min-width: 240px;
                max-width: 280px;
            }

            .gallery-nav {
                padding: 15px 10px;
                font-size: 1.5rem;
            }

            .gallery-prev {
                left: 10px;
            }

            .gallery-next {
                right: 10px;
            }

            .gallery-close {
                font-size: 2.5rem;
                top: 10px;
                right: 10px;
                width: 50px;
                height: 50px;
            }

            .gallery-controls {
                top: 10px;
                left: 10px;
                flex-direction: column;
                gap: 5px;
            }

            .gallery-control-btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }

            .toggle-info-btn {
                bottom: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 0.85rem;
            }

            .gallery-info {
                bottom: 10px;
                padding: 15px 20px;
                max-width: 90%;
                font-size: 0.9rem;
            }

            .gallery-media-container {
                max-height: 70vh;
            }

            .gallery-image,
            .gallery-video {
                max-height: 70vh;
            }

            .tag-badge {
                font-size: 0.75rem;
                padding: 5px 10px;
            }

            .contributor-card {
                padding: 12px 15px;
            }

            .contributor-avatar {
                width: 40px;
                height: 40px;
                margin: 0 10px;
            }
        }

        /* ==================== NEW FEATURES STYLES ==================== */
        
        /* Share Buttons */
        .share-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .share-facebook {
            background: #1877F2;
        }

        .share-twitter {
            background: #1DA1F2;
        }

        .share-whatsapp {
            background: #25D366;
        }

        .share-linkedin {
            background: #0A66C2;
        }

        .share-copy {
            background: var(--navy);
        }

        /* Journal Entry Styles */
        .fab-journal {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
        }

        .journal-entry-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .journal-entry-card:hover {
            box-shadow: 0 4px 25px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .journal-date {
            color: var(--saffron);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .journal-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .journal-mood {
            display: inline-block;
            padding: 5px 12px;
            background: linear-gradient(135deg, var(--saffron), var(--light-saffron));
            color: white;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        .journal-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .journal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .journal-edit-btn {
            background: var(--green);
            color: white;
        }

        .journal-delete-btn {
            background: #dc3545;
            color: white;
        }

        .journal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* Export Buttons */
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .notification-permission-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            padding: 15px 20px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }

        .notification-permission-banner.show {
            display: block;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .notification-banner-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .notification-btn {
            padding: 8px 20px;
            border: 2px solid white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .notification-btn:hover {
            background: white;
            color: var(--saffron);
        }

        /* Journal Calendar View */
        .journal-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .calendar-day {
            padding: 10px;
            background: white;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            border-color: var(--saffron);
            transform: scale(1.05);
        }

        .calendar-day.has-entry {
            background: linear-gradient(135deg, var(--light-saffron), var(--saffron));
            color: white;
            font-weight: 600;
        }

        .calendar-day.selected {
            border-color: var(--green);
            box-shadow: 0 0 15px rgba(19, 136, 8, 0.3);
        }

        /* ==================== END NEW FEATURES STYLES ==================== */

        /* Journey Preview Modal */
        .journey-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: white;
            z-index: 3500;
            overflow: hidden;
        }

        .journey-preview-modal.active {
            display: block;
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .journey-preview-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .journey-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .journey-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .journey-back-btn,
        .journey-close-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .journey-back-btn:hover,
        .journey-close-btn:hover {
            background: white;
            color: var(--saffron);
        }

        .journey-preview-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .journey-map-section {
            width: 50%;
            position: relative;
            background: #f0f0f0;
            transition: all 0.3s ease;
        }

        .journey-map-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 4000;
        }

        .journey-map {
            width: 100%;
            height: 100%;
        }

        .journey-map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .map-control-btn {
            background: white;
            border: 2px solid var(--saffron);
            color: var(--navy);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .map-control-btn:hover {
            background: var(--saffron);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .journey-details-section {
            width: 50%;
            overflow-y: auto;
            background: white;
            padding: 30px;
        }

        .day-hero-slider {
            position: relative;
            width: 100%;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .slider-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .slider-image {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .slider-image.active {
            opacity: 1;
        }

        .slider-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .day-hero-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 30px;
            color: white;
            z-index: 1;
        }

        .day-number {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .day-place-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .day-date {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .slider-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.8);
            color: var(--navy);
            border: none;
            padding: 15px 20px;
            font-size: 2rem;
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s ease;
            border-radius: 5px;
        }

        .slider-btn:hover {
            background: white;
        }

        .prev-btn {
            left: 20px;
        }

        .next-btn {
            right: 20px;
        }

        .slider-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 2;
        }

        .slideshow-btn {
            background: rgba(255,255,255,0.9);
            color: var(--navy);
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .slideshow-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .slider-dots {
            display: flex;
            gap: 10px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dot:hover {
            background: rgba(255,255,255,0.8);
        }

        .dot.active {
            background: white;
            transform: scale(1.3);
        }

        .day-location-card {
            background: linear-gradient(135deg, var(--light-saffron), #FFE5CC);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid var(--saffron);
        }

        .location-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .location-item:last-child {
            margin-bottom: 0;
        }

        .location-icon {
            font-size: 1.2rem;
        }

        .day-description {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #333;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border-left: 4px solid var(--green);
        }

        .activities-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.6rem;
            color: var(--navy);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--saffron);
        }

        .activity-item {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid var(--green);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .activity-time {
            font-weight: 700;
            color: var(--saffron);
            min-width: 100px;
            font-size: 1rem;
        }

        .activity-text {
            flex: 1;
            color: #333;
            line-height: 1.6;
        }

        .day-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        .nav-day-btn {
            padding: 12px 30px;
            border: 2px solid var(--saffron);
            background: white;
            color: var(--saffron);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .nav-day-btn:hover {
            background: var(--saffron);
            color: white;
            transform: scale(1.05);
        }

        .nav-day-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .nav-day-btn:disabled:hover {
            background: white;
            color: var(--saffron);
            transform: none;
        }

        .journey-nav-pills-wrapper {
            display: flex;
            align-items: center;
            background: linear-gradient(to right, #f5f5f5, #e8e8e8);
            border-top: 2px solid #ddd;
            position: relative;
        }

        .pills-nav-arrow {
            min-width: 50px;
            width: 50px;
            height: 70px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            cursor: pointer;
            font-size: 2rem;
            font-weight: 700;
            color: var(--navy);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pills-nav-arrow:hover {
            background: var(--saffron);
            color: white;
            transform: scale(1.1);
        }

        .pills-nav-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pills-nav-arrow:disabled:hover {
            background: rgba(255, 255, 255, 0.95);
            color: var(--navy);
            transform: none;
        }

        .journey-nav-pills {
            display: flex;
            gap: 10px;
            padding: 15px 30px;
            overflow-x: auto;
            flex: 1;
            scroll-behavior: smooth;
        }

        .day-pill {
            min-width: 50px;
            width: 50px;
            height: 50px;
            padding: 0;
            background: white;
            border: 2px solid var(--navy);
            color: var(--navy);
            border-radius: 50%;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-pill:hover {
            background: var(--navy);
            color: white;
            transform: scale(1.15);
        }

        .day-pill.active {
            background: var(--saffron);
            border-color: var(--saffron);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(255, 153, 51, 0.4);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .journey-title {
                font-size: 1.2rem;
            }

            .journey-back-btn,
            .journey-close-btn {
                padding: 6px 12px;
                font-size: 1rem;
            }

            .journey-preview-main {
                flex-direction: column;
            }

            .journey-map-section {
                width: 100%;
                height: 500px;
            }

            .journey-details-section {
                width: 100%;
                padding: 20px;
            }

            .day-hero-slider {
                height: 200px;
            }

            .day-place-title {
                font-size: 1.6rem;
            }

            .slider-btn {
                padding: 10px 15px;
                font-size: 1.5rem;
            }

            .prev-btn {
                left: 10px;
            }

            .next-btn {
                right: 10px;
            }

            .slideshow-btn {
                padding: 6px 15px;
                font-size: 0.8rem;
            }

            .slider-dots {
                gap: 8px;
            }

            .dot {
                width: 10px;
                height: 10px;
            }

            .day-navigation {
                flex-direction: column;
                gap: 10px;
            }

            .nav-day-btn {
                width: 100%;
            }

            .day-pill {
                min-width: 45px;
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }

            .journey-nav-pills {
                padding: 10px 15px;
            }

            .pills-nav-arrow {
                min-width: 40px;
                width: 40px;
                height: 60px;
                font-size: 1.5rem;
            }

            .map-control-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }

        /* Loading Spinner */
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 153, 51, 0.3);
            border-top-color: var(--saffron);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--green);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 2500;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tag Badges */
        .tag-badge {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255,153,51,0.2);
            border: 2px solid var(--saffron);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .tag-badge:hover {
            background: rgba(255,153,51,0.3);
            transform: scale(1.05);
        }

        .tag-badge.selected {
            background: var(--saffron);
            color: white;
        }

        .tag-display {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255,153,51,0.3);
            border-radius: 15px;
            font-size: 0.75rem;
            margin: 0 4px 4px 0;
            color: white;
        }

        /* Top Contributors Panel */
        .top-contributors-panel {
            position: fixed;
            left: -350px;
            top: 168px;
            width: 320px;
            background: white;
            height: calc(100vh - 168px);
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            transition: left 0.3s ease;
            z-index: 1500;
            overflow-y: auto;
        }

        .top-contributors-panel.active {
            left: 0;
        }

        .contributors-header {
            background: linear-gradient(135deg, var(--saffron), var(--green));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .contributors-title {
            font-size: 1.3rem;
            font-weight: 600;
            font-family: 'Cinzel', serif;
        }

        .close-contributors {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-contributors:hover {
            background: rgba(255,255,255,0.5);
            transform: rotate(90deg);
        }

        .contributors-toggle-btn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .contributors-toggle-btn:hover {
            transform: scale(1.1) rotate(-10deg);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }

        .contributor-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-gray);
            transition: background 0.3s ease;
        }

        .contributor-card:hover {
            background: rgba(255,153,51,0.1);
        }

        .contributor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--saffron);
            background: var(--light-gray);
            flex-shrink: 0;
        }

        .contributor-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contributor-name {
            font-weight: 600;
            color: var(--navy);
            font-size: 1rem;
        }

        .contributor-stats {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            gap: 10px;
        }

        .contributor-badge {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- Header Banner -->
    <div class="header-banner">
        <div class="header-content">
            <div class="yatra-title">SPIRITUAL YATRA</div>
        </div>
    </div>

    <!-- Journey Information Strip -->
    <div class="journey-strip">
        <div class="journey-info">
            <div class="journey-item">
                <span class="journey-icon">üö©</span>
                <span class="journey-label">From:</span>
                <span class="journey-value" id="journeyStart">Delhi</span>
            </div>
            <div class="journey-item">
                <span class="journey-icon">üèÅ</span>
                <span class="journey-label">To:</span>
                <span class="journey-value" id="journeyDestination">Kashi</span>
            </div>
            <div class="journey-item">
                <span class="journey-icon">üìÖ</span>
                <span class="journey-label">Start:</span>
                <span class="journey-value" id="journeyStartDate">25 Nov 2024</span>
            </div>
            <div class="journey-item">
                <span class="journey-icon">üìÖ</span>
                <span class="journey-label">End:</span>
                <span class="journey-value" id="journeyEndDate">05 Dec 2024</span>
            </div>
            <div class="journey-item journey-current">
                <span class="journey-icon">üìç</span>
                <span class="journey-label">Now at:</span>
                <span class="journey-value" id="currentLocationName">Varanasi</span>
            </div>
            <div class="journey-item" id="currentWeather" style="cursor: pointer;" title="Current location weather">
                <span class="journey-icon">üå§Ô∏è</span>
                <span class="journey-label">Current:</span>
                <span class="journey-value" id="currentWeatherInfo">Loading...</span>
            </div>
            <div class="journey-item" id="nextWeather" style="cursor: pointer;" title="Next destination weather">
                <span class="journey-icon">üå¶Ô∏è</span>
                <span class="journey-label">Next:</span>
                <span class="journey-value" id="nextWeatherInfo">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <!-- Header Toggle Button -->
    <button class="header-toggle-btn" onclick="toggleHeader()" title="Toggle Header">
        ‚¨ÜÔ∏è
    </button>

    <div id="map"></div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab-button fab-checkin" onclick="openCheckInModal()" id="checkInFab" title="Check In" style="display: none; background: linear-gradient(135deg, #4caf50, #8bc34a); animation: pulse-checkin 1.5s infinite;">
            ‚úÖ
        </button>
        <button class="fab-button fab-filter" onclick="toggleFilterPanel()" title="Filter Posts">
            üîç
        </button>
        <button class="fab-button fab-journey" onclick="openJourneyPreview()" title="Journey Preview">
            üó∫Ô∏è
        </button>
        <button class="fab-button fab-actions-menu" onclick="toggleActionsMenu()" title="Actions Menu">
            ‚ò∞
        </button>
        <button class="fab-button fab-login" onclick="openLoginModal()" id="loginFab" title="Login">
            üîê
        </button>
    </div>

    <!-- Actions Menu Popup -->
    <div class="actions-menu-popup" id="actionsMenuPopup">
        <div class="action-menu-item" onclick="openPostModal(); toggleActionsMenu();">
            <div class="action-menu-icon post">‚úèÔ∏è</div>
            <span>Create Post</span>
        </div>
        <div class="action-menu-item" onclick="openJournalModal(); toggleActionsMenu();">
            <div class="action-menu-icon journal">üìî</div>
            <span>Daily Journal</span>
        </div>
        <div class="action-menu-item" onclick="openEmergencyModal(); toggleActionsMenu();">
            <div class="action-menu-icon" style="background: linear-gradient(135deg, #dc3545, #ff6b6b);">üö®</div>
            <span>Emergency</span>
        </div>
        <div class="action-menu-item" onclick="openProfileViewer(); toggleActionsMenu();" id="viewProfilesMenuItem" style="display: none;">
            <div class="action-menu-icon profile">üë•</div>
            <span>View Profiles</span>
        </div>
        <div class="action-menu-item" onclick="openCheckInList(); toggleActionsMenu();" id="checkInListMenuItem" style="display: none;">
            <div class="action-menu-icon" style="background: linear-gradient(135deg, #4caf50, #45a049);">‚úÖ</div>
            <span>Check-In List</span>
        </div>
        <div class="action-menu-item" onclick="openProfileModal(); toggleActionsMenu();" id="myProfileMenuItem" style="display: none;">
            <div class="action-menu-icon" style="background: linear-gradient(135deg, #007bff, #0056b3);">üë§</div>
            <span>My Profile</span>
        </div>
        <div class="action-menu-item" onclick="openHotelDetailsModal(); toggleActionsMenu();" id="myHotelMenuItem" style="display: none;">
            <div class="action-menu-icon" style="background: linear-gradient(135deg, #FF9933, #138808);">üè®</div>
            <span>My Hotel / Room</span>
        </div>
    </div>

    <!-- User Name Strip -->
    <div class="user-name-strip" id="userNameStrip">
        üë§ <span id="userNameDisplay"></span>
    </div>

    <!-- Check-In Modal -->
    <div id="checkInModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4caf50, #8bc34a); color: white;">
                ‚úÖ Vehicle Check-In
                <span class="close-modal" onclick="closeCheckInModal()">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 40px 20px;">
                <div id="checkInContent"></div>
            </div>
        </div>
    </div>

    <!-- Hotel Details Modal -->
    <div id="hotelDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #FF9933, #138808); color: white;">
                üè® My Hotel / Room Details
                <span class="close-modal" onclick="closeHotelDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="hotelDetailsContent" style="padding: 30px;">
                <div style="text-align: center; color: #666;">Loading hotel details...</div>
            </div>
        </div>
    </div>

    <!-- Notification Permission Banner -->
    <div class="notification-permission-banner" id="notificationBanner">
        <div>
            <strong>üîî Enable Notifications</strong>
            <p>Stay updated with new posts and journey updates!</p>
        </div>
        <div class="notification-banner-actions">
            <button class="notification-btn" onclick="requestNotificationPermission()">Enable</button>
            <button class="notification-btn" onclick="dismissNotificationBanner()">Maybe Later</button>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-header">
            <span>Filter Posts</span>
            <button class="close-filter-btn" onclick="toggleFilterPanel()" title="Close">‚úï</button>
        </div>
        <div class="filter-option">
            <label class="checkbox-label">
                <input type="checkbox" id="showAllPosts" checked onchange="applyFilters()">
                <span>Show All Posts</span>
            </label>
        </div>
        <div class="filter-option">
            <label class="checkbox-label">
                <input type="checkbox" id="showPath" checked onchange="togglePath()">
                <span>Show Travel Path</span>
            </label>
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-gray);">
            <div style="font-weight: 600; color: var(--navy); margin-bottom: 10px;">Media Type:</div>
            <div id="mediaTypeStats" style="font-size: 0.9rem; color: #666; margin-bottom: 10px;"></div>
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-gray);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: 600; color: var(--navy);">Filter by Tags:</div>
                <button onclick="clearTagFilters()" style="background: none; border: none; color: var(--saffron); cursor: pointer; font-size: 1.2rem; padding: 0 5px;" title="Clear all tags">üóëÔ∏è</button>
            </div>
            <div id="tagFilters"></div>
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-gray);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: 600; color: var(--navy);">Filter by City:</div>
                <button onclick="clearCityFilters()" style="background: none; border: none; color: var(--saffron); cursor: pointer; font-size: 1.2rem; padding: 0 5px;" title="Clear all cities">üóëÔ∏è</button>
            </div>
            <div id="cityFilters"></div>
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-gray);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: 600; color: var(--navy);">Filter by Author:</div>
                <button onclick="clearAuthorFilters()" style="background: none; border: none; color: var(--saffron); cursor: pointer; font-size: 1.2rem; padding: 0 5px;" title="Clear all authors">üóëÔ∏è</button>
            </div>
            <div id="authorFilters"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeLoginModal()">&times;</span>
            <div class="modal-header">Traveler Login</div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div style="position: relative;">
                        <input type="password" id="loginPassword" required placeholder="Enter password" style="width: 100%; padding-right: 40px;">
                        <button type="button" onclick="togglePasswordVisibility('loginPassword', this)" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; font-size: 1.2rem; 
                                       color: #666; padding: 5px;" 
                                title="Show/Hide Password">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <button type="submit" class="submit-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePostModal()">&times;</span>
            <div class="modal-header">Share Your Journey</div>
            <form onsubmit="handlePostSubmit(event)">
                <div class="form-group">
                    <label>Place Name</label>
                    <input type="text" id="placeName" required placeholder="E.g., Kashi Vishwanath Mandir">
                    <small style="color: #666;">Temple, shrine, or specific place name</small>
                </div>
                <div class="form-group">
                    <label>Location (City)</label>
                    <input type="text" id="locationCity" required placeholder="E.g., Varanasi">
                    <small style="color: #666;">City or town name</small>
                </div>
                <div class="form-group">
                    <label>Section</label>
                    <select id="postSection" required>
                        <option value="">Select Section</option>
                        <option value="temples">Temples & Sacred Sites</option>
                        <option value="experiences">Spiritual Experiences</option>
                        <option value="food">Food & Prasad</option>
                        <option value="travel">Travel Updates</option>
                        <option value="accommodation">Accommodation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Upload Photos & Videos</label>
                    <div class="photo-upload-section" onclick="document.getElementById('mediaInput').click()">
                        <div>üì∏ üé• Click to upload photos and videos</div>
                        <small>You can upload multiple photos and videos</small>
                    </div>
                    <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display: none;" onchange="handleMediaUpload(event)">
                    <div id="mediaPreviewContainer" class="photo-preview-container"></div>
                </div>
                <div class="form-group">
                    <label>Tags (Optional)</label>
                    <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                    <small style="color: #666;">Select tags that describe your post</small>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="postDescription" required placeholder="Share your thoughts and experiences..."></textarea>
                </div>
                <div class="form-group">
                    <label>Post Privacy</label>
                    <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="radio" name="postPrivacy" value="public" checked>
                            <span>üåê Public (requires approval)</span>
                        </label>
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="radio" name="postPrivacy" value="private">
                            <span>üîí Private (only you can see)</span>
                        </label>
                    </div>
                    <small style="color: #666;">Public posts appear on the map after admin approval. Private posts are visible only to you.</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="useCurrentLocation" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-size: 1rem; color: var(--navy);">üìç Use Current Location (Auto-detect)</span>
                    </label>
                    <small style="color: #666; margin-left: 30px;">Automatically detect and use your current location for this post</small>
                </div>
                <button type="submit" class="submit-btn">Submit Post</button>
            </form>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal" class="gallery-modal" onclick="closeGalleryOnBackground(event)">
        <span class="gallery-close" onclick="closeGallery(event)">&times;</span>
        <div class="gallery-controls">
            <button class="gallery-control-btn" id="playPauseBtn" onclick="toggleSlideshow(event)">‚ñ∂Ô∏è Play</button>
            <button class="gallery-control-btn" onclick="closeGallery(event)">‚úï Close</button>
        </div>
        <button class="toggle-info-btn" onclick="toggleGalleryInfo(event)">‚ÑπÔ∏è Info</button>
        <div class="gallery-content" onclick="event.stopPropagation()">
            <button class="gallery-nav gallery-prev" onclick="prevMedia(event)">‚Äπ</button>
            <div id="galleryMediaContainer" class="gallery-media-container">
                <img id="galleryImage" class="gallery-image" src="" alt="Gallery Image" style="display: none;">
                <video id="galleryVideo" class="gallery-video" controls style="display: none;"></video>
            </div>
            <button class="gallery-nav gallery-next" onclick="nextMedia(event)">‚Ä∫</button>
            <div class="gallery-info" id="galleryInfo">
                <div id="galleryAuthor" style="font-weight: 600; font-size: 1.1rem; margin-bottom: 5px;"></div>
                <div id="galleryDescription"></div>
                <div id="galleryTags" style="margin-top: 10px;"></div>
                <div id="galleryCounter" style="margin-top: 10px; font-size: 0.9rem;"></div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="closeProfileModal()">&times;</span>
            <div class="modal-header">My Profile</div>
            <form onsubmit="handleProfileUpdate(event)" style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                <div class="form-group">
                    <label>Profile Photo</label>
                    <div class="photo-upload-section" onclick="document.getElementById('profilePhotoInput').click()" style="padding: 15px;">
                        <div id="profilePhotoPreview" style="width: 150px; height: 150px; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 3px solid var(--saffron); background: var(--light-gray);">
                            <img id="profilePhotoImg" src="" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <div id="profilePhotoPlaceholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 4rem;">
                                üë§
                            </div>
                        </div>
                        <div style="margin-top: 10px;">üì∑ Click to upload profile photo</div>
                    </div>
                    <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="handleProfilePhotoUpload(event)">
                </div>

                <!-- Personal Information -->
                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--navy); font-size: 1.1rem;">üìã Personal Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Tirth ID</label>
                            <input type="text" id="profileTirthId" readonly style="background: white;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Full Name</label>
                            <input type="text" id="profileName" readonly style="background: white;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Birth Date</label>
                            <input type="text" id="profileBirthDate" readonly style="background: white;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Age</label>
                            <input type="text" id="profileAge" readonly style="background: white;">
                        </div>
                    </div>
                </div>

                <!-- Passport Information -->
                <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--navy); font-size: 1.1rem;">üõÇ Passport Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Passport #</label>
                            <input type="text" id="profilePassportNo" readonly style="background: white;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Nationality</label>
                            <input type="text" id="profileNationality" readonly style="background: white;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Issue Date</label>
                            <input type="text" id="profilePassportIssue" readonly style="background: white;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Expiry Date</label>
                            <input type="text" id="profilePassportExpiry" readonly style="background: white;">
                        </div>
                    </div>
                </div>

                <!-- Contact & Location -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--navy); font-size: 1.1rem;">üìû Contact & Location</h3>
                    <div class="form-group" style="margin: 0 0 15px 0;">
                        <label>Email</label>
                        <input type="email" id="profileEmail" readonly style="background: white;">
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>City</label>
                            <input type="text" id="profileCity" readonly style="background: white;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Country</label>
                            <input type="text" id="profileCountry" readonly style="background: white;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Center</label>
                            <input type="text" id="profileCenter" readonly style="background: white;">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 15px 0 0 0;">
                        <label>Hoodi Size</label>
                        <input type="text" id="profileHoodiSize" readonly style="background: white;">
                    </div>
                </div>

                <!-- Health & Preferences -->
                <div style="background: #ffe8e8; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--navy); font-size: 1.1rem;">üè• Health & Preferences</h3>
                    <div class="form-group" style="margin: 0 0 15px 0;">
                        <label>Health Issues (if any)</label>
                        <textarea id="profileHealthIssues" rows="2" placeholder="Enter any health conditions or issues (e.g., diabetes, high BP, etc.)"></textarea>
                    </div>
                    <div class="form-group" style="margin: 0 0 15px 0;">
                        <label>Allergies</label>
                        <textarea id="profileAllergies" rows="2" placeholder="List any allergies (food, medication, environmental, etc.)"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Food Preference</label>
                            <select id="profileFoodPreference" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                                <option value="">Select preference</option>
                                <option value="Vegetarian">Vegetarian</option>
                                <option value="Non-Vegetarian">Non-Vegetarian</option>
                                <option value="Vegan">Vegan</option>
                                <option value="Jain">Jain</option>
                                <option value="No Onion/Garlic">No Onion/Garlic</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Blood Group</label>
                            <select id="profileBloodGroup" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                                <option value="">Select blood group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Document Upload -->
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--navy); font-size: 1.1rem;">üìÑ Documents</h3>
                    <div id="uploadedDocumentsList" style="margin-bottom: 15px;">
                        <!-- Uploaded documents will appear here -->
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Document Name</label>
                            <input type="text" id="documentName" placeholder="e.g., Passport Copy, Medical Certificate">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Choose File</label>
                            <input type="file" id="documentFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="padding: 8px; font-size: 0.9rem;">
                        </div>
                    </div>
                    <button type="button" onclick="addDocument()" style="background: var(--green); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">+ Add Document</button>
                </div>

                <!-- Editable Fields -->
                <div class="form-group">
                    <label>Profile Line (500 characters max)</label>
                    <textarea id="profilePunchline" maxlength="500" rows="2" placeholder="A short tagline about yourself..."></textarea>
                    <small style="color: #666;"><span id="punchlineCount">0</span>/500 characters</small>
                </div>
                <div class="form-group">
                    <label>About Me</label>
                    <textarea id="profileAbout" rows="6" placeholder="Tell others about yourself... (You can write multiple paragraphs)"></textarea>
                </div>
                <button type="submit" class="submit-btn">Update Profile</button>
            </form>
        </div>
    </div>

    <!-- Profile Viewer Modal -->
    <div id="profileViewerModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close-modal" onclick="closeProfileViewer()">&times;</span>
            <div class="modal-header">Traveler Profiles</div>
            <div id="profileViewerContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <!-- Profiles will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Check-In List Modal -->
    <div id="checkInListModal" class="modal">
        <div class="modal-content" style="max-width: 750px;">
            <span class="close-modal" onclick="closeCheckInList()">&times;</span>
            <div class="modal-header" style="background: linear-gradient(135deg, var(--saffron), var(--green));">
                <div id="checkInListTitle" style="display: flex; align-items: center; justify-content: space-between;">
                    <span>‚úÖ Check-In List</span>
                    <span id="checkInCountBadge" style="background: white; color: var(--navy); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;"></span>
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div style="padding: 20px; border-bottom: 2px solid #f0f0f0;">
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; align-items: center;">
                    <button onclick="filterCheckInList('all')" id="filterAll" style="padding: 10px 20px; border: 2px solid var(--navy); background: var(--navy); color: white; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üìã All
                    </button>
                    <button onclick="filterCheckInList('checked')" id="filterChecked" style="padding: 10px 20px; border: 2px solid #4caf50; background: white; color: #4caf50; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        ‚úÖ Checked In
                    </button>
                    <button onclick="filterCheckInList('pending')" id="filterPending" style="padding: 10px 20px; border: 2px solid #ff9800; background: white; color: #ff9800; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        ‚è≥ Pending
                    </button>
                    <button onclick="clearGroupLeaderCheckIns()" id="clearCheckInBtn" style="padding: 10px 20px; border: 2px solid #dc3545; background: #dc3545; color: white; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: none;">
                        üîÑ Clear All Check-Ins
                    </button>
                </div>
            </div>
            
            <!-- Check-In List Content -->
            <div id="checkInListContent" style="max-height: 500px; overflow-y: auto; padding: 20px;">
                <!-- List will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Top Contributors Panel -->
    <div class="top-contributors-panel" id="topContributorsPanel">
        <div class="contributors-header">
            <div class="contributors-title">üèÜ Top Contributors</div>
            <button class="close-contributors" onclick="toggleContributors()">‚úï</button>
        </div>
        <div id="contributorsList"></div>
    </div>
    <button class="contributors-toggle-btn" onclick="toggleContributors()" title="Top Contributors">
        üèÜ
    </button>

    <!-- Journey Preview Modal -->
    <div id="journeyPreviewModal" class="journey-preview-modal">
        <div class="journey-preview-content">
            <!-- Header -->
            <div class="journey-preview-header">
                <button class="journey-back-btn" onclick="closeJourneyPreview()">
                    ‚Äπ
                </button>
                <h1 class="journey-title">Nilkanth Yatra Journey</h1>
                <button class="journey-close-btn" onclick="closeJourneyPreview()">
                    ‚úï
                </button>
            </div>

            <!-- Main Content -->
            <div class="journey-preview-main">
                <!-- Map Section -->
                <div class="journey-map-section">
                    <div id="journeyMap" class="journey-map"></div>
                    <div class="journey-map-controls">
                        <button class="map-control-btn" onclick="toggleMapFullscreen()" title="Toggle Fullscreen">
                            üì∫ Fullscreen
                        </button>
                        <button class="map-control-btn" onclick="showFullRoute()" title="View Full Route">
                            üó∫Ô∏è Full Route
                        </button>
                        <button class="map-control-btn" onclick="zoomToCurrentDay()" title="Focus Current Day">
                            üéØ Current Day
                        </button>
                        <button class="map-control-btn" onclick="toggleMapLayersMenu()" title="Map Layers">
                            üó∫Ô∏è Layers
                        </button>
                        <div id="mapLayersMenu" style="display: none; position: absolute; top: 180px; right: 10px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 10px; z-index: 1001; min-width: 150px;">
                            <div style="font-weight: 600; color: var(--navy); margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--border-gray);">Map Type</div>
                            <button onclick="changeMapView('streets')" style="width: 100%; text-align: left; padding: 8px 12px; border: none; background: none; cursor: pointer; border-radius: 5px; transition: background 0.3s;" onmouseover="this.style.background='var(--light-gray)'" onmouseout="this.style.background='none'">
                                üó∫Ô∏è Streets
                            </button>
                            <button onclick="changeMapView('satellite')" style="width: 100%; text-align: left; padding: 8px 12px; border: none; background: none; cursor: pointer; border-radius: 5px; transition: background 0.3s;" onmouseover="this.style.background='var(--light-gray)'" onmouseout="this.style.background='none'">
                                üõ∞Ô∏è Satellite
                            </button>
                            <button onclick="changeMapView('terrain')" style="width: 100%; text-align: left; padding: 8px 12px; border: none; background: none; cursor: pointer; border-radius: 5px; transition: background 0.3s;" onmouseover="this.style.background='var(--light-gray)'" onmouseout="this.style.background='none'">
                                ‚õ∞Ô∏è Terrain
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Details Section -->
                <div class="journey-details-section" id="journeyDetailsSection">
                    <!-- Content loaded dynamically -->
                </div>
            </div>

            <!-- Navigation Pills -->
            <div class="journey-nav-pills-wrapper">
                <button class="pills-nav-arrow" id="pillsPrevBtn" onclick="scrollPillsLeft()">‚Äπ</button>
                <div class="journey-nav-pills" id="journeyNavPills">
                    <!-- Day pills loaded dynamically -->
                </div>
                <button class="pills-nav-arrow" id="pillsNextBtn" onclick="scrollPillsRight()">‚Ä∫</button>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message"></div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Announcement Notification -->
    <div id="announcementNotification" style="
        position: fixed;
        top: 180px;
        right: 20px;
        max-width: 400px;
        background: linear-gradient(135deg, #FF9933, #138808);
        color: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        z-index: 2500;
        display: none;
        animation: slideInRight 0.5s ease;
        border-left: 5px solid white;
    ">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                üì¢ Announcement
            </div>
            <button onclick="closeAnnouncementNotification()" style="background: rgba(255,255,255,0.3); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">√ó</button>
        </div>
        <div id="announcementNotificationMessage" style="line-height: 1.6; font-size: 1rem;"></div>
        <div id="announcementNotificationTime" style="font-size: 0.85rem; margin-top: 10px; opacity: 0.9;"></div>
    </div>

    <!-- Announcement Dialog Modal -->
    <div id="announcementDialog" class="modal" style="display: none; z-index: 3000;">
        <div class="modal-content" style="max-width: 500px; animation: slideIn 0.3s ease;">
            <div class="modal-header" style="background: linear-gradient(135deg, #FF9933, #138808); color: white; position: relative;">
                üì¢ Important Announcement
            </div>
            <div style="padding: 30px;">
                <div id="announcementDialogMessage" style="font-size: 1.1rem; line-height: 1.8; color: #333; margin-bottom: 20px;"></div>
                <div id="announcementDialogTime" style="font-size: 0.9rem; color: #666; margin-bottom: 20px;"></div>
                <button onclick="closeAnnouncementDialog()" class="submit-btn" style="background: linear-gradient(135deg, #FF9933, #138808);">
                    ‚úÖ Got it!
                </button>
            </div>
        </div>
    </div>

    <!-- Journal Modal -->
    <div class="modal" id="journalModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeJournalModal()">√ó</span>
            <div class="modal-header">
                üìî Daily Journal
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="submit-btn" onclick="showJournalForm()" style="margin-bottom: 10px;">
                    ‚úçÔ∏è New Journal Entry
                </button>
                <button class="submit-btn" onclick="showJournalList()" style="background: linear-gradient(135deg, var(--navy), #0000cc);">
                    üìñ View All Entries
                </button>
            </div>

            <!-- Journal Form -->
            <div id="journalForm" style="display: none;">
                <form onsubmit="handleJournalSubmit(event)">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="journalDate" required max="">
                    </div>

                    <div class="form-group">
                        <label>How are you feeling today? üòä</label>
                        <select id="journalMood">
                            <option value="üòä Happy">üòä Happy</option>
                            <option value="üôè Blessed">üôè Blessed</option>
                            <option value="üòå Peaceful">üòå Peaceful</option>
                            <option value="‚ú® Inspired">‚ú® Inspired</option>
                            <option value="üò¥ Tired">üò¥ Tired</option>
                            <option value="ü§î Thoughtful">ü§î Thoughtful</option>
                            <option value="üòá Grateful">üòá Grateful</option>
                            <option value="üéâ Excited">üéâ Excited</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Today's Experience</label>
                        <textarea id="journalContent" rows="8" placeholder="Share your thoughts, experiences, and reflections from today's journey..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Location (Optional)</label>
                        <input type="text" id="journalLocation" placeholder="Where are you writing from?">
                    </div>

                    <input type="hidden" id="editingJournalId" value="">
                    
                    <button type="submit" class="submit-btn">
                        üíæ Save Journal Entry
                    </button>
                    <button type="button" class="submit-btn" onclick="cancelJournalEdit()" style="background: #6c757d; margin-top: 10px;">
                        Cancel
                    </button>
                </form>
            </div>

            <!-- Journal List -->
            <div id="journalList" style="display: none;">
                <div style="margin-bottom: 15px; text-align: center;">
                    <button class="journal-btn journal-edit-btn" onclick="showJournalCalendar()">
                        üìÖ Calendar View
                    </button>
                    <button class="journal-btn" onclick="showJournalList()" style="background: var(--navy);">
                        üìù List View
                    </button>
                </div>
                
                <!-- Calendar View -->
                <div id="journalCalendarView" style="display: none;">
                    <div id="journalCalendar" class="journal-calendar"></div>
                </div>
                
                <!-- Entries Container -->
                <div id="journalEntriesContainer">
                    <!-- Journal entries will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Modal -->
    <div class="modal" id="emergencyModal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="closeEmergencyModal()">√ó</span>
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #ff6b6b); color: white;">
                üö® Emergency Contacts
            </div>
            
            <div style="padding: 20px;">
                <!-- Loading Indicator -->
                <div id="emergencyLoading" style="text-align: center; padding: 40px; display: none;">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Finding nearby emergency services...</p>
                </div>

                <!-- Emergency Content -->
                <div id="emergencyContent">
                    <!-- Doctor Contact (First - from Admin Settings) -->
                    <div id="doctorContact" style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border-radius: 12px; border-left: 5px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: var(--navy); font-size: 1.3rem;">üë®‚Äç‚öïÔ∏è Primary Doctor</h3>
                            <span style="background: #ff9800; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">PRIORITY</span>
                        </div>
                        <div id="doctorContactDetails" style="font-size: 1.1rem;">
                            <p style="color: #666; font-style: italic;">Loading doctor contact...</p>
                        </div>
                    </div>

                    <!-- Location Info -->
                    <div id="locationInfo" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">
                            üìç <strong>Your Location:</strong> <span id="userLocationText"></span>
                        </p>
                    </div>

                    <!-- Police Stations -->
                    <div class="emergency-section" style="margin-bottom: 25px;">
                        <h3 style="color: var(--navy); font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid var(--saffron);">
                            üöî Nearest Police Stations
                        </h3>
                        <div id="policeList">
                            <p style="color: #666; font-style: italic;">Searching for nearby police stations...</p>
                        </div>
                    </div>

                    <!-- Hospitals -->
                    <div class="emergency-section" style="margin-bottom: 25px;">
                        <h3 style="color: var(--navy); font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid var(--saffron);">
                            üè• Nearest Hospitals
                        </h3>
                        <div id="hospitalList">
                            <p style="color: #666; font-style: italic;">Searching for nearby hospitals...</p>
                        </div>
                    </div>

                    <!-- Pharmacies/Chemists -->
                    <div class="emergency-section" style="margin-bottom: 25px;">
                        <h3 style="color: var(--navy); font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid var(--saffron);">
                            üíä Nearest Pharmacies / Chemists
                        </h3>
                        <div id="pharmacyList">
                            <p style="color: #666; font-style: italic;">Searching for nearby pharmacies...</p>
                        </div>
                    </div>

                    <!-- Ambulances -->
                    <div class="emergency-section" style="margin-bottom: 25px;">
                        <h3 style="color: var(--navy); font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid var(--saffron);">
                            üöë Ambulance Services
                        </h3>
                        <div id="ambulanceList">
                            <p style="color: #666; font-style: italic;">Searching for ambulance services...</p>
                        </div>
                    </div>

                    <!-- Emergency Numbers -->
                    <div style="background: #ffebee; padding: 20px; border-radius: 12px; border-left: 5px solid #dc3545;">
                        <h3 style="color: var(--navy); margin-bottom: 15px; font-size: 1.2rem;">üìû Universal Emergency Numbers</h3>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px;">
                                <span><strong>üö® All Emergencies:</strong> 112</span>
                                <a href="tel:112" style="background: #dc3545; color: white; padding: 8px 20px; border-radius: 25px; text-decoration: none; font-weight: 600;">Call</a>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px;">
                                <span><strong>üëÆ Police:</strong> 100</span>
                                <a href="tel:100" style="background: #0056b3; color: white; padding: 8px 20px; border-radius: 25px; text-decoration: none; font-weight: 600;">Call</a>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px;">
                                <span><strong>üöë Ambulance:</strong> 102</span>
                                <a href="tel:102" style="background: #28a745; color: white; padding: 8px 20px; border-radius: 25px; text-decoration: none; font-weight: 600;">Call</a>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px;">
                                <span><strong>üöí Fire:</strong> 101</span>
                                <a href="tel:101" style="background: #ff9800; color: white; padding: 8px 20px; border-radius: 25px; text-decoration: none; font-weight: 600;">Call</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Refresh Button -->
                <button class="submit-btn" onclick="refreshEmergencyServices()" style="margin-top: 20px; background: linear-gradient(135deg, var(--saffron), var(--green));">
                    üîÑ Refresh Emergency Services
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- API Integration -->
    <script src="api-integration.js"></script>
    
    <script>
        // Lightweight lazy loading for images (safe for existing markup)
        document.addEventListener('DOMContentLoaded', () => {
            // Set loading="lazy" on all non-eager images
            document.querySelectorAll('img:not([loading="eager"])').forEach(img => {
                if (!img.getAttribute('loading')) {
                    img.setAttribute('loading', 'lazy');
                }
            });

            // IntersectionObserver for data-src / data-srcset
            const lazyTargets = document.querySelectorAll('img[data-src], source[data-srcset]');
            if (lazyTargets.length === 0) return;

            const loadLazy = el => {
                if (el.dataset.src) {
                    el.src = el.dataset.src;
                    el.removeAttribute('data-src');
                }
                if (el.dataset.srcset) {
                    el.srcset = el.dataset.srcset;
                    el.removeAttribute('data-srcset');
                }
            };

            if (!('IntersectionObserver' in window)) {
                lazyTargets.forEach(loadLazy);
                return;
            }

            const io = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        loadLazy(entry.target);
                        obs.unobserve(entry.target);
                    }
                });
            }, { rootMargin: '200px 0px', threshold: 0.01 });

            lazyTargets.forEach(el => io.observe(el));
        });

        // ==================== SECURITY & UTILITY FUNCTIONS ====================
        
        // XSS Protection - Sanitize all user input
        function escapeHTML(str) {
            if (!str && str !== 0) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        // Safe localStorage operations with error handling
        function safeGetFromStorage(key, defaultValue = []) {
            try {
                const data = localStorage.getItem(key);
                if (!data || data === 'undefined' || data === 'null') {
                    return defaultValue;
                }
                const parsed = JSON.parse(data);
                return parsed !== null ? parsed : defaultValue;
            } catch (error) {
                console.error(`‚ùå Error loading ${key}:`, error);
                return defaultValue;
            }
        }

        function safeSetToStorage(key, value) {
            try {
                const stringified = JSON.stringify(value);
                localStorage.setItem(key, stringified);
                return true;
            } catch (error) {
                console.error(`‚ùå Error saving ${key}:`, error);
                if (error.name === 'QuotaExceededError') {
                    showMessage('üö® Storage limit exceeded!', 'error');
                } else {
                    showMessage(`‚ö†Ô∏è Failed to save ${key}.`, 'error');
                }
                return false;
            }
        }

        // Storage monitoring
        function checkStorageUsage() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const percentUsed = ((estimate.usage / estimate.quota) * 100).toFixed(1);
                    if (percentUsed > 80) {
                        console.warn(`‚ö†Ô∏è Storage ${percentUsed}% full`);
                    }
                }).catch(err => console.error('Storage estimate error:', err));
            }
        }

        // ==================== END SECURITY & UTILITY FUNCTIONS ====================

        // Initialize map
        let map;
        let currentUser = null;
        // Load posts from API or localStorage (synced with admin panel)
        let posts = [];
        
        // Load posts asynchronously
        (async function() {
            posts = await safeGetFromStorage('posts', []);
            console.log('üìù Loaded posts:', posts.length);
            // Initialize with sample posts if empty (first time load)
            if (posts.length === 0) {
                // Sample posts will be loaded from samplePosts defined later
                // This will be set during map initialization
            }
        })();
        
        let currentLocationMarker;
        let pathPolyline;
        let uploadedMedia = []; // Changed from uploadedPhotos
        let currentGalleryMedia = []; // Changed from currentGalleryImages
        let currentGalleryIndex = 0;
        let markerClusterGroup;
        let slideshowInterval = null;

        // Toggle password visibility
        function togglePasswordVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';
                button.title = 'Hide Password';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';
                button.title = 'Show Password';
            }
        }
        let slideshowPlaying = false;
        let selectedTags = [];
        let selectedCities = [];
        let availableTags = ['Temple', 'Food', 'Nature', 'Culture', 'Festival', 'Sunrise', 'Sunset', 'Prayer', 'Meditation', 'Architecture', 'People', 'Journey'];
        
        // Current location tracking
        let currentLocation = {
            lat: null,
            lng: null,
            accuracy: null,
            placeName: '',
            city: '',
            lastUpdated: null,
            permissionGranted: false
        };
        let locationWatchId = null;
        
        // Vehicle tracking
        let vehicles = [];
        let vehicleMarkers = {};
        let groupLeaderLocations = JSON.parse(localStorage.getItem('groupLeaderLocations') || '{}');
        
        // Load vehicles asynchronously
        (async function() {
            vehicles = await safeGetFromStorage('vehicles', []);
            console.log('üöå Loaded vehicles:', vehicles.length);
        })();
        
        // Load tags from localStorage (synced from admin panel)
        const savedTags = localStorage.getItem('tags');
        if (savedTags) {
            availableTags = JSON.parse(savedTags);
        }
        
        let topContributorsCount = 5; // Can be set from admin
        let travelerProfiles = JSON.parse(localStorage.getItem('travelerProfiles') || '{}'); // Store profile photos (synced with Admin)

        // Yatra Itinerary Data (synced with admin panel)
        let itinerary = [
            {
                id: 1,
                day: 1,
                date: "14 Dec 2025",
                dateObj: new Date("2025-12-14"),
                place: "BAPS Dadar Mandir",
                city: "Mumbai",
                state: "Maharashtra",
                country: "India",
                lat: 19.0176,
                lng: 72.8561,
                activities: [
                    { time: "2:00 PM", activity: "Arrive at BAPS Dadar Mandir, Mumbai" },
                    { time: "5:00 PM", activity: "Satsang sabha labh at Yogi sabha gruh" },
                    { time: "8:00 PM", activity: "Pre-departure orientation" },
                    { time: "9:00 PM", activity: "Rest - Night stay in Mumbai" }
                ],
                images: ["https://images.unsplash.com/photo-1566552881560-0be862a7c445?w=800"],
                description: "Journey begins at BAPS Dadar Mandir with spiritual preparation and orientation"
            },
            {
                id: 2,
                day: 2,
                date: "15 Dec 2025",
                dateObj: new Date("2025-12-15"),
                place: "Biratnagar",
                city: "Biratnagar",
                state: "Koshi Province",
                country: "Nepal",
                lat: 26.4525,
                lng: 87.2718,
                activities: [
                    { time: "7:10 AM", activity: "Leave for airport" },
                    { time: "10:15 AM", activity: "Departure flight Mumbai to Darbhanga (IndiGo 6E535)" },
                    { time: "12:45 PM", activity: "Arrival at Darbhanga (Bihar)" },
                    { time: "1:30 PM", activity: "Transfer to Nepal Border - Jogbani (170 km, 4 hrs)" },
                    { time: "Evening", activity: "Night stay in Biratnagar" }
                ],
                images: ["https://images.unsplash.com/photo-1583037189850-1921ae7c6c22?w=800"],
                description: "Cross international border into Nepal, beginning the sacred journey"
            },
            {
                id: 3,
                day: 3,
                date: "16 Dec 2025",
                dateObj: new Date("2025-12-16"),
                place: "Janakpur",
                city: "Janakpur",
                state: "Madhesh Province",
                country: "Nepal",
                lat: 26.7288,
                lng: 85.9266,
                activities: [
                    { time: "7:30 AM", activity: "Departure for Barahkshetra (56 km, 1:45 hrs)" },
                    { time: "12:30 PM", activity: "Departure for Janakpur from Barahkshetra (170 km, 5 hrs)" },
                    { time: "6:00 PM", activity: "Sight seeing in Janakpur" },
                    { time: "8:15 PM", activity: "Night stay in Janakpur" }
                ],
                images: ["https://images.unsplash.com/photo-1609137144813-7d9921338f24?w=800"],
                description: "Visit birthplace of Goddess Sita, explore sacred Janakpur Dham"
            },
            {
                id: 4,
                day: 4,
                date: "17 Dec 2025",
                dateObj: new Date("2025-12-17"),
                place: "Chitwan National Park",
                city: "Chitwan",
                state: "Bagmati Province",
                country: "Nepal",
                lat: 27.5291,
                lng: 84.3542,
                activities: [
                    { time: "8:00 AM", activity: "Sight seeing in Janakpur" },
                    { time: "12:00 PM", activity: "Departure for Chitwan (240 km, 6 hrs)" },
                    { time: "Evening", activity: "Night stay in Chitwan" }
                ],
                images: ["https://images.unsplash.com/photo-1564760055775-d63b17a55c44?w=800"],
                description: "Journey through scenic Nepal countryside to Chitwan National Park"
            },
            {
                id: 5,
                day: 5,
                date: "18 Dec 2025",
                dateObj: new Date("2025-12-18"),
                place: "Kathmandu",
                city: "Kathmandu",
                state: "Bagmati Province",
                country: "Nepal",
                lat: 27.7172,
                lng: 85.3240,
                activities: [
                    { time: "6:30 AM", activity: "Safari in Chitwan National Park" },
                    { time: "12:30 PM", activity: "Departure for Kathmandu (150 km, 5:30 hrs)" },
                    { time: "Evening", activity: "Night stay in Kathmandu" }
                ],
                images: ["https://images.unsplash.com/photo-1571898223382-a7458302a2ea?w=800"],
                description: "Wildlife safari adventure, then travel to sacred Kathmandu valley"
            },
            {
                id: 6,
                day: 6,
                date: "19 Dec 2025",
                dateObj: new Date("2025-12-19"),
                place: "Kathmandu Sightseeing",
                city: "Kathmandu",
                state: "Bagmati Province",
                country: "Nepal",
                lat: 27.7172,
                lng: 85.3240,
                activities: [
                    { time: "7:00 AM", activity: "Sight seeing part 1" },
                    { time: "2:00 PM", activity: "Sight seeing part 2" },
                    { time: "Evening", activity: "Night stay in Kathmandu" }
                ],
                images: ["https://images.unsplash.com/photo-1605640840605-14ac1855827b?w=800"],
                description: "Explore ancient temples and cultural heritage of Kathmandu"
            },
            {
                id: 7,
                day: 7,
                date: "20 Dec 2025",
                dateObj: new Date("2025-12-20"),
                place: "Pashupatinath Temple",
                city: "Kathmandu",
                state: "Bagmati Province",
                country: "Nepal",
                lat: 27.7104,
                lng: 85.3489,
                activities: [
                    { time: "5:00 AM", activity: "Pashupatinath Jyotirlingam darshan" },
                    { time: "6:30 AM", activity: "Depart for surprise location" },
                    { time: "9:30 AM", activity: "Sight seeing part 1" },
                    { time: "1:30 PM", activity: "Sight seeing part 2" },
                    { time: "4:30 PM", activity: "Swayambhu stupa sunset viewpoint" },
                    { time: "Evening", activity: "Night stay in Kathmandu" }
                ],
                images: ["https://images.unsplash.com/photo-1626621341517-bbf3d9990a23?w=800"],
                description: "Sacred darshan at Pashupatinath Jyotirlingam, one of holiest Shiva temples"
            },
            {
                id: 8,
                day: 8,
                date: "21 Dec 2025",
                dateObj: new Date("2025-12-21"),
                place: "Pokhara",
                city: "Pokhara",
                state: "Gandaki Province",
                country: "Nepal",
                lat: 28.2096,
                lng: 83.9856,
                activities: [
                    { time: "7:00 AM", activity: "Departure for Pokhara (205 km, 6:15 hrs)" },
                    { time: "5:00 PM", activity: "Arrive at Pokhara" },
                    { time: "8:00 PM", activity: "Satsang sabha in Pokhara" },
                    { time: "Evening", activity: "Night stay in Pokhara" }
                ],
                images: ["https://images.unsplash.com/photo-1605640635484-f969f2f7f6c7?w=800"],
                description: "Travel to beautiful Pokhara valley with stunning Himalayan views"
            },
            {
                id: 9,
                day: 9,
                date: "22 Dec 2025",
                dateObj: new Date("2025-12-22"),
                place: "Muktinath Temple",
                city: "Muktinath",
                state: "Gandaki Province",
                country: "Nepal",
                lat: 28.8170,
                lng: 83.8717,
                activities: [
                    { time: "6:00 AM", activity: "Depart for Muktinath (175 km, 10 hrs)" },
                    { time: "En route", activity: "Tatopani, Jomsom Swaminarayan Mandir, Kagbeni" },
                    { time: "6:15 PM", activity: "Arti at Muktinath Mandir" },
                    { time: "Evening", activity: "Bathe under 108 holy water spouts" },
                    { time: "7:30 PM", activity: "Arti, sabha & dinner - Night stay" }
                ],
                images: ["https://images.unsplash.com/photo-1626621341580-356d0cb9c9f9?w=800"],
                description: "Sacred pilgrimage to Muktinath, bathing in 108 holy water spouts"
            },
            {
                id: 10,
                day: 10,
                date: "23 Dec 2025",
                dateObj: new Date("2025-12-23"),
                place: "Muktinath to Pokhara",
                city: "Pokhara",
                state: "Gandaki Province",
                country: "Nepal",
                lat: 28.2096,
                lng: 83.9856,
                activities: [
                    { time: "5:15 AM", activity: "Arti at Muktinath Temple" },
                    { time: "Morning", activity: "Tapni mala, Sahajanand Namavali path" },
                    { time: "9:00 AM", activity: "Depart for Pokhara (175 km, 10 hrs)" },
                    { time: "5:00 PM", activity: "Gopal Yogi Ashram (Kushma)" },
                    { time: "Evening", activity: "Night stay in Pokhara" }
                ],
                images: ["https://images.unsplash.com/photo-1605640840604-3e5aaaac88b7?w=800"],
                description: "Morning prayers at Muktinath, return journey to Pokhara valley"
            }
        ];

        // ==================== ITINERARY SYNC SYSTEM ====================
        
        // Load itinerary from localStorage (synced with admin) or use default
        function loadItineraryFromStorage() {
            const savedItinerary = safeGetFromStorage('itinerary', null);
            if (savedItinerary && savedItinerary.length > 0) {
                try {
                    // Restore Date objects
                    itinerary = savedItinerary.map(day => ({
                        ...day,
                        dateObj: day.dateObj ? new Date(day.dateObj) : new Date(day.date)
                    }));
                    console.log(`‚úÖ Loaded ${itinerary.length} days from admin sync`);
                    return true;
                } catch (e) {
                    console.error('Error loading itinerary:', e);
                    return false;
                }
            }
            return false;
        }

        // Try to load from admin first, otherwise use defaults
        if (!loadItineraryFromStorage()) {
            console.log('üìã Using default itinerary (no admin data found)');
            // Save default itinerary to localStorage for first time
            safeSetToStorage('itinerary', itinerary);
        }

        // Monitor for itinerary updates from admin panel
        let lastItineraryUpdate = localStorage.getItem('itineraryLastUpdate') || Date.now();
        
        function checkForItineraryUpdates() {
            const currentUpdate = localStorage.getItem('itineraryLastUpdate');
            if (currentUpdate && currentUpdate !== lastItineraryUpdate) {
                lastItineraryUpdate = currentUpdate;
                const reloaded = loadItineraryFromStorage();
                if (reloaded) {
                    console.log('üîÑ Itinerary updated from admin');
                    // Refresh current display if on journey section
                    const journeySection = document.getElementById('journey');
                    if (journeySection && journeySection.classList.contains('active')) {
                        // Reinitialize journey display
                        if (typeof initializeJourney === 'function') {
                            initializeJourney();
                        }
                        // Refresh current day display
                        if (currentPreviewDay < itinerary.length) {
                            showDayDetails(currentPreviewDay);
                        }
                        showSyncNotification('‚úÖ Journey updated!');
                    }
                }
            }
        }

        // Check for updates every 3 seconds when page is visible
        setInterval(() => {
            if (!document.hidden) {
                checkForItineraryUpdates();
            }
        }, 3000);

        // Also check when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                checkForItineraryUpdates();
            }
        });

        // Manual refresh function (can be called from UI)
        function refreshItineraryFromAdmin() {
            const reloaded = loadItineraryFromStorage();
            if (reloaded) {
                showSyncNotification('‚úÖ Itinerary refreshed from admin!');
                // Reinitialize if on journey section
                const journeySection = document.getElementById('journey');
                if (journeySection && journeySection.classList.contains('active')) {
                    if (currentPreviewDay < itinerary.length) {
                        showDayDetails(currentPreviewDay);
                    }
                }
                return true;
            } else {
                showSyncNotification('‚ö†Ô∏è No updates available');
                return false;
            }
        }

        // Visual sync notification
        function showSyncNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, var(--saffron), #FF7700);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add CSS animation for notification
        const syncStyle = document.createElement('style');
        syncStyle.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(syncStyle);

        // ==================== END ITINERARY SYNC SYSTEM ====================


        let currentPreviewDay = 0;

        // Sample authorized travelers (in production, this comes from backend)
        // Load travelers from API or localStorage (synced with Admin Panel)
        let authorizedTravelers = [];
        
        // Load travelers asynchronously
        (async function() {
            authorizedTravelers = await safeGetFromStorage('authorizedTravelers', []);
            console.log('üìä Loaded travelers:', authorizedTravelers.length);
        })();
        
        // Initialize with default travelers if empty
        if (authorizedTravelers.length === 0) {
            authorizedTravelers = [
                { 
                    id: 1, 
                    tirthId: "TY001",
                    firstName: "Ram", 
                    middleName: "", 
                    lastName: "Kumar", 
                    name: "Ram Kumar", 
                    profileLine: "Travel Enthusiast",
                    aboutMe: "Love exploring spiritual places",
                    birthDate: "1990-03-15",
                    age: "34",
                    passportNo: "BK918758",
                    passportIssueDate: "2024-03-26",
                    passportExpiryDate: "2034-03-25",
                    nationality: "Indian",
                    email: "ram@yatra.com", 
                    password: "ram123", 
                    phone: "+91-9876543210", 
                    city: "Varanasi", 
                    country: "India",
                    center: "Nairobi",
                    hoodiSize: "L",
                    vehicleId: null
                },
                { 
                    id: 2, 
                    tirthId: "TY002",
                    firstName: "Sita", 
                    middleName: "", 
                    lastName: "Devi", 
                    name: "Sita Devi", 
                    profileLine: "Spiritual Seeker",
                    aboutMe: "Devoted to spiritual journey",
                    birthDate: "1992-06-20",
                    age: "32",
                    passportNo: "BK918759",
                    passportIssueDate: "2024-04-10",
                    passportExpiryDate: "2034-04-09",
                    nationality: "Indian",
                    email: "sita@yatra.com", 
                    password: "sita123", 
                    phone: "+91-9876543211", 
                    city: "Ayodhya", 
                    country: "India",
                    center: "Nairobi",
                    hoodiSize: "M",
                    vehicleId: null
                },
                { 
                    id: 3, 
                    tirthId: "TY003",
                    firstName: "Arjun", 
                    middleName: "", 
                    lastName: "Sharma", 
                    name: "Arjun Sharma", 
                    profileLine: "Photographer",
                    aboutMe: "Capturing moments of divine journey",
                    birthDate: "1988-12-05",
                    age: "35",
                    passportNo: "BK918760",
                    passportIssueDate: "2024-05-15",
                    passportExpiryDate: "2034-05-14",
                    nationality: "Indian",
                    email: "arjun@yatra.com", 
                    password: "arjun123", 
                    phone: "+91-9876543212", 
                    city: "Delhi", 
                    country: "India",
                    center: "Nairobi",
                    hoodiSize: "XL",
                    vehicleId: null
                }
            ];
            // Save to localStorage
            localStorage.setItem('authorizedTravelers', JSON.stringify(authorizedTravelers));
        }

        // Sample posts (in production, loaded from backend)
        const samplePosts = [
            {
                id: 1,
                author: "Ram Kumar",
                email: "ram@yatra.com",
                place: "Kashi Vishwanath Mandir",
                location: "Varanasi",
                lat: 25.3109,
                lng: 83.0107,
                section: "temples",
                description: "Divine darshan at the holy Kashi Vishwanath Temple. The spiritual energy here is overwhelming. Har Har Mahadev! üôè",
                media: [
                    { type: 'image', url: "https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=800" },
                    { type: 'image', url: "https://images.unsplash.com/photo-1564507592333-c60657eea523?w=800" }
                ],
                tags: ['Temple', 'Prayer', 'Architecture'],
                timestamp: new Date("2024-11-28T10:30:00"),
                approved: true
            },
            {
                id: 2,
                author: "Sita Devi",
                email: "sita@yatra.com",
                place: "Ram Janmabhoomi Mandir",
                location: "Ayodhya",
                lat: 26.7955,
                lng: 82.1945,
                section: "temples",
                description: "Blessed to visit the sacred birthplace of Lord Ram. Jai Shri Ram! üö©",
                media: [
                    { type: 'image', url: "https://images.unsplash.com/photo-1548013146-72479768bada?w=800" }
                ],
                tags: ['Temple', 'Culture'],
                timestamp: new Date("2024-11-29T14:20:00"),
                approved: true
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadPosts();
            updateAuthorFilters();
            updateCityFilters();
            updateTagFilters();
            updateMediaTypeStats();
            startLocationTracking();
            renderTagsSelection();
            updateTopContributors();
            initializeWeather();
            checkWakeUpAlarm();
        });

        function initializeWeather() {
            // Initialize weather with first and second post locations if available
            const approvedPosts = posts.filter(p => p.approved).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            if (approvedPosts.length > 0) {
                updateWeather(approvedPosts[0].lat, approvedPosts[0].lng, 'currentWeatherInfo');
                if (approvedPosts.length > 1) {
                    updateWeather(approvedPosts[1].lat, approvedPosts[1].lng, 'nextWeatherInfo', approvedPosts[1].location);
                }
            }
        }

        function initMap() {
            // Initialize map centered on India
            map = L.map('map').setView([23.5937, 78.9629], 5);

            // Add tile layers with layer control
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxZoom: 19
            });

            const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap contributors',
                maxZoom: 17
            });

            // Add default layer
            osmLayer.addTo(map);

            // Layer control
            const baseLayers = {
                "Street Map": osmLayer,
                "Satellite": satelliteLayer,
                "Topographic": topoLayer
            };

            L.control.layers(baseLayers).addTo(map);

            // Initialize marker cluster group
            markerClusterGroup = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    return L.divIcon({
                        html: '<div style="background: linear-gradient(135deg, #FF9933, #138808); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">' + cluster.getChildCount() + '</div>',
                        className: 'custom-cluster-icon',
                        iconSize: L.point(40, 40)
                    });
                }
            });

            map.addLayer(markerClusterGroup);
        }

        function loadPosts() {
            // Initialize with sample posts if posts array is empty (first time)
            if (posts.length === 0) {
                posts = [...samplePosts];
                localStorage.setItem('posts', JSON.stringify(posts));
                console.log('‚úÖ Initialized with sample posts');
            }
            
            // Posts already loaded from localStorage, just display them
            displayPosts();
            updateTravelPath();
            loadVehicles(); // Load and display vehicles
        }

        function displayPosts() {
            markerClusterGroup.clearLayers();

            // Get selected filters
            const selectedAuthorElements = document.querySelectorAll('.author-filter:checked');
            const selectedAuthors = Array.from(selectedAuthorElements).map(el => el.value);
            
            const selectedCityElements = document.querySelectorAll('.city-filter:checked');
            const selectedCities = Array.from(selectedCityElements).map(el => el.value);
            
            const selectedTagElements = document.querySelectorAll('.tag-filter:checked');
            const selectedTags = Array.from(selectedTagElements).map(el => el.value);

            // Filter posts: approved public posts + user's own private posts
            const visiblePosts = posts.filter(p => {
                if (p.isPrivate) {
                    // Private posts: only show to the author
                    return currentUser && p.email === currentUser.email;
                } else {
                    // Public posts: only show if approved
                    return p.approved;
                }
            }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            let postNumber = 1;

            visiblePosts.forEach(post => {
                // Apply filters
                if (selectedAuthors.length > 0 && !selectedAuthors.includes(post.author)) return;
                if (selectedCities.length > 0 && !selectedCities.includes(post.location)) return;
                if (selectedTags.length > 0) {
                    const hasMatchingTag = post.tags && post.tags.some(tag => selectedTags.includes(tag));
                    if (!hasMatchingTag) return;
                }

                const icon = L.divIcon({
                    html: `<div style="background: linear-gradient(135deg, ${post.isPrivate ? '#6c757d, #495057' : '#FF9933, #138808'}); color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 2px solid white;">${post.isPrivate ? 'üîí' : postNumber}</div>`,
                    className: 'custom-marker-icon',
                    iconSize: [35, 35]
                });

                const marker = L.marker([post.lat, post.lng], { icon: icon });

                const popupContent = createPopupContent(post);
                marker.bindPopup(popupContent, {
                    maxWidth: 350,
                    className: 'post-popup'
                });

                markerClusterGroup.addLayer(marker);
                if (!post.isPrivate) postNumber++;
            });
        }

        function createPopupContent(post) {
            const firstMedia = post.media && post.media.length > 0 ? post.media[0] : null;
            const firstMediaUrl = firstMedia ? firstMedia.url : 'https://via.placeholder.com/300x200?text=No+Media';
            const timeAgo = getTimeAgo(post.timestamp);
            
            // Count media types
            const imageCount = post.media.filter(m => m.type === 'image').length;
            const videoCount = post.media.filter(m => m.type === 'video').length;
            const totalCount = post.media.length;

            let mediaInfo = '';
            if (totalCount > 1) {
                let parts = [];
                if (imageCount > 0) parts.push(`${imageCount} Photo${imageCount > 1 ? 's' : ''}`);
                if (videoCount > 0) parts.push(`${videoCount} Video${videoCount > 1 ? 's' : ''}`);
                mediaInfo = parts.join(' & ');
            }

            const tagsJson = post.tags ? JSON.stringify(post.tags).replace(/'/g, "&apos;") : '[]';
            const postJson = JSON.stringify(post).replace(/'/g, "&#39;");

            return `
                <div class="popup-header">${post.place}</div>
                <div class="popup-content">
                    <img src="${firstMediaUrl}" class="popup-image" onclick='openGallery(${JSON.stringify(post.media).replace(/'/g, "&apos;")}, "${post.description}", "${post.author}", ${tagsJson})'>
                    <div style="font-size: 0.85rem; color: var(--saffron); font-weight: 500; margin-bottom: 5px;">üìç ${post.location}</div>
                    <div class="popup-author">üìù ${post.author}</div>
                    <div class="popup-description">${post.description}</div>
                    ${addShareButtonsToPopup(post, null)}
                    <div class="popup-footer">
                        <span class="popup-time">üïê ${timeAgo}</span>
                        ${totalCount > 1 ? `<button class="view-all-btn" onclick='openGallery(${JSON.stringify(post.media).replace(/'/g, "&apos;")}, "${post.description}", "${post.author}", ${tagsJson})'>${mediaInfo}</button>` : ''}
                    </div>
                </div>
            `;
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        function updateTravelPath() {
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
            }

            const sortedPosts = [...posts].filter(p => p.approved).sort((a, b) => a.timestamp - b.timestamp);
            const pathCoords = sortedPosts.map(post => [post.lat, post.lng]);

            if (pathCoords.length > 1) {
                pathPolyline = L.polyline(pathCoords, {
                    color: '#FF9933',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10',
                    lineJoin: 'round'
                }).addTo(map);
            }
        }

        // ==================== VEHICLE TRACKING FUNCTIONS ====================
        
        function loadVehicles() {
            vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            displayVehicles();
        }

        function displayVehicles() {
            // Clear existing vehicle markers
            Object.values(vehicleMarkers).forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            vehicleMarkers = {};
            
            // Display active vehicles
            vehicles.filter(v => v.status === 'Active').forEach(vehicle => {
                displayVehicleMarker(vehicle);
            });
        }

        function displayVehicleMarker(vehicle) {
            // Get location from group leader if available
            const location = groupLeaderLocations[vehicle.groupLeaderEmail];
            
            if (!location) {
                // If no location yet, place at default position (will update when location is received)
                return;
            }
            
            // Check if map is initialized
            if (typeof map === 'undefined' || !map) {
                console.log('‚è≥ Map not ready for vehicle marker:', vehicle.name);
                return;
            }
            
            // Create bus icon with vehicle color
            const busIcon = L.divIcon({
                html: `
                    <div style="
                        position: relative;
                        width: 50px;
                        height: 50px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <div style="
                            background: ${vehicle.color};
                            border: 3px solid white;
                            border-radius: 50%;
                            width: 45px;
                            height: 45px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                            box-shadow: 0 3px 15px rgba(0,0,0,0.4);
                            animation: pulse-vehicle 2s infinite;
                        ">üöå</div>
                        <div style="
                            position: absolute;
                            bottom: -8px;
                            background: ${vehicle.color};
                            color: white;
                            padding: 2px 8px;
                            border-radius: 10px;
                            font-size: 10px;
                            font-weight: bold;
                            white-space: nowrap;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        ">${vehicle.name}</div>
                    </div>
                `,
                className: 'vehicle-marker-icon',
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });
            
            const marker = L.marker([location.lat, location.lng], { icon: busIcon });
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <div style="background: ${vehicle.color}; color: white; padding: 10px; margin: -10px -10px 10px -10px; border-radius: 5px 5px 0 0; font-weight: 600; font-size: 1.1rem;">
                        üöå ${vehicle.name}
                    </div>
                    <div style="padding: 5px 0;">
                        <strong>Type:</strong> ${vehicle.type}<br>
                        <strong>Capacity:</strong> ${vehicle.capacity} seats<br>
                        <strong>Group Leader:</strong> ${vehicle.groupLeaderName}<br>
                        ${vehicle.regNo ? `<strong>Reg. No:</strong> ${vehicle.regNo}<br>` : ''}
                        <strong>Status:</strong> <span style="color: #28a745; font-weight: 600;">${vehicle.status}</span>
                    </div>
                    ${vehicle.notes ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.9rem; color: #666;">${vehicle.notes}</div>` : ''}
                </div>
            `;
            
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'vehicle-popup'
            });
            
            marker.addTo(map);
            vehicleMarkers[vehicle.id] = marker;
        }

        function updateGroupLeaderLocation(email, lat, lng) {
            groupLeaderLocations[email] = { lat, lng, timestamp: Date.now() };
            
            // Save to localStorage for cross-page sync (admin panel)
            localStorage.setItem('groupLeaderLocations', JSON.stringify(groupLeaderLocations));
            
            // Update vehicle location in vehicles array
            vehicles.filter(v => v.groupLeaderEmail === email && v.status === 'Active').forEach(vehicle => {
                vehicle.currentLat = lat;
                vehicle.currentLng = lng;
                vehicle.lastUpdate = Date.now();
            });
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
            
            // Update all vehicles with this group leader on map
            vehicles.filter(v => v.groupLeaderEmail === email && v.status === 'Active').forEach(vehicle => {
                // Remove old marker if exists
                if (vehicleMarkers[vehicle.id] && map.hasLayer(vehicleMarkers[vehicle.id])) {
                    map.removeLayer(vehicleMarkers[vehicle.id]);
                }
                // Display updated marker
                displayVehicleMarker(vehicle);
            });
            
            console.log(`‚úÖ Vehicle location updated for ${email}:`, lat, lng);
        }
        
        // ==================== END VEHICLE TRACKING ====================

        function startLocationTracking() {
            if (!navigator.geolocation) {
                console.log('Geolocation not supported');
                return;
            }
            
            // Request location permission and start tracking
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Permission granted
                    currentLocation.permissionGranted = true;
                    updateCurrentLocation(position);
                    
                    // Start continuous tracking
                    if (locationWatchId) {
                        navigator.geolocation.clearWatch(locationWatchId);
                    }
                    
                    locationWatchId = navigator.geolocation.watchPosition(
                        updateCurrentLocation,
                        handleLocationError,
                        {
                            enableHighAccuracy: true,
                            maximumAge: 10000,
                            timeout: 30000
                        }
                    );
                },
                function(error) {
                    currentLocation.permissionGranted = false;
                    handleLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000
                }
            );
        }

        // Track current user location and update if they're a group leader
        function updateCurrentLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            // Store current location globally
            currentLocation.lat = lat;
            currentLocation.lng = lng;
            currentLocation.accuracy = accuracy;
            currentLocation.lastUpdated = new Date();
            currentLocation.permissionGranted = true;

            // Only add marker if map is initialized
            if (typeof map !== 'undefined' && map) {
                if (currentLocationMarker) {
                    map.removeLayer(currentLocationMarker);
                }

                const icon = L.divIcon({
                    html: '<div class="current-location-pulse"></div>',
                    className: 'current-location-icon',
                    iconSize: [20, 20]
                });

                currentLocationMarker = L.marker([lat, lng], { icon: icon }).addTo(map);
                currentLocationMarker.bindPopup(`
                    <b>üìç You are here</b><br>
                    <small>Accuracy: ¬±${Math.round(accuracy)}m</small><br>
                    <small>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</small>
                `);
                
                console.log('‚úÖ Current location marker added:', lat, lng);
            } else {
                console.log('‚è≥ Map not ready, location stored:', lat, lng);
            }

            // Update current location name in journey strip
            updateCurrentLocationName(lat, lng);
            
            // If current user is a group leader, update vehicle location
            if (currentUser && currentUser.email) {
                updateGroupLeaderLocation(currentUser.email, lat, lng);
            }
        }

        function updateCurrentLocationName(lat, lng) {
            // Find nearest post to current location
            if (posts.length > 0) {
                const approvedPosts = posts.filter(p => p.approved);
                if (approvedPosts.length > 0) {
                    let nearest = approvedPosts[0];
                    let minDistance = getDistance(lat, lng, nearest.lat, nearest.lng);

                    approvedPosts.forEach(post => {
                        const distance = getDistance(lat, lng, post.lat, post.lng);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearest = post;
                        }
                    });

                    document.getElementById('currentLocationName').textContent = nearest.location;
                    
                    // Update weather for current location
                    updateWeather(nearest.lat, nearest.lng, 'currentWeatherInfo');
                    
                    // Find next destination (next post in chronological order)
                    const sortedPosts = approvedPosts.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    const currentIndex = sortedPosts.findIndex(p => p.id === nearest.id);
                    if (currentIndex !== -1 && currentIndex < sortedPosts.length - 1) {
                        const nextPost = sortedPosts[currentIndex + 1];
                        updateWeather(nextPost.lat, nextPost.lng, 'nextWeatherInfo', nextPost.location);
                    } else {
                        document.getElementById('nextWeatherInfo').textContent = 'Journey Complete';
                    }
                }
            }
        }

        function updateWeather(lat, lng, elementId, locationName = '') {
            // Using Open-Meteo API (free, no API key required)
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&temperature_unit=celsius`)
                .then(response => response.json())
                .then(data => {
                    const weather = data.current_weather;
                    const temp = Math.round(weather.temperature);
                    const weatherCode = weather.weathercode;
                    
                    // Weather code to emoji mapping
                    const weatherEmoji = {
                        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
                        45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                        51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è',
                        61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
                        71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
                        80: 'üåßÔ∏è', 81: 'üåßÔ∏è', 82: 'üåßÔ∏è',
                        95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
                    };
                    
                    const emoji = weatherEmoji[weatherCode] || 'üå§Ô∏è';
                    const displayText = locationName ? 
                        `${emoji} ${temp}¬∞C ${locationName}` : 
                        `${emoji} ${temp}¬∞C`;
                    
                    document.getElementById(elementId).textContent = displayText;
                })
                .catch(error => {
                    document.getElementById(elementId).textContent = 'Weather unavailable';
                });
        }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function handleLocationError(error) {
            console.log('Location error:', error);
        }

        // Modal Functions
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function openPostModal() {
            if (!currentUser) {
                showMessage('Please login first to create a post', 'error');
                openLoginModal();
                return;
            }
            document.getElementById('postModal').style.display = 'block';
        }

        function closePostModal() {
            document.getElementById('postModal').style.display = 'none';
            document.getElementById('mediaPreviewContainer').innerHTML = '';
            uploadedMedia = [];
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Try API login first
                if (typeof api !== 'undefined' && api.loginTraveler) {
                    const traveler = await api.loginTraveler(email, password);
                    if (traveler) {
                        currentUser = traveler;
                        closeLoginModal();
                        showMessage(`Welcome back, ${traveler.name}! üôè`);
                        updateUIForLoginStatus();
                        loadCheckInData();
                        checkCheckInStatus();
                        return;
                    }
                }
            } catch (error) {
                console.log('API login failed, trying local fallback:', error);
            }

            // Fallback to local storage
            const traveler = authorizedTravelers.find(t => t.email === email && t.password === password);

            if (traveler) {
                currentUser = traveler;
                closeLoginModal();
                showMessage(`Welcome back, ${traveler.name}! üôè`);
                updateUIForLoginStatus();
                loadCheckInData();
                checkCheckInStatus();
            } else {
                showMessage('Invalid email or password', 'error');
            }
        }

        // Tags Functions
        function renderTagsSelection() {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = availableTags.map(tag => 
                `<span class="tag-badge" onclick="toggleTag('${tag}')">${tag}</span>`
            ).join('');
        }

        function toggleTag(tag) {
            const index = selectedTags.indexOf(tag);
            if (index > -1) {
                selectedTags.splice(index, 1);
            } else {
                selectedTags.push(tag);
            }
            
            // Update UI
            const badges = document.querySelectorAll('.tag-badge');
            badges.forEach(badge => {
                if (badge.textContent === tag) {
                    badge.classList.toggle('selected');
                }
            });
        }

        // Profile Functions
        function openProfileModal() {
            if (!currentUser) {
                showMessage('Please login first', 'error');
                return;
            }
            
            // Populate readonly fields from current user data
            document.getElementById('profileTirthId').value = currentUser.tirthId || '';
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileBirthDate').value = currentUser.birthDate ? new Date(currentUser.birthDate).toLocaleDateString() : '';
            document.getElementById('profileAge').value = currentUser.age || '';
            document.getElementById('profilePassportNo').value = currentUser.passportNo || '';
            document.getElementById('profileNationality').value = currentUser.nationality || '';
            document.getElementById('profilePassportIssue').value = currentUser.passportIssueDate ? new Date(currentUser.passportIssueDate).toLocaleDateString() : '';
            document.getElementById('profilePassportExpiry').value = currentUser.passportExpiryDate ? new Date(currentUser.passportExpiryDate).toLocaleDateString() : '';
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profileCity').value = currentUser.city;
            document.getElementById('profileCountry').value = currentUser.country;
            document.getElementById('profileCenter').value = currentUser.center || '';
            document.getElementById('profileHoodiSize').value = currentUser.hoodiSize || '';
            
            // Load existing profile data (editable fields)
            const allProfiles = JSON.parse(localStorage.getItem('travelerProfileData') || '{}');
            const profileData = allProfiles[currentUser.email];
            
            if (profileData) {
                document.getElementById('profilePunchline').value = profileData.punchline || currentUser.profileLine || '';
                document.getElementById('profileAbout').value = profileData.about || currentUser.aboutMe || '';
                document.getElementById('punchlineCount').textContent = (profileData.punchline || currentUser.profileLine || '').length;
                
                // Load health & preferences
                document.getElementById('profileHealthIssues').value = profileData.healthIssues || currentUser.healthIssues || '';
                document.getElementById('profileAllergies').value = profileData.allergies || currentUser.allergies || '';
                document.getElementById('profileFoodPreference').value = profileData.foodPreference || currentUser.foodPreference || '';
                document.getElementById('profileBloodGroup').value = profileData.bloodGroup || currentUser.bloodGroup || '';
            } else {
                // Use data from authorizedTravelers if no localStorage data
                document.getElementById('profilePunchline').value = currentUser.profileLine || '';
                document.getElementById('profileAbout').value = currentUser.aboutMe || '';
                document.getElementById('punchlineCount').textContent = (currentUser.profileLine || '').length;
                
                // Load health & preferences from traveler data
                document.getElementById('profileHealthIssues').value = currentUser.healthIssues || '';
                document.getElementById('profileAllergies').value = currentUser.allergies || '';
                document.getElementById('profileFoodPreference').value = currentUser.foodPreference || '';
                document.getElementById('profileBloodGroup').value = currentUser.bloodGroup || '';
            }
            
            // Load documents
            displayUploadedDocuments();
            
            // Load profile photo if exists
            if (travelerProfiles[currentUser.email]) {
                document.getElementById('profilePhotoImg').src = travelerProfiles[currentUser.email];
                document.getElementById('profilePhotoImg').style.display = 'block';
                document.getElementById('profilePhotoPlaceholder').style.display = 'none';
            } else {
                document.getElementById('profilePhotoImg').style.display = 'none';
                document.getElementById('profilePhotoPlaceholder').style.display = 'flex';
            }
            
            document.getElementById('profileModal').style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function handleProfilePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhotoImg').src = e.target.result;
                    document.getElementById('profilePhotoImg').style.display = 'block';
                    document.getElementById('profilePhotoPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function handleProfileUpdate(event) {
            event.preventDefault();
            
            if (!currentUser) return;
            
            const punchline = document.getElementById('profilePunchline').value;
            const about = document.getElementById('profileAbout').value;
            const healthIssues = document.getElementById('profileHealthIssues').value;
            const allergies = document.getElementById('profileAllergies').value;
            const foodPreference = document.getElementById('profileFoodPreference').value;
            const bloodGroup = document.getElementById('profileBloodGroup').value;
            
            // Save profile data
            const profileData = {
                email: currentUser.email,
                name: currentUser.name,
                city: currentUser.city,
                punchline: punchline,
                about: about,
                healthIssues: healthIssues,
                allergies: allergies,
                foodPreference: foodPreference,
                bloodGroup: bloodGroup,
                photo: travelerProfiles[currentUser.email] || ''
            };
            
            const photoImg = document.getElementById('profilePhotoImg');
            if (photoImg.src && photoImg.style.display !== 'none') {
                travelerProfiles[currentUser.email] = photoImg.src;
                profileData.photo = photoImg.src;
            }
            
            // Save to localStorage
            const allProfiles = JSON.parse(localStorage.getItem('travelerProfileData') || '{}');
            allProfiles[currentUser.email] = profileData;
            localStorage.setItem('travelerProfileData', JSON.stringify(allProfiles));
            localStorage.setItem('travelerProfiles', JSON.stringify(travelerProfiles));
            
            // SYNC TO ADMIN: Update authorizedTravelers with profile line, about me, and image
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const travelerIndex = travelers.findIndex(t => t.email === currentUser.email);
            if (travelerIndex !== -1) {
                travelers[travelerIndex].profileLine = punchline;
                travelers[travelerIndex].aboutMe = about;
                travelers[travelerIndex].healthIssues = healthIssues;
                travelers[travelerIndex].allergies = allergies;
                travelers[travelerIndex].foodPreference = foodPreference;
                travelers[travelerIndex].bloodGroup = bloodGroup;
                travelers[travelerIndex].image = travelerProfiles[currentUser.email] || '';
                localStorage.setItem('authorizedTravelers', JSON.stringify(travelers));
                
                // Update current user object
                currentUser.profileLine = punchline;
                currentUser.aboutMe = about;
                currentUser.healthIssues = healthIssues;
                currentUser.allergies = allergies;
                currentUser.foodPreference = foodPreference;
                currentUser.bloodGroup = bloodGroup;
                currentUser.image = travelerProfiles[currentUser.email] || '';
            }
            
            showMessage('Profile updated successfully! üéâ');
            updateTopContributors();
            closeProfileModal();
        }

        // Document Management Functions
        function addDocument() {
            const docName = document.getElementById('documentName').value.trim();
            const docFile = document.getElementById('documentFile').files[0];
            
            if (!docName) {
                showMessage('Please enter document name', 'error');
                return;
            }
            
            if (!docFile) {
                showMessage('Please select a file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const allDocuments = JSON.parse(localStorage.getItem('travelerDocuments') || '{}');
                if (!allDocuments[currentUser.email]) {
                    allDocuments[currentUser.email] = [];
                }
                
                const document = {
                    id: Date.now(),
                    name: docName,
                    fileName: docFile.name,
                    fileType: docFile.type,
                    fileData: e.target.result,
                    uploadDate: new Date().toISOString()
                };
                
                allDocuments[currentUser.email].push(document);
                localStorage.setItem('travelerDocuments', JSON.stringify(allDocuments));
                
                // Clear inputs
                document.getElementById('documentName').value = '';
                document.getElementById('documentFile').value = '';
                
                displayUploadedDocuments();
                showMessage('Document added successfully! üìÑ');
            };
            reader.readAsDataURL(docFile);
        }
        
        function displayUploadedDocuments() {
            const container = document.getElementById('uploadedDocumentsList');
            if (!currentUser) return;
            
            const allDocuments = JSON.parse(localStorage.getItem('travelerDocuments') || '{}');
            const userDocuments = allDocuments[currentUser.email] || [];
            
            if (userDocuments.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No documents uploaded yet</div>';
                return;
            }
            
            container.innerHTML = userDocuments.map(doc => `
                <div style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--navy);">${doc.name}</div>
                        <div style="font-size: 0.85rem; color: #666;">${doc.fileName} ‚Ä¢ ${new Date(doc.uploadDate).toLocaleDateString()}</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="downloadDocument(${doc.id})" style="background: #2196f3; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;" title="Download">
                            ‚¨áÔ∏è Download
                        </button>
                        <button onclick="deleteDocument(${doc.id})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function downloadDocument(docId) {
            const allDocuments = JSON.parse(localStorage.getItem('travelerDocuments') || '{}');
            const userDocuments = allDocuments[currentUser.email] || [];
            const document = userDocuments.find(d => d.id === docId);
            
            if (document) {
                const link = document.createElement('a');
                link.href = document.fileData;
                link.download = document.fileName;
                link.click();
                showMessage('Document download started! üì•');
            }
        }
        
        function deleteDocument(docId) {
            if (confirm('Delete this document?')) {
                const allDocuments = JSON.parse(localStorage.getItem('travelerDocuments') || '{}');
                if (allDocuments[currentUser.email]) {
                    allDocuments[currentUser.email] = allDocuments[currentUser.email].filter(d => d.id !== docId);
                    localStorage.setItem('travelerDocuments', JSON.stringify(allDocuments));
                    displayUploadedDocuments();
                    showMessage('Document deleted');
                }
            }
        }

        // Profile Viewer Functions
        function openProfileViewer() {
            document.getElementById('profileViewerModal').style.display = 'block';
            loadAllProfiles();
        }

        function closeProfileViewer() {
            document.getElementById('profileViewerModal').style.display = 'none';
        }

        function loadAllProfiles() {
            const container = document.getElementById('profileViewerContent');
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const travelerProfiles = JSON.parse(localStorage.getItem('travelerProfiles') || '{}');
            
            container.innerHTML = '';
            
            if (travelers.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">No traveler profiles yet</div>';
                return;
            }
            
            travelers.forEach(traveler => {
                const vehicle = vehicles.find(v => v.id == traveler.vehicleId);
                const profileImage = travelerProfiles[traveler.email] || traveler.image || '';
                
                const card = document.createElement('div');
                card.style.cssText = 'background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s;';
                card.onmouseover = () => card.style.transform = 'translateY(-5px)';
                card.onmouseout = () => card.style.transform = 'translateY(0)';
                card.onclick = () => viewProfileDetail(traveler, vehicle, profileImage);
                
                card.innerHTML = `
                    <div style="width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 3px solid var(--saffron); background: var(--light-gray);">
                        ${profileImage ? 
                            `<img src="${escapeHTML(profileImage)}" style="width: 100%; height: 100%; object-fit: cover;">` :
                            `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem;">üë§</div>`
                        }
                    </div>
                    <h3 style="text-align: center; margin-top: 15px; color: var(--navy);">${escapeHTML(traveler.name)}</h3>
                    ${traveler.profileLine ? `<p style="text-align: center; font-style: italic; color: #666; font-size: 0.85rem; margin-top: 5px;">"${escapeHTML(traveler.profileLine)}"</p>` : ''}
                    <p style="text-align: center; color: var(--saffron); font-size: 0.9rem; margin-top: 5px;">${escapeHTML(traveler.city)}</p>
                    ${vehicle ? `<p style="text-align: center; color: #138808; font-size: 0.85rem; margin-top: 5px;">üöå ${escapeHTML(vehicle.name)}</p>` : ''}
                `;
                
                container.appendChild(card);
            });
        }

        function viewProfileDetail(traveler, vehicle, profileImage) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 650px;">
                    <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <div class="modal-header" style="background: linear-gradient(135deg, var(--saffron), var(--green)); color: white;">${escapeHTML(traveler.name)}'s Profile</div>
                    <div style="padding: 30px;">
                        <!-- Profile Image -->
                        <div style="width: 150px; height: 150px; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 3px solid var(--saffron); background: var(--light-gray);">
                            ${profileImage ? 
                                `<img src="${escapeHTML(profileImage)}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 5rem;">üë§</div>`
                            }
                        </div>
                        
                        <!-- Name -->
                        <h2 style="text-align: center; margin-top: 20px; margin-bottom: 10px; color: var(--navy);">${escapeHTML(traveler.name)}</h2>
                        
                        <!-- Profile Line (without title) -->
                        ${traveler.profileLine ? `
                            <p style="text-align: center; font-style: italic; color: #666; font-size: 0.95rem; margin-bottom: 20px;">${escapeHTML(traveler.profileLine)}</p>
                        ` : ''}
                        
                        <!-- About Me Section (scrollable) -->
                        ${traveler.aboutMe ? `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: var(--navy); margin-bottom: 10px; font-size: 1.1rem; border-bottom: 2px solid var(--saffron); padding-bottom: 5px;">About Me</h3>
                                <div style="
                                    max-height: 150px; 
                                    overflow-y: auto; 
                                    white-space: pre-wrap; 
                                    color: #666; 
                                    line-height: 1.6; 
                                    padding: 15px; 
                                    background: #f9f9f9; 
                                    border-radius: 8px;
                                    border-left: 3px solid var(--saffron);
                                ">${traveler.aboutMe}</div>
                            </div>
                        ` : ''}
                        
                        <!-- Contact & Location Grid -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üìû Phone</div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-weight: 600; color: var(--navy); font-size: 0.9rem;">${traveler.phone || 'Not provided'}</div>
                                    ${traveler.phone ? `
                                        <a href="https://wa.me/${traveler.phone.replace(/\\D/g, '')}" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #25D366; border-radius: 50%; text-decoration: none; box-shadow: 0 2px 6px rgba(37, 211, 102, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="WhatsApp Chat">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                            </svg>
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üìç City</div>
                                <div style="font-weight: 600; color: var(--navy); font-size: 0.9rem;">${traveler.city}</div>
                            </div>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üåç Country</div>
                                <div style="font-weight: 600; color: var(--navy); font-size: 0.9rem;">${traveler.country}</div>
                            </div>
                            ${vehicle ? `
                                <div style="background: linear-gradient(135deg, ${vehicle.color}22, ${vehicle.color}11); padding: 15px; border-radius: 8px; border: 2px solid ${vehicle.color};">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üöå Vehicle</div>
                                    <div style="font-weight: 600; color: var(--navy); font-size: 0.9rem;">${vehicle.name}</div>
                                    <div style="font-size: 0.75rem; color: #666; margin-top: 3px;">${vehicle.regNo || ''}</div>
                                </div>
                            ` : `
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üöå Vehicle</div>
                                    <div style="color: #999; font-size: 0.9rem;">No vehicle assigned</div>
                                </div>
                            `}
                        </div>
                        
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ===== CHECK-IN LIST FUNCTIONS =====
        let currentCheckInFilter = 'all';

        function openCheckInList() {
            if (!currentUser || !currentUser.email) {
                showMessage('Please login to view check-in list', 'error');
                return;
            }
            
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const currentTraveler = travelers.find(t => t.email === currentUser.email);
            
            if (!currentTraveler || !currentTraveler.vehicleId) {
                showMessage('You are not assigned to any vehicle', 'error');
                return;
            }
            
            // Check if user is a group leader
            const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const vehicle = vehicles.find(v => v.id == currentTraveler.vehicleId);
            const isGroupLeader = vehicle && vehicle.groupLeaderEmail === currentUser.email;
            
            // Show/hide clear button based on group leader status
            const clearBtn = document.getElementById('clearCheckInBtn');
            if (clearBtn) {
                clearBtn.style.display = isGroupLeader ? 'block' : 'none';
            }
            
            document.getElementById('checkInListModal').style.display = 'block';
            currentCheckInFilter = 'all';
            loadCheckInList();
        }

        function closeCheckInList() {
            document.getElementById('checkInListModal').style.display = 'none';
        }

        function loadCheckInList() {
            if (!currentUser || !currentUser.email) return;
            
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const currentTraveler = travelers.find(t => t.email === currentUser.email);
            
            if (!currentTraveler || !currentTraveler.vehicleId) return;
            
            const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const vehicle = vehicles.find(v => v.id == currentTraveler.vehicleId);
            const checkInData = JSON.parse(localStorage.getItem('checkInData') || '{}');
            const vehicleCheckIn = checkInData[currentTraveler.vehicleId] || { checkedIn: [] };
            
            // Get all travelers in the same vehicle
            const vehicleTravelers = travelers.filter(t => t.vehicleId == currentTraveler.vehicleId);
            
            // Sort alphabetically by name
            vehicleTravelers.sort((a, b) => a.name.localeCompare(b.name));
            
            // Count checked in and pending
            const checkedInCount = vehicleTravelers.filter(t => vehicleCheckIn.checkedIn.includes(t.email)).length;
            const pendingCount = vehicleTravelers.length - checkedInCount;
            
            // Update header
            const vehicleName = vehicle ? vehicle.name : 'Your Vehicle';
            document.getElementById('checkInListTitle').innerHTML = `
                <span>‚úÖ ${vehicleName} - Check-In List</span>
                <span id="checkInCountBadge" style="background: white; color: var(--navy); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;">${checkedInCount}/${vehicleTravelers.length}</span>
            `;
            
            // Apply filter and render list
            renderCheckInList(vehicleTravelers, vehicleCheckIn.checkedIn);
        }

        function renderCheckInList(vehicleTravelers, checkedInEmails) {
            const container = document.getElementById('checkInListContent');
            
            // Filter travelers based on current filter
            let filteredTravelers = vehicleTravelers;
            if (currentCheckInFilter === 'checked') {
                filteredTravelers = vehicleTravelers.filter(t => checkedInEmails.includes(t.email));
            } else if (currentCheckInFilter === 'pending') {
                filteredTravelers = vehicleTravelers.filter(t => !checkedInEmails.includes(t.email));
            }
            
            container.innerHTML = '';
            
            if (filteredTravelers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üîç</div>
                        <div>No travelers in this category</div>
                    </div>
                `;
                return;
            }
            
            filteredTravelers.forEach(traveler => {
                const isCheckedIn = checkedInEmails.includes(traveler.email);
                const statusIcon = isCheckedIn ? '‚úÖ' : '‚è≥';
                const statusColor = isCheckedIn ? '#4caf50' : '#ff9800';
                const bgColor = isCheckedIn ? '#e8f5e9' : '#fff3e0';
                
                // Format phone number for WhatsApp (remove spaces, dashes, etc.)
                const phone = traveler.phone ? traveler.phone.replace(/\D/g, '') : '';
                const hasPhone = phone && phone.length > 0;
                
                const row = document.createElement('div');
                row.style.cssText = `
                    display: grid;
                    grid-template-columns: 80px 1fr 60px 60px;
                    gap: 15px;
                    align-items: center;
                    padding: 15px;
                    margin-bottom: 10px;
                    background: ${bgColor};
                    border-radius: 10px;
                    border-left: 4px solid ${statusColor};
                    transition: transform 0.2s;
                `;
                
                row.onmouseover = () => row.style.transform = 'translateX(5px)';
                row.onmouseout = () => row.style.transform = 'translateX(0)';
                
                row.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 3px;">Tirth ID</div>
                        <div style="font-weight: 700; color: var(--navy); font-size: 1rem;">${traveler.tirthId || '-'}</div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: var(--navy); font-size: 1.05rem; margin-bottom: 3px;">${traveler.name}</div>
                        <div style="font-size: 0.85rem; color: #666;">${traveler.city}</div>
                    </div>
                    <div style="text-align: center;">
                        ${hasPhone ? `
                            <a href="https://wa.me/${phone}" target="_blank" style="display: inline-block; width: 45px; height: 45px; background: #25D366; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(37, 211, 102, 0.6)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(37, 211, 102, 0.4)';" title="Call ${traveler.name} on WhatsApp">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="white">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                            </a>
                        ` : `
                            <div style="width: 45px; height: 45px; background: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.5;" title="No phone number">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="#666">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                            </div>
                        `}
                    </div>
                    <div style="text-align: center; font-size: 2rem;">
                        ${statusIcon}
                    </div>
                `;
                
                container.appendChild(row);
            });
        }

        function filterCheckInList(filter) {
            currentCheckInFilter = filter;
            
            // Update button styles
            document.getElementById('filterAll').style.cssText = filter === 'all' 
                ? 'padding: 10px 20px; border: 2px solid var(--navy); background: var(--navy); color: white; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;'
                : 'padding: 10px 20px; border: 2px solid var(--navy); background: white; color: var(--navy); border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;';
                
            document.getElementById('filterChecked').style.cssText = filter === 'checked'
                ? 'padding: 10px 20px; border: 2px solid #4caf50; background: #4caf50; color: white; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;'
                : 'padding: 10px 20px; border: 2px solid #4caf50; background: white; color: #4caf50; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;';
                
            document.getElementById('filterPending').style.cssText = filter === 'pending'
                ? 'padding: 10px 20px; border: 2px solid #ff9800; background: #ff9800; color: white; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;'
                : 'padding: 10px 20px; border: 2px solid #ff9800; background: white; color: #ff9800; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;';
            
            // Reload list with new filter
            loadCheckInList();
        }

        // Character counter for punchline
        document.addEventListener('DOMContentLoaded', function() {
            const punchlineInput = document.getElementById('profilePunchline');
            if (punchlineInput) {
                punchlineInput.addEventListener('input', function() {
                    document.getElementById('punchlineCount').textContent = this.value.length;
                });
            }
        });

        // Top Contributors Functions
        function toggleContributors() {
            const panel = document.getElementById('topContributorsPanel');
            panel.classList.toggle('active');
        }

        function updateTopContributors() {
            // Get admin profile settings
            const adminProfile = JSON.parse(localStorage.getItem('adminProfile') || '{"includeInContributors":true}');
            
            // Count posts and media per traveler
            const stats = {};
            
            posts.forEach(post => {
                if (!post.approved) return;
                
                // Skip admin posts if not included in contributors
                if (post.author === 'Admin' && !adminProfile.includeInContributors) return;
                
                const key = post.email || post.author; // Use author name as fallback for admin
                
                if (!stats[key]) {
                    stats[key] = {
                        name: post.author,
                        email: post.email || '',
                        photos: 0,
                        videos: 0,
                        posts: 0
                    };
                }
                
                stats[key].posts++;
                
                post.media.forEach(m => {
                    if (m.type === 'image') stats[key].photos++;
                    else if (m.type === 'video') stats[key].videos++;
                });
            });
            
            // Convert to array and sort by total contributions
            const contributors = Object.values(stats).sort((a, b) => {
                const totalA = a.posts + a.photos + a.videos;
                const totalB = b.posts + b.photos + b.videos;
                return totalB - totalA;
            });
            
            // Display top N contributors
            const container = document.getElementById('contributorsList');
            container.innerHTML = '';
            
            const topN = contributors.slice(0, topContributorsCount);
            
            if (topN.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No contributors yet</div>';
                return;
            }
            
            topN.forEach((contributor, index) => {
                const badge = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                let photoUrl = '';
                
                // Check if this is admin
                if (contributor.name === 'Admin' || contributor.name === adminProfile.name) {
                    photoUrl = adminProfile.image || '';
                } else {
                    photoUrl = travelerProfiles[contributor.email] || '';
                }
                
                const card = document.createElement('div');
                card.className = 'contributor-card';
                card.innerHTML = `
                    ${photoUrl ? 
                        `<img src="${photoUrl}" class="contributor-avatar" alt="${contributor.name}">` :
                        `<div class="contributor-avatar" style="display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üë§</div>`
                    }
                    <div class="contributor-info">
                        <div class="contributor-name">${contributor.name}</div>
                        <div class="contributor-stats">
                            <span>üìù ${contributor.posts} posts</span>
                            <span>üì∏ ${contributor.photos} photos</span>
                            <span>üé• ${contributor.videos} videos</span>
                        </div>
                    </div>
                    ${badge ? `<div class="contributor-badge">${badge}</div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        function handleMediaUpload(event) {
            const files = Array.from(event.target.files);
            const previewContainer = document.getElementById('mediaPreviewContainer');

            files.forEach((file) => {
                const isVideo = file.type.startsWith('video/');
                
                if (isVideo) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedMedia.push({
                            type: 'video',
                            url: e.target.result
                        });
                        
                        const mediaDiv = document.createElement('div');
                        mediaDiv.className = 'photo-preview';
                        mediaDiv.innerHTML = `
                            <span class="media-type-badge">üé• VIDEO</span>
                            <video src="${e.target.result}" muted></video>
                            <button class="remove-photo" onclick="removeMedia(${uploadedMedia.length - 1})">&times;</button>
                        `;
                        previewContainer.appendChild(mediaDiv);
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Compress image
                    compressImage(file, (compressedUrl) => {
                        uploadedMedia.push({
                            type: 'image',
                            url: compressedUrl
                        });
                        
                        const mediaDiv = document.createElement('div');
                        mediaDiv.className = 'photo-preview';
                        mediaDiv.innerHTML = `
                            <span class="media-type-badge">üì∏ PHOTO</span>
                            <img src="${compressedUrl}" alt="Preview">
                            <button class="remove-photo" onclick="removeMedia(${uploadedMedia.length - 1})">&times;</button>
                        `;
                        previewContainer.appendChild(mediaDiv);
                    });
                }
            });
        }

        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set maximum dimensions (1920x1080 for best quality)
                    const MAX_WIDTH = 1920;
                    const MAX_HEIGHT = 1080;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions maintaining aspect ratio
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = height * (MAX_WIDTH / width);
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = width * (MAX_HEIGHT / height);
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Use quality setting from admin profile (synced from admin panel)
                    const adminProfile = JSON.parse(localStorage.getItem('adminProfile') || '{"imageCompressionQuality":0.85}');
                    const quality = adminProfile.imageCompressionQuality || 0.85;
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    callback(compressedDataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeMedia(index) {
            uploadedMedia.splice(index, 1);
            const previewContainer = document.getElementById('mediaPreviewContainer');
            previewContainer.innerHTML = '';
            
            uploadedMedia.forEach((media, i) => {
                const mediaDiv = document.createElement('div');
                mediaDiv.className = 'photo-preview';
                
                if (media.type === 'video') {
                    mediaDiv.innerHTML = `
                        <span class="media-type-badge">üé• VIDEO</span>
                        <video src="${media.url}" muted></video>
                        <button class="remove-photo" onclick="removeMedia(${i})">&times;</button>
                    `;
                } else {
                    mediaDiv.innerHTML = `
                        <span class="media-type-badge">üì∏ PHOTO</span>
                        <img src="${media.url}" alt="Preview">
                        <button class="remove-photo" onclick="removeMedia(${i})">&times;</button>
                    `;
                }
                
                previewContainer.appendChild(mediaDiv);
            });
        }

        function handlePostSubmit(event) {
            event.preventDefault();

            if (!currentUser) {
                showMessage('Please login first', 'error');
                return;
            }

            const placeName = document.getElementById('placeName').value;
            const locationCity = document.getElementById('locationCity').value;
            const section = document.getElementById('postSection').value;
            const description = document.getElementById('postDescription').value;
            const useLocation = document.getElementById('useCurrentLocation').checked;

            if (uploadedMedia.length === 0) {
                showMessage('Please upload at least one photo or video', 'error');
                return;
            }

            if (useLocation) {
                // Check if we have current location stored
                if (currentLocation.lat && currentLocation.lng && currentLocation.permissionGranted) {
                    // Use stored location - no permission prompt
                    createPost(currentLocation.lat, currentLocation.lng, placeName, locationCity, section, description);
                } else if (navigator.geolocation) {
                    // Request location permission only if not already granted
                    showMessage('Getting your location...', 'info');
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            currentLocation.lat = position.coords.latitude;
                            currentLocation.lng = position.coords.longitude;
                            currentLocation.accuracy = position.coords.accuracy;
                            currentLocation.permissionGranted = true;
                            currentLocation.lastUpdated = new Date();
                            createPost(position.coords.latitude, position.coords.longitude, placeName, locationCity, section, description);
                        },
                        function(error) {
                            showMessage('Could not get location. Using default location.', 'warning');
                            createPost(23.5937, 78.9629, placeName, locationCity, section, description);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000 // Allow cached location up to 1 minute old
                        }
                    );
                } else {
                    // Fallback to default India location
                    createPost(23.5937, 78.9629, placeName, locationCity, section, description);
                }
            } else {
                // Use default India location
                createPost(23.5937, 78.9629, placeName, locationCity, section, description);
            }
        }

        function createPost(lat, lng, placeName, locationCity, section, description) {
            // Get privacy setting
            const privacyRadio = document.querySelector('input[name="postPrivacy"]:checked');
            const isPrivate = privacyRadio ? privacyRadio.value === 'private' : false;
            
            const newPost = {
                id: posts.length > 0 ? Math.max(...posts.map(p => p.id)) + 1 : 1,
                author: currentUser.name,
                email: currentUser.email,
                place: placeName,
                location: locationCity,
                lat: lat,
                lng: lng,
                section: section,
                description: description,
                media: [...uploadedMedia],
                tags: [...selectedTags],
                timestamp: new Date().toISOString(),
                isPrivate: isPrivate,
                approved: isPrivate ? true : false // Private posts auto-approved
            };

            posts.push(newPost);
            
            // ‚úÖ Save to localStorage
            localStorage.setItem('posts', JSON.stringify(posts));
            
            if (isPrivate) {
                console.log('‚úÖ Private post created:', newPost.place);
                showMessage('üîí Private post created! Only visible to you.', 'success');
            } else {
                console.log('‚úÖ Public post submitted:', newPost.place);
                showMessage('üì§ Post submitted successfully! Waiting for admin approval. üôè', 'success');
            }
            
            // Trigger notification for new post
            notifyNewPost(newPost);
            
            closePostModal();
            
            // Reset form
            document.getElementById('placeName').value = '';
            document.getElementById('locationCity').value = '';
            document.getElementById('postSection').value = '';
            document.getElementById('postDescription').value = '';
            document.getElementById('mediaPreviewContainer').innerHTML = '';
            uploadedMedia = [];
            selectedTags = [];
            renderTagsSelection();
        }

        function openGallery(media, description, author, tags) {
            if (typeof media === 'string') {
                media = JSON.parse(media);
            }
            currentGalleryMedia = media;
            currentGalleryIndex = 0;
            
            // Reset slideshow state
            if (slideshowPlaying) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
                slideshowPlaying = false;
            }
            const playBtn = document.getElementById('playPauseBtn');
            if (playBtn) {
                playBtn.textContent = '‚ñ∂Ô∏è Play';
            }
            
            showGalleryMedia();
            document.getElementById('galleryModal').style.display = 'block';
            document.getElementById('galleryDescription').textContent = description;
            document.getElementById('galleryAuthor').textContent = 'üìù ' + author;
            
            // Display tags
            const tagsContainer = document.getElementById('galleryTags');
            if (tags && tags.length > 0) {
                tagsContainer.innerHTML = tags.map(tag => `<span class="tag-display">#${tag}</span>`).join('');
            } else {
                tagsContainer.innerHTML = '';
            }
            
            // Reset info visibility
            document.getElementById('galleryInfo').classList.remove('hidden');
        }

        function toggleGalleryInfo(event) {
            event.stopPropagation();
            const infoPanel = document.getElementById('galleryInfo');
            infoPanel.classList.toggle('hidden');
        }

        function showGalleryMedia() {
            const currentMedia = currentGalleryMedia[currentGalleryIndex];
            const imgElement = document.getElementById('galleryImage');
            const videoElement = document.getElementById('galleryVideo');
            
            if (currentMedia.type === 'video') {
                imgElement.style.display = 'none';
                videoElement.style.display = 'block';
                videoElement.src = currentMedia.url;
                videoElement.load();
            } else {
                videoElement.style.display = 'none';
                imgElement.style.display = 'block';
                imgElement.src = currentMedia.url;
            }
            
            // Count media types for display
            const imageCount = currentGalleryMedia.filter(m => m.type === 'image').length;
            const videoCount = currentGalleryMedia.filter(m => m.type === 'video').length;
            
            let counterText = `${currentGalleryIndex + 1} / ${currentGalleryMedia.length}`;
            if (imageCount > 0 && videoCount > 0) {
                counterText += ` (${imageCount} photos, ${videoCount} videos)`;
            }
            
            document.getElementById('galleryCounter').textContent = counterText;
        }

        function prevMedia(event) {
            if (event) {
                event.stopPropagation();
            }
            
            // Stop slideshow when manually navigating
            if (slideshowPlaying) {
                const btn = document.getElementById('playPauseBtn');
                clearInterval(slideshowInterval);
                slideshowInterval = null;
                slideshowPlaying = false;
                btn.textContent = '‚ñ∂Ô∏è Play';
            }
            
            currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryMedia.length) % currentGalleryMedia.length;
            showGalleryMedia();
        }

        function nextMedia(event) {
            if (event) {
                event.stopPropagation();
            }
            
            // Stop slideshow when manually navigating
            if (slideshowPlaying) {
                const btn = document.getElementById('playPauseBtn');
                clearInterval(slideshowInterval);
                slideshowInterval = null;
                slideshowPlaying = false;
                btn.textContent = '‚ñ∂Ô∏è Play';
            }
            
            currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryMedia.length;
            showGalleryMedia();
        }

        function toggleSlideshow(event) {
            if (event) {
                event.stopPropagation();
            }
            const btn = document.getElementById('playPauseBtn');
            
            if (slideshowPlaying) {
                // Stop slideshow
                clearInterval(slideshowInterval);
                slideshowInterval = null;
                slideshowPlaying = false;
                btn.textContent = '‚ñ∂Ô∏è Play';
            } else {
                // Start slideshow
                slideshowPlaying = true;
                btn.textContent = '‚è∏Ô∏è Pause';
                
                slideshowInterval = setInterval(() => {
                    if (currentGalleryMedia && currentGalleryMedia.length > 0) {
                        currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryMedia.length;
                        showGalleryMedia();
                    }
                }, 5000); // 5 seconds interval
            }
        }

        function closeGallery(event) {
            if (event) {
                event.stopPropagation();
            }
            
            // Stop slideshow if playing
            if (slideshowPlaying) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
                slideshowPlaying = false;
            }
            
            // Pause and clear video
            const videoElement = document.getElementById('galleryVideo');
            videoElement.pause();
            videoElement.src = '';
            
            document.getElementById('galleryModal').style.display = 'none';
        }

        function closeGalleryOnBackground(event) {
            // Only close if clicking on the modal background, not the content
            if (event.target.id === 'galleryModal') {
                closeGallery(event);
            }
        }

        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('active');
        }

        function togglePath() {
            const showPath = document.getElementById('showPath').checked;
            if (pathPolyline) {
                if (showPath) {
                    map.addLayer(pathPolyline);
                } else {
                    map.removeLayer(pathPolyline);
                }
            }
        }

        function applyFilters() {
            displayPosts();
        }

        function clearTagFilters() {
            document.querySelectorAll('.tag-filter').forEach(checkbox => {
                checkbox.checked = false;
            });
            applyFilters();
        }

        function clearCityFilters() {
            document.querySelectorAll('.city-filter').forEach(checkbox => {
                checkbox.checked = false;
            });
            applyFilters();
        }

        function clearAuthorFilters() {
            document.querySelectorAll('.author-filter').forEach(checkbox => {
                checkbox.checked = false;
            });
            applyFilters();
        }

        function updateAuthorFilters() {
            const container = document.getElementById('authorFilters');
            const authors = [...new Set(posts.filter(p => p.approved).map(p => p.author))];
            
            container.innerHTML = '';
            authors.forEach(author => {
                const authorPosts = posts.filter(p => p.approved && p.author === author);
                const postCount = authorPosts.length;
                
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <label class="checkbox-label">
                        <input type="checkbox" class="author-filter" value="${author}" checked onchange="applyFilters()">
                        <span>${author} <small style="color: #999;">(${postCount})</small></span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function updateCityFilters() {
            const container = document.getElementById('cityFilters');
            
            // Count posts per city
            const cityCounts = {};
            posts.filter(p => p.approved).forEach(post => {
                if (post.location) {
                    cityCounts[post.location] = (cityCounts[post.location] || 0) + 1;
                }
            });
            
            // Sort cities by count
            const sortedCities = Object.keys(cityCounts).sort((a, b) => cityCounts[b] - cityCounts[a]);
            
            container.innerHTML = '';
            if (sortedCities.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: #999; font-size: 0.85rem;">No cities yet</div>';
                return;
            }
            
            sortedCities.forEach(city => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <label class="checkbox-label">
                        <input type="checkbox" class="city-filter" value="${city}" checked onchange="applyFilters()">
                        <span>üìç${city} <small style="color: #999;">(${cityCounts[city]})</small></span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function updateTagFilters() {
            const container = document.getElementById('tagFilters');
            
            // Count posts per tag
            const tagCounts = {};
            posts.filter(p => p.approved).forEach(post => {
                if (post.tags && post.tags.length > 0) {
                    post.tags.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });
            
            // Sort tags by count
            const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
            
            container.innerHTML = '';
            if (sortedTags.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: #999; font-size: 0.85rem;">No tags yet</div>';
                return;
            }
            
            sortedTags.forEach(tag => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <label class="checkbox-label">
                        <input type="checkbox" class="tag-filter" value="${tag}" checked onchange="applyFilters()">
                        <span>#${tag} <small style="color: #999;">(${tagCounts[tag]})</small></span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function updateMediaTypeStats() {
            let totalPhotos = 0;
            let totalVideos = 0;
            
            posts.filter(p => p.approved).forEach(post => {
                if (post.media) {
                    post.media.forEach(m => {
                        if (m.type === 'image') totalPhotos++;
                        else if (m.type === 'video') totalVideos++;
                    });
                }
            });
            
            const container = document.getElementById('mediaTypeStats');
            container.innerHTML = `üì∏ ${totalPhotos} Photos | üé• ${totalVideos} Videos`;
        }

        function showMessage(message, type = 'success') {
            const msgDiv = document.getElementById('successMessage');
            msgDiv.textContent = message;
            msgDiv.style.background = type === 'error' ? '#dc3545' : 'var(--green)';
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 3000);
        }

        // Journey Preview Functions
        let journeyMap;
        let journeyMarkers = [];
        let journeyPath;

        function openJourneyPreview() {
            const modal = document.getElementById('journeyPreviewModal');
            modal.classList.add('active');
            
            setTimeout(() => {
                initializeJourneyMap();
                renderDayNavigation();
                showDayDetails(0);
            }, 100);
        }

        function closeJourneyPreview() {
            const modal = document.getElementById('journeyPreviewModal');
            modal.classList.remove('active');
            
            if (journeyMap) {
                journeyMap.remove();
                journeyMap = null;
            }
        }

        function initializeJourneyMap() {
            if (journeyMap) {
                journeyMap.remove();
            }

            // Initialize map
            journeyMap = L.map('journeyMap').setView([27.7, 84.4], 6);

            // Add default tile layer (streets)
            window.currentTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(journeyMap);

            // Clear previous markers and path
            journeyMarkers = [];

            // Add markers for each day
            itinerary.forEach((day, index) => {
                const customIcon = L.divIcon({
                    html: `<div style="background: ${index === currentPreviewDay ? 'var(--saffron)' : 'var(--navy)'}; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${day.day}</div>`,
                    className: 'custom-day-marker',
                    iconSize: [35, 35]
                });

                const marker = L.marker([day.lat, day.lng], { icon: customIcon })
                    .bindPopup(`
                        <div style="font-family: Poppins; padding: 5px;">
                            <div style="font-weight: 700; font-size: 1rem; color: var(--saffron); margin-bottom: 5px;">Day ${day.day}</div>
                            <div style="font-weight: 600; color: var(--navy);">${day.place}</div>
                            <div style="font-size: 0.85rem; color: #666;">${day.city}, ${day.country}</div>
                            <div style="font-size: 0.85rem; color: var(--green); margin-top: 5px;">${day.date}</div>
                        </div>
                    `)
                    .addTo(journeyMap);

                marker.on('click', () => {
                    showDayDetails(index);
                });

                journeyMarkers.push(marker);
            });

            // Draw path connecting all locations
            const pathCoords = itinerary.map(day => [day.lat, day.lng]);
            journeyPath = L.polyline(pathCoords, {
                color: '#FF9933',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10',
                lineJoin: 'round'
            }).addTo(journeyMap);
            
            // ‚úÖ Fit map to show all itinerary markers
            if (pathCoords.length > 0) {
                const bounds = L.latLngBounds(pathCoords);
                journeyMap.fitBounds(bounds, { padding: [50, 50] });
            }
            
            console.log(`‚úÖ Loaded ${itinerary.length} days on Journey Map`);
        }

        function showDayDetails(index) {
            // Stop any running slideshows
            stopAllAutoplay();
            
            currentPreviewDay = index;
            const day = itinerary[index];

            // Update markers
            updateJourneyMarkers();

            // Center map on selected day
            if (journeyMap) {
                journeyMap.setView([day.lat, day.lng], 10, {
                    animate: true,
                    duration: 1
                });
            }

            // Render day details
            const detailsSection = document.getElementById('journeyDetailsSection');
            const images = day.images && day.images.length > 0 ? day.images : ['https://via.placeholder.com/800x300?text=Sacred+Journey'];

            detailsSection.innerHTML = `
                <div class="day-hero-slider">
                    <div class="slider-container" id="daySliderContainer">
                        ${images.map((img, idx) => `
                            <div class="slider-image ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                                <img src="${img}" alt="${day.place}">
                                <div class="day-hero-overlay">
                                    <div class="day-number">Day ${day.day} of ${itinerary.length}</div>
                                    <div class="day-place-title">${day.place}</div>
                                    <div class="day-date">üìÖ ${day.date}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${images.length > 1 ? `
                        <button class="slider-btn prev-btn" onclick="changeSlide(-1)">‚Äπ</button>
                        <button class="slider-btn next-btn" onclick="changeSlide(1)">‚Ä∫</button>
                        <div class="slider-controls">
                            <button class="slideshow-btn" id="slideshowBtn" onclick="toggleSlideshow()">‚ñ∂Ô∏è Play</button>
                            <div class="slider-dots" id="sliderDots">
                                ${images.map((_, idx) => `
                                    <span class="dot ${idx === 0 ? 'active' : ''}" onclick="goToSlide(${idx})"></span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div class="day-location-card">
                    <div class="location-item">
                        <span class="location-icon">üìç</span>
                        <span>${day.city}, ${day.state || ''} ${day.country}</span>
                    </div>
                    <div class="location-item">
                        <span class="location-icon">üåç</span>
                        <span>Coordinates: ${day.lat.toFixed(4)}¬∞N, ${day.lng.toFixed(4)}¬∞E</span>
                    </div>
                </div>

                ${day.description ? `
                    <div class="day-description">
                        ${escapeHTML(day.description)}
                    </div>
                ` : ''}

                <div class="activities-section">
                    <h2 class="section-title">Daily Schedule</h2>
                    ${day.activities.map((activity, actIdx) => `
                        <div class="activity-item-enhanced" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid var(--saffron);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <div class="activity-time" style="font-size: 0.95rem; color: var(--saffron); font-weight: 600; margin-bottom: 8px;">
                                        üïê ${escapeHTML(activity.time)}
                                    </div>
                                    <div class="activity-text" style="font-size: 1.1rem; font-weight: 600; color: var(--navy); margin-bottom: 8px;">
                                        ${escapeHTML(activity.place || activity.activity)}
                                    </div>
                                    ${activity.description ? `
                                        <div style="color: #666; font-size: 0.95rem; line-height: 1.6; margin-top: 10px;">
                                            ${escapeHTML(activity.description)}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${activity.image ? `
                                <div class="activity-image-container" style="margin-top: 15px;">
                                    <img src="${escapeHTML(activity.image)}" 
                                        alt="${escapeHTML(activity.place || activity.activity)}"
                                        style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                                        onerror="this.style.display='none'">
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                
                ${day.images && day.images.length > 0 ? `
                    <div class="location-images-section" style="margin-top: 30px;">
                        <h2 class="section-title">Location Gallery</h2>
                        <div class="image-slideshow-container" style="position: relative; background: #000; border-radius: 12px; overflow: hidden; max-height: 500px;">
                            <div class="slideshow-images" id="slideshow_day${index}">
                                ${getAllImagesForDay(day).map((img, imgIdx) => `
                                    <img src="${escapeHTML(img)}" 
                                        class="slideshow-slide ${imgIdx === 0 ? 'active' : ''}"
                                        style="width: 100%; height: 500px; object-fit: contain; display: ${imgIdx === 0 ? 'block' : 'none'};"
                                        onerror="this.style.display='none'">
                                `).join('')}
                            </div>
                            
                            ${getAllImagesForDay(day).length > 1 ? `
                                <button class="slideshow-prev" onclick="changeSlide('slideshow_day${index}', -1)" 
                                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; z-index: 10;">
                                    ‚Äπ
                                </button>
                                <button class="slideshow-next" onclick="changeSlide('slideshow_day${index}', 1)" 
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; z-index: 10;">
                                    ‚Ä∫
                                </button>
                                
                                <div class="slideshow-indicators" style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10;">
                                    ${getAllImagesForDay(day).map((_, dotIdx) => `
                                        <span class="slideshow-dot ${dotIdx === 0 ? 'active' : ''}" 
                                            onclick="goToSlide('slideshow_day${index}', ${dotIdx})"
                                            style="width: 12px; height: 12px; border-radius: 50%; background: ${dotIdx === 0 ? 'var(--saffron)' : 'rgba(255,255,255,0.5)'}; cursor: pointer; transition: all 0.3s;">
                                        </span>
                                    `).join('')}
                                </div>
                                
                                <div class="slideshow-counter" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; z-index: 10;">
                                    <span class="current-slide">1</span> / <span class="total-slides">${getAllImagesForDay(day).length}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${getAllImagesForDay(day).length > 1 ? `
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="toggleAutoplay('slideshow_day${index}')" 
                                    class="autoplay-btn"
                                    style="background: var(--green); color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: 600;">
                                    ‚ñ∂ Auto Play
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                ${getTravelInfo(index)}

                <div class="day-navigation">
                    <button class="nav-day-btn" onclick="previousDay()" ${index === 0 ? 'disabled' : ''}>
                        ‚Äπ Previous Day
                    </button>
                    <button class="nav-day-btn" onclick="nextDay()" ${index === itinerary.length - 1 ? 'disabled' : ''}>
                        Next Day ‚Ä∫
                    </button>
                </div>
            `;

            // Initialize slider state
            window.currentSlideIndex = 0;
            window.slideshowInterval = null;

            // Update navigation pills
            updateDayPills();
        }

        // ==================== SLIDESHOW FUNCTIONS ====================
        
        function getAllImagesForDay(day) {
            const allImages = [];
            
            // Add main location images first
            if (day.images && day.images.length > 0) {
                allImages.push(...day.images);
            }
            
            // Add activity-specific images
            if (day.activities) {
                day.activities.forEach(activity => {
                    if (activity.image) {
                        allImages.push(activity.image);
                    }
                });
            }
            
            return allImages;
        }
        
        const slideshowStates = {};
        
        function changeSlide(slideshowId, direction) {
            const container = document.getElementById(slideshowId);
            if (!container) return;
            
            const slides = container.querySelectorAll('.slideshow-slide');
            const dots = container.parentElement.querySelectorAll('.slideshow-dot');
            const counter = container.parentElement.querySelector('.current-slide');
            
            if (slides.length === 0) return;
            
            // Initialize state if not exists
            if (!slideshowStates[slideshowId]) {
                slideshowStates[slideshowId] = { currentIndex: 0, autoplayInterval: null };
            }
            
            const state = slideshowStates[slideshowId];
            
            // Hide current slide
            slides[state.currentIndex].style.display = 'none';
            slides[state.currentIndex].classList.remove('active');
            if (dots[state.currentIndex]) {
                dots[state.currentIndex].classList.remove('active');
                dots[state.currentIndex].style.background = 'rgba(255,255,255,0.5)';
            }
            
            // Calculate new index
            state.currentIndex = (state.currentIndex + direction + slides.length) % slides.length;
            
            // Show new slide
            slides[state.currentIndex].style.display = 'block';
            slides[state.currentIndex].classList.add('active');
            if (dots[state.currentIndex]) {
                dots[state.currentIndex].classList.add('active');
                dots[state.currentIndex].style.background = 'var(--saffron)';
            }
            
            // Update counter
            if (counter) {
                counter.textContent = state.currentIndex + 1;
            }
        }
        
        function goToSlide(slideshowId, index) {
            const container = document.getElementById(slideshowId);
            if (!container) return;
            
            const slides = container.querySelectorAll('.slideshow-slide');
            const dots = container.parentElement.querySelectorAll('.slideshow-dot');
            const counter = container.parentElement.querySelector('.current-slide');
            
            if (!slideshowStates[slideshowId]) {
                slideshowStates[slideshowId] = { currentIndex: 0, autoplayInterval: null };
            }
            
            const state = slideshowStates[slideshowId];
            
            // Hide all slides
            slides.forEach(slide => {
                slide.style.display = 'none';
                slide.classList.remove('active');
            });
            
            dots.forEach(dot => {
                dot.classList.remove('active');
                dot.style.background = 'rgba(255,255,255,0.5)';
            });
            
            // Show selected slide
            state.currentIndex = index;
            slides[index].style.display = 'block';
            slides[index].classList.add('active');
            
            if (dots[index]) {
                dots[index].classList.add('active');
                dots[index].style.background = 'var(--saffron)';
            }
            
            if (counter) {
                counter.textContent = index + 1;
            }
        }
        
        function toggleAutoplay(slideshowId) {
            if (!slideshowStates[slideshowId]) {
                slideshowStates[slideshowId] = { currentIndex: 0, autoplayInterval: null };
            }
            
            const state = slideshowStates[slideshowId];
            const btn = event.target;
            
            if (state.autoplayInterval) {
                // Stop autoplay
                clearInterval(state.autoplayInterval);
                state.autoplayInterval = null;
                btn.innerHTML = '‚ñ∂ Auto Play';
                btn.style.background = 'var(--green)';
            } else {
                // Start autoplay
                state.autoplayInterval = setInterval(() => {
                    changeSlide(slideshowId, 1);
                }, 3000);
                btn.innerHTML = '‚è∏ Pause';
                btn.style.background = '#dc3545';
            }
        }
        
        // Stop all autoplay when changing days
        function stopAllAutoplay() {
            Object.keys(slideshowStates).forEach(slideshowId => {
                if (slideshowStates[slideshowId].autoplayInterval) {
                    clearInterval(slideshowStates[slideshowId].autoplayInterval);
                    slideshowStates[slideshowId].autoplayInterval = null;
                }
            });
        }
        
        // ==================== END SLIDESHOW FUNCTIONS ====================

        function getTravelInfo(index) {
            if (index === 0) return '';
            
            const currentDay = itinerary[index];
            const prevDay = itinerary[index - 1];
            
            return `
                <div class="activities-section">
                    <h2 class="section-title">Travel Information</h2>
                    <div style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB); padding: 20px; border-radius: 12px; border-left: 5px solid #2196F3;">
                        <div style="font-weight: 600; margin-bottom: 10px;">üöó From ${prevDay.city} to ${currentDay.city}</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div>
                                <div style="font-size: 0.85rem; color: #666;">Previous Stop</div>
                                <div style="font-weight: 600;">${prevDay.place}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #666;">Current Stop</div>
                                <div style="font-weight: 600;">${currentDay.place}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateJourneyMarkers() {
            journeyMarkers.forEach((marker, index) => {
                const isActive = index === currentPreviewDay;
                const customIcon = L.divIcon({
                    html: `<div style="background: ${isActive ? 'var(--saffron)' : 'var(--navy)'}; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transform: ${isActive ? 'scale(1.3)' : 'scale(1)'};">${itinerary[index].day}</div>`,
                    className: 'custom-day-marker',
                    iconSize: [35, 35]
                });
                marker.setIcon(customIcon);
            });
        }

        function renderDayNavigation() {
            const navPills = document.getElementById('journeyNavPills');
            navPills.innerHTML = itinerary.map((day, index) => `
                <div class="day-pill ${index === currentPreviewDay ? 'active' : ''}" onclick="showDayDetails(${index})">
                    ${day.day}
                </div>
            `).join('');
        }

        function updateDayPills() {
            const pills = document.querySelectorAll('.day-pill');
            pills.forEach((pill, index) => {
                if (index === currentPreviewDay) {
                    pill.classList.add('active');
                    pill.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    pill.classList.remove('active');
                }
            });
        }

        function previousDay() {
            if (currentPreviewDay > 0) {
                showDayDetails(currentPreviewDay - 1);
            }
        }

        function nextDay() {
            if (currentPreviewDay < itinerary.length - 1) {
                showDayDetails(currentPreviewDay + 1);
            }
        }

        function scrollPillsLeft() {
            if (currentPreviewDay > 0) {
                showDayDetails(currentPreviewDay - 1);
            }
        }

        function scrollPillsRight() {
            if (currentPreviewDay < itinerary.length - 1) {
                showDayDetails(currentPreviewDay + 1);
            }
        }

        function showFullRoute() {
            if (journeyMap && journeyPath) {
                journeyMap.fitBounds(journeyPath.getBounds(), {
                    padding: [50, 50],
                    animate: true,
                    duration: 1
                });
            }
        }

        function zoomToCurrentDay() {
            if (journeyMap) {
                const day = itinerary[currentPreviewDay];
                journeyMap.setView([day.lat, day.lng], 12, {
                    animate: true,
                    duration: 1
                });
            }
        }

        function changeMapView(viewType) {
            if (!journeyMap || !window.currentTileLayer) return;

            // Remove current tile layer
            journeyMap.removeLayer(window.currentTileLayer);

            // Define tile layer options
            const tileLayers = {
                streets: {
                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    attribution: '¬© OpenStreetMap contributors'
                },
                satellite: {
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attribution: '¬© Esri'
                },
                terrain: {
                    url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                    attribution: '¬© OpenTopoMap contributors'
                }
            };

            // Add new tile layer
            const selectedLayer = tileLayers[viewType] || tileLayers.streets;
            window.currentTileLayer = L.tileLayer(selectedLayer.url, {
                attribution: selectedLayer.attribution,
                maxZoom: 18
            }).addTo(journeyMap);
            
            // Close the menu after selection
            document.getElementById('mapLayersMenu').style.display = 'none';
        }

        function toggleMapLayersMenu() {
            const menu = document.getElementById('mapLayersMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('mapLayersMenu');
            const button = event.target.closest('.map-control-btn');
            if (menu && menu.style.display === 'block' && !menu.contains(event.target) && (!button || button.textContent.indexOf('Layers') === -1)) {
                menu.style.display = 'none';
            }
        });


        function changeSlide(direction) {
            const slides = document.querySelectorAll('.slider-image');
            const dots = document.querySelectorAll('.slider-dots .dot');
            
            if (slides.length === 0) return;
            
            // Stop slideshow when manually changing
            if (window.slideshowInterval) {
                clearInterval(window.slideshowInterval);
                window.slideshowInterval = null;
                const btn = document.getElementById('slideshowBtn');
                if (btn) btn.textContent = '‚ñ∂Ô∏è Play';
            }
            
            slides[window.currentSlideIndex].classList.remove('active');
            dots[window.currentSlideIndex].classList.remove('active');
            
            window.currentSlideIndex += direction;
            
            if (window.currentSlideIndex >= slides.length) {
                window.currentSlideIndex = 0;
            } else if (window.currentSlideIndex < 0) {
                window.currentSlideIndex = slides.length - 1;
            }
            
            slides[window.currentSlideIndex].classList.add('active');
            dots[window.currentSlideIndex].classList.add('active');
        }

        function goToSlide(index) {
            const slides = document.querySelectorAll('.slider-image');
            const dots = document.querySelectorAll('.slider-dots .dot');
            
            if (slides.length === 0) return;
            
            // Stop slideshow
            if (window.slideshowInterval) {
                clearInterval(window.slideshowInterval);
                window.slideshowInterval = null;
                const btn = document.getElementById('slideshowBtn');
                if (btn) btn.textContent = '‚ñ∂Ô∏è Play';
            }
            
            slides[window.currentSlideIndex].classList.remove('active');
            dots[window.currentSlideIndex].classList.remove('active');
            
            window.currentSlideIndex = index;
            
            slides[window.currentSlideIndex].classList.add('active');
            dots[window.currentSlideIndex].classList.add('active');
        }

        function toggleSlideshow() {
            const btn = document.getElementById('slideshowBtn');
            
            if (window.slideshowInterval) {
                // Stop slideshow
                clearInterval(window.slideshowInterval);
                window.slideshowInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Play';
            } else {
                // Start slideshow
                btn.textContent = '‚è∏Ô∏è Pause';
                window.slideshowInterval = setInterval(() => {
                    changeSlide(1);
                }, 3000); // Change every 3 seconds
            }
        }

        function toggleMapFullscreen() {
            const mapSection = document.querySelector('.journey-map-section');
            const detailsSection = document.querySelector('.journey-details-section');
            const navPills = document.querySelector('.journey-nav-pills');
            const btn = event.target;
            
            if (mapSection.classList.contains('fullscreen')) {
                // Exit fullscreen
                mapSection.classList.remove('fullscreen');
                detailsSection.style.display = 'block';
                navPills.style.display = 'flex';
                btn.textContent = 'üì∫ Fullscreen';
            } else {
                // Enter fullscreen
                mapSection.classList.add('fullscreen');
                detailsSection.style.display = 'none';
                navPills.style.display = 'none';
                btn.textContent = 'üì∫ Exit Fullscreen';
            }
            
            // Invalidate map size after transition
            setTimeout(() => {
                if (journeyMap) {
                    journeyMap.invalidateSize();
                }
            }, 350);
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
        // Wake-Up Alarm System
        let dismissedAlarms = new Set(); // Track dismissed alarms by time
        
        function checkWakeUpAlarm() {
            // Check every minute
            setInterval(() => {
                const alarmData = JSON.parse(localStorage.getItem('wakeUpAlarm') || '{}');
                
                if (!alarmData.enabled && !alarmData.test) return;
                
                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 5);
                
                // Check if alarm was already dismissed for this minute
                if (dismissedAlarms.has(currentTime)) {
                    return;
                }
                
                // Check if it's time to ring the alarm or if it's a test
                if (alarmData.test || currentTime === alarmData.time) {
                    ringAlarm(alarmData.message, currentTime);
                    
                    // Clear test flag
                    if (alarmData.test) {
                        delete alarmData.test;
                        localStorage.setItem('wakeUpAlarm', JSON.stringify(alarmData));
                    }
                }
            }, 10000); // Check every 10 seconds for better accuracy
        }

        function ringAlarm(message, currentTime) {
            // Don't ring if already dismissed for this minute
            if (dismissedAlarms.has(currentTime)) return;
            
            // Create alarm modal
            const alarmModal = document.createElement('div');
            alarmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; display: flex; align-items: center; justify-content: center; animation: pulse 1s infinite;';
            
            alarmModal.innerHTML = `
                <div style="background: linear-gradient(135deg, #FF9933, #138808); padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; animation: shake 0.5s infinite;">
                    <div style="font-size: 5rem; margin-bottom: 20px;">‚è∞</div>
                    <h1 style="color: white; font-size: 2rem; margin-bottom: 20px;">WAKE UP!</h1>
                    <p style="color: white; font-size: 1.2rem; margin-bottom: 30px;">${message}</p>
                    <button onclick="dismissAlarm('${currentTime}')" style="background: white; color: var(--navy); border: none; padding: 15px 40px; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        DISMISS ALARM
                    </button>
                </div>
            `;
            
            // Add shake animation
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-10px); }
                    75% { transform: translateX(10px); }
                }
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.8; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(alarmModal);
            alarmModal.id = 'wakeUpAlarmModal';
            
            // Play alarm sound (using audio API)
            playAlarmSound();
        }

        function playAlarmSound() {
            // Create an oscillator for alarm sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            
            oscillator.start();
            
            // Beep pattern
            let beepCount = 0;
            const beepInterval = setInterval(() => {
                if (beepCount < 10) {
                    oscillator.frequency.value = beepCount % 2 === 0 ? 800 : 1000;
                    beepCount++;
                } else {
                    oscillator.stop();
                    clearInterval(beepInterval);
                    
                    // Repeat if alarm not dismissed
                    if (document.getElementById('wakeUpAlarmModal')) {
                        setTimeout(() => playAlarmSound(), 1000);
                    }
                }
            }, 200);
        }

        function dismissAlarm(currentTime) {
            const alarmModal = document.getElementById('wakeUpAlarmModal');
            if (alarmModal) {
                alarmModal.remove();
            }
            
            // Mark this minute as dismissed
            if (currentTime) {
                dismissedAlarms.add(currentTime);
                console.log(`‚úÖ Alarm dismissed for ${currentTime}. Won't ring again this minute.`);
            }
        }

        // ==================== NEW FEATURES FUNCTIONS ====================

        // ===== HEADER TOGGLE =====
        let headerVisible = true;

        function toggleHeader() {
            const headerBanner = document.querySelector('.header-banner');
            const journeyStrip = document.querySelector('.journey-strip');
            const map = document.getElementById('map');
            const toggleBtn = document.querySelector('.header-toggle-btn');
            
            headerVisible = !headerVisible;
            
            if (headerVisible) {
                // Show header
                headerBanner.classList.remove('hidden');
                journeyStrip.classList.remove('hidden');
                map.classList.remove('expanded');
                toggleBtn.innerHTML = '‚¨ÜÔ∏è';
                toggleBtn.title = 'Hide Header';
            } else {
                // Hide header
                headerBanner.classList.add('hidden');
                journeyStrip.classList.add('hidden');
                map.classList.add('expanded');
                toggleBtn.innerHTML = '‚¨áÔ∏è';
                toggleBtn.title = 'Show Header';
            }
            
            // Invalidate map size after transition
            setTimeout(() => {
                if (map && typeof map.invalidateSize === 'function') {
                    map.invalidateSize();
                }
            }, 350);
        }

        // ===== CHECK-IN SYSTEM =====
        let checkInData = JSON.parse(localStorage.getItem('checkInData') || '{}');
        let checkInSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+zO7DdCkBGm7A7dWKNQcZXrTp66hVFApGnOH0u3QoAh1+');
        
        function loadCheckInData() {
            checkInData = JSON.parse(localStorage.getItem('checkInData') || '{}');
            checkCheckInStatus();
        }
        
        function checkCheckInStatus() {
            if (!currentUser || !currentUser.email) return;
            
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const currentTraveler = travelers.find(t => t.email === currentUser.email);
            
            if (!currentTraveler || !currentTraveler.vehicleId) {
                document.getElementById('checkInFab').style.display = 'none';
                return;
            }
            
            const vehicleCheckIn = checkInData[currentTraveler.vehicleId];
            const checkInFab = document.getElementById('checkInFab');
            
            if (vehicleCheckIn && vehicleCheckIn.active && !vehicleCheckIn.checkedIn.includes(currentUser.email)) {
                checkInFab.style.display = 'flex';
                // Play notification sound when check-in becomes available
                if (vehicleCheckIn.timestamp) {
                    const timeDiff = Date.now() - new Date(vehicleCheckIn.timestamp).getTime();
                    if (timeDiff < 5000) { // Within 5 seconds of activation
                        checkInSound.play().catch(e => console.log('Sound play failed:', e));
                    }
                }
            } else {
                checkInFab.style.display = 'none';
            }
        }
        
        function openCheckInModal() {
            if (!currentUser || !currentUser.email) {
                showMessage('Please login first', 'error');
                return;
            }
            
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const currentTraveler = travelers.find(t => t.email === currentUser.email);
            
            if (!currentTraveler) {
                showMessage('Traveler information not found', 'error');
                return;
            }
            
            const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const activeVehicles = vehicles.filter(v => v.status === 'Active');
            
            // Get vehicle allotments for today
            const vehicleAllotments = JSON.parse(localStorage.getItem('vehicleAllotments') || '{}');
            const today = new Date().toISOString().split('T')[0];
            const todayAllotments = vehicleAllotments[today] || {};
            
            // Find allocated vehicle for today
            let allocatedVehicleId = null;
            if (todayAllotments[currentTraveler.id]) {
                allocatedVehicleId = todayAllotments[currentTraveler.id].vehicleId;
            } else if (currentTraveler.vehicleId) {
                // Fallback to permanent vehicle assignment
                allocatedVehicleId = currentTraveler.vehicleId;
            }
            
            const allocatedVehicle = vehicles.find(v => v.id == allocatedVehicleId);
            
            const content = document.getElementById('checkInContent');
            content.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">üöå</div>
                <h2 style="color: var(--navy); margin-bottom: 10px;">Vehicle Check-In</h2>
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Passenger:</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--navy);">${currentUser.name}</div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 10px;">
                        üöê Select Vehicle
                    </label>
                    ${allocatedVehicle ? `
                        <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ff9800;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: #ff9800; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">ALLOCATED</span>
                                <span style="font-weight: 600; color: var(--navy);">${allocatedVehicle.name}</span>
                            </div>
                        </div>
                    ` : ''}
                    <select id="checkInVehicleSelect" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; font-weight: 600;">
                        ${activeVehicles.length > 0 ? activeVehicles.map(v => `
                            <option value="${v.id}" ${v.id == allocatedVehicleId ? 'selected' : ''}>
                                ${v.name} (${v.type} - ${v.capacity} seats)${v.id == allocatedVehicleId ? ' ‚≠ê Allocated' : ''}
                            </option>
                        `).join('') : '<option value="">No active vehicles available</option>'}
                    </select>
                    <small style="color: #666; display: block; margin-top: 8px;">
                        ${allocatedVehicle ? '‚úÖ Your allocated vehicle is pre-selected' : '‚ö†Ô∏è No vehicle allocated for today'}
                    </small>
                </div>
                
                <button onclick="performCheckIn()" ${activeVehicles.length === 0 ? 'disabled' : ''} style="
                    padding: 15px 40px;
                    background: ${activeVehicles.length > 0 ? 'linear-gradient(135deg, #4caf50, #8bc34a)' : '#ccc'};
                    color: white;
                    border: none;
                    border-radius: 25px;
                    font-size: 1.2rem;
                    font-weight: 600;
                    cursor: ${activeVehicles.length > 0 ? 'pointer' : 'not-allowed'};
                    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                    transition: all 0.3s ease;
                    width: 100%;
                " onmouseover="if(!this.disabled) this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    ‚úÖ Check In Now
                </button>
            `;
            
            document.getElementById('checkInModal').style.display = 'block';
        }
        
        function closeCheckInModal() {
            document.getElementById('checkInModal').style.display = 'none';
        }
        
        function performCheckIn() {
            if (!currentUser || !currentUser.email) return;
            
            const selectedVehicleId = document.getElementById('checkInVehicleSelect')?.value;
            
            if (!selectedVehicleId) {
                showMessage('Please select a vehicle', 'error');
                return;
            }
            
            if (!checkInData[selectedVehicleId]) {
                checkInData[selectedVehicleId] = { active: true, checkedIn: [], timestamp: new Date().toISOString() };
            }
            
            if (!checkInData[selectedVehicleId].checkedIn.includes(currentUser.email)) {
                checkInData[selectedVehicleId].checkedIn.push(currentUser.email);
                localStorage.setItem('checkInData', JSON.stringify(checkInData));
                
                const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
                const vehicle = vehicles.find(v => v.id == selectedVehicleId);
                
                showMessage(`‚úÖ Checked in to ${vehicle?.name || 'vehicle'} successfully!`, 'success');
                closeCheckInModal();
                checkCheckInStatus();
            } else {
                showMessage('You have already checked in to this vehicle', 'info');
            }
        }
        
        function clearGroupLeaderCheckIns() {
            if (!currentUser || !currentUser.email) return;
            
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const currentTraveler = travelers.find(t => t.email === currentUser.email);
            
            if (!currentTraveler || !currentTraveler.vehicleId) return;
            
            // Check if user is a group leader
            const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const vehicle = vehicles.find(v => v.id == currentTraveler.vehicleId);
            
            if (!vehicle || vehicle.groupLeaderEmail !== currentUser.email) {
                showMessage('Only group leaders can clear check-ins', 'error');
                return;
            }
            
            if (confirm('Clear all check-ins for your vehicle? This will reset the check-in list.')) {
                const checkInData = JSON.parse(localStorage.getItem('checkInData') || '{}');
                
                if (checkInData[currentTraveler.vehicleId]) {
                    checkInData[currentTraveler.vehicleId] = {
                        active: true,
                        checkedIn: [],
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('checkInData', JSON.stringify(checkInData));
                    
                    showMessage('‚úÖ All check-ins cleared successfully!');
                    loadCheckInList(); // Refresh the list
                } else {
                    showMessage('No check-ins to clear', 'info');
                }
            }
        }
        
        // Monitor check-in status changes
        setInterval(() => {
            if (currentUser) {
                const newCheckInData = JSON.parse(localStorage.getItem('checkInData') || '{}');
                const oldData = JSON.stringify(checkInData);
                const newData = JSON.stringify(newCheckInData);
                
                if (oldData !== newData) {
                    checkInData = newCheckInData;
                    checkCheckInStatus();
                    
                    // Refresh check-in list if modal is open
                    const checkInListModal = document.getElementById('checkInListModal');
                    if (checkInListModal && checkInListModal.style.display === 'block') {
                        loadCheckInList();
                    }
                }
            }
        }, 2000); // Check every 2 seconds

        // ==================== HOTEL DETAILS FOR TRAVELERS ====================
        
        function openHotelDetailsModal() {
            if (!currentUser) {
                showMessage('Please login to view hotel details', 'error');
                return;
            }
            
            document.getElementById('hotelDetailsModal').style.display = 'block';
            loadTravelerHotelDetails();
        }
        
        function closeHotelDetailsModal() {
            document.getElementById('hotelDetailsModal').style.display = 'none';
        }
        
        function loadTravelerHotelDetails() {
            const container = document.getElementById('hotelDetailsContent');
            const hotels = JSON.parse(localStorage.getItem('hotels') || '[]');
            const hotelAllotments = JSON.parse(localStorage.getItem('hotelAllotments') || '{}');
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            
            const currentTraveler = travelers.find(t => t.email === currentUser.email);
            
            if (!currentTraveler) {
                container.innerHTML = '<div style="text-align: center; color: #666;">Traveler details not found</div>';
                return;
            }
            
            // Find all allotments for this traveler
            const travelerAllotments = [];
            
            Object.keys(hotelAllotments).forEach(key => {
                const [hotelId, date] = key.split('-');
                const allotments = hotelAllotments[key];
                
                if (allotments[currentTraveler.id]) {
                    const hotel = hotels.find(h => h.id == hotelId);
                    if (hotel) {
                        travelerAllotments.push({
                            hotel: hotel,
                            date: date,
                            floor: allotments[currentTraveler.id].floor,
                            room: allotments[currentTraveler.id].room
                        });
                    }
                }
            });
            
            if (travelerAllotments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üè®</div>
                        <div style="color: #666; margin-bottom: 10px;">No hotel rooms assigned yet</div>
                        <div style="font-size: 0.9rem; color: #999;">Room assignments will be updated by the admin</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date
            travelerAllotments.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            travelerAllotments.forEach(allotment => {
                const date = new Date(allotment.date);
                const formattedDate = date.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                html += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--saffron);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="font-size: 1.5rem;">üè®</div>
                            <div>
                                <div style="font-weight: 600; color: var(--navy); font-size: 1.1rem;">${allotment.hotel.name}</div>
                                <div style="font-size: 0.85rem; color: #666;">${allotment.hotel.location}</div>
                            </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 15px; margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                                <div>
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">üìÖ Date</div>
                                    <div style="font-weight: 600; color: var(--navy);">${formattedDate}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">üè¢ Floor</div>
                                    <div style="font-weight: 600; color: var(--saffron); font-size: 1.2rem;">${allotment.floor || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">üö™ Room</div>
                                    <div style="font-weight: 600; color: var(--green); font-size: 1.2rem;">${allotment.room || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        ${getRoommatesHTML(allotment.hotel.id, allotment.date, allotment.floor, allotment.room)}
                        ${allotment.hotel.address ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                <div style="font-size: 0.85rem; color: #666;">
                                    üìç ${allotment.hotel.address}
                                </div>
                            </div>
                        ` : ''}
                        ${allotment.hotel.contact ? `
                            <div style="margin-top: 5px;">
                                <div style="font-size: 0.85rem; color: #666;">
                                    üìû ${allotment.hotel.contact}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Get roommates HTML - show who is sharing the room
        function getRoommatesHTML(hotelId, date, floor, room) {
            if (!floor || !room) return '';
            
            const hotelAllotments = JSON.parse(localStorage.getItem('hotelAllotments') || '{}');
            const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const key = `${hotelId}-${date}`;
            const allotments = hotelAllotments[key] || {};
            
            // Find all travelers in the same room
            const roommates = [];
            Object.keys(allotments).forEach(travelerId => {
                const allotment = allotments[travelerId];
                if (allotment.floor === floor && allotment.room === room) {
                    const traveler = travelers.find(t => t.id == travelerId);
                    if (traveler && traveler.email !== currentUser.email) {
                        roommates.push(traveler);
                    }
                }
            });
            
            // Get pair information if available
            const roomPairs = JSON.parse(localStorage.getItem('roomPairs') || '[]');
            const travelers_all = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
            const currentTraveler = travelers_all.find(t => t.email === currentUser.email);
            
            let pairNo = null;
            let companionNames = [];
            if (currentTraveler) {
                const pair = roomPairs.find(p => p.travelerIds.includes(currentTraveler.id));
                if (pair) {
                    pairNo = pair.pairNo;
                    // Get companion names from pair (exclude current user)
                    companionNames = pair.travelerIds
                        .filter(id => id !== currentTraveler.id)
                        .map(id => {
                            const t = travelers_all.find(tr => tr.id === id);
                            return t ? t.name : '';
                        })
                        .filter(name => name !== '');
                }
            }
            
            const roomStatus = roommates.length === 0 ? 'Single occupancy' : 'Shared';
            
            return `
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffc107;">
                    <div style="font-size: 0.85rem; color: #856404;">
                        üõèÔ∏è <strong>Room Status:</strong> ${roomStatus}
                    </div>
                    ${companionNames.length > 0 ? `
                        <div style="font-size: 0.85rem; color: #856404; margin-top: 8px;">
                            üë• <strong>Companion Names:</strong> ${companionNames.join(', ')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ‚úÖ Monitor posts for real-time updates (admin posts & approvals)
        let lastPostCheck = Date.now();
        setInterval(() => {
            const newPosts = JSON.parse(localStorage.getItem('posts') || '[]');
            const oldPostsCount = posts.length;
            const newPostsCount = newPosts.length;
            
            // Check if new posts added or posts approved
            if (newPostsCount > oldPostsCount || JSON.stringify(posts) !== JSON.stringify(newPosts)) {
                const previousPosts = [...posts];
                posts = newPosts;
                
                console.log(`üìä Posts updated: ${oldPostsCount} ‚Üí ${newPostsCount}`);
                
                // Find newly approved or created posts
                newPosts.forEach(newPost => {
                    const oldPost = previousPosts.find(p => p.id === newPost.id);
                    
                    if (!oldPost && newPost.approved) {
                        // New approved post (admin post)
                        console.log('üÜï New post detected:', newPost.place);
                        showLiveNotification(newPost, 'new');
                    } else if (oldPost && !oldPost.approved && newPost.approved) {
                        // Post just got approved
                        console.log('‚úÖ Post approved:', newPost.place);
                        showLiveNotification(newPost, 'approved');
                    }
                });
                
                // Refresh map with new posts (only if map is initialized)
                if (markerClusterGroup && typeof displayPosts === 'function') {
                    displayPosts();
                    console.log('üó∫Ô∏è Map refreshed with new posts');
                } else {
                    console.log('‚è≥ Map not ready yet, posts will load when map opens');
                }
            }
        }, 3000); // Check every 3 seconds

        // ‚úÖ Monitor vehicle locations for real-time updates
        setInterval(() => {
            const newVehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const newGroupLeaderLocations = JSON.parse(localStorage.getItem('groupLeaderLocations') || '{}');
            
            // Check if vehicles data changed
            if (JSON.stringify(vehicles) !== JSON.stringify(newVehicles)) {
                vehicles = newVehicles;
                console.log('üöå Vehicles data updated');
                if (typeof map !== 'undefined' && map) {
                    displayVehicles();
                }
            }
            
            // Check if group leader locations changed
            if (JSON.stringify(groupLeaderLocations) !== JSON.stringify(newGroupLeaderLocations)) {
                groupLeaderLocations = newGroupLeaderLocations;
                console.log('üìç Group leader locations updated');
                if (typeof map !== 'undefined' && map) {
                    displayVehicles();
                }
            }
        }, 2000); // Check every 2 seconds for live tracking

        function showLiveNotification(post, type) {
            const firstMedia = post.media && post.media.length > 0 ? post.media[0] : null;
            const mediaUrl = firstMedia ? firstMedia.url : 'https://via.placeholder.com/80';
            const isVideo = firstMedia && firstMedia.type === 'video';
            
            const message = type === 'new' 
                ? `üìç New post by ${post.author}: ${post.place}` 
                : `‚úÖ Post approved: ${post.place} by ${post.author}`;
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                min-width: 300px;
                max-width: 400px;
                animation: slideInRight 0.5s ease;
                display: flex;
                gap: 15px;
                align-items: center;
                border-left: 4px solid ${type === 'new' ? '#4caf50' : '#ff9800'};
            `;
            
            notification.innerHTML = `
                <div style="flex-shrink: 0;">
                    ${isVideo ? 
                        `<video src="${mediaUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" muted></video>` :
                        `<img src="${mediaUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">`
                    }
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--navy); margin-bottom: 5px;">${message}</div>
                    <div style="font-size: 0.85rem; color: #666;">üìç ${post.location}</div>
                </div>
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #999;">‚úï</button>
            `;
            
            document.body.appendChild(notification);
            
            // Play notification sound
            if (typeof checkInSound !== 'undefined') {
                checkInSound.play().catch(() => {});
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Add CSS animation for notification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        // ===== ACTIONS MENU =====
        function toggleActionsMenu() {
            const menu = document.getElementById('actionsMenuPopup');
            menu.classList.toggle('active');
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            const actionsMenu = document.getElementById('actionsMenuPopup');
            const actionsBtn = event.target.closest('.fab-actions-menu');
            
            // Close actions menu if clicking outside
            if (actionsMenu && actionsMenu.classList.contains('active') && 
                !actionsMenu.contains(event.target) && !actionsBtn) {
                actionsMenu.classList.remove('active');
            }
        });

        // Update UI based on login status
        function updateUIForLoginStatus() {
            const loginFab = document.getElementById('loginFab');
            const myProfileMenuItem = document.getElementById('myProfileMenuItem');
            const myHotelMenuItem = document.getElementById('myHotelMenuItem');
            const checkInListMenuItem = document.getElementById('checkInListMenuItem');
            const viewProfilesMenuItem = document.getElementById('viewProfilesMenuItem');
            const userNameStrip = document.getElementById('userNameStrip');
            const userNameDisplay = document.getElementById('userNameDisplay');
            
            if (currentUser) {
                // Hide login button
                if (loginFab) loginFab.style.display = 'none';
                
                // Show View Profiles (only for logged-in users)
                if (viewProfilesMenuItem) viewProfilesMenuItem.style.display = 'flex';
                
                // Show My Profile in menu
                if (myProfileMenuItem) myProfileMenuItem.style.display = 'flex';
                
                // Show My Hotel / Room in menu
                if (myHotelMenuItem) myHotelMenuItem.style.display = 'flex';
                
                // Show Check-In List if user has vehicle assigned
                const travelers = JSON.parse(localStorage.getItem('authorizedTravelers') || '[]');
                const currentTraveler = travelers.find(t => t.email === currentUser.email);
                if (checkInListMenuItem && currentTraveler && currentTraveler.vehicleId) {
                    checkInListMenuItem.style.display = 'flex';
                } else if (checkInListMenuItem) {
                    checkInListMenuItem.style.display = 'none';
                }
                
                // Show user name strip
                if (userNameStrip && userNameDisplay) {
                    const firstName = currentUser.name.split(' ')[0];
                    userNameDisplay.textContent = firstName;
                    userNameStrip.classList.add('show');
                }
            } else {
                // Show login button
                if (loginFab) loginFab.style.display = 'flex';
                
                // Hide View Profiles (only for logged-in users)
                if (viewProfilesMenuItem) viewProfilesMenuItem.style.display = 'none';
                
                // Hide My Profile in menu
                if (myProfileMenuItem) myProfileMenuItem.style.display = 'none';
                
                // Hide My Hotel / Room in menu
                if (myHotelMenuItem) myHotelMenuItem.style.display = 'none';
                
                // Hide Check-In List in menu
                if (checkInListMenuItem) checkInListMenuItem.style.display = 'none';
                
                // Hide user name strip
                if (userNameStrip) userNameStrip.classList.remove('show');
            }
        }

        // Call updateUIForLoginStatus on page load and after login/logout
        window.addEventListener('load', () => {
            updateUIForLoginStatus();
            loadCheckInData();
        });

        // ===== 1. PUSH NOTIFICATIONS =====
        let notificationPermissionGranted = false;

        // Check notification permission on load
        window.addEventListener('load', () => {
            checkNotificationPermission();
            checkWakeUpAlarm();
        });

        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationPermissionGranted = true;
                } else if (Notification.permission === 'default') {
                    // Show banner after 5 seconds
                    setTimeout(() => {
                        const banner = document.getElementById('notificationBanner');
                        if (banner && !localStorage.getItem('notificationBannerDismissed')) {
                            banner.classList.add('show');
                        }
                    }, 5000);
                }
            }
        }

        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationPermissionGranted = true;
                    showMessage('üîî Notifications enabled! You\'ll receive updates for new posts.');
                    dismissNotificationBanner();
                    
                    // Send a test notification
                    new Notification('Yatra Updates Enabled!', {
                        body: 'You will now receive notifications for new posts and journey updates.',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FF9933"/></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FF9933"/></svg>'
                    });
                } else {
                    showMessage('‚ö†Ô∏è Notification permission denied. You can enable it later in browser settings.');
                }
            } catch (error) {
                console.error('Notification permission error:', error);
            }
        }

        function dismissNotificationBanner() {
            const banner = document.getElementById('notificationBanner');
            if (banner) {
                banner.classList.remove('show');
                localStorage.setItem('notificationBannerDismissed', 'true');
            }
        }

        function sendPushNotification(title, body, icon) {
            if (notificationPermissionGranted && 'Notification' in window) {
                new Notification(title, {
                    body: body,
                    icon: icon || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FF9933"/></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FF9933"/></svg>',
                    requireInteraction: false
                });
            }
        }

        // Listen for new posts (called when post is added)
        function notifyNewPost(post) {
            if (notificationPermissionGranted) {
                sendPushNotification(
                    '‚ú® New Post from ' + post.author,
                    post.place + ' - ' + post.description.substring(0, 100),
                    post.media && post.media.length > 0 ? post.media[0].data : null
                );
            }
        }

        // ===== 2. SHARE POSTS TO SOCIAL MEDIA =====
        function addShareButtonsToPopup(post, popupElement) {
            const shareHTML = `
                <div class="share-buttons">
                    <button class="share-btn share-facebook" onclick='shareToFacebook(${JSON.stringify(post).replace(/'/g, "&#39;")})' title="Share on Facebook">
                        üìò Facebook
                    </button>
                    <button class="share-btn share-twitter" onclick='shareToTwitter(${JSON.stringify(post).replace(/'/g, "&#39;")})' title="Share on Twitter">
                        üê¶ Twitter
                    </button>
                    <button class="share-btn share-whatsapp" onclick='shareToWhatsApp(${JSON.stringify(post).replace(/'/g, "&#39;")})' title="Share on WhatsApp">
                        üí¨ WhatsApp
                    </button>
                    <button class="share-btn share-linkedin" onclick='shareToLinkedIn(${JSON.stringify(post).replace(/'/g, "&#39;")})' title="Share on LinkedIn">
                        üíº LinkedIn
                    </button>
                    <button class="share-btn share-copy" onclick="copyPostLink(${post.id})" title="Copy Link">
                        üîó Copy Link
                    </button>
                </div>
            `;
            return shareHTML;
        }

        function shareToFacebook(post) {
            const url = encodeURIComponent(window.location.href + '?post=' + post.id);
            const text = encodeURIComponent(post.place + ' - ' + post.description.substring(0, 100));
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank', 'width=600,height=400');
        }

        function shareToTwitter(post) {
            const url = encodeURIComponent(window.location.href + '?post=' + post.id);
            const text = encodeURIComponent('üôè ' + post.place + ' - ' + post.description.substring(0, 150) + '... #SpiritualYatra');
            window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
        }

        function shareToWhatsApp(post) {
            const url = encodeURIComponent(window.location.href + '?post=' + post.id);
            const text = encodeURIComponent('üôè *' + post.place + '*\n\n' + post.description.substring(0, 200) + '...\n\nView more: ');
            window.open(`https://wa.me/?text=${text}${url}`, '_blank');
        }

        function shareToLinkedIn(post) {
            const url = encodeURIComponent(window.location.href + '?post=' + post.id);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=600,height=400');
        }

        function copyPostLink(postId) {
            const link = window.location.href + '?post=' + postId;
            navigator.clipboard.writeText(link).then(() => {
                showMessage('üîó Link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy link:', err);
                showMessage('‚ùå Failed to copy link');
            });
        }

        // ===== 3. DAILY JOURNAL ENTRIES =====
        // Personal Journals - stored per user email
        let personalJournals = JSON.parse(localStorage.getItem('personalJournals') || '{}');
        let journalEntries = []; // Current user's entries (loaded on login)

        function openJournalModal() {
            // Require login for personal journal
            if (!currentUser || !currentUser.email) {
                showMessage('Please login to access your personal journal', 'error');
                return;
            }
            
            // Load current user's personal journal entries
            journalEntries = personalJournals[currentUser.email] || [];
            
            document.getElementById('journalModal').style.display = 'block';
            showJournalList();
        }

        function closeJournalModal() {
            document.getElementById('journalModal').style.display = 'none';
            document.getElementById('journalForm').style.display = 'none';
            document.getElementById('journalList').style.display = 'none';
        }

        function showJournalForm() {
            document.getElementById('journalForm').style.display = 'block';
            document.getElementById('journalList').style.display = 'none';
            
            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journalDate').max = today;
            
            // Set default date to today if not editing
            if (!document.getElementById('editingJournalId').value) {
                document.getElementById('journalDate').value = today;
            }
        }

        function showJournalList() {
            document.getElementById('journalForm').style.display = 'none';
            document.getElementById('journalList').style.display = 'block';
            document.getElementById('journalCalendarView').style.display = 'none';
            loadJournalEntries();
        }

        function showJournalCalendar() {
            document.getElementById('journalCalendarView').style.display = 'block';
            renderJournalCalendar();
        }

        function renderJournalCalendar() {
            const calendar = document.getElementById('journalCalendar');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Get days in month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            
            let calendarHTML = '<div style="grid-column: 1/-1; text-align: center; font-weight: 600; margin-bottom: 10px;">' + 
                              today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) + '</div>';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<div style="font-weight: 600; text-align: center; padding: 5px;">${day}</div>`;
            });
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasEntry = journalEntries.some(entry => entry.date === dateStr);
                const isToday = day === today.getDate();
                
                calendarHTML += `
                    <div class="calendar-day ${hasEntry ? 'has-entry' : ''} ${isToday ? 'selected' : ''}" 
                         onclick="viewJournalByDate('${dateStr}')">
                        ${day}
                    </div>
                `;
            }
            
            calendar.innerHTML = calendarHTML;
        }

        function viewJournalByDate(dateStr) {
            const entry = journalEntries.find(e => e.date === dateStr);
            if (entry) {
                document.getElementById('journalCalendarView').style.display = 'none';
                loadJournalEntries(dateStr);
            } else {
                showMessage('No journal entry for this date. Create one!');
                showJournalForm();
                document.getElementById('journalDate').value = dateStr;
            }
        }

        function loadJournalEntries(filterDate = null) {
            const container = document.getElementById('journalEntriesContainer');
            let entriesToShow = journalEntries;
            
            if (filterDate) {
                entriesToShow = journalEntries.filter(e => e.date === filterDate);
            }
            
            // Sort by date descending
            entriesToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (entriesToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No journal entries yet. Start writing! ‚úçÔ∏è</p>';
                return;
            }
            
            container.innerHTML = entriesToShow.map(entry => `
                <div class="journal-entry-card">
                    <div class="journal-date">
                        üìÖ ${new Date(entry.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span class="journal-mood">${entry.mood}</span>
                        ${entry.location ? `<span style="color: #666;">üìç ${entry.location}</span>` : ''}
                    </div>
                    <div class="journal-content">${entry.content.replace(/\n/g, '<br>')}</div>
                    <div class="journal-actions">
                        <button class="journal-btn journal-edit-btn" onclick='editJournalEntry(${JSON.stringify(entry).replace(/'/g, "&#39;")})'>
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="journal-btn journal-delete-btn" onclick="deleteJournalEntry('${entry.id}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function handleJournalSubmit(event) {
            event.preventDefault();
            
            if (!currentUser || !currentUser.email) {
                showMessage('Please login first', 'error');
                return;
            }
            
            const date = document.getElementById('journalDate').value;
            const mood = document.getElementById('journalMood').value;
            const content = document.getElementById('journalContent').value;
            const location = document.getElementById('journalLocation').value;
            const editingId = document.getElementById('editingJournalId').value;
            
            if (editingId) {
                // Update existing entry
                const index = journalEntries.findIndex(e => e.id === editingId);
                if (index !== -1) {
                    journalEntries[index] = {
                        ...journalEntries[index],
                        date,
                        mood,
                        content,
                        location
                    };
                }
                showMessage('üìù Journal entry updated!');
            } else {
                // Create new entry
                const entry = {
                    id: Date.now().toString(),
                    date,
                    mood,
                    content,
                    location,
                    createdAt: new Date().toISOString(),
                    userEmail: currentUser.email // Track owner
                };
                journalEntries.push(entry);
                showMessage('‚úÖ Journal entry saved!');
            }
            
            // Save to personal journals for current user
            personalJournals[currentUser.email] = journalEntries;
            localStorage.setItem('personalJournals', JSON.stringify(personalJournals));
            
            // Reset form
            event.target.reset();
            document.getElementById('editingJournalId').value = '';
            showJournalList();
        }

        function editJournalEntry(entry) {
            showJournalForm();
            document.getElementById('journalDate').value = entry.date;
            document.getElementById('journalMood').value = entry.mood;
            document.getElementById('journalContent').value = entry.content;
            document.getElementById('journalLocation').value = entry.location || '';
            document.getElementById('editingJournalId').value = entry.id;
        }

        function deleteJournalEntry(id) {
            if (!currentUser || !currentUser.email) {
                showMessage('Please login first', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this journal entry?')) {
                journalEntries = journalEntries.filter(e => e.id !== id);
                
                // Save to personal journals for current user
                personalJournals[currentUser.email] = journalEntries;
                localStorage.setItem('personalJournals', JSON.stringify(personalJournals));
                
                loadJournalEntries();
                showMessage('üóëÔ∏è Journal entry deleted');
            }
        }

        function cancelJournalEdit() {
            document.getElementById('journalForm').style.display = 'none';
            document.getElementById('editingJournalId').value = '';
            showJournalList();
        }

        // ===== 4. EXPORT FUNCTIONALITY =====
        async function exportPostsToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(255, 153, 51);
                doc.text('Spiritual Yatra - Posts Report', 20, yPosition);
                yPosition += 15;
                
                // Date
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Generated on: ' + new Date().toLocaleString(), 20, yPosition);
                yPosition += 15;
                
                // Posts
                posts.forEach((post, index) => {
                    if (yPosition > pageHeight - 40) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 128);
                    doc.text(`${index + 1}. ${post.place}`, 20, yPosition);
                    yPosition += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.text(`Author: ${post.author}`, 25, yPosition);
                    yPosition += 6;
                    doc.text(`Location: ${post.location}`, 25, yPosition);
                    yPosition += 6;
                    doc.text(`Date: ${new Date(post.date).toLocaleDateString()}`, 25, yPosition);
                    yPosition += 6;
                    
                    // Description
                    const splitDescription = doc.splitTextToSize(post.description, 160);
                    doc.text(splitDescription, 25, yPosition);
                    yPosition += (splitDescription.length * 6) + 10;
                });
                
                doc.save('yatra_posts_' + Date.now() + '.pdf');
                showMessage('üìÑ Posts exported to PDF!');
            } catch (error) {
                console.error('PDF export error:', error);
                showMessage('‚ùå Error exporting to PDF');
            }
        }

        async function exportPostsToExcel() {
            try {
                const XLSX = window.XLSX;
                
                const data = posts.map(post => ({
                    'ID': post.id,
                    'Author': post.author,
                    'Place': post.place,
                    'Location': post.location,
                    'Section': post.section || '',
                    'Description': post.description,
                    'Date': new Date(post.date).toLocaleString(),
                    'Latitude': post.lat,
                    'Longitude': post.lng,
                    'Tags': post.tags ? post.tags.join(', ') : '',
                    'Media Count': post.media ? post.media.length : 0,
                    'Approved': post.approved ? 'Yes' : 'No'
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Posts');
                
                XLSX.writeFile(wb, 'yatra_posts_' + Date.now() + '.xlsx');
                showMessage('üìä Posts exported to Excel!');

            } catch (error) {
                console.error('Excel export error:', error);
                showMessage('‚ùå Error exporting to Excel');
            }
        }

        async function exportJournalToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(156, 39, 176);
                doc.text('Daily Journal Entries', 20, yPosition);
                yPosition += 15;
                
                // Date
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Generated on: ' + new Date().toLocaleString(), 20, yPosition);
                yPosition += 15;
                
                // Sort by date
                const sortedEntries = [...journalEntries].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedEntries.forEach((entry, index) => {
                    if (yPosition > pageHeight - 50) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(255, 153, 51);
                    doc.text(new Date(entry.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }), 20, yPosition);
                    yPosition += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.text(`Mood: ${entry.mood}`, 25, yPosition);
                    yPosition += 6;
                    
                    if (entry.location) {
                        doc.text(`Location: ${entry.location}`, 25, yPosition);
                        yPosition += 6;
                    }
                    
                    yPosition += 4;
                    const splitContent = doc.splitTextToSize(entry.content, 160);
                    doc.text(splitContent, 25, yPosition);
                    yPosition += (splitContent.length * 6) + 15;
                });
                
                doc.save('yatra_journal_' + Date.now() + '.pdf');
                showMessage('üìì Journal exported to PDF!');

            } catch (error) {
                console.error('Journal PDF export error:', error);
                showMessage('‚ùå Error exporting journal to PDF');
            }
        }

        async function exportJournalToExcel() {
            try {
                const XLSX = window.XLSX;
                
                const data = journalEntries.map(entry => ({
                    'Date': entry.date,
                    'Mood': entry.mood,
                    'Location': entry.location || '',
                    'Content': entry.content,
                    'Created At': new Date(entry.createdAt).toLocaleString()
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Journal');
                
                XLSX.writeFile(wb, 'yatra_journal_' + Date.now() + '.xlsx');
                showMessage('üìî Journal exported to Excel!');

            } catch (error) {
                console.error('Journal Excel export error:', error);
                showMessage('‚ùå Error exporting journal to Excel');
            }
        }

        async function exportFullDataToExcel() {
            try {
                const XLSX = window.XLSX;
                const wb = XLSX.utils.book_new();
                
                // Posts sheet
                const postsData = posts.map(post => ({
                    'ID': post.id,
                    'Author': post.author,
                    'Place': post.place,
                    'Location': post.location,
                    'Section': post.section || '',
                    'Description': post.description,
                    'Date': new Date(post.date).toLocaleString(),
                    'Latitude': post.lat,
                    'Longitude': post.lng,
                    'Tags': post.tags ? post.tags.join(', ') : '',
                    'Media Count': post.media ? post.media.length : 0,
                    'Approved': post.approved ? 'Yes' : 'No'
                }));
                const postsWs = XLSX.utils.json_to_sheet(postsData);
                XLSX.utils.book_append_sheet(wb, postsWs, 'Posts');
                
                // Journal sheet
                const journalData = journalEntries.map(entry => ({
                    'Date': entry.date,
                    'Mood': entry.mood,
                    'Location': entry.location || '',
                    'Content': entry.content,
                    'Created At': new Date(entry.createdAt).toLocaleString()
                }));
                const journalWs = XLSX.utils.json_to_sheet(journalData);
                XLSX.utils.book_append_sheet(wb, journalWs, 'Journal');
                
                // Journey statistics
                const stats = {
                    'Total Posts': posts.length,
                    'Total Journal Entries': journalEntries.length,
                    'Total Locations': new Set(posts.map(p => p.location)).size,
                    'Total Contributors': new Set(posts.map(p => p.author)).size,
                    'Export Date': new Date().toLocaleString()
                };
                const statsWs = XLSX.utils.json_to_sheet([stats]);
                XLSX.utils.book_append_sheet(wb, statsWs, 'Statistics');
                
                XLSX.writeFile(wb, 'yatra_complete_data_' + Date.now() + '.xlsx');
                showMessage('üìÅ Complete data exported to Excel!');

            } catch (error) {
                console.error('Full data export error:', error);
                showMessage('‚ùå Error exporting complete data');
            }
        }

        // ==================== EMERGENCY FUNCTIONS ====================

        function openEmergencyModal() {
            document.getElementById('emergencyModal').style.display = 'block';
            loadEmergencyServices();
        }

        function closeEmergencyModal() {
            document.getElementById('emergencyModal').style.display = 'none';
        }

        async function loadEmergencyServices() {
            // Load doctor contact from admin settings
            loadDoctorContact();
            
            // Get user location and find nearby services
            if (currentLocation.lat && currentLocation.lng) {
                document.getElementById('emergencyLoading').style.display = 'block';
                document.getElementById('locationInfo').style.display = 'block';
                document.getElementById('userLocationText').textContent = currentLocation.placeName || `${currentLocation.lat.toFixed(4)}, ${currentLocation.lng.toFixed(4)}`;
                
                await findNearbyEmergencyServices(currentLocation.lat, currentLocation.lng);
                
                document.getElementById('emergencyLoading').style.display = 'none';
            } else {
                // Try to get location
                if (navigator.geolocation) {
                    document.getElementById('emergencyLoading').style.display = 'block';
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            document.getElementById('locationInfo').style.display = 'block';
                            document.getElementById('userLocationText').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                            
                            await findNearbyEmergencyServices(lat, lng);
                            document.getElementById('emergencyLoading').style.display = 'none';
                        },
                        (error) => {
                            console.error('Location error:', error);
                            document.getElementById('emergencyLoading').style.display = 'none';
                            showLocationError();
                        }
                    );
                } else {
                    showLocationError();
                }
            }
        }

        function loadDoctorContact() {
            const emergencySettings = JSON.parse(localStorage.getItem('emergencySettings') || '{}');
            const doctorName = emergencySettings.doctorName || 'Not Set';
            const doctorPhone = emergencySettings.doctorPhone || 'Not Set';
            
            const doctorHTML = `
                <div style="margin-bottom: 12px;">
                    <strong style="color: var(--navy); font-size: 1.1rem;">${doctorName}</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="flex: 1;">
                        <a href="tel:${doctorPhone}" style="color: #007bff; font-size: 1.1rem; text-decoration: none; font-weight: 600;">
                            üìû ${doctorPhone}
                        </a>
                    </div>
                    ${doctorPhone !== 'Not Set' ? `
                        <a href="https://wa.me/${doctorPhone.replace(/[^0-9]/g, '')}" target="_blank" style="background: #25D366; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                            WhatsApp
                        </a>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('doctorContactDetails').innerHTML = doctorHTML;
        }

        async function findNearbyEmergencyServices(lat, lng) {
            try {
                // Find Police Stations
                await findNearbyPlaces(lat, lng, 'police', 3, 'policeList');
                
                // Find Hospitals
                await findNearbyPlaces(lat, lng, 'hospital', 5, 'hospitalList');
                
                // Find Pharmacies
                await findNearbyPlaces(lat, lng, 'pharmacy', 5, 'pharmacyList');
                
                // Find Ambulance Services
                await findNearbyPlaces(lat, lng, 'ambulance', 3, 'ambulanceList');
            } catch (error) {
                console.error('Error finding emergency services:', error);
                showMessage('Error finding nearby services. Please try again.');
            }
        }

        async function findNearbyPlaces(lat, lng, type, limit, containerId) {
            const radius = 5000; // 5km radius
            let overpassQuery = '';
            
            switch(type) {
                case 'police':
                    overpassQuery = `
                        [out:json][timeout:25];
                        (
                            node["amenity"="police"](around:${radius},${lat},${lng});
                            way["amenity"="police"](around:${radius},${lat},${lng});
                        );
                        out center ${limit};
                    `;
                    break;
                case 'hospital':
                    overpassQuery = `
                        [out:json][timeout:25];
                        (
                            node["amenity"="hospital"](around:${radius},${lat},${lng});
                            way["amenity"="hospital"](around:${radius},${lat},${lng});
                            node["amenity"="clinic"](around:${radius},${lat},${lng});
                            way["amenity"="clinic"](around:${radius},${lat},${lng});
                        );
                        out center ${limit};
                    `;
                    break;
                case 'pharmacy':
                    overpassQuery = `
                        [out:json][timeout:25];
                        (
                            node["amenity"="pharmacy"](around:${radius},${lat},${lng});
                            way["amenity"="pharmacy"](around:${radius},${lat},${lng});
                        );
                        out center ${limit};
                    `;
                    break;
                case 'ambulance':
                    // For ambulances, we'll show emergency numbers instead
                    document.getElementById(containerId).innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--navy);">National Ambulance Service</strong><br>
                                    <span style="color: #666;">üìû 102 (National)</span>
                                </div>
                                <a href="tel:102" style="background: #28a745; color: white; padding: 8px 20px; border-radius: 25px; text-decoration: none; font-weight: 600;">Call</a>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--navy);">Emergency Services</strong><br>
                                    <span style="color: #666;">üìû 112 (All Emergencies)</span>
                                </div>
                                <a href="tel:112" style="background: #dc3545; color: white; padding: 8px 20px; border-radius: 25px; text-decoration: none; font-weight: 600;">Call</a>
                            </div>
                        </div>
                    `;
                    return;
            }
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery
                });
                
                const data = await response.json();
                displayEmergencyResults(data.elements, type, containerId, lat, lng);
            } catch (error) {
                console.error(`Error fetching ${type}:`, error);
                document.getElementById(containerId).innerHTML = `<p style="color: #dc3545;">Could not load ${type} data. Please try again.</p>`;
            }
        }

        function displayEmergencyResults(places, type, containerId, userLat, userLng) {
            const container = document.getElementById(containerId);
            
            if (!places || places.length === 0) {
                container.innerHTML = `<p style="color: #666; font-style: italic;">No ${type}s found nearby. Try refreshing or enable location services.</p>`;
                return;
            }
            
            // Calculate distances and sort
            const placesWithDistance = places.map(place => {
                const placeLat = place.lat || place.center?.lat;
                const placeLng = place.lon || place.center?.lon;
                const distance = calculateDistance(userLat, userLng, placeLat, placeLng);
                return { ...place, distance };
            }).sort((a, b) => a.distance - b.distance);
            
            const html = placesWithDistance.map(place => {
                const name = escapeHTML(place.tags?.name || `${type.charAt(0).toUpperCase() + type.slice(1)}`);
                const phone = place.tags?.phone || place.tags?.['contact:phone'] || 'N/A';
                const address = escapeHTML(place.tags?.['addr:street'] || place.tags?.['addr:full'] || 'Address not available');
                const distanceKm = place.distance.toFixed(2);
                
                const phoneClean = phone.replace(/[^0-9+]/g, '');
                
                return `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--saffron);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <strong style="color: var(--navy); font-size: 1.05rem;">${name}</strong><br>
                                <small style="color: #666;">üìç ${distanceKm} km away</small><br>
                                <small style="color: #666;">${address}</small>
                            </div>
                        </div>
                        ${phone !== 'N/A' ? `
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <a href="tel:${escapeHTML(phoneClean)}" style="flex: 1; background: #007bff; color: white; padding: 10px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: 600;">
                                    üìû Call
                                </a>
                                <a href="https://wa.me/${escapeHTML(phoneClean)}" target="_blank" style="flex: 1; background: #25D366; color: white; padding: 10px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                    </svg>
                                    WhatsApp
                                </a>
                            </div>
                        ` : `
                            <p style="color: #999; font-size: 0.9rem; margin-top: 10px;">Phone number not available</p>
                        `}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function showLocationError() {
            document.getElementById('policeList').innerHTML = '<p style="color: #dc3545;">Location access required to find nearby services.</p>';
            document.getElementById('hospitalList').innerHTML = '<p style="color: #dc3545;">Location access required to find nearby services.</p>';
            document.getElementById('pharmacyList').innerHTML = '<p style="color: #dc3545;">Location access required to find nearby services.</p>';
        }

        function refreshEmergencyServices() {
            loadEmergencyServices();
            showMessage('üîÑ Refreshing emergency services...');
        }

        // ==================== END EMERGENCY FUNCTIONS ====================

        // ==================== ANNOUNCEMENTS SYSTEM ====================

        let processedAnnouncements = JSON.parse(localStorage.getItem('processedAnnouncements') || '[]');
        let announcementCheckInterval = null;

        function startAnnouncementChecker() {
            if (announcementCheckInterval) return; // Already running
            
            announcementCheckInterval = setInterval(() => {
                checkPendingAnnouncements();
            }, 5000); // Check every 5 seconds
            
            console.log('‚úÖ Announcement checker started');
        }

        function checkPendingAnnouncements() {
            const pendingAnnouncements = JSON.parse(localStorage.getItem('pendingAnnouncements') || '[]');
            
            if (pendingAnnouncements.length === 0) return;
            
            pendingAnnouncements.forEach(announcement => {
                // Check if already processed
                if (processedAnnouncements.includes(announcement.id)) return;
                
                // Check if user should receive this announcement
                if (shouldReceiveAnnouncement(announcement)) {
                    displayAnnouncement(announcement);
                    
                    // Mark as processed
                    processedAnnouncements.push(announcement.id);
                    localStorage.setItem('processedAnnouncements', JSON.stringify(processedAnnouncements));
                }
            });
        }

        function shouldReceiveAnnouncement(announcement) {
            if (!announcement.recipients || announcement.recipients.length === 0) return true;
            
            // Check if current user is in recipients list
            if (!currentUser || !currentUser.email) return false;
            
            return announcement.recipients.includes(currentUser.email);
        }

        function displayAnnouncement(announcement) {
            const displayType = announcement.displayType || 'notification';
            const message = announcement.message || 'No message';
            const timestamp = announcement.timestamp ? new Date(announcement.timestamp).toLocaleString() : 'Just now';
            
            if (displayType === 'dialog') {
                // Show as dialog box
                document.getElementById('announcementDialogMessage').textContent = message;
                document.getElementById('announcementDialogTime').textContent = `üìÖ ${timestamp}`;
                document.getElementById('announcementDialog').style.display = 'block';
            } else {
                // Show as notification
                document.getElementById('announcementNotificationMessage').textContent = message;
                document.getElementById('announcementNotificationTime').textContent = `üìÖ ${timestamp}`;
                
                const notification = document.getElementById('announcementNotification');
                notification.style.display = 'block';
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    closeAnnouncementNotification();
                }, 10000);
            }
        }

        function closeAnnouncementNotification() {
            const notification = document.getElementById('announcementNotification');
            notification.style.animation = 'slideInRight 0.3s ease reverse';
            setTimeout(() => {
                notification.style.display = 'none';
                notification.style.animation = 'slideInRight 0.5s ease';
            }, 300);
        }

        function closeAnnouncementDialog() {
            document.getElementById('announcementDialog').style.display = 'none';
        }

        // Clean up old processed announcements (keep only last 100)
        function cleanupProcessedAnnouncements() {
            if (processedAnnouncements.length > 100) {
                processedAnnouncements = processedAnnouncements.slice(-100);
                localStorage.setItem('processedAnnouncements', JSON.stringify(processedAnnouncements));
            }
        }

        // Start announcement checker when page loads
        startAnnouncementChecker();
        cleanupProcessedAnnouncements();

        // Global error handlers
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Check storage usage on load
        checkStorageUsage();

        // ==================== END ANNOUNCEMENTS SYSTEM ====================

        // ==================== END NEW FEATURES FUNCTIONS ====================

    </script>
</body>
</html>
